"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        bind: '',
        dtus: [],
        nodes: [],
        radio: ''
    },
    onLoad: function () {
        this.getNodes();
    },
    async scanMac() {
        const scanResult = await wx.scanCode({});
        this.setData({
            mac: scanResult.result
        });
        this.addDtus();
    },
    scanRequst() {
        this.addDtus();
    },
    async addDtus() {
        const { mac, bind, radio } = this.data;
        if (this.data.dtus.findIndex(el => el.DevMac === mac) !== -1) {
            console.log('重复扫描');
        }
        else {
            this.setData({
                mac,
                dtus: [{ DevMac: mac, bindDev: bind, mountNode: radio }, ...this.data.dtus]
            });
            const dtulen = this.data.dtus.length;
            for (let node of this.data.nodes) {
                if (node.MaxConnections - (node.count || 0) > dtulen) {
                    this.setData({
                        radio: node.Name
                    });
                    break;
                }
            }
        }
    },
    onChange_Node(event) {
        console.log(event);
    },
    rmDtu(event) {
        const mac = event.currentTarget.dataset.key;
        wx.showModal({
            title: '删除dtu',
            content: `确定删除dtu:${mac} ??`,
            success: (res) => {
                if (res.confirm) {
                    this.setData({
                        dtus: this.data.dtus.filter(el => el.DevMac !== mac)
                    });
                }
            }
        });
    },
    async getNodes() {
        const { data } = await api_1.default.Nodes();
        this.setData({
            nodes: data,
            radio: data[0].Name
        });
    },
    changeNode(event) {
        this.setData({
            radio: event.detail,
        });
    },
    selectNode(event) {
        const item = event.currentTarget.dataset.item;
        this.setData({
            radio: item.Name
        });
    },
    submit() {
        const { dtus, radio } = this.data;
        wx.showModal({
            title: '提交核对',
            content: `本次提交的dtu数目:${dtus.length},挂载的节点为:${radio},`,
            success: async () => {
                const all = await Promise.all(dtus.map(el => api_1.default.addRegisterTerminal(el.DevMac, el.mountNode)));
                if (all.length === dtus.length) {
                    wx.showModal({
                        title: '提交成功',
                        content: `成功提交[${all.length}] 个设备`
                    });
                    this.getNodes();
                    this.setData({
                        dtus: [],
                        mac: ''
                    });
                }
                else {
                    wx.showModal({
                        title: '提交错误',
                        content: '提交错误'
                    });
                }
            }
        });
    },
    copy() {
        const mac = this.data.dtus.map(el => '866' + el.DevMac).join("\n");
        wx.setClipboardData({
            data: mac,
            success() {
                wx.showToast({
                    title: 'success'
                });
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZWdpc3Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRDQUFxQztBQUdyQyxJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUU7UUFDSixHQUFHLEVBQUUsRUFBRTtRQUNQLElBQUksRUFBRSxFQUFFO1FBQ1IsSUFBSSxFQUFFLEVBQTZCO1FBQ25DLEtBQUssRUFBRSxFQUF1QjtRQUM5QixLQUFLLEVBQUUsRUFBRTtLQUNWO0lBS0QsTUFBTSxFQUFFO1FBQ04sSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFBO0lBQ2pCLENBQUM7SUFHRCxLQUFLLENBQUMsT0FBTztRQUNYLE1BQU0sVUFBVSxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUV4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsR0FBRyxFQUFFLFVBQVUsQ0FBQyxNQUFNO1NBQ3ZCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUNoQixDQUFDO0lBV0QsVUFBVTtRQVVSLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtJQUNoQixDQUFDO0lBR0QsS0FBSyxDQUFDLE9BQU87UUFDWCxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFBO1FBQ3RDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLE1BQU0sS0FBSyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtZQUM1RCxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3JCO2FBQU07WUFDTCxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLEdBQUc7Z0JBQ0gsSUFBSSxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLE9B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Q1gsS0FBSyxFQUFFLE1BQU07d0JBQ2IsT0FBTyxFQUFFLFFBQVEsR0FBRyxDQUFDLE1BQU0sT0FBTztxQkFDbkMsQ0FBQyxDQUFBO29CQUNGLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQTtvQkFDZixJQUFJLENBQUMsT0FBTyxDQUFDO3dCQUNYLElBQUksRUFBRSxFQUFFO3dCQUNSLEdBQUcsRUFBRSxFQUFFO3FCQUNSLENBQUMsQ0FBQTtpQkFDSDtxQkFBTTtvQkFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO3dCQUNYLEtBQUssRUFBRSxNQUFNO3dCQUNiLE9BQU8sRUFBRSxNQUFNO3FCQUNoQixDQUFDLENBQUE7aUJBQ0g7WUFDSCxDQUFDO1NBQ0YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUdELElBQUk7UUFDRixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNsRSxFQUFFLENBQUMsZ0JBQWdCLENBQUM7WUFDbEIsSUFBSSxFQUFFLEdBQUc7WUFDVCxPQUFPO2dCQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLFNBQVM7aUJBQ2pCLENBQUMsQ0FBQTtZQUNKLENBQUM7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCI7XG5cbi8vIG1pbmlwcm9ncmFtL3BhZ2VzL2FkbWluL3JlZ2lzdGVyL3JlZ2lzdGVyLmpzXG5QYWdlKHtcblxuICAvKipcbiAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXG4gICAqL1xuICBkYXRhOiB7XG4gICAgbWFjOiAnJyxcbiAgICBiaW5kOiAnJyxcbiAgICBkdHVzOiBbXSBhcyBVYXJ0LlJlZ2lzdGVyVGVybWluYWxbXSxcbiAgICBub2RlczogW10gYXMgVWFydC5Ob2RlQ2xpZW50W10sXG4gICAgcmFkaW86ICcnXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XG4gICAqL1xuICBvbkxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLmdldE5vZGVzKClcbiAgfSxcblxuICAvLyDosIPnlKjlvq7kv6FhcGnvvIzmiavmj49EVFXmnaHlvaLnoIFcbiAgYXN5bmMgc2Nhbk1hYygpIHtcbiAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgd3guc2NhbkNvZGUoe30pXG4gICAgLy9jb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5nZXRUZXJtaW5hbChzY2FuUmVzdWx0LnJlc3VsdClcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbWFjOiBzY2FuUmVzdWx0LnJlc3VsdFxuICAgIH0pXG4gICAgdGhpcy5hZGREdHVzKClcbiAgfSxcblxuICAvKiBhc3luYyBzY2FuQmluZCgpIHtcbiAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgd3guc2NhbkNvZGUoe30pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGJpbmQ6IHNjYW5SZXN1bHQucmVzdWx0XG4gICAgfSlcbiAgICBpZiAodGhpcy5kYXRhLm1hYyAmJiB0aGlzLmRhdGEuYmluZCkgdGhpcy5hZGREdHVzKClcbiAgfSwgKi9cblxuICAvLyDliqDlhaVkdHVzXG4gIHNjYW5SZXF1c3QoKSB7XG4gICAgLyogaWYgKCF0aGlzLmRhdGEuYmluZCkge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICflj4LmlbDkuI3lrozmlbQnLFxuICAgICAgICBjb250ZW50OiAn6K6+5aSHSUTov5jmnKrloavlhpks5piv5ZCm5re75YqgPz8nLFxuICAgICAgICBzdWNjZXNzOiAoZSkgPT4ge1xuICAgICAgICAgIGlmIChlLmNvbmZpcm0pIHRoaXMuYWRkRHR1cygpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSBlbHNlICovXG4gICAgdGhpcy5hZGREdHVzKClcbiAgfSxcblxuICAvLyBhZGRcbiAgYXN5bmMgYWRkRHR1cygpIHtcbiAgICBjb25zdCB7IG1hYywgYmluZCwgcmFkaW8gfSA9IHRoaXMuZGF0YVxuICAgIGlmICh0aGlzLmRhdGEuZHR1cy5maW5kSW5kZXgoZWwgPT4gZWwuRGV2TWFjID09PSBtYWMpICE9PSAtMSkge1xuICAgICAgY29uc29sZS5sb2coJ+mHjeWkjeaJq+aPjycpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBtYWMsXG4gICAgICAgIGR0dXM6IFt7IERldk1hYzogbWFjLCBiaW5kRGV2OiBiaW5kLCBtb3VudE5vZGU6IHJhZGlvIH0sIC4uLnRoaXMuZGF0YS5kdHVzXVxuICAgICAgfSlcbiAgICAgIGNvbnN0IGR0dWxlbiA9IHRoaXMuZGF0YS5kdHVzLmxlbmd0aFxuICAgICAgZm9yIChsZXQgbm9kZSBvZiB0aGlzLmRhdGEubm9kZXMpIHtcbiAgICAgICAgaWYgKG5vZGUuTWF4Q29ubmVjdGlvbnMgLSAobm9kZS5jb3VudCB8fCAwKSA+IGR0dWxlbikge1xuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICByYWRpbzogbm9kZS5OYW1lXG4gICAgICAgICAgfSlcbiAgICAgICAgICBicmVha1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIC8vIOmAieaLqeiKgueCuVxuICBvbkNoYW5nZV9Ob2RlKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICBjb25zb2xlLmxvZyhldmVudCk7XG5cbiAgfSxcblxuICAvLyDliKDpmaTpgInmi6nnmoREVFVcbiAgcm1EdHUoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIGNvbnN0IG1hYyA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5rZXlcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6ICfliKDpmaRkdHUnLFxuICAgICAgY29udGVudDogYOehruWumuWIoOmZpGR0dToke21hY30gPz9gLFxuICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLmNvbmZpcm0pIHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgZHR1czogdGhpcy5kYXRhLmR0dXMuZmlsdGVyKGVsID0+IGVsLkRldk1hYyAhPT0gbWFjKVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIC8vIOiOt+WPluiKgueCueWIl+ihqFxuICBhc3luYyBnZXROb2RlcygpIHtcbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IGFwaS5Ob2RlcygpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIG5vZGVzOiBkYXRhLFxuICAgICAgcmFkaW86IGRhdGFbMF0uTmFtZVxuICAgIH0pXG4gIH0sXG4gIC8vIOWPmOabtOmAieaLqeiKgueCuVxuICBjaGFuZ2VOb2RlKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgcmFkaW86IGV2ZW50LmRldGFpbCxcbiAgICB9KTtcbiAgfSxcblxuICAvLyDpgInmi6noioLngrlcbiAgc2VsZWN0Tm9kZShldmVudDogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgaXRlbTogVWFydC5Ob2RlQ2xpZW50ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgcmFkaW86IGl0ZW0uTmFtZVxuICAgIH0pO1xuICB9LFxuICAvLyDmj5DkuqRcbiAgc3VibWl0KCkge1xuICAgIGNvbnN0IHsgZHR1cywgcmFkaW8gfSA9IHRoaXMuZGF0YVxuICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ+aPkOS6pOaguOWvuScsXG4gICAgICBjb250ZW50OiBg5pys5qyh5o+Q5Lqk55qEZHR15pWw55uuOiR7ZHR1cy5sZW5ndGh9LOaMgui9veeahOiKgueCueS4ujoke3JhZGlvfSxgLFxuICAgICAgc3VjY2VzczogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCBhbGwgPSBhd2FpdCBQcm9taXNlLmFsbChkdHVzLm1hcChlbCA9PiBhcGkuYWRkUmVnaXN0ZXJUZXJtaW5hbChlbC5EZXZNYWMsIGVsLm1vdW50Tm9kZSkpKVxuICAgICAgICBpZiAoYWxsLmxlbmd0aCA9PT0gZHR1cy5sZW5ndGgpIHtcbiAgICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgICAgdGl0bGU6ICfmj5DkuqTmiJDlip8nLFxuICAgICAgICAgICAgY29udGVudDogYOaIkOWKn+aPkOS6pFske2FsbC5sZW5ndGh9XSDkuKrorr7lpIdgXG4gICAgICAgICAgfSlcbiAgICAgICAgICB0aGlzLmdldE5vZGVzKClcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgZHR1czogW10sXG4gICAgICAgICAgICBtYWM6ICcnXG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgICAgdGl0bGU6ICfmj5DkuqTplJnor68nLFxuICAgICAgICAgICAgY29udGVudDogJ+aPkOS6pOmUmeivrydcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuXG4gIGNvcHkoKSB7XG4gICAgY29uc3QgbWFjID0gdGhpcy5kYXRhLmR0dXMubWFwKGVsID0+ICc4NjYnICsgZWwuRGV2TWFjKS5qb2luKFwiXFxuXCIpXG4gICAgd3guc2V0Q2xpcGJvYXJkRGF0YSh7XG4gICAgICBkYXRhOiBtYWMsXG4gICAgICBzdWNjZXNzKCkge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAnc3VjY2VzcydcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG59KSJdfQ==