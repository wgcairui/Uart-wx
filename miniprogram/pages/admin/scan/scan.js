"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        terminal: {
            name: '',
            mountNode: '',
            mountDevs: [],
            uptime: ''
        },
        remoteUrl: '',
        uarts: ['2400,8,1,NONE,NFC', '4800,8,1,NONE,HD', '9600,8,1,NONE,HD', '19200,8,1,NONE,HD', '115200,8,1,NONE,HD']
    },
    async scanMac() {
        const scanResult = await wx.scanCode({});
        this.setData({
            mac: scanResult.result
        });
        this.scanRequst();
    },
    async scanRequst() {
        wx.showLoading({ title: '查询中' });
        const { code, data } = await api_1.default.getRootTerminal(this.data.mac);
        wx.hideLoading();
        if (code && data) {
            this.setData({
                mac: data.DevMac,
                terminal: data
            });
            this.generateLabel();
        }
        else {
            wx.showModal({
                title: 'search',
                content: '此设备没有注册，请核对设备是否在我司渠道购买'
            });
        }
    },
    async initTerminal() {
        const { confirm } = await wx.showModal({
            title: '初始化' + this.data.terminal.name,
            content: '初始化操作不可逆,会清除dtu绑定的设备信息,告警信息,且只能清除未被绑定的dtu!!!'
        });
        if (confirm) {
            wx.showLoading({ title: 'loading' });
            const { code, data, msg } = await api_1.default.initTerminal(this.data.terminal.DevMac);
            if (code) {
                wx.showModal({
                    title: 'success',
                    content: `耗时${data}ms`
                });
                this.scanRequst();
            }
            else {
                wx.showModal({
                    title: 'error',
                    content: msg
                });
            }
        }
    },
    async modifyUart() {
        const d = await wx.showActionSheet({
            itemList: this.data.uarts
        });
        if (this.data.terminal.DevMac && d.errMsg === 'showActionSheet:ok') {
            const uart = `+++AT+UART=1,` + this.data.uarts[d.tapIndex];
            wx.showLoading({ title: '正在修改' });
            const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
            wx.hideLoading();
            if (code && data.ok) {
                wx.showToast({
                    title: 'success',
                    content: data.msg
                });
                this.setData({
                    "terminal.uart": this.data.uarts[d.tapIndex]
                });
            }
            else {
                wx.showModal({
                    title: '操作失败',
                    content: data.msg
                });
            }
        }
    },
    async resetDtu() {
        wx.showModal({
            title: "重启Dtu",
            content: "确定现在重启Dtu吗?",
            success: async () => {
                const uart = `+++AT+Z`;
                wx.showLoading({ title: '正在修改' });
                const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
                wx.hideLoading();
                if (code) {
                    wx.showToast({
                        title: 'success',
                        content: data.msg
                    });
                }
            }
        });
    },
    async bindDevId() {
        const scanResult = await wx.scanCode({});
        wx.showLoading({ title: 'loading' });
        const t = await api_1.default.getTerminal(scanResult.result);
        if (t.data) {
            wx.hideLoading();
            wx.showModal({
                title: 'error',
                content: `${scanResult.result}已被dtu:${t.data.DevMac} 绑定`
            });
            return;
        }
        const { data } = await api_1.default.getRegisterDev(scanResult.result);
        wx.hideLoading();
        if (data) {
            const { confirm } = await wx.showModal({
                title: '确认绑定信息',
                content: `类型:${data.Type}\n 设备:${data.mountDev}\n 协议:${data.protocol}\n 地址:${data.pid}`
            });
            if (confirm) {
                wx.showLoading({ title: '正在绑定设备' });
                const r = await api_1.default.addTerminalMountDev(this.data.terminal.DevMac, { mountDev: data.mountDev, Type: data.Type, protocol: data.protocol, pid: data.pid, bindDev: scanResult.result });
                wx.hideLoading();
                if (r.code) {
                    wx.showToast({
                        title: '设备绑定成功'
                    });
                    this.scanRequst();
                }
            }
        }
        else {
            wx.showModal({
                title: '流程出错',
                content: `${scanResult.result}未注册,请先注册后绑定`
            });
        }
    },
    see(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/admin/devs/devs' + util_1.ObjectToStrquery({ pid: String(pid), mountDev, protocol, DevMac: this.data.terminal.DevMac, Type })
        });
    },
    async rmBind(e) {
        const item = e.currentTarget.dataset.item;
        const { confirm } = await wx.showModal({
            title: '删除绑定设备',
            content: `确定删除 ${item.mountDev} ???`
        });
        if (confirm) {
            api_1.default.delTerminalMountDev(this.data.terminal.DevMac, item.pid).then(() => {
                this.scanRequst();
            });
        }
    },
    async iotRemoteUrl() {
        const { code, data } = await api_1.default.iotRemoteUrl(this.data.mac);
        if (!code) {
            wx.showModal({
                title: '获取失败',
                content: '设备未绑定到IOT账号'
            });
        }
        else {
            if (!/remote_code=$/.test(data)) {
                wx.showModal({
                    title: '调试地址',
                    content: data,
                    success() {
                        wx.setClipboardData({
                            data,
                            success() {
                                wx.showToast({
                                    title: '已复制网址到剪切板'
                                });
                            }
                        });
                    }
                });
            }
            else {
                wx.showModal({
                    title: '获取失败',
                    content: '设备未连接到iot server中心'
                });
            }
        }
    },
    async generateLabel() {
        const mac = this.data.terminal.DevMac;
        const pic_readmeqr = await this.dowmPic("https://www.ladishb.com/upload/9_18_2021_qrcode_www.yuque.com.png");
        const pic_wpqr = await this.dowmPic("https://www.ladishb.com/upload/3312021__LADS_Uart.5df2cc6.png");
        const pic_mac = await this.generateFile(mac);
        const res = await new Promise(resolve => {
            wx.createSelectorQuery()
                .select("#canvas1")
                .fields({ node: true, size: true })
                .exec(res => resolve(res));
        });
        const canvas = res[0].node;
        canvas.height = 150;
        canvas.width = 400;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#FFFFFF";
        ctx.fillRect(0, 0, 350, 200);
        ctx.fillStyle = "#000000";
        ctx.drawImage(await this.generateCanvasImg(canvas, pic_readmeqr), 10, 20, 110, 95);
        ctx.fillText('操作说明', 50, 130);
        ctx.drawImage(await this.generateCanvasImg(canvas, pic_wpqr), 120, 20, 110, 95);
        ctx.fillText('小程序', 165, 130);
        ctx.drawImage(await this.generateCanvasImg(canvas, pic_mac), 230, 20, 110, 95);
        ctx.fillText('mac:' + mac, 240, 130);
    },
    async downLabel() {
        const res = await new Promise(resolve => {
            wx.createSelectorQuery()
                .select("#canvas1")
                .fields({ node: true, size: true })
                .exec(res => resolve(res));
        });
        const canvas = res[0].node;
        wx.canvasToTempFilePath({
            canvasId: "canvas1",
            quality: 1,
            canvas,
            fileType: "jpg",
            destHeight: 300,
            destWidth: 700,
            success(res) {
                wx.saveImageToPhotosAlbum({
                    filePath: res.tempFilePath,
                    success(res) {
                        if (res.errMsg = "saveImageToPhotosAlbum:ok") {
                            wx.showToast({
                                title: "已保存到照片库",
                                icon: "success"
                            });
                        }
                    }
                });
            }
        });
    },
    async generateFile(code) {
        const base = await api_1.default.qr(code);
        const filePath = `${wx.env.USER_DATA_PATH}/${code}.png`;
        const m = wx.getFileSystemManager();
        return await new Promise(resolve => {
            m.writeFile({
                filePath,
                data: base.data.replace(/[\r\n]/g, '').slice(22),
                encoding: "base64",
                success() {
                    resolve(filePath);
                }
            });
        });
    },
    generateCanvasImg(canvas, path) {
        return new Promise(resolve => {
            const img = canvas.createImage();
            img.onload = () => resolve(img);
            img.onerror = (e) => {
                console.log({ e });
            };
            img.src = path;
        });
    },
    dowmPic(url) {
        const nArr = url.split("/");
        const name = nArr[nArr.length - 1];
        const filename = `${wx.env.USER_DATA_PATH}/${name}`;
        return new Promise(resolve => {
            const m = wx.getFileSystemManager();
            m.stat({
                path: filename,
                success() {
                    resolve(filename);
                },
                fail(e) {
                    console.log(e.errMsg);
                    wx.downloadFile({
                        url,
                        filePath: filename,
                        success(res) {
                            resolve(res.filePath);
                        }
                    });
                }
            });
        });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBc0Q7QUFDdEQsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsRUFBRTtZQUNiLFNBQVMsRUFBRSxFQUE4QjtZQUN6QyxNQUFNLEVBQUUsRUFBRTtTQUNNO1FBQ2xCLFNBQVMsRUFBRSxFQUFFO1FBQ2IsS0FBSyxFQUFFLENBQUMsbUJBQW1CLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUsbUJBQW1CLEVBQUUsb0JBQW9CLENBQUM7S0FDaEg7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNYLE1BQU0sVUFBVSxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsR0FBRyxFQUFFLFVBQVUsQ0FBQyxNQUFNO1NBQ3ZCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUNuQixDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVU7UUFDZCxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7UUFDaEMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLGFBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUMvRCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDaEIsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO1lBRWhCLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNO2dCQUNoQixRQUFRLEVBQUUsSUFBSTthQUNmLENB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QUNqQixNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzNCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBQ2xDLE1BQU0sUUFBUSxHQUFHLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQyxjQUFjLElBQUksSUFBSSxFQUFFLENBQUE7UUFDbkQsT0FBTyxJQUFJLE9BQU8sQ0FBUyxPQUFPLENBQUMsRUFBRTtZQUVuQyxNQUFNLENBQUMsR0FBRyxFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtZQUNuQyxDQUFDLENBQUMsSUFBSSxDQUFDO2dCQUNMLElBQUksRUFBRSxRQUFRO2dCQUNkLE9BQU87b0JBQ0wsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFBO2dCQUNuQixDQUFDO2dCQUNELElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUN0QixFQUFFLENBQUMsWUFBWSxDQUFDO3dCQUNkLEdBQUc7d0JBQ0gsUUFBUSxFQUFFLFFBQVE7d0JBQ2xCLE9BQU8sQ0FBQyxHQUFHOzRCQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUE7d0JBQ3ZCLENBQUM7cUJBQ0YsQ0FBQyxDQUFBO2dCQUNKLENBQUM7YUFDRixDQUFDLENBQUE7UUFDSixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FHRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYmplY3RUb1N0cnF1ZXJ5IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgbWFjOiAnJyxcbiAgICB0ZXJtaW5hbDoge1xuICAgICAgbmFtZTogJycsXG4gICAgICBtb3VudE5vZGU6ICcnLFxuICAgICAgbW91bnREZXZzOiBbXSBhcyBVYXJ0LlRlcm1pbmFsTW91bnREZXZzW10sXG4gICAgICB1cHRpbWU6ICcnXG4gICAgfSBhcyBVYXJ0LlRlcm1pbmFsLFxuICAgIHJlbW90ZVVybDogJycsXG4gICAgdWFydHM6IFsnMjQwMCw4LDEsTk9ORSxORkMnLCAnNDgwMCw4LDEsTk9ORSxIRCcsICc5NjAwLDgsMSxOT05FLEhEJywgJzE5MjAwLDgsMSxOT05FLEhEJywgJzExNTIwMCw4LDEsTk9ORSxIRCddXG4gIH0sXG4gIC8vIOiwg+eUqOW+ruS/oWFwae+8jOaJq+aPj0RUVeadoeW9oueggVxuICBhc3luYyBzY2FuTWFjKCkge1xuICAgIGNvbnN0IHNjYW5SZXN1bHQgPSBhd2FpdCB3eC5zY2FuQ29kZSh7fSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbWFjOiBzY2FuUmVzdWx0LnJlc3VsdFxuICAgIH0pXG4gICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgfSxcbiAgLy8g5p+l6K+iRFRV6K6+5aSH5L+h5oGvXG4gIGFzeW5jIHNjYW5SZXF1c3QoKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+afpeivouS4rScgfSlcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5nZXRSb290VGVybWluYWwodGhpcy5kYXRhLm1hYylcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKGNvZGUgJiYgZGF0YSkge1xuXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBtYWM6IGRhdGEuRGV2TWFjLFxuICAgICAgICB0ZXJtaW5hbDogZGF0YVxuICAgICAgfSlcbiAgICAgIHRoaXMuZ2VuZXJhdGVMYWJlbCgpXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAnc2VhcmNoJyxcbiAgICAgICAgY29udGVudDogJ+atpOiuvuWkh+ayoeacieazqOWGjO+8jOivt+aguOWvueiuvuWkh+aYr+WQpuWcqOaIkeWPuOa4oOmBk+i0reS5sCdcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIGFzeW5jIGluaXRUZXJtaW5hbCgpIHtcbiAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ+WIneWni+WMlicgKyB0aGlzLmRhdGEudGVybWluYWwubmFtZSxcbiAgICAgIGNvbnRlbnQ6ICfliJ3lp4vljJbmk43kvZzkuI3lj6/pgIYs5Lya5riF6ZmkZHR157uR5a6a55qE6K6+5aSH5L+h5oGvLOWRiuitpuS/oeaBryzkuJTlj6rog73muIXpmaTmnKrooqvnu5HlrprnmoRkdHUhISEnXG4gICAgfSlcbiAgICBpZiAoY29uZmlybSkge1xuICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgICBjb25zdCB7IGNvZGUsIGRhdGEsIG1zZyB9ID0gYXdhaXQgYXBpLmluaXRUZXJtaW5hbCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjKVxuICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IGDogJfml7Yke2RhdGF9bXNgXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAnZXJyb3InLFxuICAgICAgICAgIGNvbnRlbnQ6IG1zZ1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICog5L+u5pS55rOi54m5546HXG4gICAqL1xuICBhc3luYyBtb2RpZnlVYXJ0KCkge1xuICAgIGNvbnN0IGQgPSBhd2FpdCB3eC5zaG93QWN0aW9uU2hlZXQoe1xuICAgICAgaXRlbUxpc3Q6IHRoaXMuZGF0YS51YXJ0c1xuICAgIH0pXG4gICAgaWYgKHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMgJiYgZC5lcnJNc2cgPT09ICdzaG93QWN0aW9uU2hlZXQ6b2snKSB7XG4gICAgICBjb25zdCB1YXJ0ID0gYCsrK0FUK1VBUlQ9MSxgICsgdGhpcy5kYXRhLnVhcnRzW2QudGFwSW5kZXhdXG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5q2j5Zyo5L+u5pS5JyB9KVxuICAgICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuc2VuZEFUSW5zdHJ1Y3QodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgdWFydClcbiAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIGlmIChjb2RlICYmIGRhdGEub2spIHtcbiAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IGRhdGEubXNnXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgXCJ0ZXJtaW5hbC51YXJ0XCI6IHRoaXMuZGF0YS51YXJ0c1tkLnRhcEluZGV4XVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+aTjeS9nOWksei0pScsXG4gICAgICAgICAgY29udGVudDogZGF0YS5tc2dcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgfSxcblxuICBhc3luYyByZXNldER0dSgpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IFwi6YeN5ZCvRHR1XCIsXG4gICAgICBjb250ZW50OiBcIuehruWumueOsOWcqOmHjeWQr0R0deWQlz9cIixcbiAgICAgIHN1Y2Nlc3M6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgdWFydCA9IGArKytBVCtaYFxuICAgICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5q2j5Zyo5L+u5pS5JyB9KVxuICAgICAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5zZW5kQVRJbnN0cnVjdCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCB1YXJ0KVxuICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIGlmIChjb2RlKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAnc3VjY2VzcycsXG4gICAgICAgICAgICBjb250ZW50OiBkYXRhLm1zZ1xuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvKipcbiAgICog57uR5a6a6K6+5aSHaWRcbiAgICovXG4gIGFzeW5jIGJpbmREZXZJZCgpIHtcbiAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgd3guc2NhbkNvZGUoe30pXG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgY29uc3QgdCA9IGF3YWl0IGFwaS5nZXRUZXJtaW5hbChzY2FuUmVzdWx0LnJlc3VsdClcbiAgICBpZiAodC5kYXRhKSB7XG4gICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ2Vycm9yJyxcbiAgICAgICAgY29udGVudDogYCR7c2NhblJlc3VsdC5yZXN1bHR95bey6KKrZHR1OiR7dC5kYXRhLkRldk1hY30g57uR5a6aYFxuICAgICAgfSlcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IGFwaS5nZXRSZWdpc3RlckRldihzY2FuUmVzdWx0LnJlc3VsdClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGNvbnN0IHsgY29uZmlybSB9ID0gYXdhaXQgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICfnoa7orqTnu5Hlrprkv6Hmga8nLFxuICAgICAgICBjb250ZW50OiBg57G75Z6LOiR7ZGF0YS5UeXBlfVxcbiDorr7lpIc6JHtkYXRhLm1vdW50RGV2fVxcbiDljY/orq46JHtkYXRhLnByb3RvY29sfVxcbiDlnLDlnYA6JHtkYXRhLnBpZH1gXG4gICAgICB9KVxuICAgICAgaWYgKGNvbmZpcm0pIHtcbiAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ato+WcqOe7keWumuiuvuWkhycgfSlcbiAgICAgICAgY29uc3QgciA9IGF3YWl0IGFwaS5hZGRUZXJtaW5hbE1vdW50RGV2KHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIHsgbW91bnREZXY6IGRhdGEubW91bnREZXYsIFR5cGU6IGRhdGEuVHlwZSwgcHJvdG9jb2w6IGRhdGEucHJvdG9jb2wsIHBpZDogZGF0YS5waWQsIGJpbmREZXY6IHNjYW5SZXN1bHQucmVzdWx0IH0pXG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgaWYgKHIuY29kZSkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+iuvuWkh+e7keWumuaIkOWKnydcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICfmtYHnqIvlh7rplJknLFxuICAgICAgICBjb250ZW50OiBgJHtzY2FuUmVzdWx0LnJlc3VsdH3mnKrms6jlhows6K+35YWI5rOo5YaM5ZCO57uR5a6aYFxuICAgICAgfSlcbiAgICB9XG5cbiAgfSxcblxuICAvLyDmn6XnnIvorr7lpIfmlbDmja5cbiAgc2VlKGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UZXJtaW5hbE1vdW50RGV2cz4pIHtcbiAgICBjb25zdCB7IHBpZCwgbW91bnREZXYsIHByb3RvY29sLCBUeXBlIH0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2FkbWluL2RldnMvZGV2cycgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgcGlkOiBTdHJpbmcocGlkKSwgbW91bnREZXYsIHByb3RvY29sLCBEZXZNYWM6IHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIFR5cGUgfSlcbiAgICB9KVxuICB9LFxuXG4gIC8vIOWIoOmZpOe7keWumuiuvuWkh1xuICBhc3luYyBybUJpbmQoZTogdmFudEV2ZW50PFVhcnQucmVnaXN0ZXJEZXY+KSB7XG4gICAgY29uc3QgaXRlbSA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ+WIoOmZpOe7keWumuiuvuWkhycsXG4gICAgICBjb250ZW50OiBg56Gu5a6a5Yig6ZmkICR7aXRlbS5tb3VudERldn0gPz8/YFxuICAgIH0pXG4gICAgaWYgKGNvbmZpcm0pIHtcbiAgICAgIGFwaS5kZWxUZXJtaW5hbE1vdW50RGV2KHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIGl0ZW0ucGlkKS50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgICAgIH0pXG4gICAgfVxuXG5cbiAgfSxcbiAgLy/ov5znqIvosIPor5Xorr7lpIdcbiAgYXN5bmMgaW90UmVtb3RlVXJsKCkge1xuICAgIGNvbnN0IHsgY29kZSwgZGF0YSB9ID0gYXdhaXQgYXBpLmlvdFJlbW90ZVVybCh0aGlzLmRhdGEubWFjKVxuICAgIGlmICghY29kZSkge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICfojrflj5blpLHotKUnLFxuICAgICAgICBjb250ZW50OiAn6K6+5aSH5pyq57uR5a6a5YiwSU9U6LSm5Y+3J1xuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCEvcmVtb3RlX2NvZGU9JC8udGVzdChkYXRhKSkge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAn6LCD6K+V5Zyw5Z2AJyxcbiAgICAgICAgICBjb250ZW50OiBkYXRhLFxuICAgICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgICB3eC5zZXRDbGlwYm9hcmREYXRhKHtcbiAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgdGl0bGU6ICflt7LlpI3liLbnvZHlnYDliLDliarliIfmnb8nXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAn6I635Y+W5aSx6LSlJyxcbiAgICAgICAgICBjb250ZW50OiAn6K6+5aSH5pyq6L+e5o6l5YiwaW90IHNlcnZlcuS4reW/gydcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cblxuXG4gIC8qKlxuICAgKiDnlJ/miJDmoIfnrb5cbiAgICovXG4gIGFzeW5jIGdlbmVyYXRlTGFiZWwoKSB7XG4gICAgY29uc3QgbWFjID0gdGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hY1xuICAgIGNvbnN0IHBpY19yZWFkbWVxciA9IGF3YWl0IHRoaXMuZG93bVBpYyhcImh0dHBzOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC85XzE4XzIwMjFfcXJjb2RlX3d3dy55dXF1ZS5jb20ucG5nXCIpXG4gICAgY29uc3QgcGljX3dwcXIgPSBhd2FpdCB0aGlzLmRvd21QaWMoXCJodHRwczovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzMxMjAyMV9fTEFEU19VYXJ0LjVkZjJjYzYucG5nXCIpXG4gICAgY29uc3QgcGljX21hYyA9IGF3YWl0IHRoaXMuZ2VuZXJhdGVGaWxlKG1hYylcblxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IG5ldyBQcm9taXNlPGFueT4ocmVzb2x2ZSA9PiB7XG4gICAgICB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICAgICAgLnNlbGVjdChcIiNjYW52YXMxXCIpXG4gICAgICAgIC5maWVsZHMoeyBub2RlOiB0cnVlLCBzaXplOiB0cnVlIH0pXG4gICAgICAgIC5leGVjKHJlcyA9PiByZXNvbHZlKHJlcykpXG4gICAgfSlcbiAgICBjb25zdCBjYW52YXMgPSByZXNbMF0ubm9kZSBhcyBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXNcbiAgICBjYW52YXMuaGVpZ2h0ID0gMTUwXG4gICAgY2FudmFzLndpZHRoID0gNDAwXG4gICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKSBhcyBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXNDb250ZXh0XG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiI0ZGRkZGRlwiO1xuICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzNTAsIDIwMCk7XG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiIzAwMDAwMFwiO1xuICAgIGN0eC5kcmF3SW1hZ2UoYXdhaXQgdGhpcy5nZW5lcmF0ZUNhbnZhc0ltZyhjYW52YXMsIHBpY19yZWFkbWVxciksIDEwLCAyMCwgMTEwLCA5NSlcbiAgICBjdHguZmlsbFRleHQoJ+aTjeS9nOivtOaYjicsIDUwLCAxMzApXG4gICAgY3R4LmRyYXdJbWFnZShhd2FpdCB0aGlzLmdlbmVyYXRlQ2FudmFzSW1nKGNhbnZhcywgcGljX3dwcXIpLCAxMjAsIDIwLCAxMTAsIDk1KVxuICAgIGN0eC5maWxsVGV4dCgn5bCP56iL5bqPJywgMTY1LCAxMzApXG4gICAgY3R4LmRyYXdJbWFnZShhd2FpdCB0aGlzLmdlbmVyYXRlQ2FudmFzSW1nKGNhbnZhcywgcGljX21hYyksIDIzMCwgMjAsIDExMCwgOTUpXG4gICAgY3R4LmZpbGxUZXh0KCdtYWM6JyArIG1hYywgMjQwLCAxMzApXG4gIH0sXG5cbiAgLyoqXG4gICAqIOS4i+i9veagh+etvlxuICAgKi9cbiAgYXN5bmMgZG93bkxhYmVsKCkge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IG5ldyBQcm9taXNlPGFueT4ocmVzb2x2ZSA9PiB7XG4gICAgICB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICAgICAgLnNlbGVjdChcIiNjYW52YXMxXCIpXG4gICAgICAgIC5maWVsZHMoeyBub2RlOiB0cnVlLCBzaXplOiB0cnVlIH0pXG4gICAgICAgIC5leGVjKHJlcyA9PiByZXNvbHZlKHJlcykpXG4gICAgfSlcbiAgICBjb25zdCBjYW52YXMgPSByZXNbMF0ubm9kZSBhcyBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXNcbiAgICB3eC5jYW52YXNUb1RlbXBGaWxlUGF0aCh7XG4gICAgICBjYW52YXNJZDogXCJjYW52YXMxXCIsXG4gICAgICBxdWFsaXR5OiAxLFxuICAgICAgY2FudmFzLFxuICAgICAgZmlsZVR5cGU6IFwianBnXCIsXG4gICAgICBkZXN0SGVpZ2h0OiAzMDAsXG4gICAgICBkZXN0V2lkdGg6IDcwMCxcbiAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgIHd4LnNhdmVJbWFnZVRvUGhvdG9zQWxidW0oe1xuICAgICAgICAgIGZpbGVQYXRoOiByZXMudGVtcEZpbGVQYXRoLFxuICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgICBpZiAocmVzLmVyck1zZyA9IFwic2F2ZUltYWdlVG9QaG90b3NBbGJ1bTpva1wiKSB7XG4gICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgICAgdGl0bGU6IFwi5bey5L+d5a2Y5Yiw54Wn54mH5bqTXCIsXG4gICAgICAgICAgICAgICAgaWNvbjogXCJzdWNjZXNzXCJcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBhc3luYyBnZW5lcmF0ZUZpbGUoY29kZTogc3RyaW5nKSB7XG4gICAgY29uc3QgYmFzZSA9IGF3YWl0IGFwaS5xcihjb2RlKVxuICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7d3guZW52LlVTRVJfREFUQV9QQVRIfS8ke2NvZGV9LnBuZ2BcbiAgICBjb25zdCBtID0gd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKVxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT4ge1xuICAgICAgbS53cml0ZUZpbGUoe1xuICAgICAgICBmaWxlUGF0aCxcbiAgICAgICAgZGF0YTogYmFzZS5kYXRhLnJlcGxhY2UoL1tcXHJcXG5dL2csICcnKS5zbGljZSgyMiksXG4gICAgICAgIGVuY29kaW5nOiBcImJhc2U2NFwiLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHJlc29sdmUoZmlsZVBhdGgpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfSxcblxuICAvKipcbiAgICogXG4gICAqIEBwYXJhbSBjYW52YXMgXG4gICAqIEBwYXJhbSBwYXRoIFxuICAgKi9cbiAgZ2VuZXJhdGVDYW52YXNJbWcoY2FudmFzOiBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXMsIHBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT4ge1xuICAgICAgY29uc3QgaW1nID0gY2FudmFzLmNyZWF0ZUltYWdlKClcbiAgICAgIGltZy5vbmxvYWQgPSAoKSA9PiByZXNvbHZlKGltZyBhcyBhbnkpXG4gICAgICBpbWcub25lcnJvciA9IChlKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKHsgZSB9KTtcblxuICAgICAgfVxuICAgICAgaW1nLnNyYyA9IHBhdGhcbiAgICB9KVxuICB9LFxuXG4gIC8qKlxuICAgKiDkuIvovb3mlofku7ZcbiAgICovXG4gIGRvd21QaWModXJsOiBzdHJpbmcpIHtcbiAgICBjb25zdCBuQXJyID0gdXJsLnNwbGl0KFwiL1wiKVxuICAgIGNvbnN0IG5hbWUgPSBuQXJyW25BcnIubGVuZ3RoIC0gMV1cbiAgICBjb25zdCBmaWxlbmFtZSA9IGAke3d4LmVudi5VU0VSX0RBVEFfUEFUSH0vJHtuYW1lfWBcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPihyZXNvbHZlID0+IHtcbiAgICAgIC8vIOWIpOaWreaWh+S7tuaYr+WQpuWtmOWcqCzkuI3lrZjlnKjlsLHkuIvovb3mlofku7ZcbiAgICAgIGNvbnN0IG0gPSB3eC5nZXRGaWxlU3lzdGVtTWFuYWdlcigpXG4gICAgICBtLnN0YXQoe1xuICAgICAgICBwYXRoOiBmaWxlbmFtZSxcbiAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICByZXNvbHZlKGZpbGVuYW1lKVxuICAgICAgICB9LFxuICAgICAgICBmYWlsKGUpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhlLmVyck1zZyk7XG4gICAgICAgICAgd3guZG93bmxvYWRGaWxlKHtcbiAgICAgICAgICAgIHVybCxcbiAgICAgICAgICAgIGZpbGVQYXRoOiBmaWxlbmFtZSxcbiAgICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgICAgIHJlc29sdmUocmVzLmZpbGVQYXRoKVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfSxcblxuXG59KSJdfQ==