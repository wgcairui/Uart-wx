"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '262045427977',
        terminal: {
            name: '',
            mountNode: '',
            mountDevs: [],
            uptime: ''
        },
        remoteUrl: '',
        uarts: ['2400,8,1,NONE,NFC', '4800,8,1,NONE,HD', '9600,8,1,NONE,HD', '19200,8,1,NONE,HD', '115200,8,1,NONE,HD']
    },
    async scanMac() {
        const scanResult = await wx.scanCode({});
        this.setData({
            mac: scanResult.result
        });
        this.scanRequst();
    },
    async scanRequst() {
        wx.showLoading({ title: '查询中' });
        const { code, data } = await api_1.default.getRootTerminal(this.data.mac);
        wx.hideLoading();
        if (code && data) {
            this.setData({
                terminal: data
            });
        }
        else {
            wx.showModal({
                title: 'search',
                content: '此设备没有注册，请核对设备是否在我司渠道购买'
            });
        }
    },
    async initTerminal() {
        const { confirm } = await wx.showModal({
            title: '初始化' + this.data.terminal.name,
            content: '初始化操作不可逆,会清除dtu绑定的设备信息,告警信息,且只能清除未被绑定的dtu!!!'
        });
        if (confirm) {
            wx.showLoading({ title: 'loading' });
            const { code, data, msg } = await api_1.default.initTerminal(this.data.terminal.DevMac);
            if (code) {
                wx.showModal({
                    title: 'success',
                    content: `耗时${data}ms`
                });
                this.scanRequst();
            }
            else {
                wx.showModal({
                    title: 'error',
                    content: msg
                });
            }
        }
    },
    async modifyUart() {
        const d = await wx.showActionSheet({
            itemList: this.data.uarts
        });
        if (this.data.terminal.DevMac && d.errMsg === 'showActionSheet:ok') {
            const uart = `+++AT+UART=1,` + this.data.uarts[d.tapIndex];
            wx.showLoading({ title: '正在修改' });
            const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
            wx.hideLoading();
            if (code && data.ok) {
                wx.showToast({
                    title: 'success',
                    content: data.msg
                });
                this.setData({
                    "terminal.uart": this.data.uarts[d.tapIndex]
                });
            }
            else {
                wx.showModal({
                    title: '操作失败',
                    content: data.msg
                });
            }
        }
    },
    async resetDtu() {
        wx.showModal({
            title: "重启Dtu",
            content: "确定现在重启Dtu吗?",
            success: async () => {
                const uart = `+++AT+Z`;
                wx.showLoading({ title: '正在修改' });
                const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
                wx.hideLoading();
                if (code) {
                    wx.showToast({
                        title: 'success',
                        content: data.msg
                    });
                }
            }
        });
    },
    async bindDevId() {
        const scanResult = await wx.scanCode({});
        wx.showLoading({ title: 'loading' });
        const t = await api_1.default.getTerminal(scanResult.result);
        if (t.data) {
            wx.hideLoading();
            wx.showModal({
                title: 'error',
                content: `${scanResult.result}已被dtu:${t.data.DevMac} 绑定`
            });
            return;
        }
        const { data } = await api_1.default.getRegisterDev(scanResult.result);
        wx.hideLoading();
        if (data) {
            const { confirm } = await wx.showModal({
                title: '确认绑定信息',
                content: `类型:${data.Type}\n 设备:${data.mountDev}\n 协议:${data.protocol}\n 地址:${data.pid}`
            });
            if (confirm) {
                wx.showLoading({ title: '正在绑定设备' });
                const r = await api_1.default.addTerminalMountDev(this.data.terminal.DevMac, { mountDev: data.mountDev, Type: data.Type, protocol: data.protocol, pid: data.pid, bindDev: scanResult.result });
                wx.hideLoading();
                if (r.code) {
                    wx.showToast({
                        title: '设备绑定成功'
                    });
                    this.scanRequst();
                }
            }
        }
        else {
            wx.showModal({
                title: '流程出错',
                content: `${scanResult.result}未注册,请先注册后绑定`
            });
        }
    },
    see(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/admin/devs/devs' + util_1.ObjectToStrquery({ pid: String(pid), mountDev, protocol, DevMac: this.data.terminal.DevMac, Type })
        });
    },
    async rmBind(e) {
        const item = e.currentTarget.dataset.item;
        const { confirm } = await wx.showModal({
            title: '删除绑定设备',
            content: `确定删除 ${item.mountDev} ???`
        });
        if (confirm) {
            api_1.default.delTerminalMountDev(this.data.terminal.DevMac, item.pid).then(() => {
                this.scanRequst();
            });
        }
    },
    async iotRemoteUrl() {
        const { code, data } = await api_1.default.iotRemoteUrl(this.data.mac);
        if (!code) {
            wx.showModal({
                title: '获取失败',
                content: '设备未绑定到IOT账号'
            });
        }
        else {
            if (!/remote_code=$/.test(data)) {
                wx.showModal({
                    title: '调试地址',
                    content: data,
                    success() {
                        wx.setClipboardData({
                            data,
                            success() {
                                wx.showToast({
                                    title: '已复制网址到剪切板'
                                });
                            }
                        });
                    }
                });
            }
            else {
                wx.showModal({
                    title: '获取失败',
                    content: '设备未连接到iot server中心'
                });
            }
        }
    },
    async generateLabel() {
        const mac = this.data.terminal.DevMac;
        const pic_readmeqr = await this.dowmPic("https://www.ladishb.com/upload/9_18_2021_qrcode_www.yuque.com.png");
        const pic_wpqr = await this.dowmPic("https://www.ladishb.com/upload/3312021__LADS_Uart.5df2cc6.png");
        wx.createSelectorQuery()
            .select("#canvas1")
            .fields({ node: true, size: true })
            .exec(res => {
            const canvas = res[0].node;
            canvas.height = 200;
            canvas.width = 350;
            const ctx = canvas.getContext("2d");
            console.log(ctx);
            this.generateCanvasImg(canvas, pic_readmeqr).then(img => {
                ctx.drawImage(img, 20, 20, 100, 85);
            });
            this.generateCanvasImg(canvas, pic_wpqr).then(img => {
                ctx.drawImage(img, 120, 20, 100, 85);
            });
        });
    },
    generateCanvasImg(canvas, path) {
        return new Promise(resolve => {
            const img = canvas.createImage();
            img.onload = () => resolve(img);
            img.src = path;
        });
    },
    dowmPic(url) {
        const nArr = url.split("/");
        const name = nArr[nArr.length - 1];
        const filename = `${wx.env.USER_DATA_PATH}/${name}`;
        return new Promise(resolve => {
            const m = wx.getFileSystemManager();
            m.stat({
                path: filename,
                success() {
                    resolve(filename);
                },
                fail(e) {
                    console.log(e.errMsg);
                    wx.downloadFile({
                        url,
                        filePath: filename,
                        success(res) {
                            resolve(res.filePath);
                        }
                    });
                }
            });
        });
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBc0Q7QUFDdEQsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxjQUFjO1FBQ25CLFFBQVEsRUFBRTtZQUNSLElBQUksRUFBRSxFQUFFO1lBQ1IsU0FBUyxFQUFFLEVBQUU7WUFDYixTQUFTLEVBQUUsRUFBOEI7WUFDekMsTUFBTSxFQUFFLEVBQUU7U0FDTTtRQUNsQixTQUFTLEVBQUUsRUFBRTtRQUNiLEtBQUssRUFBRSxDQUFDLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLGtCQUFrQixFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixDQUFDO0tBQ2hIO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLEdBQUcsRUFBRSxVQUFVLENBQUMsTUFBTTtTQUN2QixDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVO1FBQ2QsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1FBQ2hDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDL0QsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ2hCLElBQUksSUFBSSxJQUFJLElBQUksRUFBRTtZQUNoQixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLFFBQVEsRUFBRSxJQUFJO2FBQ2YsQ0FBQyxDQUFBO1NBQ0g7YUFBTTtZQUNMLEVBQUUsQ0FB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QUNsQyxNQUFNLFFBQVEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBYyxJQUFJLElBQUksRUFBRSxDQUFBO1FBQ25ELE9BQU8sSUFBSSxPQUFPLENBQVMsT0FBTyxDQUFDLEVBQUU7WUFFbkMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLG9CQUFvQixFQUFFLENBQUE7WUFDbkMsQ0FBQyxDQUFDLElBQUksQ0FBQztnQkFDTCxJQUFJLEVBQUUsUUFBUTtnQkFDZCxPQUFPO29CQUNMLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQTtnQkFDbkIsQ0FBQztnQkFDRCxJQUFJLENBQUMsQ0FBQztvQkFDSixPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztvQkFDdEIsRUFBRSxDQUFDLFlBQVksQ0FBQzt3QkFDZCxHQUFHO3dCQUNILFFBQVEsRUFBRSxRQUFRO3dCQUNsQixPQUFPLENBQUMsR0FBRzs0QkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFBO3dCQUN2QixDQUFDO3FCQUNGLENBQUMsQ0FBQTtnQkFDSixDQUFDO2FBQ0YsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0NBR0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JqZWN0VG9TdHJxdWVyeSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy91dGlsXCJcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIG1hYzogJzI2MjA0NTQyNzk3NycsXG4gICAgdGVybWluYWw6IHtcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgbW91bnROb2RlOiAnJyxcbiAgICAgIG1vdW50RGV2czogW10gYXMgVWFydC5UZXJtaW5hbE1vdW50RGV2c1tdLFxuICAgICAgdXB0aW1lOiAnJ1xuICAgIH0gYXMgVWFydC5UZXJtaW5hbCxcbiAgICByZW1vdGVVcmw6ICcnLFxuICAgIHVhcnRzOiBbJzI0MDAsOCwxLE5PTkUsTkZDJywgJzQ4MDAsOCwxLE5PTkUsSEQnLCAnOTYwMCw4LDEsTk9ORSxIRCcsICcxOTIwMCw4LDEsTk9ORSxIRCcsICcxMTUyMDAsOCwxLE5PTkUsSEQnXVxuICB9LFxuICAvLyDosIPnlKjlvq7kv6FhcGnvvIzmiavmj49EVFXmnaHlvaLnoIFcbiAgYXN5bmMgc2Nhbk1hYygpIHtcbiAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgd3guc2NhbkNvZGUoe30pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIG1hYzogc2NhblJlc3VsdC5yZXN1bHRcbiAgICB9KVxuICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gIH0sXG4gIC8vIOafpeivokRUVeiuvuWkh+S/oeaBr1xuICBhc3luYyBzY2FuUmVxdXN0KCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmn6Xor6LkuK0nIH0pXG4gICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuZ2V0Um9vdFRlcm1pbmFsKHRoaXMuZGF0YS5tYWMpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmIChjb2RlICYmIGRhdGEpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHRlcm1pbmFsOiBkYXRhXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ3NlYXJjaCcsXG4gICAgICAgIGNvbnRlbnQ6ICfmraTorr7lpIfmsqHmnInms6jlhozvvIzor7fmoLjlr7norr7lpIfmmK/lkKblnKjmiJHlj7jmuKDpgZPotK3kubAnXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICBhc3luYyBpbml0VGVybWluYWwoKSB7XG4gICAgY29uc3QgeyBjb25maXJtIH0gPSBhd2FpdCB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6ICfliJ3lp4vljJYnICsgdGhpcy5kYXRhLnRlcm1pbmFsLm5hbWUsXG4gICAgICBjb250ZW50OiAn5Yid5aeL5YyW5pON5L2c5LiN5Y+v6YCGLOS8mua4hemZpGR0dee7keWumueahOiuvuWkh+S/oeaBryzlkYrorabkv6Hmga8s5LiU5Y+q6IO95riF6Zmk5pyq6KKr57uR5a6a55qEZHR1ISEhJ1xuICAgIH0pXG4gICAgaWYgKGNvbmZpcm0pIHtcbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICdsb2FkaW5nJyB9KVxuICAgICAgY29uc3QgeyBjb2RlLCBkYXRhLCBtc2cgfSA9IGF3YWl0IGFwaS5pbml0VGVybWluYWwodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYylcbiAgICAgIGlmIChjb2RlKSB7XG4gICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgdGl0bGU6ICdzdWNjZXNzJyxcbiAgICAgICAgICBjb250ZW50OiBg6ICX5pe2JHtkYXRhfW1zYFxuICAgICAgICB9KVxuICAgICAgICB0aGlzLnNjYW5SZXF1c3QoKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ2Vycm9yJyxcbiAgICAgICAgICBjb250ZW50OiBtc2dcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIOS/ruaUueazoueJueeOh1xuICAgKi9cbiAgYXN5bmMgbW9kaWZ5VWFydCgpIHtcbiAgICBjb25zdCBkID0gYXdhaXQgd3guc2hvd0FjdGlvblNoZWV0KHtcbiAgICAgIGl0ZW1MaXN0OiB0aGlzLmRhdGEudWFydHNcbiAgICB9KVxuICAgIGlmICh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjICYmIGQuZXJyTXNnID09PSAnc2hvd0FjdGlvblNoZWV0Om9rJykge1xuICAgICAgY29uc3QgdWFydCA9IGArKytBVCtVQVJUPTEsYCArIHRoaXMuZGF0YS51YXJ0c1tkLnRhcEluZGV4XVxuICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ato+WcqOS/ruaUuScgfSlcbiAgICAgIGNvbnN0IHsgY29kZSwgZGF0YSB9ID0gYXdhaXQgYXBpLnNlbmRBVEluc3RydWN0KHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIHVhcnQpXG4gICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICBpZiAoY29kZSAmJiBkYXRhLm9rKSB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6ICdzdWNjZXNzJyxcbiAgICAgICAgICBjb250ZW50OiBkYXRhLm1zZ1xuICAgICAgICB9KVxuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIFwidGVybWluYWwudWFydFwiOiB0aGlzLmRhdGEudWFydHNbZC50YXBJbmRleF1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgdGl0bGU6ICfmk43kvZzlpLHotKUnLFxuICAgICAgICAgIGNvbnRlbnQ6IGRhdGEubXNnXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuXG4gIH0sXG5cbiAgYXN5bmMgcmVzZXREdHUoKSB7XG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiBcIumHjeWQr0R0dVwiLFxuICAgICAgY29udGVudDogXCLnoa7lrprnjrDlnKjph43lkK9EdHXlkJc/XCIsXG4gICAgICBzdWNjZXNzOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHVhcnQgPSBgKysrQVQrWmBcbiAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ato+WcqOS/ruaUuScgfSlcbiAgICAgICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuc2VuZEFUSW5zdHJ1Y3QodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgdWFydClcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICBpZiAoY29kZSkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgICAgY29udGVudDogZGF0YS5tc2dcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLyoqXG4gICAqIOe7keWumuiuvuWkh2lkXG4gICAqL1xuICBhc3luYyBiaW5kRGV2SWQoKSB7XG4gICAgY29uc3Qgc2NhblJlc3VsdCA9IGF3YWl0IHd4LnNjYW5Db2RlKHt9KVxuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICdsb2FkaW5nJyB9KVxuICAgIGNvbnN0IHQgPSBhd2FpdCBhcGkuZ2V0VGVybWluYWwoc2NhblJlc3VsdC5yZXN1bHQpXG4gICAgaWYgKHQuZGF0YSkge1xuICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICdlcnJvcicsXG4gICAgICAgIGNvbnRlbnQ6IGAke3NjYW5SZXN1bHQucmVzdWx0feW3suiiq2R0dToke3QuZGF0YS5EZXZNYWN9IOe7keWummBcbiAgICAgIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBhcGkuZ2V0UmVnaXN0ZXJEZXYoc2NhblJlc3VsdC5yZXN1bHQpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmIChkYXRhKSB7XG4gICAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn56Gu6K6k57uR5a6a5L+h5oGvJyxcbiAgICAgICAgY29udGVudDogYOexu+Weizoke2RhdGEuVHlwZX1cXG4g6K6+5aSHOiR7ZGF0YS5tb3VudERldn1cXG4g5Y2P6K6uOiR7ZGF0YS5wcm90b2NvbH1cXG4g5Zyw5Z2AOiR7ZGF0YS5waWR9YFxuICAgICAgfSlcbiAgICAgIGlmIChjb25maXJtKSB7XG4gICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmraPlnKjnu5Hlrprorr7lpIcnIH0pXG4gICAgICAgIGNvbnN0IHIgPSBhd2FpdCBhcGkuYWRkVGVybWluYWxNb3VudERldih0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCB7IG1vdW50RGV2OiBkYXRhLm1vdW50RGV2LCBUeXBlOiBkYXRhLlR5cGUsIHByb3RvY29sOiBkYXRhLnByb3RvY29sLCBwaWQ6IGRhdGEucGlkLCBiaW5kRGV2OiBzY2FuUmVzdWx0LnJlc3VsdCB9KVxuICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIGlmIChyLmNvZGUpIHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6ICforr7lpIfnu5HlrprmiJDlip8nXG4gICAgICAgICAgfSlcbiAgICAgICAgICB0aGlzLnNjYW5SZXF1c3QoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn5rWB56iL5Ye66ZSZJyxcbiAgICAgICAgY29udGVudDogYCR7c2NhblJlc3VsdC5yZXN1bHR95pyq5rOo5YaMLOivt+WFiOazqOWGjOWQjue7keWummBcbiAgICAgIH0pXG4gICAgfVxuXG4gIH0sXG5cbiAgLy8g5p+l55yL6K6+5aSH5pWw5o2uXG4gIHNlZShldmVudDogdmFudEV2ZW50PFVhcnQuVGVybWluYWxNb3VudERldnM+KSB7XG4gICAgY29uc3QgeyBwaWQsIG1vdW50RGV2LCBwcm90b2NvbCwgVHlwZSB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9hZG1pbi9kZXZzL2RldnMnICsgT2JqZWN0VG9TdHJxdWVyeSh7IHBpZDogU3RyaW5nKHBpZCksIG1vdW50RGV2LCBwcm90b2NvbCwgRGV2TWFjOiB0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCBUeXBlIH0pXG4gICAgfSlcbiAgfSxcblxuICAvLyDliKDpmaTnu5Hlrprorr7lpIdcbiAgYXN5bmMgcm1CaW5kKGU6IHZhbnRFdmVudDxVYXJ0LnJlZ2lzdGVyRGV2Pikge1xuICAgIGNvbnN0IGl0ZW0gPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3QgeyBjb25maXJtIH0gPSBhd2FpdCB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6ICfliKDpmaTnu5Hlrprorr7lpIcnLFxuICAgICAgY29udGVudDogYOehruWumuWIoOmZpCAke2l0ZW0ubW91bnREZXZ9ID8/P2BcbiAgICB9KVxuICAgIGlmIChjb25maXJtKSB7XG4gICAgICBhcGkuZGVsVGVybWluYWxNb3VudERldih0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCBpdGVtLnBpZCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICB9KVxuICAgIH1cblxuXG4gIH0sXG4gIC8v6L+c56iL6LCD6K+V6K6+5aSHXG4gIGFzeW5jIGlvdFJlbW90ZVVybCgpIHtcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5pb3RSZW1vdGVVcmwodGhpcy5kYXRhLm1hYylcbiAgICBpZiAoIWNvZGUpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn6I635Y+W5aSx6LSlJyxcbiAgICAgICAgY29udGVudDogJ+iuvuWkh+acque7keWumuWIsElPVOi0puWPtydcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghL3JlbW90ZV9jb2RlPSQvLnRlc3QoZGF0YSkpIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+iwg+ivleWcsOWdgCcsXG4gICAgICAgICAgY29udGVudDogZGF0YSxcbiAgICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgICAgd3guc2V0Q2xpcGJvYXJkRGF0YSh7XG4gICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICAgIHRpdGxlOiAn5bey5aSN5Yi2572R5Z2A5Yiw5Ymq5YiH5p2/J1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+iOt+WPluWksei0pScsXG4gICAgICAgICAgY29udGVudDogJ+iuvuWkh+acqui/nuaOpeWIsGlvdCBzZXJ2ZXLkuK3lv4MnXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG5cblxuICAvKipcbiAgICog55Sf5oiQ5qCH562+XG4gICAqL1xuICBhc3luYyBnZW5lcmF0ZUxhYmVsKCkge1xuICAgIGNvbnN0IG1hYyA9IHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWNcbiAgICBjb25zdCBwaWNfcmVhZG1lcXIgPSBhd2FpdCB0aGlzLmRvd21QaWMoXCJodHRwczovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvOV8xOF8yMDIxX3FyY29kZV93d3cueXVxdWUuY29tLnBuZ1wiKVxuICAgIGNvbnN0IHBpY193cHFyID0gYXdhaXQgdGhpcy5kb3dtUGljKFwiaHR0cHM6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzMzMTIwMjFfX0xBRFNfVWFydC41ZGYyY2M2LnBuZ1wiKVxuICAgIHd4LmNyZWF0ZVNlbGVjdG9yUXVlcnkoKVxuICAgICAgLnNlbGVjdChcIiNjYW52YXMxXCIpXG4gICAgICAuZmllbGRzKHsgbm9kZTogdHJ1ZSwgc2l6ZTogdHJ1ZSB9KVxuICAgICAgLmV4ZWMocmVzID0+IHtcbiAgICAgICAgY29uc3QgY2FudmFzID0gcmVzWzBdLm5vZGUgYXMgV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzXG4gICAgICAgIGNhbnZhcy5oZWlnaHQgPSAyMDBcbiAgICAgICAgY2FudmFzLndpZHRoID0gMzUwXG4gICAgICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIikgYXMgV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzQ29udGV4dFxuICAgICAgICBjb25zb2xlLmxvZyhjdHgpO1xuICAgICAgICB0aGlzLmdlbmVyYXRlQ2FudmFzSW1nKGNhbnZhcywgcGljX3JlYWRtZXFyKS50aGVuKGltZyA9PiB7XG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDIwLCAyMCwgMTAwLCA4NSlcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5nZW5lcmF0ZUNhbnZhc0ltZyhjYW52YXMsIHBpY193cHFyKS50aGVuKGltZyA9PiB7XG4gICAgICAgICAgY3R4LmRyYXdJbWFnZShpbWcsIDEyMCwgMjAsIDEwMCwgODUpXG4gICAgICAgIH0pXG4gICAgICB9KVxuXG4gICAgLyogY29uc29sZS5sb2coe1xuICAgICAgbWFjLFxuICAgICAgcGljX3JlYWRtZXFyLFxuICAgICAgcGljX3dwcXJcbiAgICB9KTsgKi9cblxuICB9LFxuXG4gIGdlbmVyYXRlQ2FudmFzSW1nKGNhbnZhczogV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzLCBwYXRoOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPihyZXNvbHZlID0+IHtcbiAgICAgIGNvbnN0IGltZyA9IGNhbnZhcy5jcmVhdGVJbWFnZSgpXG4gICAgICBpbWcub25sb2FkID0gKCkgPT4gcmVzb2x2ZShpbWcgYXMgYW55KVxuICAgICAgaW1nLnNyYyA9IHBhdGhcbiAgICB9KVxuICB9XG5cbiAgLyoqXG4gICAqIOS4i+i9veaWh+S7tlxuICAgKi9cbiAgZG93bVBpYyh1cmw6IHN0cmluZykge1xuICAgIGNvbnN0IG5BcnIgPSB1cmwuc3BsaXQoXCIvXCIpXG4gICAgY29uc3QgbmFtZSA9IG5BcnJbbkFyci5sZW5ndGggLSAxXVxuICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7d3guZW52LlVTRVJfREFUQV9QQVRIfS8ke25hbWV9YFxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT4ge1xuICAgICAgLy8g5Yik5pat5paH5Lu25piv5ZCm5a2Y5ZyoLOS4jeWtmOWcqOWwseS4i+i9veaWh+S7tlxuICAgICAgY29uc3QgbSA9IHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKClcbiAgICAgIG0uc3RhdCh7XG4gICAgICAgIHBhdGg6IGZpbGVuYW1lLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHJlc29sdmUoZmlsZW5hbWUpXG4gICAgICAgIH0sXG4gICAgICAgIGZhaWwoZSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGUuZXJyTXNnKTtcbiAgICAgICAgICB3eC5kb3dubG9hZEZpbGUoe1xuICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgZmlsZVBhdGg6IGZpbGVuYW1lLFxuICAgICAgICAgICAgc3VjY2VzcyhyZXMpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXMuZmlsZVBhdGgpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuXG5cbn0pIl19