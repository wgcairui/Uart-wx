"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        macs: [],
        terminal: {
            name: '',
            mountNode: '',
            mountDevs: [],
            uptime: '',
            signal: 0,
            remark: ''
        },
        remoteUrl: '',
        uarts: ['2400,8,1,NONE,NFC', '4800,8,1,NONE,HD', '9600,8,1,NONE,HD', '19200,8,1,NONE,HD', '115200,8,1,NONE,HD'],
        qrReady: false
    },
    onLoad() {
        wx.getStorage({
            key: "macHis",
            success: (res) => {
                console.log(res.data);
                this.setData({
                    macs: res.data
                });
            }
        });
    },
    async scanMac() {
        const scanResult = await wx.scanCode({});
        this.setData({
            mac: scanResult.result
        });
        this.scanRequst();
    },
    async scanRequst() {
        wx.showLoading({ title: '查询中' });
        const { code, data } = await api_1.default.getRootTerminal(this.data.mac);
        wx.hideLoading();
        if (code && data) {
            this.setData({
                mac: data.DevMac,
                terminal: data
            });
            this.addHis(data.DevMac);
            api_1.default.onMessage('MacUpdate' + data.DevMac, () => {
                console.log(`listen MacUpdate,mac:${data.DevMac}`);
                this.scanMac();
            });
        }
        else {
            wx.showModal({
                title: 'search',
                content: '此设备没有注册，请核对设备是否在我司渠道购买'
            });
        }
    },
    search(e) {
        this.setData({
            mac: e.target.id
        });
        this.scanRequst();
    },
    addHis(mac) {
        if (this.data.macs.length > 5) {
            this.data.macs.pop();
        }
        const macSet = new Set(this.data.macs);
        macSet.add(mac);
        this.setData({
            macs: [...macSet]
        });
        wx.setStorage({
            key: 'macHis',
            data: [...macSet]
        });
    },
    async initTerminal() {
        const { confirm } = await wx.showModal({
            title: '初始化' + this.data.terminal.name,
            content: '初始化操作不可逆,会清除dtu绑定的设备信息,告警信息,且只能清除未被绑定的dtu!!!'
        });
        if (confirm) {
            wx.showLoading({ title: 'loading' });
            const { code, data, msg } = await api_1.default.initTerminal(this.data.terminal.DevMac);
            if (code) {
                wx.showModal({
                    title: 'success',
                    content: `耗时${data}ms`
                });
                this.scanRequst();
            }
            else {
                wx.showModal({
                    title: 'error',
                    content: msg
                });
            }
        }
    },
    async modifyUart() {
        const d = await wx.showActionSheet({
            itemList: this.data.uarts
        });
        if (this.data.terminal.DevMac && d.errMsg === 'showActionSheet:ok') {
            const uart = `+++AT+UART=1,` + this.data.uarts[d.tapIndex];
            wx.showLoading({ title: '正在修改' });
            const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
            wx.hideLoading();
            if (code && data.ok) {
                wx.showToast({
                    title: 'success',
                    content: data.msg
                });
                this.setData({
                    "terminal.uart": this.data.uarts[d.tapIndex]
                });
            }
            else {
                wx.showModal({
                    title: '操作失败',
                    content: data.msg
                });
            }
        }
    },
    async resetDtu() {
        wx.showModal({
            title: "重启Dtu",
            content: "确定现在重启Dtu吗?",
            success: async () => {
                const uart = `+++AT+Z`;
                wx.showLoading({ title: '正在修改' });
                const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
                wx.hideLoading();
                if (code) {
                    wx.showToast({
                        title: 'success',
                        content: data.msg
                    });
                }
            }
        });
    },
    async bindDevId() {
        const scanResult = await wx.scanCode({});
        wx.showLoading({ title: 'loading' });
        const t = await api_1.default.getTerminal(scanResult.result);
        if (t.data) {
            wx.hideLoading();
            wx.showModal({
                title: 'error',
                content: `${scanResult.result}已被dtu:${t.data.DevMac} 绑定`
            });
            return;
        }
        const { data } = await api_1.default.getRegisterDev(scanResult.result);
        wx.hideLoading();
        if (data) {
            const { confirm } = await wx.showModal({
                title: '确认绑定信息',
                content: `类型:${data.Type}\n 设备:${data.mountDev}\n 协议:${data.protocol}\n 地址:${data.pid}`
            });
            if (confirm) {
                wx.showLoading({ title: '正在绑定设备' });
                const r = await api_1.default.addTerminalMountDev(this.data.terminal.DevMac, { mountDev: data.mountDev, Type: data.Type, protocol: data.protocol, pid: data.pid, bindDev: scanResult.result });
                wx.hideLoading();
                if (r.code) {
                    wx.showToast({
                        title: '设备绑定成功'
                    });
                    this.scanRequst();
                }
            }
        }
        else {
            wx.showModal({
                title: '流程出错',
                content: `${scanResult.result}未注册,请先注册后绑定`
            });
        }
    },
    see(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/admin/devs/devs' + (0, util_1.ObjectToStrquery)({ pid: String(pid), mountDev, protocol, DevMac: this.data.terminal.DevMac, Type })
        });
    },
    async rmBind(e) {
        const item = e.currentTarget.dataset.item;
        const { confirm } = await wx.showModal({
            title: '删除绑定设备',
            content: `确定删除 ${item.mountDev} ???`
        });
        if (confirm) {
            api_1.default.delTerminalMountDev(this.data.terminal.DevMac, item.pid).then(() => {
                this.scanRequst();
            });
        }
    },
    async iotRemoteUrl() {
        const { code, data } = await api_1.default.iotRemoteUrl(this.data.mac);
        if (!code) {
            wx.showModal({
                title: '获取失败',
                content: '设备未绑定到IOT账号'
            });
        }
        else {
            if (!/remote_code=$/.test(data)) {
                wx.showModal({
                    title: '调试地址',
                    content: data,
                    success() {
                        wx.setClipboardData({
                            data,
                            success() {
                                wx.showToast({
                                    title: '已复制网址到剪切板'
                                });
                            }
                        });
                    }
                });
            }
            else {
                wx.showModal({
                    title: '获取失败',
                    content: '设备未连接到iot server中心'
                });
            }
        }
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBc0Q7QUFDdEQsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsSUFBSSxFQUFFLEVBQWM7UUFDcEIsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsRUFBRTtZQUNiLFNBQVMsRUFBRSxFQUE4QjtZQUN6QyxNQUFNLEVBQUUsRUFBRTtZQUNWLE1BQU0sRUFBRSxDQUFDO1lBQ1QsTUFBTSxFQUFFLEVBQUU7U0FDTTtRQUNsQixTQUFTLEVBQUUsRUFBRTtRQUNiLEtBQUssRUFBRSxDQUFDLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLGtCQUFrQixFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixDQUFDO1FBQy9HLE9BQU8sRUFBRSxLQUFLO0tBQ2Y7SUFFRCxNQUFNO1FBQ0osRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNaLEdBQUcsRUFBRSxRQUFRO1lBQ2IsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2lCQUNmLENBQUMsQ0FBQTtZQUNKLENBQUM7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLEdBQUcsRUFBRSxVQUFVLENBQUMsTUFBTTtTQUN2QixDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7SUFDbkIsQ0FB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QUM7Q0FzSkYsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JqZWN0VG9TdHJxdWVyeSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy91dGlsXCJcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIG1hYzogJycsXG4gICAgbWFjczogW10gYXMgc3RyaW5nW10sXG4gICAgdGVybWluYWw6IHtcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgbW91bnROb2RlOiAnJyxcbiAgICAgIG1vdW50RGV2czogW10gYXMgVWFydC5UZXJtaW5hbE1vdW50RGV2c1tdLFxuICAgICAgdXB0aW1lOiAnJyxcbiAgICAgIHNpZ25hbDogMCxcbiAgICAgIHJlbWFyazogJydcbiAgICB9IGFzIFVhcnQuVGVybWluYWwsXG4gICAgcmVtb3RlVXJsOiAnJyxcbiAgICB1YXJ0czogWycyNDAwLDgsMSxOT05FLE5GQycsICc0ODAwLDgsMSxOT05FLEhEJywgJzk2MDAsOCwxLE5PTkUsSEQnLCAnMTkyMDAsOCwxLE5PTkUsSEQnLCAnMTE1MjAwLDgsMSxOT05FLEhEJ10sXG4gICAgcXJSZWFkeTogZmFsc2VcbiAgfSxcblxuICBvbkxvYWQoKSB7XG4gICAgd3guZ2V0U3RvcmFnZSh7XG4gICAgICBrZXk6IFwibWFjSGlzXCIsXG4gICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKHJlcy5kYXRhKTtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBtYWNzOiByZXMuZGF0YVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOiwg+eUqOW+ruS/oWFwae+8jOaJq+aPj0RUVeadoeW9oueggVxuICBhc3luYyBzY2FuTWFjKCkge1xuICAgIGNvbnN0IHNjYW5SZXN1bHQgPSBhd2FpdCB3eC5zY2FuQ29kZSh7fSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbWFjOiBzY2FuUmVzdWx0LnJlc3VsdFxuICAgIH0pXG4gICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgfSxcbiAgLy8g5p+l6K+iRFRV6K6+5aSH5L+h5oGvXG4gIGFzeW5jIHNjYW5SZXF1c3QoKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+afpeivouS4rScgfSlcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5nZXRSb290VGVybWluYWwodGhpcy5kYXRhLm1hYylcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKGNvZGUgJiYgZGF0YSkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgbWFjOiBkYXRhLkRldk1hYyxcbiAgICAgICAgdGVybWluYWw6IGRhdGFcbiAgICAgIH0pXG4gICAgICB0aGlzLmFkZEhpcyhkYXRhLkRldk1hYylcbiAgICAgIGFwaS5vbk1lc3NhZ2U8c3RyaW5nPignTWFjVXBkYXRlJytkYXRhLkRldk1hYywgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhgbGlzdGVuIE1hY1VwZGF0ZSxtYWM6JHtkYXRhLkRldk1hY31gKTtcbiAgICAgICAgdGhpcy5zY2FuTWFjKClcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAnc2VhcmNoJyxcbiAgICAgICAgY29udGVudDogJ+atpOiuvuWkh+ayoeacieazqOWGjO+8jOivt+aguOWvueiuvuWkh+aYr+WQpuWcqOaIkeWPuOa4oOmBk+i0reS5sCdcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiDngrnlh7vljoblj7LorrDlvZXmn6Xor6JcbiAgICogQHBhcmFtIGUgXG4gICAqL1xuICBzZWFyY2goZTp2YW50RXZlbnQpe1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBtYWM6ZS50YXJnZXQuaWRcbiAgICB9KVxuICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gIH0sXG5cbiAgLyoqXG4gICAqIOa3u+WKoOWOhuWPsuiusOW9lVxuICAgKiBAcGFyYW0gbWFjIFxuICAgKi9cbiAgYWRkSGlzKG1hYzogc3RyaW5nKSB7XG4gICAgaWYgKHRoaXMuZGF0YS5tYWNzLmxlbmd0aCA+IDUpIHtcbiAgICAgIHRoaXMuZGF0YS5tYWNzLnBvcCgpXG4gICAgfVxuICAgIGNvbnN0IG1hY1NldCA9IG5ldyBTZXQodGhpcy5kYXRhLm1hY3MpXG4gICAgbWFjU2V0LmFkZChtYWMpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIG1hY3M6IFsuLi5tYWNTZXRdXG4gICAgfSlcbiAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgIGtleTogJ21hY0hpcycsXG4gICAgICBkYXRhOiBbLi4ubWFjU2V0XVxuICAgIH0pXG4gIH0sXG5cbiAgYXN5bmMgaW5pdFRlcm1pbmFsKCkge1xuICAgIGNvbnN0IHsgY29uZmlybSB9ID0gYXdhaXQgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiAn5Yid5aeL5YyWJyArIHRoaXMuZGF0YS50ZXJtaW5hbC5uYW1lLFxuICAgICAgY29udGVudDogJ+WIneWni+WMluaTjeS9nOS4jeWPr+mAhizkvJrmuIXpmaRkdHXnu5HlrprnmoTorr7lpIfkv6Hmga8s5ZGK6K2m5L+h5oGvLOS4lOWPquiDvea4hemZpOacquiiq+e7keWumueahGR0dSEhISdcbiAgICB9KVxuICAgIGlmIChjb25maXJtKSB7XG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAnbG9hZGluZycgfSlcbiAgICAgIGNvbnN0IHsgY29kZSwgZGF0YSwgbXNnIH0gPSBhd2FpdCBhcGkuaW5pdFRlcm1pbmFsKHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMpXG4gICAgICBpZiAoY29kZSkge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAnc3VjY2VzcycsXG4gICAgICAgICAgY29udGVudDogYOiAl+aXtiR7ZGF0YX1tc2BcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgdGl0bGU6ICdlcnJvcicsXG4gICAgICAgICAgY29udGVudDogbXNnXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiDkv67mlLnms6LnibnnjodcbiAgICovXG4gIGFzeW5jIG1vZGlmeVVhcnQoKSB7XG4gICAgY29uc3QgZCA9IGF3YWl0IHd4LnNob3dBY3Rpb25TaGVldCh7XG4gICAgICBpdGVtTGlzdDogdGhpcy5kYXRhLnVhcnRzXG4gICAgfSlcbiAgICBpZiAodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYyAmJiBkLmVyck1zZyA9PT0gJ3Nob3dBY3Rpb25TaGVldDpvaycpIHtcbiAgICAgIGNvbnN0IHVhcnQgPSBgKysrQVQrVUFSVD0xLGAgKyB0aGlzLmRhdGEudWFydHNbZC50YXBJbmRleF1cbiAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmraPlnKjkv67mlLknIH0pXG4gICAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5zZW5kQVRJbnN0cnVjdCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCB1YXJ0KVxuICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgaWYgKGNvZGUgJiYgZGF0YS5vaykge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiAnc3VjY2VzcycsXG4gICAgICAgICAgY29udGVudDogZGF0YS5tc2dcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBcInRlcm1pbmFsLnVhcnRcIjogdGhpcy5kYXRhLnVhcnRzW2QudGFwSW5kZXhdXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAn5pON5L2c5aSx6LSlJyxcbiAgICAgICAgICBjb250ZW50OiBkYXRhLm1zZ1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cblxuICB9LFxuXG4gIGFzeW5jIHJlc2V0RHR1KCkge1xuICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogXCLph43lkK9EdHVcIixcbiAgICAgIGNvbnRlbnQ6IFwi56Gu5a6a546w5Zyo6YeN5ZCvRHR15ZCXP1wiLFxuICAgICAgc3VjY2VzczogYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCB1YXJ0ID0gYCsrK0FUK1pgXG4gICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmraPlnKjkv67mlLknIH0pXG4gICAgICAgIGNvbnN0IHsgY29kZSwgZGF0YSB9ID0gYXdhaXQgYXBpLnNlbmRBVEluc3RydWN0KHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIHVhcnQpXG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6ICdzdWNjZXNzJyxcbiAgICAgICAgICAgIGNvbnRlbnQ6IGRhdGEubXNnXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8qKlxuICAgKiDnu5Hlrprorr7lpIdpZFxuICAgKi9cbiAgYXN5bmMgYmluZERldklkKCkge1xuICAgIGNvbnN0IHNjYW5SZXN1bHQgPSBhd2FpdCB3eC5zY2FuQ29kZSh7fSlcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAnbG9hZGluZycgfSlcbiAgICBjb25zdCB0ID0gYXdhaXQgYXBpLmdldFRlcm1pbmFsKHNjYW5SZXN1bHQucmVzdWx0KVxuICAgIGlmICh0LmRhdGEpIHtcbiAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAnZXJyb3InLFxuICAgICAgICBjb250ZW50OiBgJHtzY2FuUmVzdWx0LnJlc3VsdH3lt7LooqtkdHU6JHt0LmRhdGEuRGV2TWFjfSDnu5HlrppgXG4gICAgICB9KVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgYXBpLmdldFJlZ2lzdGVyRGV2KHNjYW5SZXN1bHQucmVzdWx0KVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICBpZiAoZGF0YSkge1xuICAgICAgY29uc3QgeyBjb25maXJtIH0gPSBhd2FpdCB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ+ehruiupOe7keWumuS/oeaBrycsXG4gICAgICAgIGNvbnRlbnQ6IGDnsbvlnos6JHtkYXRhLlR5cGV9XFxuIOiuvuWkhzoke2RhdGEubW91bnREZXZ9XFxuIOWNj+iurjoke2RhdGEucHJvdG9jb2x9XFxuIOWcsOWdgDoke2RhdGEucGlkfWBcbiAgICAgIH0pXG4gICAgICBpZiAoY29uZmlybSkge1xuICAgICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5q2j5Zyo57uR5a6a6K6+5aSHJyB9KVxuICAgICAgICBjb25zdCByID0gYXdhaXQgYXBpLmFkZFRlcm1pbmFsTW91bnREZXYodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgeyBtb3VudERldjogZGF0YS5tb3VudERldiwgVHlwZTogZGF0YS5UeXBlLCBwcm90b2NvbDogZGF0YS5wcm90b2NvbCwgcGlkOiBkYXRhLnBpZCwgYmluZERldjogc2NhblJlc3VsdC5yZXN1bHQgfSlcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICBpZiAoci5jb2RlKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAn6K6+5aSH57uR5a6a5oiQ5YqfJ1xuICAgICAgICAgIH0pXG4gICAgICAgICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ+a1geeoi+WHuumUmScsXG4gICAgICAgIGNvbnRlbnQ6IGAke3NjYW5SZXN1bHQucmVzdWx0feacquazqOWGjCzor7flhYjms6jlhozlkI7nu5HlrppgXG4gICAgICB9KVxuICAgIH1cblxuICB9LFxuXG4gIC8vIOafpeeci+iuvuWkh+aVsOaNrlxuICBzZWUoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LlRlcm1pbmFsTW91bnREZXZzPikge1xuICAgIGNvbnN0IHsgcGlkLCBtb3VudERldiwgcHJvdG9jb2wsIFR5cGUgfSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvYWRtaW4vZGV2cy9kZXZzJyArIE9iamVjdFRvU3RycXVlcnkoeyBwaWQ6IFN0cmluZyhwaWQpLCBtb3VudERldiwgcHJvdG9jb2wsIERldk1hYzogdGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgVHlwZSB9KVxuICAgIH0pXG4gIH0sXG5cbiAgLy8g5Yig6Zmk57uR5a6a6K6+5aSHXG4gIGFzeW5jIHJtQmluZChlOiB2YW50RXZlbnQ8VWFydC5yZWdpc3RlckRldj4pIHtcbiAgICBjb25zdCBpdGVtID0gZS5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHsgY29uZmlybSB9ID0gYXdhaXQgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiAn5Yig6Zmk57uR5a6a6K6+5aSHJyxcbiAgICAgIGNvbnRlbnQ6IGDnoa7lrprliKDpmaQgJHtpdGVtLm1vdW50RGV2fSA/Pz9gXG4gICAgfSlcbiAgICBpZiAoY29uZmlybSkge1xuICAgICAgYXBpLmRlbFRlcm1pbmFsTW91bnREZXYodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgaXRlbS5waWQpLnRoZW4oKCkgPT4ge1xuICAgICAgICB0aGlzLnNjYW5SZXF1c3QoKVxuICAgICAgfSlcbiAgICB9XG5cblxuICB9LFxuICAvL+i/nOeoi+iwg+ivleiuvuWkh1xuICBhc3luYyBpb3RSZW1vdGVVcmwoKSB7XG4gICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuaW90UmVtb3RlVXJsKHRoaXMuZGF0YS5tYWMpXG4gICAgaWYgKCFjb2RlKSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ+iOt+WPluWksei0pScsXG4gICAgICAgIGNvbnRlbnQ6ICforr7lpIfmnKrnu5HlrprliLBJT1TotKblj7cnXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIS9yZW1vdGVfY29kZT0kLy50ZXN0KGRhdGEpKSB7XG4gICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgdGl0bGU6ICfosIPor5XlnLDlnYAnLFxuICAgICAgICAgIGNvbnRlbnQ6IGRhdGEsXG4gICAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICAgIHd4LnNldENsaXBib2FyZERhdGEoe1xuICAgICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgICAgICB0aXRsZTogJ+W3suWkjeWItue9keWdgOWIsOWJquWIh+advydcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgdGl0bGU6ICfojrflj5blpLHotKUnLFxuICAgICAgICAgIGNvbnRlbnQ6ICforr7lpIfmnKrov57mjqXliLBpb3Qgc2VydmVy5Lit5b+DJ1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuXG5cbiAgLyoqXG4gICAqIOeUn+aIkOagh+etvlxuICAgKi9cbiAgLyogYXN5bmMgZ2VuZXJhdGVMYWJlbCgpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgcXJSZWFkeTogZmFsc2VcbiAgICB9KVxuICAgIGNvbnN0IG1hYyA9IHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWNcbiAgICBjb25zdCBwaWNfcmVhZG1lcXIgPSBhd2FpdCB0aGlzLmRvd21QaWMoXCJodHRwczovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvOV8xOF8yMDIxX3FyY29kZV93d3cueXVxdWUuY29tLnBuZ1wiKVxuICAgIGNvbnN0IHBpY193cHFyID0gYXdhaXQgdGhpcy5kb3dtUGljKFwiaHR0cHM6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzMzMTIwMjFfX0xBRFNfVWFydC41ZGYyY2M2LnBuZ1wiKVxuICAgIGNvbnN0IHBpY19tYWMgPSBhd2FpdCB0aGlzLmdlbmVyYXRlRmlsZShtYWMpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHFyUmVhZHk6IHRydWVcbiAgICB9KVxuICAgIGNvbnN0IHJlcyA9IGF3YWl0IG5ldyBQcm9taXNlPGFueT4ocmVzb2x2ZSA9PiB7XG4gICAgICB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICAgICAgLnNlbGVjdChcIiNjYW52YXMxXCIpXG4gICAgICAgIC5maWVsZHMoeyBub2RlOiB0cnVlLCBzaXplOiB0cnVlIH0pXG4gICAgICAgIC5leGVjKHJlcyA9PiByZXNvbHZlKHJlcykpXG4gICAgfSlcbiAgICBjb25zdCBjYW52YXMgPSByZXNbMF0ubm9kZSBhcyBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXNcbiAgICBjYW52YXMuaGVpZ2h0ID0gMTgwXG4gICAgY2FudmFzLndpZHRoID0gMzgwXG4gICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoXCIyZFwiKSBhcyBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXNDb250ZXh0XG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiI0ZGRkZGRlwiO1xuICAgIGN0eC5maWxsUmVjdCgwLCAwLCAzNTAsIDIwMCk7XG4gICAgY3R4LmZpbGxTdHlsZSA9IFwiIzAwMDAwMFwiO1xuICAgIGN0eC5kcmF3SW1hZ2UoYXdhaXQgdGhpcy5nZW5lcmF0ZUNhbnZhc0ltZyhjYW52YXMsIHBpY19yZWFkbWVxciksIDEwLCA1LCAxMTAsIDk1KVxuICAgIGN0eC5maWxsVGV4dCgn5pON5L2c6K+05piOJywgNTAsIDExMClcbiAgICBjdHguZHJhd0ltYWdlKGF3YWl0IHRoaXMuZ2VuZXJhdGVDYW52YXNJbWcoY2FudmFzLCBwaWNfd3BxciksIDEyMCwgNSwgMTEwLCA5NSlcbiAgICBjdHguZmlsbFRleHQoJ+Wwj+eoi+W6jycsIDE2NSwgMTEwKVxuICAgIGN0eC5kcmF3SW1hZ2UoYXdhaXQgdGhpcy5nZW5lcmF0ZUNhbnZhc0ltZyhjYW52YXMsIHBpY19tYWMpLCAyMzAsIDUsIDExMCwgOTUpXG4gICAgY3R4LmZpbGxUZXh0KCdtYWM6JyArIG1hYywgMjQwLCAxMTApXG4gIH0sICovXG5cbiAgLyoqXG4gICAqIOS4i+i9veagh+etvlxuICAgKi9cbiAgLyogYXN5bmMgZG93bkxhYmVsKCkge1xuICAgIGNvbnN0IHJlcyA9IGF3YWl0IG5ldyBQcm9taXNlPGFueT4ocmVzb2x2ZSA9PiB7XG4gICAgICB3eC5jcmVhdGVTZWxlY3RvclF1ZXJ5KClcbiAgICAgICAgLnNlbGVjdChcIiNjYW52YXMxXCIpXG4gICAgICAgIC5maWVsZHMoeyBub2RlOiB0cnVlLCBzaXplOiB0cnVlIH0pXG4gICAgICAgIC5leGVjKHJlcyA9PiByZXNvbHZlKHJlcykpXG4gICAgfSlcbiAgICBjb25zdCBjYW52YXMgPSByZXNbMF0ubm9kZSBhcyBXZWNoYXRNaW5pcHJvZ3JhbS5DYW52YXNcbiAgICB3eC5jYW52YXNUb1RlbXBGaWxlUGF0aCh7XG4gICAgICBjYW52YXNJZDogXCJjYW52YXMxXCIsXG4gICAgICBxdWFsaXR5OiAxLFxuICAgICAgY2FudmFzLFxuICAgICAgZmlsZVR5cGU6IFwianBnXCIsXG4gICAgICBkZXN0SGVpZ2h0OiAzMDAsXG4gICAgICBkZXN0V2lkdGg6IDcwMCxcbiAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgIHd4LnNhdmVJbWFnZVRvUGhvdG9zQWxidW0oe1xuICAgICAgICAgIGZpbGVQYXRoOiByZXMudGVtcEZpbGVQYXRoLFxuICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgICBpZiAocmVzLmVyck1zZyA9IFwic2F2ZUltYWdlVG9QaG90b3NBbGJ1bTpva1wiKSB7XG4gICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgICAgdGl0bGU6IFwi5bey5L+d5a2Y5Yiw54Wn54mH5bqTXCIsXG4gICAgICAgICAgICAgICAgaWNvbjogXCJzdWNjZXNzXCJcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBhc3luYyBnZW5lcmF0ZUZpbGUoY29kZTogc3RyaW5nKSB7XG4gICAgY29uc3QgYmFzZSA9IGF3YWl0IGFwaS5xcihjb2RlKVxuICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7d3guZW52LlVTRVJfREFUQV9QQVRIfS8ke2NvZGV9LnBuZ2BcbiAgICBjb25zdCBtID0gd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKVxuICAgIHJldHVybiBhd2FpdCBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT4ge1xuICAgICAgbS53cml0ZUZpbGUoe1xuICAgICAgICBmaWxlUGF0aCxcbiAgICAgICAgZGF0YTogYmFzZS5kYXRhLnJlcGxhY2UoL1tcXHJcXG5dL2csICcnKS5zbGljZSgyMiksXG4gICAgICAgIGVuY29kaW5nOiBcImJhc2U2NFwiLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHJlc29sdmUoZmlsZVBhdGgpXG4gICAgICAgIH0sXG4gICAgICAgIGZhaWwoZSkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogZS5lcnJNc2csXG4gICAgICAgICAgICBpY29uOiBcImVycm9yXCJcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG4gIH0sXG4gKi9cbiAgLyoqXG4gICAqIFxuICAgKiBAcGFyYW0gY2FudmFzIFxuICAgKiBAcGFyYW0gcGF0aCBcbiAgICovXG4gIC8qIGdlbmVyYXRlQ2FudmFzSW1nKGNhbnZhczogV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzLCBwYXRoOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPihyZXNvbHZlID0+IHtcbiAgICAgIGNvbnN0IGltZyA9IGNhbnZhcy5jcmVhdGVJbWFnZSgpXG4gICAgICBpbWcub25sb2FkID0gKCkgPT4gcmVzb2x2ZShpbWcgYXMgYW55KVxuICAgICAgaW1nLm9uZXJyb3IgPSAoZSkgPT4ge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiBlLmVyck1zZyxcbiAgICAgICAgICBpY29uOiBcImVycm9yXCJcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIGltZy5zcmMgPSBwYXRoXG4gICAgfSlcbiAgfSxcbiAqL1xuICAvKipcbiAgICog5LiL6L295paH5Lu2XG4gICAqL1xuICAvKiBkb3dtUGljKHVybDogc3RyaW5nKSB7XG4gICAgY29uc3QgbkFyciA9IHVybC5zcGxpdChcIi9cIilcbiAgICBjb25zdCBuYW1lID0gbkFycltuQXJyLmxlbmd0aCAtIDFdXG4gICAgY29uc3QgZmlsZW5hbWUgPSBgJHt3eC5lbnYuVVNFUl9EQVRBX1BBVEh9LyR7bmFtZX1gXG4gICAgLy9jb25zb2xlLmxvZyh7IG5BcnIsIG5hbWUsIGZpbGVuYW1lIH0pO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PiB7XG4gICAgICAvLyDliKTmlq3mlofku7bmmK/lkKblrZjlnKgs5LiN5a2Y5Zyo5bCx5LiL6L295paH5Lu2XG4gICAgICBjb25zdCBtID0gd3guZ2V0RmlsZVN5c3RlbU1hbmFnZXIoKVxuICAgICAgbS5zdGF0KHtcbiAgICAgICAgcGF0aDogZmlsZW5hbWUsXG4gICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgcmVzb2x2ZShmaWxlbmFtZSlcbiAgICAgICAgfSxcbiAgICAgICAgZmFpbChlKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coZS5lcnJNc2cpO1xuICAgICAgICAgIHd4LmRvd25sb2FkRmlsZSh7XG4gICAgICAgICAgICB1cmwsXG4gICAgICAgICAgICBmaWxlUGF0aDogZmlsZW5hbWUsXG4gICAgICAgICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgICByZXNvbHZlKHJlcy5maWxlUGF0aClcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBmYWlsKGUpIHtcbiAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogZS5lcnJNc2csXG4gICAgICAgICAgICAgICAgaWNvbjogXCJlcnJvclwiXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9LCAqL1xufSkiXX0=