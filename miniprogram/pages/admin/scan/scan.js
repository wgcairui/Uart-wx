"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        macs: [],
        terminal: {
            name: '',
            mountNode: '',
            mountDevs: [],
            uptime: '',
            signal: 0,
            remark: ''
        },
        remoteUrl: '',
        uarts: ['2400,8,1,NONE,NFC', '4800,8,1,NONE,HD', '9600,8,1,NONE,HD', '19200,8,1,NONE,HD', '115200,8,1,NONE,HD'],
        qrReady: false
    },
    onLoad() {
        wx.getStorage({
            key: "macHis",
            success: (res) => {
                console.log(res.data);
                this.setData({
                    macs: res.data
                });
            }
        });
    },
    async scanMac() {
        const scanResult = await wx.scanCode({});
        this.setData({
            mac: scanResult.result
        });
        this.scanRequst();
    },
    async scanRequst() {
        wx.showLoading({ title: '查询中' });
        const { code, data } = await api_1.default.getRootTerminal(this.data.mac);
        wx.hideLoading();
        if (code && data) {
            this.setData({
                mac: data.DevMac,
                terminal: data
            });
            this.addHis(data.DevMac);
            api_1.default.onMessage('MacUpdate' + data.DevMac, () => {
                console.log(`listen MacUpdate,mac:${data.DevMac}`);
                this.scanMac();
            });
        }
        else {
            wx.showModal({
                title: 'search',
                content: '此设备没有注册，请核对设备是否在我司渠道购买'
            });
        }
    },
    search(e) {
        this.setData({
            mac: e.target.id
        });
        this.scanRequst();
    },
    addHis(mac) {
        if (this.data.macs.length > 5) {
            this.data.macs.pop();
        }
        const macSet = new Set(this.data.macs);
        macSet.add(mac);
        this.setData({
            macs: [...macSet]
        });
        wx.setStorage({
            key: 'macHis',
            data: [...macSet]
        });
    },
    async initTerminal() {
        const { confirm } = await wx.showModal({
            title: '初始化' + this.data.terminal.name,
            content: '初始化操作不可逆,会清除dtu绑定的设备信息,告警信息,且只能清除未被绑定的dtu!!!'
        });
        if (confirm) {
            wx.showLoading({ title: 'loading' });
            const { code, data, msg } = await api_1.default.initTerminal(this.data.terminal.DevMac);
            if (code) {
                wx.showModal({
                    title: 'success',
                    content: `耗时${data}ms`
                });
                this.scanRequst();
            }
            else {
                wx.showModal({
                    title: 'error',
                    content: msg
                });
            }
        }
    },
    async modifyUart() {
        const d = await wx.showActionSheet({
            itemList: this.data.uarts
        });
        if (this.data.terminal.DevMac && d.errMsg === 'showActionSheet:ok') {
            const uart = `+++AT+UART=1,` + this.data.uarts[d.tapIndex];
            wx.showLoading({ title: '正在修改' });
            const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
            wx.hideLoading();
            if (code && data.ok) {
                wx.showToast({
                    title: 'success',
                    content: data.msg
                });
                this.setData({
                    "terminal.uart": this.data.uarts[d.tapIndex]
                });
            }
            else {
                wx.showModal({
                    title: '操作失败',
                    content: data.msg
                });
            }
        }
    },
    async resetDtu() {
        wx.showModal({
            title: "重启Dtu",
            content: "确定现在重启Dtu吗?",
            success: async () => {
                const uart = `+++AT+Z`;
                wx.showLoading({ title: '正在修改' });
                const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
                wx.hideLoading();
                if (code) {
                    wx.showToast({
                        title: 'success',
                        content: data.msg
                    });
                }
            }
        });
    },
    async bindDevId() {
        const scanResult = await wx.scanCode({});
        wx.showLoading({ title: 'loading' });
        const t = await api_1.default.getTerminal(scanResult.result);
        if (t.data) {
            wx.hideLoading();
            wx.showModal({
                title: 'error',
                content: `${scanResult.result}已被dtu:${t.data.DevMac} 绑定`
            });
            return;
        }
        const { data } = await api_1.default.getRegisterDev(scanResult.result);
        wx.hideLoading();
        if (data) {
            const { confirm } = await wx.showModal({
                title: '确认绑定信息',
                content: `类型:${data.Type}\n 设备:${data.mountDev}\n 协议:${data.protocol}\n 地址:${data.pid}`
            });
            if (confirm) {
                wx.showLoading({ title: '正在绑定设备' });
                const r = await api_1.default.addTerminalMountDev(this.data.terminal.DevMac, { mountDev: data.mountDev, Type: data.Type, protocol: data.protocol, pid: data.pid, bindDev: scanResult.result });
                wx.hideLoading();
                if (r.code) {
                    wx.showToast({
                        title: '设备绑定成功'
                    });
                    this.scanRequst();
                }
            }
        }
        else {
            wx.showModal({
                title: '流程出错',
                content: `${scanResult.result}未注册,请先注册后绑定`
            });
        }
    },
    see(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/admin/devs/devs' + (0, util_1.ObjectToStrquery)({ pid: String(pid), mountDev, protocol, DevMac: this.data.terminal.DevMac, Type })
        });
    },
    async rmBind(e) {
        const item = e.currentTarget.dataset.item;
        const { confirm } = await wx.showModal({
            title: '删除绑定设备',
            content: `确定删除 ${item.mountDev} ???`
        });
        if (confirm) {
            api_1.default.delTerminalMountDev(this.data.terminal.DevMac, item.pid).then(() => {
                this.scanRequst();
            });
        }
    },
    async iotRemoteUrl() {
        const { code, data } = await api_1.default.iotRemoteUrl(this.data.mac);
        if (!code) {
            wx.showModal({
                title: '获取失败',
                content: '设备未绑定到IOT账号'
            });
        }
        else {
            if (!/remote_code=$/.test(data)) {
                wx.showModal({
                    title: '调试地址',
                    content: data,
                    success() {
                        wx.setClipboardData({
                            data,
                            success() {
                                wx.showToast({
                                    title: '已复制网址到剪切板'
                                });
                            }
                        });
                    }
                });
            }
            else {
                wx.showModal({
                    title: '获取失败',
                    content: '设备未连接到iot server中心'
                });
            }
        }
    },
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBc0Q7QUFDdEQsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsSUFBSSxFQUFFLEVBQWM7UUFDcEIsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsRUFBRTtZQUNiLFNBQVMsRUFBRSxFQUE4QjtZQUN6QyxNQUFNLEVBQUUsRUFBRTtZQUNWLE1BQU0sRUFBRSxDQUFDO1lBQ1QsTUFBTSxFQUFFLEVBQUU7U0FDTTtRQUNsQixTQUFTLEVBQUUsRUFBRTtRQUNiLEtBQUssRUFBRSxDQUFDLG1CQUFtQixFQUFFLGtCQUFrQixFQUFFLGtCQUFrQixFQUFFLG1CQUFtQixFQUFFLG9CQUFvQixDQUFDO1FBQy9HLE9BQU8sRUFBRSxLQUFLO0tBQ2Y7SUFFRCxNQUFNO1FBQ0osRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNaLEdBQUcsRUFBRSxRQUFRO1lBQ2IsT0FBTyxFQUFFLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0JBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJO2lCQUNmLENBQUMsQ0FBQTtZQUNKLENBQUM7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU87UUFDWCxNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLEdBQUcsRUFBRSxVQUFVLENBQUMsTUFBTTtTQUN2QixDQUFDLENBQUE7UUFDRixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7SUFDbkIsQ0FB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RUFBRSxDQUFBO1lBQ25CLENBQUMsQ0FBQyxDQUFBO1NBQ0g7SUFHSCxDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVk7UUFDaEIsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLGFBQUcsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM1RCxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDWCxLQUFLLEVBQUUsTUFBTTtnQkFDYixPQUFPLEVBQUUsYUFBYTthQUN2QixDQUFDLENBQUE7U0FDSDthQUFNO1lBQ0wsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7Z0JBQy9CLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLE1BQU07b0JBQ2IsT0FBTyxFQUFFLElBQUk7b0JBQ2IsT0FBTzt3QkFDTCxFQUFFLENBQUMsZ0JBQWdCLENBQUM7NEJBQ2xCLElBQUk7NEJBQ0osT0FBTztnQ0FDTCxFQUFFLENBQUMsU0FBUyxDQUFDO29DQUNYLEtBQUssRUFBRSxXQUFXO2lDQUNuQixDQUFDLENBQUE7NEJBQ0osQ0FBQzt5QkFDRixDQUFDLENBQUE7b0JBQ0osQ0FBQztpQkFDRixDQUFDLENBQUE7YUFDSDtpQkFBTTtnQkFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO29CQUNYLEtBQUssRUFBRSxNQUFNO29CQUNiLE9BQU8sRUFBRSxvQkFBb0I7aUJBQzlCLENBQUMsQ0FBQTthQUNIO1NBQ0Y7SUFDSCxDQUFDO0NBc0pGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9iamVjdFRvU3RycXVlcnkgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiXG5pbXBvcnQgYXBpIGZyb20gXCIuLi8uLi8uLi91dGlscy9hcGlcIlxuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICBtYWM6ICcnLFxuICAgIG1hY3M6IFtdIGFzIHN0cmluZ1tdLFxuICAgIHRlcm1pbmFsOiB7XG4gICAgICBuYW1lOiAnJyxcbiAgICAgIG1vdW50Tm9kZTogJycsXG4gICAgICBtb3VudERldnM6IFtdIGFzIFVhcnQuVGVybWluYWxNb3VudERldnNbXSxcbiAgICAgIHVwdGltZTogJycsXG4gICAgICBzaWduYWw6IDAsXG4gICAgICByZW1hcms6ICcnXG4gICAgfSBhcyBVYXJ0LlRlcm1pbmFsLFxuICAgIHJlbW90ZVVybDogJycsXG4gICAgdWFydHM6IFsnMjQwMCw4LDEsTk9ORSxORkMnLCAnNDgwMCw4LDEsTk9ORSxIRCcsICc5NjAwLDgsMSxOT05FLEhEJywgJzE5MjAwLDgsMSxOT05FLEhEJywgJzExNTIwMCw4LDEsTk9ORSxIRCddLFxuICAgIHFyUmVhZHk6IGZhbHNlXG4gIH0sXG5cbiAgb25Mb2FkKCkge1xuICAgIHd4LmdldFN0b3JhZ2Uoe1xuICAgICAga2V5OiBcIm1hY0hpc1wiLFxuICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhyZXMuZGF0YSk7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgbWFjczogcmVzLmRhdGFcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDosIPnlKjlvq7kv6FhcGnvvIzmiavmj49EVFXmnaHlvaLnoIFcbiAgYXN5bmMgc2Nhbk1hYygpIHtcbiAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgd3guc2NhbkNvZGUoe30pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIG1hYzogc2NhblJlc3VsdC5yZXN1bHRcbiAgICB9KVxuICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gIH0sXG4gIC8vIOafpeivokRUVeiuvuWkh+S/oeaBr1xuICBhc3luYyBzY2FuUmVxdXN0KCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmn6Xor6LkuK0nIH0pXG4gICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuZ2V0Um9vdFRlcm1pbmFsKHRoaXMuZGF0YS5tYWMpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmIChjb2RlICYmIGRhdGEpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIG1hYzogZGF0YS5EZXZNYWMsXG4gICAgICAgIHRlcm1pbmFsOiBkYXRhXG4gICAgICB9KVxuICAgICAgdGhpcy5hZGRIaXMoZGF0YS5EZXZNYWMpXG4gICAgICBhcGkub25NZXNzYWdlPHN0cmluZz4oJ01hY1VwZGF0ZScrZGF0YS5EZXZNYWMsICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coYGxpc3RlbiBNYWNVcGRhdGUsbWFjOiR7ZGF0YS5EZXZNYWN9YCk7XG4gICAgICAgIHRoaXMuc2Nhbk1hYygpXG4gICAgICB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ3NlYXJjaCcsXG4gICAgICAgIGNvbnRlbnQ6ICfmraTorr7lpIfmsqHmnInms6jlhozvvIzor7fmoLjlr7norr7lpIfmmK/lkKblnKjmiJHlj7jmuKDpgZPotK3kubAnXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICog54K55Ye75Y6G5Y+y6K6w5b2V5p+l6K+iXG4gICAqIEBwYXJhbSBlIFxuICAgKi9cbiAgc2VhcmNoKGU6dmFudEV2ZW50KXtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbWFjOmUudGFyZ2V0LmlkXG4gICAgfSlcbiAgICB0aGlzLnNjYW5SZXF1c3QoKVxuICB9LFxuXG4gIC8qKlxuICAgKiDmt7vliqDljoblj7LorrDlvZVcbiAgICogQHBhcmFtIG1hYyBcbiAgICovXG4gIGFkZEhpcyhtYWM6IHN0cmluZykge1xuICAgIGlmICh0aGlzLmRhdGEubWFjcy5sZW5ndGggPiA1KSB7XG4gICAgICB0aGlzLmRhdGEubWFjcy5wb3AoKVxuICAgIH1cbiAgICBjb25zdCBtYWNTZXQgPSBuZXcgU2V0KHRoaXMuZGF0YS5tYWNzKVxuICAgIG1hY1NldC5hZGQobWFjKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBtYWNzOiBbLi4ubWFjU2V0XVxuICAgIH0pXG4gICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICBrZXk6ICdtYWNIaXMnLFxuICAgICAgZGF0YTogWy4uLm1hY1NldF1cbiAgICB9KVxuICB9LFxuXG4gIGFzeW5jIGluaXRUZXJtaW5hbCgpIHtcbiAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ+WIneWni+WMlicgKyB0aGlzLmRhdGEudGVybWluYWwubmFtZSxcbiAgICAgIGNvbnRlbnQ6ICfliJ3lp4vljJbmk43kvZzkuI3lj6/pgIYs5Lya5riF6ZmkZHR157uR5a6a55qE6K6+5aSH5L+h5oGvLOWRiuitpuS/oeaBryzkuJTlj6rog73muIXpmaTmnKrooqvnu5HlrprnmoRkdHUhISEnXG4gICAgfSlcbiAgICBpZiAoY29uZmlybSkge1xuICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgICBjb25zdCB7IGNvZGUsIGRhdGEsIG1zZyB9ID0gYXdhaXQgYXBpLmluaXRUZXJtaW5hbCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjKVxuICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IGDogJfml7Yke2RhdGF9bXNgXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAnZXJyb3InLFxuICAgICAgICAgIGNvbnRlbnQ6IG1zZ1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICog5L+u5pS55rOi54m5546HXG4gICAqL1xuICBhc3luYyBtb2RpZnlVYXJ0KCkge1xuICAgIGNvbnN0IGQgPSBhd2FpdCB3eC5zaG93QWN0aW9uU2hlZXQoe1xuICAgICAgaXRlbUxpc3Q6IHRoaXMuZGF0YS51YXJ0c1xuICAgIH0pXG4gICAgaWYgKHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMgJiYgZC5lcnJNc2cgPT09ICdzaG93QWN0aW9uU2hlZXQ6b2snKSB7XG4gICAgICBjb25zdCB1YXJ0ID0gYCsrK0FUK1VBUlQ9MSxgICsgdGhpcy5kYXRhLnVhcnRzW2QudGFwSW5kZXhdXG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5q2j5Zyo5L+u5pS5JyB9KVxuICAgICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuc2VuZEFUSW5zdHJ1Y3QodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgdWFydClcbiAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIGlmIChjb2RlICYmIGRhdGEub2spIHtcbiAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IGRhdGEubXNnXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgXCJ0ZXJtaW5hbC51YXJ0XCI6IHRoaXMuZGF0YS51YXJ0c1tkLnRhcEluZGV4XVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+aTjeS9nOWksei0pScsXG4gICAgICAgICAgY29udGVudDogZGF0YS5tc2dcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgfSxcblxuICBhc3luYyByZXNldER0dSgpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IFwi6YeN5ZCvRHR1XCIsXG4gICAgICBjb250ZW50OiBcIuehruWumueOsOWcqOmHjeWQr0R0deWQlz9cIixcbiAgICAgIHN1Y2Nlc3M6IGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgdWFydCA9IGArKytBVCtaYFxuICAgICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5q2j5Zyo5L+u5pS5JyB9KVxuICAgICAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5zZW5kQVRJbnN0cnVjdCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCB1YXJ0KVxuICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIGlmIChjb2RlKSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgIHRpdGxlOiAnc3VjY2VzcycsXG4gICAgICAgICAgICBjb250ZW50OiBkYXRhLm1zZ1xuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvKipcbiAgICog57uR5a6a6K6+5aSHaWRcbiAgICovXG4gIGFzeW5jIGJpbmREZXZJZCgpIHtcbiAgICBjb25zdCBzY2FuUmVzdWx0ID0gYXdhaXQgd3guc2NhbkNvZGUoe30pXG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgY29uc3QgdCA9IGF3YWl0IGFwaS5nZXRUZXJtaW5hbChzY2FuUmVzdWx0LnJlc3VsdClcbiAgICBpZiAodC5kYXRhKSB7XG4gICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ2Vycm9yJyxcbiAgICAgICAgY29udGVudDogYCR7c2NhblJlc3VsdC5yZXN1bHR95bey6KKrZHR1OiR7dC5kYXRhLkRldk1hY30g57uR5a6aYFxuICAgICAgfSlcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IGFwaS5nZXRSZWdpc3RlckRldihzY2FuUmVzdWx0LnJlc3VsdClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGNvbnN0IHsgY29uZmlybSB9ID0gYXdhaXQgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICfnoa7orqTnu5Hlrprkv6Hmga8nLFxuICAgICAgICBjb250ZW50OiBg57G75Z6LOiR7ZGF0YS5UeXBlfVxcbiDorr7lpIc6JHtkYXRhLm1vdW50RGV2fVxcbiDljY/orq46JHtkYXRhLnByb3RvY29sfVxcbiDlnLDlnYA6JHtkYXRhLnBpZH1gXG4gICAgICB9KVxuICAgICAgaWYgKGNvbmZpcm0pIHtcbiAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ato+WcqOe7keWumuiuvuWkhycgfSlcbiAgICAgICAgY29uc3QgciA9IGF3YWl0IGFwaS5hZGRUZXJtaW5hbE1vdW50RGV2KHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIHsgbW91bnREZXY6IGRhdGEubW91bnREZXYsIFR5cGU6IGRhdGEuVHlwZSwgcHJvdG9jb2w6IGRhdGEucHJvdG9jb2wsIHBpZDogZGF0YS5waWQsIGJpbmREZXY6IHNjYW5SZXN1bHQucmVzdWx0IH0pXG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgaWYgKHIuY29kZSkge1xuICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICB0aXRsZTogJ+iuvuWkh+e7keWumuaIkOWKnydcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICfmtYHnqIvlh7rplJknLFxuICAgICAgICBjb250ZW50OiBgJHtzY2FuUmVzdWx0LnJlc3VsdH3mnKrms6jlhows6K+35YWI5rOo5YaM5ZCO57uR5a6aYFxuICAgICAgfSlcbiAgICB9XG5cbiAgfSxcblxuICAvLyDmn6XnnIvorr7lpIfmlbDmja5cbiAgc2VlKGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UZXJtaW5hbE1vdW50RGV2cz4pIHtcbiAgICBjb25zdCB7IHBpZCwgbW91bnREZXYsIHByb3RvY29sLCBUeXBlIH0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2FkbWluL2RldnMvZGV2cycgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgcGlkOiBTdHJpbmcocGlkKSwgbW91bnREZXYsIHByb3RvY29sLCBEZXZNYWM6IHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIFR5cGUgfSlcbiAgICB9KVxuICB9LFxuXG4gIC8vIOWIoOmZpOe7keWumuiuvuWkh1xuICBhc3luYyBybUJpbmQoZTogdmFudEV2ZW50PFVhcnQucmVnaXN0ZXJEZXY+KSB7XG4gICAgY29uc3QgaXRlbSA9IGUuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ+WIoOmZpOe7keWumuiuvuWkhycsXG4gICAgICBjb250ZW50OiBg56Gu5a6a5Yig6ZmkICR7aXRlbS5tb3VudERldn0gPz8/YFxuICAgIH0pXG4gICAgaWYgKGNvbmZpcm0pIHtcbiAgICAgIGFwaS5kZWxUZXJtaW5hbE1vdW50RGV2KHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMsIGl0ZW0ucGlkKS50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgICAgIH0pXG4gICAgfVxuXG5cbiAgfSxcbiAgLy/ov5znqIvosIPor5Xorr7lpIdcbiAgYXN5bmMgaW90UmVtb3RlVXJsKCkge1xuICAgIGNvbnN0IHsgY29kZSwgZGF0YSB9ID0gYXdhaXQgYXBpLmlvdFJlbW90ZVVybCh0aGlzLmRhdGEubWFjKVxuICAgIGlmICghY29kZSkge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICfojrflj5blpLHotKUnLFxuICAgICAgICBjb250ZW50OiAn6K6+5aSH5pyq57uR5a6a5YiwSU9U6LSm5Y+3J1xuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCEvcmVtb3RlX2NvZGU9JC8udGVzdChkYXRhKSkge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAn6LCD6K+V5Zyw5Z2AJyxcbiAgICAgICAgICBjb250ZW50OiBkYXRhLFxuICAgICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgICB3eC5zZXRDbGlwYm9hcmREYXRhKHtcbiAgICAgICAgICAgICAgZGF0YSxcbiAgICAgICAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgICAgdGl0bGU6ICflt7LlpI3liLbnvZHlnYDliLDliarliIfmnb8nXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAn6I635Y+W5aSx6LSlJyxcbiAgICAgICAgICBjb250ZW50OiAn6K6+5aSH5pyq6L+e5o6l5YiwaW90IHNlcnZlcuS4reW/gydcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cblxuXG4gIC8qKlxuICAgKiDnlJ/miJDmoIfnrb5cbiAgICovXG4gIC8qIGFzeW5jIGdlbmVyYXRlTGFiZWwoKSB7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHFyUmVhZHk6IGZhbHNlXG4gICAgfSlcbiAgICBjb25zdCBtYWMgPSB0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjXG4gICAgY29uc3QgcGljX3JlYWRtZXFyID0gYXdhaXQgdGhpcy5kb3dtUGljKFwiaHR0cHM6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzlfMThfMjAyMV9xcmNvZGVfd3d3Lnl1cXVlLmNvbS5wbmdcIilcbiAgICBjb25zdCBwaWNfd3BxciA9IGF3YWl0IHRoaXMuZG93bVBpYyhcImh0dHBzOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC8zMzEyMDIxX19MQURTX1VhcnQuNWRmMmNjNi5wbmdcIilcbiAgICBjb25zdCBwaWNfbWFjID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUZpbGUobWFjKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBxclJlYWR5OiB0cnVlXG4gICAgfSlcbiAgICBjb25zdCByZXMgPSBhd2FpdCBuZXcgUHJvbWlzZTxhbnk+KHJlc29sdmUgPT4ge1xuICAgICAgd3guY3JlYXRlU2VsZWN0b3JRdWVyeSgpXG4gICAgICAgIC5zZWxlY3QoXCIjY2FudmFzMVwiKVxuICAgICAgICAuZmllbGRzKHsgbm9kZTogdHJ1ZSwgc2l6ZTogdHJ1ZSB9KVxuICAgICAgICAuZXhlYyhyZXMgPT4gcmVzb2x2ZShyZXMpKVxuICAgIH0pXG4gICAgY29uc3QgY2FudmFzID0gcmVzWzBdLm5vZGUgYXMgV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzXG4gICAgY2FudmFzLmhlaWdodCA9IDE4MFxuICAgIGNhbnZhcy53aWR0aCA9IDM4MFxuICAgIGNvbnN0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIikgYXMgV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzQ29udGV4dFxuICAgIGN0eC5maWxsU3R5bGUgPSBcIiNGRkZGRkZcIjtcbiAgICBjdHguZmlsbFJlY3QoMCwgMCwgMzUwLCAyMDApO1xuICAgIGN0eC5maWxsU3R5bGUgPSBcIiMwMDAwMDBcIjtcbiAgICBjdHguZHJhd0ltYWdlKGF3YWl0IHRoaXMuZ2VuZXJhdGVDYW52YXNJbWcoY2FudmFzLCBwaWNfcmVhZG1lcXIpLCAxMCwgNSwgMTEwLCA5NSlcbiAgICBjdHguZmlsbFRleHQoJ+aTjeS9nOivtOaYjicsIDUwLCAxMTApXG4gICAgY3R4LmRyYXdJbWFnZShhd2FpdCB0aGlzLmdlbmVyYXRlQ2FudmFzSW1nKGNhbnZhcywgcGljX3dwcXIpLCAxMjAsIDUsIDExMCwgOTUpXG4gICAgY3R4LmZpbGxUZXh0KCflsI/nqIvluo8nLCAxNjUsIDExMClcbiAgICBjdHguZHJhd0ltYWdlKGF3YWl0IHRoaXMuZ2VuZXJhdGVDYW52YXNJbWcoY2FudmFzLCBwaWNfbWFjKSwgMjMwLCA1LCAxMTAsIDk1KVxuICAgIGN0eC5maWxsVGV4dCgnbWFjOicgKyBtYWMsIDI0MCwgMTEwKVxuICB9LCAqL1xuXG4gIC8qKlxuICAgKiDkuIvovb3moIfnrb5cbiAgICovXG4gIC8qIGFzeW5jIGRvd25MYWJlbCgpIHtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBuZXcgUHJvbWlzZTxhbnk+KHJlc29sdmUgPT4ge1xuICAgICAgd3guY3JlYXRlU2VsZWN0b3JRdWVyeSgpXG4gICAgICAgIC5zZWxlY3QoXCIjY2FudmFzMVwiKVxuICAgICAgICAuZmllbGRzKHsgbm9kZTogdHJ1ZSwgc2l6ZTogdHJ1ZSB9KVxuICAgICAgICAuZXhlYyhyZXMgPT4gcmVzb2x2ZShyZXMpKVxuICAgIH0pXG4gICAgY29uc3QgY2FudmFzID0gcmVzWzBdLm5vZGUgYXMgV2VjaGF0TWluaXByb2dyYW0uQ2FudmFzXG4gICAgd3guY2FudmFzVG9UZW1wRmlsZVBhdGgoe1xuICAgICAgY2FudmFzSWQ6IFwiY2FudmFzMVwiLFxuICAgICAgcXVhbGl0eTogMSxcbiAgICAgIGNhbnZhcyxcbiAgICAgIGZpbGVUeXBlOiBcImpwZ1wiLFxuICAgICAgZGVzdEhlaWdodDogMzAwLFxuICAgICAgZGVzdFdpZHRoOiA3MDAsXG4gICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICB3eC5zYXZlSW1hZ2VUb1Bob3Rvc0FsYnVtKHtcbiAgICAgICAgICBmaWxlUGF0aDogcmVzLnRlbXBGaWxlUGF0aCxcbiAgICAgICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgaWYgKHJlcy5lcnJNc2cgPSBcInNhdmVJbWFnZVRvUGhvdG9zQWxidW06b2tcIikge1xuICAgICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICAgIHRpdGxlOiBcIuW3suS/neWtmOWIsOeFp+eJh+W6k1wiLFxuICAgICAgICAgICAgICAgIGljb246IFwic3VjY2Vzc1wiXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgYXN5bmMgZ2VuZXJhdGVGaWxlKGNvZGU6IHN0cmluZykge1xuICAgIGNvbnN0IGJhc2UgPSBhd2FpdCBhcGkucXIoY29kZSlcbiAgICBjb25zdCBmaWxlUGF0aCA9IGAke3d4LmVudi5VU0VSX0RBVEFfUEFUSH0vJHtjb2RlfS5wbmdgXG4gICAgY29uc3QgbSA9IHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKClcbiAgICByZXR1cm4gYXdhaXQgbmV3IFByb21pc2U8c3RyaW5nPihyZXNvbHZlID0+IHtcbiAgICAgIG0ud3JpdGVGaWxlKHtcbiAgICAgICAgZmlsZVBhdGgsXG4gICAgICAgIGRhdGE6IGJhc2UuZGF0YS5yZXBsYWNlKC9bXFxyXFxuXS9nLCAnJykuc2xpY2UoMjIpLFxuICAgICAgICBlbmNvZGluZzogXCJiYXNlNjRcIixcbiAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICByZXNvbHZlKGZpbGVQYXRoKVxuICAgICAgICB9LFxuICAgICAgICBmYWlsKGUpIHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6IGUuZXJyTXNnLFxuICAgICAgICAgICAgaWNvbjogXCJlcnJvclwiXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuICovXG4gIC8qKlxuICAgKiBcbiAgICogQHBhcmFtIGNhbnZhcyBcbiAgICogQHBhcmFtIHBhdGggXG4gICAqL1xuICAvKiBnZW5lcmF0ZUNhbnZhc0ltZyhjYW52YXM6IFdlY2hhdE1pbmlwcm9ncmFtLkNhbnZhcywgcGF0aDogc3RyaW5nKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4ocmVzb2x2ZSA9PiB7XG4gICAgICBjb25zdCBpbWcgPSBjYW52YXMuY3JlYXRlSW1hZ2UoKVxuICAgICAgaW1nLm9ubG9hZCA9ICgpID0+IHJlc29sdmUoaW1nIGFzIGFueSlcbiAgICAgIGltZy5vbmVycm9yID0gKGUpID0+IHtcbiAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICB0aXRsZTogZS5lcnJNc2csXG4gICAgICAgICAgaWNvbjogXCJlcnJvclwiXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICBpbWcuc3JjID0gcGF0aFxuICAgIH0pXG4gIH0sXG4gKi9cbiAgLyoqXG4gICAqIOS4i+i9veaWh+S7tlxuICAgKi9cbiAgLyogZG93bVBpYyh1cmw6IHN0cmluZykge1xuICAgIGNvbnN0IG5BcnIgPSB1cmwuc3BsaXQoXCIvXCIpXG4gICAgY29uc3QgbmFtZSA9IG5BcnJbbkFyci5sZW5ndGggLSAxXVxuICAgIGNvbnN0IGZpbGVuYW1lID0gYCR7d3guZW52LlVTRVJfREFUQV9QQVRIfS8ke25hbWV9YFxuICAgIC8vY29uc29sZS5sb2coeyBuQXJyLCBuYW1lLCBmaWxlbmFtZSB9KTtcblxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KHJlc29sdmUgPT4ge1xuICAgICAgLy8g5Yik5pat5paH5Lu25piv5ZCm5a2Y5ZyoLOS4jeWtmOWcqOWwseS4i+i9veaWh+S7tlxuICAgICAgY29uc3QgbSA9IHd4LmdldEZpbGVTeXN0ZW1NYW5hZ2VyKClcbiAgICAgIG0uc3RhdCh7XG4gICAgICAgIHBhdGg6IGZpbGVuYW1lLFxuICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgIHJlc29sdmUoZmlsZW5hbWUpXG4gICAgICAgIH0sXG4gICAgICAgIGZhaWwoZSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGUuZXJyTXNnKTtcbiAgICAgICAgICB3eC5kb3dubG9hZEZpbGUoe1xuICAgICAgICAgICAgdXJsLFxuICAgICAgICAgICAgZmlsZVBhdGg6IGZpbGVuYW1lLFxuICAgICAgICAgICAgc3VjY2VzcyhyZXMpIHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXMuZmlsZVBhdGgpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZmFpbChlKSB7XG4gICAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgICAgICAgdGl0bGU6IGUuZXJyTXNnLFxuICAgICAgICAgICAgICAgIGljb246IFwiZXJyb3JcIlxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfSwgKi9cbn0pIl19