"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        terminal: {
            name: '',
            mountNode: '',
            mountDevs: [],
            uptime: ''
        },
        remoteUrl: '',
        uarts: ['2400,8,1,NONE,NFC', '4800,8,1,NONE,HD', '9600,8,1,NONE,HD', '19200,8,1,NONE,HD', '115200,8,1,NONE,HD']
    },
    async scanMac() {
        const scanResult = await wx.scanCode({});
        this.setData({
            mac: scanResult.result
        });
        this.scanRequst();
    },
    async scanRequst() {
        wx.showLoading({ title: '查询中' });
        const { code, data } = await api_1.default.getRootTerminal(this.data.mac);
        wx.hideLoading();
        if (code && data) {
            this.setData({
                terminal: data
            });
        }
        else {
            wx.showModal({
                title: 'search',
                content: '此设备没有注册，请核对设备是否在我司渠道购买'
            });
        }
    },
    async initTerminal() {
        const { confirm } = await wx.showModal({
            title: '初始化' + this.data.terminal.name,
            content: '初始化操作不可逆,会清除dtu绑定的设备信息,告警信息,且只能清除未被绑定的dtu!!!'
        });
        if (confirm) {
            wx.showLoading({ title: 'loading' });
            const { code, data, msg } = await api_1.default.initTerminal(this.data.terminal.DevMac);
            if (code) {
                wx.showModal({
                    title: 'success',
                    content: `耗时${data}ms`
                });
                this.scanRequst();
            }
            else {
                wx.showModal({
                    title: 'error',
                    content: msg
                });
            }
        }
    },
    async modifyUart() {
        const d = await wx.showActionSheet({
            itemList: this.data.uarts
        });
        if (this.data.terminal.DevMac && d.errMsg === 'showActionSheet:ok') {
            const uart = `+++AT+UART=1,` + this.data.uarts[d.tapIndex];
            wx.showLoading({ title: '正在修改' });
            const { code, data } = await api_1.default.sendATInstruct(this.data.terminal.DevMac, uart);
            wx.hideLoading();
            if (code && data.ok) {
                wx.showToast({
                    title: 'success',
                    content: data.msg
                });
                this.setData({
                    "terminal.uart": this.data.uarts[d.tapIndex]
                });
            }
            else {
                wx.showModal({
                    title: '操作失败',
                    content: data.msg
                });
            }
        }
    },
    async bindDevId() {
        const scanResult = await wx.scanCode({});
        wx.showLoading({ title: 'loading' });
        const t = await api_1.default.getTerminal(scanResult.result);
        if (t.data) {
            wx.hideLoading();
            wx.showModal({
                title: 'error',
                content: `${scanResult.result}已被dtu:${t.data.DevMac} 绑定`
            });
            return;
        }
        const { data } = await api_1.default.getRegisterDev(scanResult.result);
        wx.hideLoading();
        if (data) {
            const { confirm } = await wx.showModal({
                title: '确认绑定信息',
                content: `类型:${data.Type}\n 设备:${data.mountDev}\n 协议:${data.protocol}\n 地址:${data.pid}`
            });
            if (confirm) {
                wx.showLoading({ title: '正在绑定设备' });
                const r = await api_1.default.addTerminalMountDev(this.data.terminal.DevMac, { mountDev: data.mountDev, Type: data.Type, protocol: data.protocol, pid: data.pid, bindDev: scanResult.result });
                wx.hideLoading();
                if (r.code) {
                    wx.showToast({
                        title: '设备绑定成功'
                    });
                    this.scanRequst();
                }
            }
        }
        else {
            wx.showModal({
                title: '流程出错',
                content: `${scanResult.result}未注册,请先注册后绑定`
            });
        }
    },
    see(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/admin/devs/devs' + util_1.ObjectToStrquery({ pid: String(pid), mountDev, protocol, DevMac: this.data.mac, Type })
        });
    },
    async rmBind(e) {
        const item = e.currentTarget.dataset.item;
        const { confirm } = await wx.showModal({
            title: '删除绑定设备',
            content: `确定删除 ${item.mountDev} ???`
        });
        if (confirm) {
            api_1.default.delTerminalMountDev(this.data.terminal.DevMac, item.pid).then(() => {
                this.scanRequst();
            });
        }
    },
    async iotRemoteUrl() {
        const { code, data } = await api_1.default.iotRemoteUrl(this.data.mac);
        if (!code) {
            wx.showModal({
                title: '获取失败',
                content: '设备未绑定到IOT账号'
            });
        }
        else {
            if (!/remote_code=$/.test(data)) {
                wx.showModal({
                    title: '调试地址',
                    content: data,
                    success() {
                        wx.setClipboardData({
                            data,
                            success() {
                                wx.showToast({
                                    title: '已复制网址到剪切板'
                                });
                            }
                        });
                    }
                });
            }
            else {
                wx.showModal({
                    title: '获取失败',
                    content: '设备未连接到iot server中心'
                });
            }
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nhbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNjYW4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSw4Q0FBc0Q7QUFDdEQsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQUNILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsUUFBUSxFQUFFO1lBQ1IsSUFBSSxFQUFFLEVBQUU7WUFDUixTQUFTLEVBQUUsRUFBRTtZQUNiLFNBQVMsRUFBRSxFQUE4QjtZQUN6QyxNQUFNLEVBQUUsRUFBRTtTQUNNO1FBQ2xCLFNBQVMsRUFBRSxFQUFFO1FBQ2IsS0FBSyxFQUFFLENBQUMsbUJBQW1CLEVBQUUsa0JBQWtCLEVBQUUsa0JBQWtCLEVBQUUsbUJBQW1CLEVBQUUsb0JBQW9CLENBQUM7S0FDaEg7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNYLE1BQU0sVUFBVSxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsR0FBRyxFQUFFLFVBQVUsQ0FBQyxNQUFNO1NBQ3ZCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUNuQixDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVU7UUFDZCxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7UUFDaEMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLGFBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUMvRCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDaEIsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO1lBQ2hCLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsUUFBUSxFQUFFLElBQUk7YUFDZixDQUFDLENBQUE7U0FDSDthQUFNO1lBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQztnQkFDWCxLQUFLLEVBQUUsUUFBUTtnQkFDZixPQUFPLEVBQUUsd0JBQXdCO2FBQ2xDLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZO1FBQ2hCLE1BQU0sRUFBRSxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDckMsS0FBSyxFQUFFLEtBQUssR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJO1lBQ3RDLE9BQU8sRUFBRSw4Q0FBOEM7U0FDeEQsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxPQUFPLEVBQUU7WUFDWCxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUE7WUFDcEMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQzdFLElBQUksSUFBSSxFQUFFO2dCQUNSLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLFNBQVM7b0JBQ2hCLE9BQU8sRUFBRSxLQUFLLElBQUksSUFBSTtpQkFDdkIsQ0FBQyxDQUFBO2dCQUNGLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTthQUNsQjtpQkFBTTtnQkFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO29CQUNYLEtBQUssRUFBRSxPQUFPO29CQUNkLE9BQU8sRUFBRSxHQUFHO2lCQUNiLENBQUMsQ0FBQTthQUNIO1NBQ0Y7SUFDSCxDQUFDO0lBS0QsS0FBSyxDQUFDLFVBQVU7UUFDZCxNQUFNLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxlQUFlLENBQUM7WUFDakMsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSztTQUMxQixDQUFDLENBQUE7UUFDRixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLG9CQUFvQixFQUFFO1lBQ2xFLE1BQU0sSUFBSSxHQUFHLGVBQWUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUE7WUFDMUQsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1lBQ2pDLE1BQU0sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQTtZQUNoRixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7WUFDaEIsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDbkIsRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDWCxLQUFLLEVBQUUsU0FBUztvQkFDaEIsT0FBTyxFQUFFLElBQUksQ0FBQyxHQUFHO2lCQUNsQixDQUFDLENBQUE7Z0JBQ0YsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDWCxlQUFlLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztpQkFDN0MsQ0FBQyxDQUFBO2FBQ0g7aUJBQU07Z0JBQ0wsRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDWCxLQUFLLEVBQUUsTUFBTTtvQkFDYixPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUc7aUJBQ2xCLENBQUMsQ0FBQTthQUNIO1NBQ0Y7SUFFSCxDQUFDO0lBSUQsS0FBSyxDQUFDLFNBQVM7UUFDYixNQUFNLFVBQVUsR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDeEMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFBO1FBQ3BDLE1BQU0sQ0FBQyxHQUFHLE1BQU0sYUFBRyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDbEQsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFO1lBQ1YsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQ2hCLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0JBQ1gsS0FBSyxFQUFFLE9BQU87Z0JBQ2QsT0FBTyxFQUFFLEdBQUcsVUFBVSxDQUFDLE1BQU0sU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSzthQUN6RCxDQUFDLENBQUE7WUFDRixPQUFNO1NBQ1A7UUFDRCxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUM1RCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7UUFDaEIsSUFBSSxJQUFJLEVBQUU7WUFDUixNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNyQyxLQUFLLEVBQUUsUUFBUTtnQkFDZixPQUFPLEVBQUUsTUFBTSxJQUFJLENBQUMsSUFBSSxTQUFTLElBQUksQ0FBQyxRQUFRLFNBQVMsSUFBSSxDQUFDLFFBQVEsU0FBUyxJQUFJLENBQUMsR0FBRyxFQUFFO2FBQ3hGLENBQUMsQ0FBQTtZQUNGLElBQUksT0FBTyxFQUFFO2dCQUNYLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtnQkFDbkMsTUFBTSxDQUFDLEdBQUcsTUFBTSxhQUFHLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsT0FBTyxFQUFFLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFBO2dCQUNwTCxFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7Z0JBQ2hCLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRTtvQkFDVixFQUFFLENBQUMsU0FBUyxDQUFDO3dCQUNYLEtBQUssRUFBRSxRQUFRO3FCQUNoQixDQUFDLENBQUE7b0JBQ0YsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO2lCQUNsQjthQUNGO1NBQ0Y7YUFBTTtZQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0JBQ1gsS0FBSyxFQUFFLE1BQU07Z0JBQ2IsT0FBTyxFQUFFLEdBQUcsVUFBVSxDQUFDLE1BQU0sYUFBYTthQUMzQyxDQUFDLENBQUE7U0FDSDtJQUVILENBQUM7SUFHRCxHQUFHLENBQUMsS0FBd0M7UUFDMUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQTtRQUMxRSxFQUFFLENBQUMsVUFBVSxDQUFDO1lBQ1osR0FBRyxFQUFFLHdCQUF3QixHQUFHLHVCQUFnQixDQUFDLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQztTQUN4SCxDQUFDLENBQUE7SUFDSixDQUFDO0lBR0QsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUE4QjtRQUN6QyxNQUFNLElBQUksR0FBRyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUE7UUFDekMsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDLFNBQVMsQ0FBQztZQUNyQyxLQUFLLEVBQUUsUUFBUTtZQUNmLE9BQU8sRUFBRSxRQUFRLElBQUksQ0FBQyxRQUFRLE1BQU07U0FDckMsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxPQUFPLEVBQUU7WUFDWCxhQUFHLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNyRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDbkIsQ0FBQyxDQUFDLENBQUE7U0FDSDtJQUdILENBQUM7SUFFRCxLQUFLLENBQUMsWUFBWTtRQUNoQixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sYUFBRyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1FBQzVELElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNYLEtBQUssRUFBRSxNQUFNO2dCQUNiLE9BQU8sRUFBRSxhQUFhO2FBQ3ZCLENBQUMsQ0FBQTtTQUNIO2FBQU07WUFDTCxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDL0IsRUFBRSxDQUFDLFNBQVMsQ0FBQztvQkFDWCxLQUFLLEVBQUUsTUFBTTtvQkFDYixPQUFPLEVBQUUsSUFBSTtvQkFDYixPQUFPO3dCQUNMLEVBQUUsQ0FBQyxnQkFBZ0IsQ0FBQzs0QkFDbEIsSUFBSTs0QkFDSixPQUFPO2dDQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0NBQ1gsS0FBSyxFQUFFLFdBQVc7aUNBQ25CLENBQUMsQ0FBQTs0QkFDSixDQUFDO3lCQUNGLENBQUMsQ0FBQTtvQkFDSixDQUFDO2lCQUNGLENBQUMsQ0FBQTthQUNIO2lCQUFNO2dCQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUM7b0JBQ1gsS0FBSyxFQUFFLE1BQU07b0JBQ2IsT0FBTyxFQUFFLG9CQUFvQjtpQkFDOUIsQ0FBQyxDQUFBO2FBQ0g7U0FDRjtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYmplY3RUb1N0cnF1ZXJ5IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgbWFjOiAnJyxcbiAgICB0ZXJtaW5hbDoge1xuICAgICAgbmFtZTogJycsXG4gICAgICBtb3VudE5vZGU6ICcnLFxuICAgICAgbW91bnREZXZzOiBbXSBhcyBVYXJ0LlRlcm1pbmFsTW91bnREZXZzW10sXG4gICAgICB1cHRpbWU6ICcnXG4gICAgfSBhcyBVYXJ0LlRlcm1pbmFsLFxuICAgIHJlbW90ZVVybDogJycsXG4gICAgdWFydHM6IFsnMjQwMCw4LDEsTk9ORSxORkMnLCAnNDgwMCw4LDEsTk9ORSxIRCcsICc5NjAwLDgsMSxOT05FLEhEJywgJzE5MjAwLDgsMSxOT05FLEhEJywgJzExNTIwMCw4LDEsTk9ORSxIRCddXG4gIH0sXG4gIC8vIOiwg+eUqOW+ruS/oWFwae+8jOaJq+aPj0RUVeadoeW9oueggVxuICBhc3luYyBzY2FuTWFjKCkge1xuICAgIGNvbnN0IHNjYW5SZXN1bHQgPSBhd2FpdCB3eC5zY2FuQ29kZSh7fSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbWFjOiBzY2FuUmVzdWx0LnJlc3VsdFxuICAgIH0pXG4gICAgdGhpcy5zY2FuUmVxdXN0KClcbiAgfSxcbiAgLy8g5p+l6K+iRFRV6K6+5aSH5L+h5oGvXG4gIGFzeW5jIHNjYW5SZXF1c3QoKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+afpeivouS4rScgfSlcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5nZXRSb290VGVybWluYWwodGhpcy5kYXRhLm1hYylcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKGNvZGUgJiYgZGF0YSkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgdGVybWluYWw6IGRhdGFcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAnc2VhcmNoJyxcbiAgICAgICAgY29udGVudDogJ+atpOiuvuWkh+ayoeacieazqOWGjO+8jOivt+aguOWvueiuvuWkh+aYr+WQpuWcqOaIkeWPuOa4oOmBk+i0reS5sCdcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIGFzeW5jIGluaXRUZXJtaW5hbCgpIHtcbiAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ+WIneWni+WMlicgKyB0aGlzLmRhdGEudGVybWluYWwubmFtZSxcbiAgICAgIGNvbnRlbnQ6ICfliJ3lp4vljJbmk43kvZzkuI3lj6/pgIYs5Lya5riF6ZmkZHR157uR5a6a55qE6K6+5aSH5L+h5oGvLOWRiuitpuS/oeaBryzkuJTlj6rog73muIXpmaTmnKrooqvnu5HlrprnmoRkdHUhISEnXG4gICAgfSlcbiAgICBpZiAoY29uZmlybSkge1xuICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgICBjb25zdCB7IGNvZGUsIGRhdGEsIG1zZyB9ID0gYXdhaXQgYXBpLmluaXRUZXJtaW5hbCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjKVxuICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IGDogJfml7Yke2RhdGF9bXNgXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgIHRpdGxlOiAnZXJyb3InLFxuICAgICAgICAgIGNvbnRlbnQ6IG1zZ1xuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICog5L+u5pS55rOi54m5546HXG4gICAqL1xuICBhc3luYyBtb2RpZnlVYXJ0KCkge1xuICAgIGNvbnN0IGQgPSBhd2FpdCB3eC5zaG93QWN0aW9uU2hlZXQoe1xuICAgICAgaXRlbUxpc3Q6IHRoaXMuZGF0YS51YXJ0c1xuICAgIH0pXG4gICAgaWYgKHRoaXMuZGF0YS50ZXJtaW5hbC5EZXZNYWMgJiYgZC5lcnJNc2cgPT09ICdzaG93QWN0aW9uU2hlZXQ6b2snKSB7XG4gICAgICBjb25zdCB1YXJ0ID0gYCsrK0FUK1VBUlQ9MSxgICsgdGhpcy5kYXRhLnVhcnRzW2QudGFwSW5kZXhdXG4gICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5q2j5Zyo5L+u5pS5JyB9KVxuICAgICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkuc2VuZEFUSW5zdHJ1Y3QodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgdWFydClcbiAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgIGlmIChjb2RlICYmIGRhdGEub2spIHtcbiAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICB0aXRsZTogJ3N1Y2Nlc3MnLFxuICAgICAgICAgIGNvbnRlbnQ6IGRhdGEubXNnXG4gICAgICAgIH0pXG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgXCJ0ZXJtaW5hbC51YXJ0XCI6IHRoaXMuZGF0YS51YXJ0c1tkLnRhcEluZGV4XVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+aTjeS9nOWksei0pScsXG4gICAgICAgICAgY29udGVudDogZGF0YS5tc2dcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgfSxcbiAgLyoqXG4gICAqIOe7keWumuiuvuWkh2lkXG4gICAqL1xuICBhc3luYyBiaW5kRGV2SWQoKSB7XG4gICAgY29uc3Qgc2NhblJlc3VsdCA9IGF3YWl0IHd4LnNjYW5Db2RlKHt9KVxuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICdsb2FkaW5nJyB9KVxuICAgIGNvbnN0IHQgPSBhd2FpdCBhcGkuZ2V0VGVybWluYWwoc2NhblJlc3VsdC5yZXN1bHQpXG4gICAgaWYgKHQuZGF0YSkge1xuICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICdlcnJvcicsXG4gICAgICAgIGNvbnRlbnQ6IGAke3NjYW5SZXN1bHQucmVzdWx0feW3suiiq2R0dToke3QuZGF0YS5EZXZNYWN9IOe7keWummBcbiAgICAgIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBhcGkuZ2V0UmVnaXN0ZXJEZXYoc2NhblJlc3VsdC5yZXN1bHQpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmIChkYXRhKSB7XG4gICAgICBjb25zdCB7IGNvbmZpcm0gfSA9IGF3YWl0IHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn56Gu6K6k57uR5a6a5L+h5oGvJyxcbiAgICAgICAgY29udGVudDogYOexu+Weizoke2RhdGEuVHlwZX1cXG4g6K6+5aSHOiR7ZGF0YS5tb3VudERldn1cXG4g5Y2P6K6uOiR7ZGF0YS5wcm90b2NvbH1cXG4g5Zyw5Z2AOiR7ZGF0YS5waWR9YFxuICAgICAgfSlcbiAgICAgIGlmIChjb25maXJtKSB7XG4gICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmraPlnKjnu5Hlrprorr7lpIcnIH0pXG4gICAgICAgIGNvbnN0IHIgPSBhd2FpdCBhcGkuYWRkVGVybWluYWxNb3VudERldih0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCB7IG1vdW50RGV2OiBkYXRhLm1vdW50RGV2LCBUeXBlOiBkYXRhLlR5cGUsIHByb3RvY29sOiBkYXRhLnByb3RvY29sLCBwaWQ6IGRhdGEucGlkLCBiaW5kRGV2OiBzY2FuUmVzdWx0LnJlc3VsdCB9KVxuICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIGlmIChyLmNvZGUpIHtcbiAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgdGl0bGU6ICforr7lpIfnu5HlrprmiJDlip8nXG4gICAgICAgICAgfSlcbiAgICAgICAgICB0aGlzLnNjYW5SZXF1c3QoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn5rWB56iL5Ye66ZSZJyxcbiAgICAgICAgY29udGVudDogYCR7c2NhblJlc3VsdC5yZXN1bHR95pyq5rOo5YaMLOivt+WFiOazqOWGjOWQjue7keWummBcbiAgICAgIH0pXG4gICAgfVxuXG4gIH0sXG5cbiAgLy8g5p+l55yL6K6+5aSH5pWw5o2uXG4gIHNlZShldmVudDogdmFudEV2ZW50PFVhcnQuVGVybWluYWxNb3VudERldnM+KSB7XG4gICAgY29uc3QgeyBwaWQsIG1vdW50RGV2LCBwcm90b2NvbCwgVHlwZSB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9hZG1pbi9kZXZzL2RldnMnICsgT2JqZWN0VG9TdHJxdWVyeSh7IHBpZDogU3RyaW5nKHBpZCksIG1vdW50RGV2LCBwcm90b2NvbCwgRGV2TWFjOiB0aGlzLmRhdGEubWFjLCBUeXBlIH0pXG4gICAgfSlcbiAgfSxcblxuICAvLyDliKDpmaTnu5Hlrprorr7lpIdcbiAgYXN5bmMgcm1CaW5kKGU6IHZhbnRFdmVudDxVYXJ0LnJlZ2lzdGVyRGV2Pikge1xuICAgIGNvbnN0IGl0ZW0gPSBlLmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3QgeyBjb25maXJtIH0gPSBhd2FpdCB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6ICfliKDpmaTnu5Hlrprorr7lpIcnLFxuICAgICAgY29udGVudDogYOehruWumuWIoOmZpCAke2l0ZW0ubW91bnREZXZ9ID8/P2BcbiAgICB9KVxuICAgIGlmIChjb25maXJtKSB7XG4gICAgICBhcGkuZGVsVGVybWluYWxNb3VudERldih0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCBpdGVtLnBpZCkudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuc2NhblJlcXVzdCgpXG4gICAgICB9KVxuICAgIH1cblxuXG4gIH0sXG4gIC8v6L+c56iL6LCD6K+V6K6+5aSHXG4gIGFzeW5jIGlvdFJlbW90ZVVybCgpIHtcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5pb3RSZW1vdGVVcmwodGhpcy5kYXRhLm1hYylcbiAgICBpZiAoIWNvZGUpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn6I635Y+W5aSx6LSlJyxcbiAgICAgICAgY29udGVudDogJ+iuvuWkh+acque7keWumuWIsElPVOi0puWPtydcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghL3JlbW90ZV9jb2RlPSQvLnRlc3QoZGF0YSkpIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+iwg+ivleWcsOWdgCcsXG4gICAgICAgICAgY29udGVudDogZGF0YSxcbiAgICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgICAgd3guc2V0Q2xpcGJvYXJkRGF0YSh7XG4gICAgICAgICAgICAgIGRhdGEsXG4gICAgICAgICAgICAgIHN1Y2Nlc3MoKSB7XG4gICAgICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgICAgIHRpdGxlOiAn5bey5aSN5Yi2572R5Z2A5Yiw5Ymq5YiH5p2/J1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgICB0aXRsZTogJ+iOt+WPluWksei0pScsXG4gICAgICAgICAgY29udGVudDogJ+iuvuWkh+acqui/nuaOpeWIsGlvdCBzZXJ2ZXLkuK3lv4MnXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICB9XG59KSJdfQ==