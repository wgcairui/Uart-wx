"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_1 = require("../../utils/api");
Page({
    data: {
        active: 0,
        userInfo: {
            avatarUrl: "https://www.ladishb.com/upload/11122020__LADS108.png",
        },
        tel: '',
        registerloading: false,
        loginloading: false,
        openid: '',
        unionid: '',
        accontUser: '',
        accontPasswd: ''
    },
    onLoad(opt) {
        this.setData({
            openid: opt.openid,
            unionid: opt.unionid
        });
    },
    async getUserInfo() {
        const s = await wx.getUserProfile({
            desc: '用于注册小程序'
        });
        if (s.userInfo) {
            this.setData({
                userInfo: s.userInfo
            });
        }
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: event.detail.title });
    },
    async getphonenumber(e) {
        if (!e.detail.encryptedData)
            return;
        wx.showLoading({ title: '获取手机号' });
        const { data } = await api_1.default.getphonenumber({ openid: this.data.openid, encryptedData: e.detail.encryptedData, iv: e.detail.iv });
        const tel = data.phoneNumber;
        this.setData({
            tel,
            "userInfo.nickName": this.data.userInfo.nickName || 'user' + tel.slice(-4)
        });
        wx.hideLoading();
    },
    async register() {
        const tel = this.data.tel;
        if (!tel || !/^(0|86|17951)?(13[0-9]|15[012356789]|166|17[3678]|18[0-9]|14[57])[0-9]{8}$/.test(tel.toString())) {
            wx.showToast({ title: "需要手机号码", icon: "error" });
            return;
        }
        this.setData({ registerloading: true });
        const { userInfo: { nickName, avatarUrl }, unionid, openid } = this.data;
        const { code, msg } = await api_1.default.registerUser({ user: unionid, openid, name: nickName, avanter: avatarUrl || 'http://www.ladishb.com/upload/11122020__LADS108.png', tel });
        this.setData({ registerloading: false });
        if (!code) {
            wx.showModal({ title: msg, icon: "none", duration: 5000 });
        }
        else {
            wx.reLaunch({ url: '/pages/index/index' });
        }
    },
    async login() {
        const { accontUser, accontPasswd, openid, unionid } = this.data;
        this.setData({ loginloading: true });
        const { code, msg } = await api_1.default.userlogin({ avanter: this.data.userInfo.avatarUrl, openid, unionid, user: accontUser, passwd: accontPasswd });
        this.setData({ loginloading: false });
        if (code) {
            wx.reLaunch({ url: '/pages/index/index' });
        }
        else {
            wx.showModal({
                title: '登录错误',
                content: msg,
                success: () => {
                    this.setData({
                        active: 0
                    });
                }
            });
        }
    },
    trial() {
        this.setData({
            accontPasswd: '123456',
            accontUser: 'test'
        });
        this.login();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsb2dpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHlDQUFrQztBQUNsQyxJQUFJLENBQUM7SUFJSCxJQUFJLEVBQUU7UUFDSixNQUFNLEVBQUUsQ0FBQztRQUVULFFBQVEsRUFBRTtZQUNSLFNBQVMsRUFBRSxzREFBc0Q7U0FDcEM7UUFDL0IsR0FBRyxFQUFFLEVBQUU7UUFDUCxlQUFlLEVBQUUsS0FBSztRQUN0QixZQUFZLEVBQUUsS0FBSztRQUNuQixNQUFNLEVBQUUsRUFBRTtRQUNWLE9BQU8sRUFBRSxFQUFFO1FBQ1gsVUFBVSxFQUFFLEVBQUU7UUFDZCxZQUFZLEVBQUUsRUFBRTtLQUNqQjtJQUNELE1BQU0sQ0FBQyxHQUF3QztRQUM3QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztTQUNyQixDQUFDLENBQUE7SUFDSixDQUFDO0lBS0QsS0FBSyxDQUFDLFdBQVc7UUFDZixNQUFNLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFDaEMsSUFBSSxFQUFFLFNBQVM7U0FDaEIsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ2QsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVE7YUFDckIsQ0FBQyxDQUFBO1NBRUg7SUFDSCxDQUFDO0lBQ0QsUUFBUSxDQUFDLEtBQWdCO1FBQ3ZCLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUE7SUFDekQsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBWTtRQUMvQixJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhO1lBQUUsT0FBTTtR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LENBQUMsRUFBRSxHQUFHLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyxDQUFBO1NBQzNDO2FBQU07WUFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNYLEtBQUssRUFBRSxNQUFNO2dCQUNiLE9BQU8sRUFBRSxHQUFHO2dCQUNaLE9BQU8sRUFBRSxHQUFHLEVBQUU7b0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxNQUFNLEVBQUUsQ0FBQztxQkFDVixDQUFDLENBQUE7Z0JBQ0osQ0FBQzthQUNGLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztJQUVELEtBQUs7UUFDSCxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsWUFBWSxFQUFFLFFBQVE7WUFDdEIsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFBO0lBQ2QsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhcGkgZnJvbSBcIi4uLy4uL3V0aWxzL2FwaVwiO1xuUGFnZSh7XG4gIC8qKlxuICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICovXG4gIGRhdGE6IHtcbiAgICBhY3RpdmU6IDAsXG4gICAgLy8gaW1nOlwiaHR0cHM6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzV5MndZV2tsRTB1c2dZRzBWd0xUZFJuYy5wbmdcIixcbiAgICB1c2VySW5mbzoge1xuICAgICAgYXZhdGFyVXJsOiBcImh0dHBzOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC8xMTEyMjAyMF9fTEFEUzEwOC5wbmdcIixcbiAgICB9IGFzIFdlY2hhdE1pbmlwcm9ncmFtLlVzZXJJbmZvLFxuICAgIHRlbDogJycsXG4gICAgcmVnaXN0ZXJsb2FkaW5nOiBmYWxzZSxcbiAgICBsb2dpbmxvYWRpbmc6IGZhbHNlLFxuICAgIG9wZW5pZDogJycsXG4gICAgdW5pb25pZDogJycsXG4gICAgYWNjb250VXNlcjogJycsXG4gICAgYWNjb250UGFzc3dkOiAnJ1xuICB9LFxuICBvbkxvYWQob3B0OiB7IG9wZW5pZDogc3RyaW5nOyB1bmlvbmlkOiBzdHJpbmcgfSkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBvcGVuaWQ6IG9wdC5vcGVuaWQsXG4gICAgICB1bmlvbmlkOiBvcHQudW5pb25pZFxuICAgIH0pXG4gIH0sXG5cbiAgLyoqXG4gICAqIOiOt+WPlueUqOaIt+S/oeaBr1xuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckluZm8oKSB7XG4gICAgY29uc3QgcyA9IGF3YWl0IHd4LmdldFVzZXJQcm9maWxlKHtcbiAgICAgIGRlc2M6ICfnlKjkuo7ms6jlhozlsI/nqIvluo8nXG4gICAgfSlcbiAgICBpZiAocy51c2VySW5mbykge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgdXNlckluZm86IHMudXNlckluZm9cbiAgICAgIH0pXG5cbiAgICB9XG4gIH0sXG4gIHRhYmNsaWNrKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogZXZlbnQuZGV0YWlsLnRpdGxlIH0pXG4gIH0sXG4gIC8vIOiOt+WPlueUqOaIt+aJi+acuuWPt+eggVxuICBhc3luYyBnZXRwaG9uZW51bWJlcihlOiB2YW50RXZlbnQpIHtcbiAgICBpZiAoIWUuZGV0YWlsLmVuY3J5cHRlZERhdGEpIHJldHVyblxuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bmiYvmnLrlj7cnIH0pXG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBhcGkuZ2V0cGhvbmVudW1iZXIoeyBvcGVuaWQ6IHRoaXMuZGF0YS5vcGVuaWQsIGVuY3J5cHRlZERhdGE6IGUuZGV0YWlsLmVuY3J5cHRlZERhdGEsIGl2OiBlLmRldGFpbC5pdiB9KVxuICAgIGNvbnN0IHRlbCA9IGRhdGEucGhvbmVOdW1iZXJcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgdGVsLFxuICAgICAgXCJ1c2VySW5mby5uaWNrTmFtZVwiOiB0aGlzLmRhdGEudXNlckluZm8ubmlja05hbWUgfHwgJ3VzZXInICsgdGVsLnNsaWNlKC00KVxuICAgIH0pXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuXG4gIH0sXG4gIC8vIOazqOWGjOeUqOaIt1xuICBhc3luYyByZWdpc3RlcigpIHtcbiAgICAvLyBhd2FpdCB0aGlzLmdldFVzZXJJbmZvKClcbiAgICBjb25zdCB0ZWwgPSB0aGlzLmRhdGEudGVsXG4gICAgaWYgKCF0ZWwgfHwgIS9eKDB8ODZ8MTc5NTEpPygxM1swLTldfDE1WzAxMjM1Njc4OV18MTY2fDE3WzM2NzhdfDE4WzAtOV18MTRbNTddKVswLTldezh9JC8udGVzdCh0ZWwudG9TdHJpbmcoKSkpIHtcbiAgICAgIHd4LnNob3dUb2FzdCh7IHRpdGxlOiBcIumcgOimgeaJi+acuuWPt+eggVwiLCBpY29uOiBcImVycm9yXCIgfSlcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICAvLyBhd2FpdCBTdWJzY3JpYmVNZXNzYWdlKFsn5rOo5YaM5oiQ5Yqf5o+Q6YaSJ10pXG4gICAgdGhpcy5zZXREYXRhKHsgcmVnaXN0ZXJsb2FkaW5nOiB0cnVlIH0pXG4gICAgY29uc3QgeyB1c2VySW5mbzogeyBuaWNrTmFtZSwgYXZhdGFyVXJsIH0sIHVuaW9uaWQsIG9wZW5pZCB9ID0gdGhpcy5kYXRhXG4gICAgY29uc3QgeyBjb2RlLCBtc2cgfSA9IGF3YWl0IGFwaS5yZWdpc3RlclVzZXIoeyB1c2VyOiB1bmlvbmlkLCBvcGVuaWQsIG5hbWU6IG5pY2tOYW1lLCBhdmFudGVyOiBhdmF0YXJVcmwgfHwgJ2h0dHA6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzExMTIyMDIwX19MQURTMTA4LnBuZycsIHRlbCB9KVxuICAgIHRoaXMuc2V0RGF0YSh7IHJlZ2lzdGVybG9hZGluZzogZmFsc2UgfSlcbiAgICBpZiAoIWNvZGUpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7IHRpdGxlOiBtc2csIGljb246IFwibm9uZVwiLCBkdXJhdGlvbjogNTAwMCB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5yZUxhdW5jaCh7IHVybDogJy9wYWdlcy9pbmRleC9pbmRleCcgfSlcbiAgICB9XG5cbiAgfSxcbiAgLy8g55m75b2VXG4gIGFzeW5jIGxvZ2luKCkge1xuICAgIC8vYXdhaXQgU3Vic2NyaWJlTWVzc2FnZShbJ+iuvuWkh+WRiuitpuaPkOmGkiddKVxuICAgIGNvbnN0IHsgYWNjb250VXNlciwgYWNjb250UGFzc3dkLCBvcGVuaWQsIHVuaW9uaWQgfSA9IHRoaXMuZGF0YVxuICAgIHRoaXMuc2V0RGF0YSh7IGxvZ2lubG9hZGluZzogdHJ1ZSB9KVxuICAgIGNvbnN0IHsgY29kZSwgbXNnIH0gPSBhd2FpdCBhcGkudXNlcmxvZ2luKHsgYXZhbnRlcjogdGhpcy5kYXRhLnVzZXJJbmZvLmF2YXRhclVybCwgb3BlbmlkLCB1bmlvbmlkLCB1c2VyOiBhY2NvbnRVc2VyLCBwYXNzd2Q6IGFjY29udFBhc3N3ZCB9KVxuICAgIHRoaXMuc2V0RGF0YSh7IGxvZ2lubG9hZGluZzogZmFsc2UgfSlcbiAgICBpZiAoY29kZSkge1xuICAgICAgd3gucmVMYXVuY2goeyB1cmw6ICcvcGFnZXMvaW5kZXgvaW5kZXgnIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn55m75b2V6ZSZ6K+vJyxcbiAgICAgICAgY29udGVudDogbXNnLFxuICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIGFjdGl2ZTogMFxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9XG4gICxcbiAgdHJpYWwoKSB7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFjY29udFBhc3N3ZDogJzEyMzQ1NicsXG4gICAgICBhY2NvbnRVc2VyOiAndGVzdCdcbiAgICB9KVxuICAgIHRoaXMubG9naW4oKVxuICB9XG59KVxuIl19