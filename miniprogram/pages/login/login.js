"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_1 = require("../../utils/api");
Page({
    data: {
        active: 0,
        userInfo: {
            avatarUrl: "https://www.ladishb.com/upload/5y2wYWklE0usgYG0VwLTdRnc.png",
        },
        tel: '',
        registerloading: false,
        loginloading: false,
        openid: '',
        unionid: '',
        accontUser: '',
        accontPasswd: ''
    },
    onLoad(opt) {
        this.setData({
            openid: opt.openid,
            unionid: opt.unionid
        });
    },
    async getUserInfo() {
        const s = await wx.getUserProfile({
            desc: '用于注册小程序'
        });
        if (s.userInfo) {
            this.setData({
                userInfo: s.userInfo
            });
        }
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: event.detail.title });
    },
    async getphonenumber(e) {
        if (!e.detail.encryptedData)
            return;
        wx.showLoading({ title: '获取手机号' });
        const { data } = await api_1.default.getphonenumber({ openid: this.data.openid, encryptedData: e.detail.encryptedData, iv: e.detail.iv });
        const tel = data.phoneNumber;
        this.setData({
            tel,
            "userInfo.nickName": this.data.userInfo.nickName || 'user' + tel.slice(-4)
        });
        wx.hideLoading();
    },
    async register() {
        const tel = this.data.tel;
        if (!tel || !/^(0|86|17951)?(13[0-9]|15[012356789]|166|17[3678]|18[0-9]|14[57])[0-9]{8}$/.test(tel.toString())) {
            wx.showToast({ title: "需要手机号码", icon: "error" });
            return;
        }
        this.setData({ registerloading: true });
        const { userInfo: { nickName, avatarUrl }, unionid, openid } = this.data;
        const { code, msg } = await api_1.default.registerUser({ user: unionid, openid, name: nickName, avanter: avatarUrl || 'http://www.ladishb.com/upload/11122020__LADS108.png', tel });
        this.setData({ registerloading: false });
        if (!code) {
            wx.showModal({ title: msg, icon: "none", duration: 5000 });
        }
        else {
            wx.reLaunch({ url: '/pages/index/index' });
        }
    },
    async login() {
        const { accontUser, accontPasswd, openid, unionid } = this.data;
        this.setData({ loginloading: true });
        const { code, msg } = await api_1.default.userlogin({ avanter: this.data.userInfo.avatarUrl, openid, unionid, user: accontUser, passwd: accontPasswd });
        this.setData({ loginloading: false });
        if (code) {
            wx.reLaunch({ url: '/pages/index/index' });
        }
        else {
            wx.showModal({
                title: '登录错误',
                content: msg,
                success: () => {
                    this.setData({
                        active: 0
                    });
                }
            });
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibG9naW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsb2dpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLHlDQUFrQztBQUNsQyxJQUFJLENBQUM7SUFJSCxJQUFJLEVBQUU7UUFDSixNQUFNLEVBQUUsQ0FBQztRQUVULFFBQVEsRUFBRTtZQUNSLFNBQVMsRUFBRSw2REFBNkQ7U0FDM0M7UUFDL0IsR0FBRyxFQUFFLEVBQUU7UUFDUCxlQUFlLEVBQUUsS0FBSztRQUN0QixZQUFZLEVBQUUsS0FBSztRQUNuQixNQUFNLEVBQUUsRUFBRTtRQUNWLE9BQU8sRUFBRSxFQUFFO1FBQ1gsVUFBVSxFQUFFLEVBQUU7UUFDZCxZQUFZLEVBQUUsRUFBRTtLQUNqQjtJQUNELE1BQU0sQ0FBQyxHQUF3QztRQUM3QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsTUFBTSxFQUFFLEdBQUcsQ0FBQyxNQUFNO1lBQ2xCLE9BQU8sRUFBRSxHQUFHLENBQUMsT0FBTztTQUNyQixDQUFDLENBQUE7SUFDSixDQUFDO0lBS0QsS0FBSyxDQUFDLFdBQVc7UUFDZixNQUFNLENBQUMsR0FBRyxNQUFNLEVBQUUsQ0FBQyxjQUFjLENBQUM7WUFDaEMsSUFBSSxFQUFFLFNBQVM7U0FDaEIsQ0FBQyxDQUFBO1FBQ0YsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFO1lBQ2QsSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxRQUFRLEVBQUUsQ0FBQyxDQUFDLFFBQVE7YUFDckIsQ0FBQyxDQUFBO1NBRUg7SUFDSCxDQUFDO0lBQ0QsUUFBUSxDQUFDLEtBQWdCO1FBQ3ZCLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUE7SUFDekQsQ0FBQztJQUVELEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBWTtRQUMvQixJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxhQUFhO1lBQUUsT0FBTTtR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LENBQUMsRUFBRSxHQUFHLEVBQUUsb0JBQW9CLEVBQUUsQ0FBQyxDQUFBO1NBQzNDO2FBQU07WUFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNYLEtBQUssRUFBRSxNQUFNO2dCQUNiLE9BQU8sRUFBRSxHQUFHO2dCQUNaLE9BQU8sRUFBRSxHQUFHLEVBQUU7b0JBQ1osSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxNQUFNLEVBQUUsQ0FBQztxQkFDVixDQUFDLENBQUE7Z0JBQ0osQ0FBQzthQUNGLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmliZU1lc3NhZ2UgfSBmcm9tIFwiLi4vLi4vdXRpbHMvdXRpbFwiO1xuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vdXRpbHMvYXBpXCI7XG5QYWdlKHtcbiAgLyoqXG4gICAqIOmhtemdoueahOWIneWni+aVsOaNrlxuICAgKi9cbiAgZGF0YToge1xuICAgIGFjdGl2ZTogMCxcbiAgICAvLyBpbWc6XCJodHRwczovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvNXkyd1lXa2xFMHVzZ1lHMFZ3TFRkUm5jLnBuZ1wiLFxuICAgIHVzZXJJbmZvOiB7XG4gICAgICBhdmF0YXJVcmw6IFwiaHR0cHM6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzV5MndZV2tsRTB1c2dZRzBWd0xUZFJuYy5wbmdcIixcbiAgICB9IGFzIFdlY2hhdE1pbmlwcm9ncmFtLlVzZXJJbmZvLFxuICAgIHRlbDogJycsXG4gICAgcmVnaXN0ZXJsb2FkaW5nOiBmYWxzZSxcbiAgICBsb2dpbmxvYWRpbmc6IGZhbHNlLFxuICAgIG9wZW5pZDogJycsXG4gICAgdW5pb25pZDogJycsXG4gICAgYWNjb250VXNlcjogJycsXG4gICAgYWNjb250UGFzc3dkOiAnJ1xuICB9LFxuICBvbkxvYWQob3B0OiB7IG9wZW5pZDogc3RyaW5nOyB1bmlvbmlkOiBzdHJpbmcgfSkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBvcGVuaWQ6IG9wdC5vcGVuaWQsXG4gICAgICB1bmlvbmlkOiBvcHQudW5pb25pZFxuICAgIH0pXG4gIH0sXG5cbiAgLyoqXG4gICAqIOiOt+WPlueUqOaIt+S/oeaBr1xuICAgKi9cbiAgYXN5bmMgZ2V0VXNlckluZm8oKSB7XG4gICAgY29uc3QgcyA9IGF3YWl0IHd4LmdldFVzZXJQcm9maWxlKHtcbiAgICAgIGRlc2M6ICfnlKjkuo7ms6jlhozlsI/nqIvluo8nXG4gICAgfSlcbiAgICBpZiAocy51c2VySW5mbykge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgdXNlckluZm86IHMudXNlckluZm9cbiAgICAgIH0pXG5cbiAgICB9XG4gIH0sXG4gIHRhYmNsaWNrKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogZXZlbnQuZGV0YWlsLnRpdGxlIH0pXG4gIH0sXG4gIC8vIOiOt+WPlueUqOaIt+aJi+acuuWPt+eggVxuICBhc3luYyBnZXRwaG9uZW51bWJlcihlOiB2YW50RXZlbnQpIHtcbiAgICBpZiAoIWUuZGV0YWlsLmVuY3J5cHRlZERhdGEpIHJldHVyblxuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bmiYvmnLrlj7cnIH0pXG4gICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCBhcGkuZ2V0cGhvbmVudW1iZXIoeyBvcGVuaWQ6IHRoaXMuZGF0YS5vcGVuaWQsIGVuY3J5cHRlZERhdGE6IGUuZGV0YWlsLmVuY3J5cHRlZERhdGEsIGl2OiBlLmRldGFpbC5pdiB9KVxuICAgIGNvbnN0IHRlbCA9IGRhdGEucGhvbmVOdW1iZXJcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgdGVsLFxuICAgICAgXCJ1c2VySW5mby5uaWNrTmFtZVwiOiB0aGlzLmRhdGEudXNlckluZm8ubmlja05hbWUgfHwgJ3VzZXInICsgdGVsLnNsaWNlKC00KVxuICAgIH0pXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICB9LFxuICAvLyDms6jlhoznlKjmiLdcbiAgYXN5bmMgcmVnaXN0ZXIoKSB7XG4gICAgLy8gYXdhaXQgdGhpcy5nZXRVc2VySW5mbygpXG4gICAgY29uc3QgdGVsID0gdGhpcy5kYXRhLnRlbFxuICAgIGlmICghdGVsIHx8ICEvXigwfDg2fDE3OTUxKT8oMTNbMC05XXwxNVswMTIzNTY3ODldfDE2NnwxN1szNjc4XXwxOFswLTldfDE0WzU3XSlbMC05XXs4fSQvLnRlc3QodGVsLnRvU3RyaW5nKCkpKSB7XG4gICAgICB3eC5zaG93VG9hc3QoeyB0aXRsZTogXCLpnIDopoHmiYvmnLrlj7fnoIFcIiwgaWNvbjogXCJlcnJvclwiIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgLy8gYXdhaXQgU3Vic2NyaWJlTWVzc2FnZShbJ+azqOWGjOaIkOWKn+aPkOmGkiddKVxuICAgIHRoaXMuc2V0RGF0YSh7IHJlZ2lzdGVybG9hZGluZzogdHJ1ZSB9KVxuICAgIGNvbnN0IHsgdXNlckluZm86IHsgbmlja05hbWUsIGF2YXRhclVybCB9LCB1bmlvbmlkLCBvcGVuaWQgfSA9IHRoaXMuZGF0YVxuICAgIGNvbnN0IHsgY29kZSwgbXNnIH0gPSBhd2FpdCBhcGkucmVnaXN0ZXJVc2VyKHsgdXNlcjogdW5pb25pZCwgb3BlbmlkLCBuYW1lOiBuaWNrTmFtZSwgYXZhbnRlcjogYXZhdGFyVXJsIHx8ICdodHRwOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC8xMTEyMjAyMF9fTEFEUzEwOC5wbmcnLCB0ZWwgfSlcbiAgICB0aGlzLnNldERhdGEoeyByZWdpc3RlcmxvYWRpbmc6IGZhbHNlIH0pXG4gICAgaWYgKCFjb2RlKSB7XG4gICAgICB3eC5zaG93TW9kYWwoeyB0aXRsZTogbXNnLCBpY29uOiBcIm5vbmVcIiwgZHVyYXRpb246IDUwMDAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgd3gucmVMYXVuY2goeyB1cmw6ICcvcGFnZXMvaW5kZXgvaW5kZXgnIH0pXG4gICAgfVxuXG4gIH0sXG4gIC8vIOeZu+W9lVxuICBhc3luYyBsb2dpbigpIHtcbiAgICAvL2F3YWl0IFN1YnNjcmliZU1lc3NhZ2UoWyforr7lpIflkYrorabmj5DphpInXSlcbiAgICBjb25zdCB7IGFjY29udFVzZXIsIGFjY29udFBhc3N3ZCwgb3BlbmlkLCB1bmlvbmlkIH0gPSB0aGlzLmRhdGFcbiAgICB0aGlzLnNldERhdGEoeyBsb2dpbmxvYWRpbmc6IHRydWUgfSlcbiAgICBjb25zdCB7IGNvZGUsIG1zZyB9ID0gYXdhaXQgYXBpLnVzZXJsb2dpbih7IGF2YW50ZXI6IHRoaXMuZGF0YS51c2VySW5mby5hdmF0YXJVcmwsIG9wZW5pZCwgdW5pb25pZCwgdXNlcjogYWNjb250VXNlciwgcGFzc3dkOiBhY2NvbnRQYXNzd2QgfSlcbiAgICB0aGlzLnNldERhdGEoeyBsb2dpbmxvYWRpbmc6IGZhbHNlIH0pXG4gICAgaWYgKGNvZGUpIHtcbiAgICAgIHd4LnJlTGF1bmNoKHsgdXJsOiAnL3BhZ2VzL2luZGV4L2luZGV4JyB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ+eZu+W9lemUmeivrycsXG4gICAgICAgIGNvbnRlbnQ6IG1zZyxcbiAgICAgICAgc3VjY2VzczogKCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBhY3RpdmU6IDBcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgfVxufSlcbiJdfQ==