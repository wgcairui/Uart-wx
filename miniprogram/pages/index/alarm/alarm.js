"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        subMessageStat: false,
        Alarm: [],
        filter: '',
        date: '',
        dateShow: false,
        minDate: new Date(2020, 0, 1).getTime(),
        maxDate: Date.now()
    },
    onLoad: async function () {
        const date = new Date();
        const start = this.formatDate(date);
        const end = this.formatDate(date);
        this.setData({
            date: start + '-' + end
        });
        wx.getStorage({
            key: 'alarm_list',
            success: (el) => {
                this.setData({
                    Alarm: el.data
                });
                wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
            },
            fail: () => {
                this.getAlarmInfo();
            }
        });
        const { subscriptionsSetting } = await wx.getSetting({
            withSubscriptions: true
        });
        this.setData({
            subMessageStat: Boolean(subscriptionsSetting?.itemSettings?.['8NX6ji8ABlNAOEMcU7v2jtD4sgCB7NMHguWzxZn3HO4'] === 'accept')
        });
    },
    async subMessage() {
        if (!this.data.subMessageStat) {
            const res = await util_1.SubscribeMessage(['设备告警提醒']);
            this.setData({
                subMessageStat: res['8NX6ji8ABlNAOEMcU7v2jtD4sgCB7NMHguWzxZn3HO4'] === 'accept'
            });
        }
    },
    async getAlarmInfo() {
        wx.showLoading({ title: '加载数据' });
        const [start, end] = this.data.date.split('-');
        const { ok, msg, arg } = await api_1.default.getAlarm(start + ' 00:00:00', end + " 23:59:59");
        wx.hideLoading();
        if (ok) {
            const Alarm = arg.map(el => {
                el.time = this.formattime(el.timeStamp);
                return el;
            });
            this.setData({
                Alarm
            });
            const alarmNum = Alarm.filter(el => !el.isOk).length;
            if (alarmNum > 0)
                wx.setTabBarBadge({ index: 1, text: alarmNum.toString() });
            else
                wx.removeTabBarBadge({ index: 1 });
            wx.setStorage({ key: 'alarm_list', data: Alarm });
        }
        else {
            wx.showModal({
                title: '发生错误',
                content: msg || '未知错误'
            });
        }
    },
    showCalendar() {
        this.setData({
            dateShow: true
        });
    },
    onClose() {
        this.setData({ dateShow: false });
    },
    formatDate(date) {
        date = new Date(date);
        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    },
    onConfirm(event) {
        const [start, end] = event.detail;
        this.setData({
            dateShow: false,
            date: `${this.formatDate(start)} - ${this.formatDate(end)}`,
        });
        this.getAlarmInfo();
    },
    showalarm(event) {
        const alarm = event.currentTarget.dataset.item;
        const key = event.currentTarget.dataset.key;
        wx.showModal({
            title: alarm.devName,
            content: alarm.msg,
            showCancel: !alarm.isOk,
            confirmText: alarm.isOk ? '确定' : '确认消息',
            success: async (res) => {
                if (res.confirm && !alarm.isOk) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.alarmConfirmed(alarm._id);
                    this.setData({
                        [`Alarm[${key}].isOk`]: true
                    });
                    this.subMessage();
                    wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
                    wx.hideLoading();
                }
            }
        });
    },
    allQuest() {
        wx.showModal({
            title: "Tips",
            content: "是否确认全部告警信息?",
            success: async (res) => {
                if (res.confirm) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.alarmConfirmed();
                    wx.startPullDownRefresh();
                    wx.hideLoading();
                    this.subMessage();
                }
            }
        });
    },
    onShow() {
        wx.startPullDownRefresh();
    },
    async onPullDownRefresh() {
        await this.getAlarmInfo();
        wx.stopPullDownRefresh();
    },
    formattime(time) {
        const Dates = new Date(time);
        return `${Dates.getMonth() + 1}-${Dates.getDate()} ${Dates.getHours()}:${Dates.getMinutes()}:${Dates.getSeconds()}`;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhbGFybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDhDQUFzRDtBQUV0RCw0Q0FBb0M7QUFDcEMsSUFBSSxDQUFDO0lBS0gsSUFBSSxFQUFFO1FBQ0osY0FBYyxFQUFFLEtBQUs7UUFDckIsS0FBSyxFQUFFLEVBQXVCO1FBQzlCLE1BQU0sRUFBRSxFQUFFO1FBQ1YsSUFBSSxFQUFFLEVBQUU7UUFDUixRQUFRLEVBQUUsS0FBSztRQUNmLE9BQU8sRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRTtRQUN2QyxPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtLQUNwQjtJQUtELE1BQU0sRUFBRSxLQUFLO1FBQ1gsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQTtRQUN2QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25DLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLElBQUksRUFBRSxLQUFLLEdBQUcsR0FBRyxHQUFHLEdBQUc7U0FDeEIsQ0FBQyxDQUFBO1FBQ0YsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNaLEdBQUcsRUFBRSxZQUFZO1lBQ2pCLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFO2dCQUNkLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJO2lCQUNmLENBQUMsQ0FBQTtnQkFDRixFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQTtZQUNqRyxDQUFDO1lBQ0QsSUFBSSxFQUFFLEdBQUcsRUFBRTtnQkFDVCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7WUFDckIsQ0FBQztTQUNGLENBQUMsQ0FBQTtRQUVGLE1BQU0sRUFBRSxvQkFBb0IsRUFBRSxHQUFHLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNuRCxpQkFBaUIsRUFBRSxJQUFJO1NBQ3hCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxjQUFjLEVBQUUsT0FBTyxDQUFDLG9CQUFvQixFQUFFLFlBQVksRUFBRSxDQUFDLDZDQUE2QyxDQUFDLEtBQUssUUFBUSxDQUFDO1NBQzFILENBQUMsQ0FBQTtJQUNKLENBQUM7SUFJRCxLQUFLLENBQUMsVUFBVTtRQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUM3QixNQUFNLEdBQUcsR0FBRyxNQUFNLHVCQUFnQixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQTtZQUM5QyxJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLGNBQWMsRUFBRyxHQUFXLENBQUMsNkNBQTZDLENBQUMsS0FBSyxRQUFRO2FBQ3pGLENBQUMsQ0FBQTtTQUNIO0lBRUgsQ0FBQztJQUVELEtBQUssQ0FBQyxZQUFZO1FBQ2hCLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQTtRQUNqQyxNQUFNLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtRQUM5QyxNQUFNLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxNQUFNLGFBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLFdBQVcsRUFBRSxHQUFHLEdBQUcsV0FBVyxDQUFDLENBQUE7UUFDbkYsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQ2hCLElBQUksRUFBRSxFQUFFO1lBQ04sTUFBTSxLQUFLLEdBQUcsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRTtnQkFDekIsRUFBRSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtnQkFDdkMsT0FBTyxFQUFFLENBQUE7WUFDWCxDQUFDLENBQUMsQ0FBQTtZQUNGLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsS0FBSzthQUNOLENBQUMsQ0FBQTtZQUVGLE1BQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUE7WUFDcEQsSUFBSSxRQUFRLEdBQUcsQ0FBQztnQkFBRSxFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQTs7Z0JBQ3ZFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO1lBQ3ZDLEVBQUUsQ0FBQyxVQUFVLENBQUMsRUFBRSxHQUFHLEVBQUUsWUFBWSxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFBO1NBQ2xEO2FBQU07WUFDTCxFQUFFLENBQUMsU0FBUyxDQUFDO2dCQUNYLEtBQUssRUFBRSxNQUFNO2dCQUNiLE9BQU8sRUFBRSxHQUFHLElBQUksTUFBTTthQUN2QixDQUFDLENBQUE7U0FDSDtJQUNILENBQUM7SUFFRCxZQUFZO1FBQ1YsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLFFBQVEsRUFBRSxJQUFJO1NBQ2YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsUUFBUSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUNELFVBQVUsQ0FBQyxJQUFVO1FBQ25CLElBQUksR0FBRyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN0QixPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7SUFDMUUsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUFVO1FBQ2xCLE1BQU0sQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUNsQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsUUFBUSxFQUFFLEtBQUs7WUFDZixJQUFJLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7U0FDNUQsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFBO0lBQ3JCLENBQUM7SUFFRCxTQUFTLENBQUMsS0FBaUM7UUFDekMsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFBO1FBQzlDLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQWEsQ0FBQTtRQUNyRCxFQUFFLENBQUMsU0FBUyxDQUFDO1lBQ1gsS0FBSyxFQUFFLEtBQUssQ0FBQyxPQUFPO1lBQ3BCLE9BQU8sRUFBRSxLQUFLLENBQUMsR0FBRztZQUNsQixVQUFVLEVBQUUsQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUV2QixXQUFXLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxNQUFNO1lBQ3ZDLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0JBQ3JCLElBQUksR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUU7b0JBQzlCLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtvQkFDbkMsTUFBTSxhQUFHLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQTtvQkFDbkMsSUFBSSxDQUFDLE9BQU8sQ0FBQzt3QkFDWCxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsRUFBRSxJQUFJO3FCQUM3QixDQUFDLENBQUE7b0JBQ0YsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO29CQUNqQixFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQTtvQkFDL0YsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO2lCQUNqQjtZQUNILENBQUM7U0FDRixDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsUUFBUTtRQUNOLEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDWCxLQUFLLEVBQUUsTUFBTTtZQUNiLE9BQU8sRUFBRSxhQUFhO1lBQ3RCLE9BQU8sRUFBRSxLQUFLLEVBQUUsR0FBRyxFQUFFLEVBQUU7Z0JBQ3JCLElBQUksR0FBRyxDQUFDLE9BQU8sRUFBRTtvQkFDZixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUE7b0JBQ25DLE1BQU0sYUFBRyxDQUFDLGNBQWMsRUFBRSxDQUFBO29CQUMxQixFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtvQkFDekIsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO29CQUNoQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7aUJBQ2xCO1lBQ0gsQ0FBQztTQUNGLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxNQUFNO1FBQ0osRUFBRSxDQUFDLG9CQUFvQixFQUFFLENBQUE7SUFDM0IsQ0FBQztJQUVELEtBQUssQ0FBQyxpQkFBaUI7UUFDckIsTUFBTSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7UUFDekIsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUE7SUFDMUIsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFZO1FBQ3JCLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVCLE9BQU8sR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRSxJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFBO0lBQ3JILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJzY3JpYmVNZXNzYWdlIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuLy8gbWluaXByb2dyYW0vcGFnZXMvaW5kZXgvYWxhcm0vYWxhcm0uanNcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5QYWdlKHtcblxuICAvKipcbiAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXG4gICAqL1xuICBkYXRhOiB7XG4gICAgc3ViTWVzc2FnZVN0YXQ6IGZhbHNlLFxuICAgIEFsYXJtOiBbXSBhcyB1YXJ0QWxhcm1PYmplY3RbXSxcbiAgICBmaWx0ZXI6ICcnLFxuICAgIGRhdGU6ICcnLFxuICAgIGRhdGVTaG93OiBmYWxzZSxcbiAgICBtaW5EYXRlOiBuZXcgRGF0ZSgyMDIwLCAwLCAxKS5nZXRUaW1lKCksXG4gICAgbWF4RGF0ZTogRGF0ZS5ub3coKVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWKoOi9vVxuICAgKi9cbiAgb25Mb2FkOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKClcbiAgICBjb25zdCBzdGFydCA9IHRoaXMuZm9ybWF0RGF0ZShkYXRlKVxuICAgIGNvbnN0IGVuZCA9IHRoaXMuZm9ybWF0RGF0ZShkYXRlKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlOiBzdGFydCArICctJyArIGVuZFxuICAgIH0pXG4gICAgd3guZ2V0U3RvcmFnZSh7XG4gICAgICBrZXk6ICdhbGFybV9saXN0JyxcbiAgICAgIHN1Y2Nlc3M6IChlbCkgPT4ge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIEFsYXJtOiBlbC5kYXRhXG4gICAgICAgIH0pXG4gICAgICAgIHd4LnNldFRhYkJhckJhZGdlKHsgaW5kZXg6IDEsIHRleHQ6IHRoaXMuZGF0YS5BbGFybS5maWx0ZXIoZWwgPT4gIWVsLmlzT2spLmxlbmd0aC50b1N0cmluZygpIH0pXG4gICAgICB9LFxuICAgICAgZmFpbDogKCkgPT4ge1xuICAgICAgICB0aGlzLmdldEFsYXJtSW5mbygpXG4gICAgICB9XG4gICAgfSlcbiAgICAvL+ajgOafpeWRiuitpuiuoumYheeKtuaAgVxuICAgIGNvbnN0IHsgc3Vic2NyaXB0aW9uc1NldHRpbmcgfSA9IGF3YWl0IHd4LmdldFNldHRpbmcoe1xuICAgICAgd2l0aFN1YnNjcmlwdGlvbnM6IHRydWVcbiAgICB9KVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBzdWJNZXNzYWdlU3RhdDogQm9vbGVhbihzdWJzY3JpcHRpb25zU2V0dGluZz8uaXRlbVNldHRpbmdzPy5bJzhOWDZqaThBQmxOQU9FTWNVN3YyanRENHNnQ0I3Tk1IZ3VXenhabjNITzQnXSA9PT0gJ2FjY2VwdCcpXG4gICAgfSlcbiAgfSxcbiAgLyoqXG4gICAqIOiuoumYheS4i+asoeWRiuitplxuICAgKi9cbiAgYXN5bmMgc3ViTWVzc2FnZSgpIHtcbiAgICBpZiAoIXRoaXMuZGF0YS5zdWJNZXNzYWdlU3RhdCkge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgU3Vic2NyaWJlTWVzc2FnZShbJ+iuvuWkh+WRiuitpuaPkOmGkiddKVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgc3ViTWVzc2FnZVN0YXQ6IChyZXMgYXMgYW55KVsnOE5YNmppOEFCbE5BT0VNY1U3djJqdEQ0c2dDQjdOTUhndVd6eFpuM0hPNCddID09PSAnYWNjZXB0J1xuICAgICAgfSlcbiAgICB9XG5cbiAgfSxcbiAgLy8g6I635Y+W5ZGK6K2m5L+h5oGvXG4gIGFzeW5jIGdldEFsYXJtSW5mbygpIHtcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5Yqg6L295pWw5o2uJyB9KVxuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHRoaXMuZGF0YS5kYXRlLnNwbGl0KCctJylcbiAgICBjb25zdCB7IG9rLCBtc2csIGFyZyB9ID0gYXdhaXQgYXBpLmdldEFsYXJtKHN0YXJ0ICsgJyAwMDowMDowMCcsIGVuZCArIFwiIDIzOjU5OjU5XCIpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmIChvaykge1xuICAgICAgY29uc3QgQWxhcm0gPSBhcmcubWFwKGVsID0+IHtcbiAgICAgICAgZWwudGltZSA9IHRoaXMuZm9ybWF0dGltZShlbC50aW1lU3RhbXApXG4gICAgICAgIHJldHVybiBlbFxuICAgICAgfSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIEFsYXJtXG4gICAgICB9KVxuICAgICAgLy8g6K6h566X5pyq56Gu6K6k5ZGK6K2m5pWw6YePXG4gICAgICBjb25zdCBhbGFybU51bSA9IEFsYXJtLmZpbHRlcihlbCA9PiAhZWwuaXNPaykubGVuZ3RoXG4gICAgICBpZiAoYWxhcm1OdW0gPiAwKSB3eC5zZXRUYWJCYXJCYWRnZSh7IGluZGV4OiAxLCB0ZXh0OiBhbGFybU51bS50b1N0cmluZygpIH0pXG4gICAgICBlbHNlIHd4LnJlbW92ZVRhYkJhckJhZGdlKHsgaW5kZXg6IDEgfSlcbiAgICAgIHd4LnNldFN0b3JhZ2UoeyBrZXk6ICdhbGFybV9saXN0JywgZGF0YTogQWxhcm0gfSlcbiAgICB9IGVsc2Uge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICflj5HnlJ/plJnor68nLFxuICAgICAgICBjb250ZW50OiBtc2cgfHwgJ+acquefpemUmeivrydcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuICAvLyDmmL7npLrml6XmnJ/pgInmi6nlmahcbiAgc2hvd0NhbGVuZGFyKCkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlU2hvdzogdHJ1ZVxuICAgIH0pXG4gIH0sXG4gIC8vICDlhbPpl63ml6XmnJ/pgInmi6nlmahcbiAgb25DbG9zZSgpIHtcbiAgICB0aGlzLnNldERhdGEoeyBkYXRlU2hvdzogZmFsc2UgfSk7XG4gIH0sXG4gIGZvcm1hdERhdGUoZGF0ZTogRGF0ZSkge1xuICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICByZXR1cm4gYCR7ZGF0ZS5nZXRGdWxsWWVhcigpfS8ke2RhdGUuZ2V0TW9udGgoKSArIDF9LyR7ZGF0ZS5nZXREYXRlKCl9YDtcbiAgfSxcbiAgLy8g56Gu5a6a5pel5pyfXG4gIG9uQ29uZmlybShldmVudDogYW55KSB7XG4gICAgY29uc3QgW3N0YXJ0LCBlbmRdID0gZXZlbnQuZGV0YWlsO1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlU2hvdzogZmFsc2UsXG4gICAgICBkYXRlOiBgJHt0aGlzLmZvcm1hdERhdGUoc3RhcnQpfSAtICR7dGhpcy5mb3JtYXREYXRlKGVuZCl9YCxcbiAgICB9KTtcbiAgICB0aGlzLmdldEFsYXJtSW5mbygpXG4gIH0sXG4gIC8vIOehruiupOWRiuitpuS/oeaBr1xuICBzaG93YWxhcm0oZXZlbnQ6IHZhbnRFdmVudDx1YXJ0QWxhcm1PYmplY3Q+KSB7XG4gICAgY29uc3QgYWxhcm0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IGtleSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5rZXkgYXMgbnVtYmVyXG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiBhbGFybS5kZXZOYW1lLFxuICAgICAgY29udGVudDogYWxhcm0ubXNnLFxuICAgICAgc2hvd0NhbmNlbDogIWFsYXJtLmlzT2ssXG4gICAgICAvLyBjb25maXJtQ29sb3I6ICdncmVlbicsXG4gICAgICBjb25maXJtVGV4dDogYWxhcm0uaXNPayA/ICfnoa7lrponIDogJ+ehruiupOa2iOaBrycsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSAmJiAhYWxhcm0uaXNPaykge1xuICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfnoa7orqTlkYrorabkv6Hmga8nIH0pXG4gICAgICAgICAgYXdhaXQgYXBpLmFsYXJtQ29uZmlybWVkKGFsYXJtLl9pZClcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgW2BBbGFybVske2tleX1dLmlzT2tgXTogdHJ1ZVxuICAgICAgICAgIH0pXG4gICAgICAgICAgdGhpcy5zdWJNZXNzYWdlKClcbiAgICAgICAgICB3eC5zZXRUYWJCYXJCYWRnZSh7IGluZGV4OiAxLCB0ZXh0OiB0aGlzLmRhdGEuQWxhcm0uZmlsdGVyKGVsID0+ICFlbC5pc09rKS5sZW5ndGgudG9TdHJpbmcoKSB9KVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOWFqOmDqOehruiupFxuICBhbGxRdWVzdCgpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IFwiVGlwc1wiLFxuICAgICAgY29udGVudDogXCLmmK/lkKbnoa7orqTlhajpg6jlkYrorabkv6Hmga8/XCIsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfnoa7orqTlkYrorabkv6Hmga8nIH0pXG4gICAgICAgICAgYXdhaXQgYXBpLmFsYXJtQ29uZmlybWVkKClcbiAgICAgICAgICB3eC5zdGFydFB1bGxEb3duUmVmcmVzaCgpXG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICAgIHRoaXMuc3ViTWVzc2FnZSgpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIG9uU2hvdygpIHtcbiAgICB3eC5zdGFydFB1bGxEb3duUmVmcmVzaCgpXG4gIH0sXG4gIC8vIOS4i+aLieWIt+aWsFxuICBhc3luYyBvblB1bGxEb3duUmVmcmVzaCgpIHtcbiAgICBhd2FpdCB0aGlzLmdldEFsYXJtSW5mbygpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH1cbiAgLFxuICBmb3JtYXR0aW1lKHRpbWU6IG51bWJlcikge1xuICAgIGNvbnN0IERhdGVzID0gbmV3IERhdGUodGltZSlcbiAgICByZXR1cm4gYCR7RGF0ZXMuZ2V0TW9udGgoKSArIDF9LSR7RGF0ZXMuZ2V0RGF0ZSgpfSAke0RhdGVzLmdldEhvdXJzKCl9OiR7RGF0ZXMuZ2V0TWludXRlcygpfToke0RhdGVzLmdldFNlY29uZHMoKX1gXG4gIH1cbn0pIl19