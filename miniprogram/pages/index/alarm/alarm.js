"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_1 = require("../../../utils/api");
Page({
    data: {
        Alarm: [],
        filter: '',
        date: '',
        dateShow: false,
        minDate: new Date(2020, 0, 1).getTime(),
        maxDate: Date.now()
    },
    onLoad: async function () {
        const date = new Date();
        const start = this.formatDate(date);
        const end = this.formatDate(date);
        this.setData({
            date: start + '-' + end
        });
        wx.getStorage({
            key: 'alarm_list',
            success: (el) => {
                this.setData({
                    Alarm: el.data
                });
                wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
            },
            fail: () => {
                this.getAlarmInfo();
            }
        });
    },
    async getAlarmInfo() {
        wx.showLoading({ title: '加载数据' });
        const [start, end] = this.data.date.split('-');
        const { ok, msg, arg } = await api_1.default.getAlarm(start + ' 00:00:00', end + " 23:59:59");
        wx.hideLoading();
        if (ok) {
            const Alarm = arg.map(el => {
                el.time = this.formattime(el.timeStamp);
                return el;
            });
            this.setData({
                Alarm
            });
            const alarmNum = Alarm.filter(el => !el.isOk).length;
            if (alarmNum > 0)
                wx.setTabBarBadge({ index: 1, text: alarmNum.toString() });
            else
                wx.removeTabBarBadge({ index: 1 });
            wx.setStorage({ key: 'alarm_list', data: Alarm });
        }
        else {
            wx.showModal({
                title: '发生错误',
                content: msg || '未知错误'
            });
        }
    },
    showCalendar() {
        this.setData({
            dateShow: true
        });
    },
    onClose() {
        this.setData({ dateShow: false });
    },
    formatDate(date) {
        date = new Date(date);
        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    },
    onConfirm(event) {
        const [start, end] = event.detail;
        this.setData({
            dateShow: false,
            date: `${this.formatDate(start)} - ${this.formatDate(end)}`,
        });
        this.getAlarmInfo();
    },
    showalarm(event) {
        const alarm = event.currentTarget.dataset.item;
        const key = event.currentTarget.dataset.key;
        wx.showModal({
            title: alarm.devName,
            content: alarm.msg,
            showCancel: !alarm.isOk,
            confirmText: alarm.isOk ? '确定' : '确认消息',
            success: async (res) => {
                if (res.confirm && !alarm.isOk) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.alarmConfirmed(alarm._id);
                    this.setData({
                        [`Alarm[${key}].isOk`]: true
                    });
                    wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
                    wx.hideLoading();
                }
            }
        });
    },
    allQuest() {
        wx.showModal({
            title: "Tips",
            content: "是否确认全部告警信息?",
            success: async (res) => {
                if (res.confirm) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.alarmConfirmed();
                    wx.startPullDownRefresh();
                    wx.hideLoading();
                }
            }
        });
    },
    onShow() {
        wx.startPullDownRefresh();
    },
    async onPullDownRefresh() {
        await this.getAlarmInfo();
        wx.stopPullDownRefresh();
    },
    formattime(time) {
        const Dates = new Date(time);
        return `${Dates.getMonth() + 1}-${Dates.getDate()} ${Dates.getHours()}:${Dates.getMinutes()}:${Dates.getSeconds()}`;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhbGFybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDRDQUFvQztBQUNwQyxJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsRUFBdUI7UUFDOUIsTUFBTSxFQUFFLEVBQUU7UUFDVixJQUFJLEVBQUUsRUFBRTtRQUNSLFFBQVEsRUFBRSxLQUFLO1FBQ2YsT0FBTyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFO1FBQ3ZDLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO0tBQ3BCO0lBS0QsTUFBTSxFQUFFLEtBQUs7UUFDWCxNQUFNLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFBO1FBQ3ZCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDbkMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsSUFBSSxFQUFFLEtBQUssR0FBRyxHQUFHLEdBQUcsR0FBRztTQUN4QixDQUFDLENBQUE7UUFDRixFQUFFLENBQUMsVUFBVSxDQUFDO1lBQ1osR0FBRyxFQUFFLFlBQVk7WUFDakIsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUU7Z0JBQ2QsSUFBSSxDQUFDLE9BQU8sQ0FBQztvQkFDWCxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUk7aUJBQ2YsQ0FBQyxDQUFBO2dCQUNGLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFN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Q0osQ0FBQztJQUVELFFBQVE7UUFDTixFQUFFLENBQUMsU0FBUyxDQUFDO1lBQ1gsS0FBSyxFQUFFLE1BQU07WUFDYixPQUFPLEVBQUUsYUFBYTtZQUN0QixPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO2dCQUNyQixJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7b0JBQ2YsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFBO29CQUNuQyxNQUFNLGFBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQTtvQkFDMUIsRUFBRSxDQUFDLG9CQUFvQixFQUFFLENBQUE7b0JBQ3pCLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQTtpQkFDakI7WUFDSCxDQUFDO1NBQ0YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELE1BQU07UUFDSixFQUFFLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtJQUMzQixDQUFDO0lBRUQsS0FBSyxDQUFDLGlCQUFpQjtRQUNyQixNQUFNLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUN6QixFQUFFLENBQUMsbUJBQW1CLEVBQUUsQ0FBQTtJQUMxQixDQUFDO0lBRUQsVUFBVSxDQUFDLElBQVk7UUFDckIsTUFBTSxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUIsT0FBTyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUE7SUFDckgsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1pbmlwcm9ncmFtL3BhZ2VzL2luZGV4L2FsYXJtL2FsYXJtLmpzXG5pbXBvcnQgYXBpIGZyb20gXCIuLi8uLi8uLi91dGlscy9hcGlcIlxuUGFnZSh7XG5cbiAgLyoqXG4gICAqIOmhtemdoueahOWIneWni+aVsOaNrlxuICAgKi9cbiAgZGF0YToge1xuICAgIEFsYXJtOiBbXSBhcyB1YXJ0QWxhcm1PYmplY3RbXSxcbiAgICBmaWx0ZXI6ICcnLFxuICAgIGRhdGU6ICcnLFxuICAgIGRhdGVTaG93OiBmYWxzZSxcbiAgICBtaW5EYXRlOiBuZXcgRGF0ZSgyMDIwLCAwLCAxKS5nZXRUaW1lKCksXG4gICAgbWF4RGF0ZTogRGF0ZS5ub3coKVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWKoOi9vVxuICAgKi9cbiAgb25Mb2FkOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKClcbiAgICBjb25zdCBzdGFydCA9IHRoaXMuZm9ybWF0RGF0ZShkYXRlKVxuICAgIGNvbnN0IGVuZCA9IHRoaXMuZm9ybWF0RGF0ZShkYXRlKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlOiBzdGFydCArICctJyArIGVuZFxuICAgIH0pXG4gICAgd3guZ2V0U3RvcmFnZSh7XG4gICAgICBrZXk6ICdhbGFybV9saXN0JyxcbiAgICAgIHN1Y2Nlc3M6IChlbCkgPT4ge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIEFsYXJtOiBlbC5kYXRhXG4gICAgICAgIH0pXG4gICAgICAgIHd4LnNldFRhYkJhckJhZGdlKHsgaW5kZXg6IDEsIHRleHQ6IHRoaXMuZGF0YS5BbGFybS5maWx0ZXIoZWwgPT4gIWVsLmlzT2spLmxlbmd0aC50b1N0cmluZygpIH0pXG4gICAgICB9LFxuICAgICAgZmFpbDogKCkgPT4ge1xuICAgICAgICB0aGlzLmdldEFsYXJtSW5mbygpXG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLy8g6I635Y+W5ZGK6K2m5L+h5oGvXG4gIGFzeW5jIGdldEFsYXJtSW5mbygpIHtcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn5Yqg6L295pWw5o2uJyB9KVxuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHRoaXMuZGF0YS5kYXRlLnNwbGl0KCctJylcbiAgICBjb25zdCB7IG9rLCBtc2csIGFyZyB9ID0gYXdhaXQgYXBpLmdldEFsYXJtKHN0YXJ0ICsgJyAwMDowMDowMCcsIGVuZCArIFwiIDIzOjU5OjU5XCIpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmIChvaykge1xuICAgICAgY29uc3QgQWxhcm0gPSBhcmcubWFwKGVsID0+IHtcbiAgICAgICAgZWwudGltZSA9IHRoaXMuZm9ybWF0dGltZShlbC50aW1lU3RhbXApXG4gICAgICAgIHJldHVybiBlbFxuICAgICAgfSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIEFsYXJtXG4gICAgICB9KVxuICAgICAgLy8g6K6h566X5pyq56Gu6K6k5ZGK6K2m5pWw6YePXG4gICAgICBjb25zdCBhbGFybU51bSA9IEFsYXJtLmZpbHRlcihlbCA9PiAhZWwuaXNPaykubGVuZ3RoXG4gICAgICBpZiAoYWxhcm1OdW0gPiAwKSB3eC5zZXRUYWJCYXJCYWRnZSh7IGluZGV4OiAxLCB0ZXh0OiBhbGFybU51bS50b1N0cmluZygpIH0pXG4gICAgICBlbHNlIHd4LnJlbW92ZVRhYkJhckJhZGdlKHtpbmRleDoxfSlcbiAgICAgIHd4LnNldFN0b3JhZ2UoeyBrZXk6ICdhbGFybV9saXN0JywgZGF0YTogQWxhcm0gfSlcbiAgICB9IGVsc2Uge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICflj5HnlJ/plJnor68nLFxuICAgICAgICBjb250ZW50OiBtc2cgfHwgJ+acquefpemUmeivrydcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuICAvLyDmmL7npLrml6XmnJ/pgInmi6nlmahcbiAgc2hvd0NhbGVuZGFyKCkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlU2hvdzogdHJ1ZVxuICAgIH0pXG4gIH0sXG4gIC8vICDlhbPpl63ml6XmnJ/pgInmi6nlmahcbiAgb25DbG9zZSgpIHtcbiAgICB0aGlzLnNldERhdGEoeyBkYXRlU2hvdzogZmFsc2UgfSk7XG4gIH0sXG4gIGZvcm1hdERhdGUoZGF0ZTogRGF0ZSkge1xuICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICByZXR1cm4gYCR7ZGF0ZS5nZXRGdWxsWWVhcigpfS8ke2RhdGUuZ2V0TW9udGgoKSArIDF9LyR7ZGF0ZS5nZXREYXRlKCl9YDtcbiAgfSxcbiAgLy8g56Gu5a6a5pel5pyfXG4gIG9uQ29uZmlybShldmVudDogYW55KSB7XG4gICAgY29uc3QgW3N0YXJ0LCBlbmRdID0gZXZlbnQuZGV0YWlsO1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlU2hvdzogZmFsc2UsXG4gICAgICBkYXRlOiBgJHt0aGlzLmZvcm1hdERhdGUoc3RhcnQpfSAtICR7dGhpcy5mb3JtYXREYXRlKGVuZCl9YCxcbiAgICB9KTtcbiAgICB0aGlzLmdldEFsYXJtSW5mbygpXG4gIH0sXG4gIC8vIOehruiupOWRiuitpuS/oeaBr1xuICBzaG93YWxhcm0oZXZlbnQ6IHZhbnRFdmVudDx1YXJ0QWxhcm1PYmplY3Q+KSB7XG4gICAgY29uc3QgYWxhcm0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IGtleSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5rZXkgYXMgbnVtYmVyXG5cbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IGFsYXJtLmRldk5hbWUsXG4gICAgICBjb250ZW50OiBhbGFybS5tc2csXG4gICAgICBzaG93Q2FuY2VsOiAhYWxhcm0uaXNPayxcbiAgICAgIC8vIGNvbmZpcm1Db2xvcjogJ2dyZWVuJyxcbiAgICAgIGNvbmZpcm1UZXh0OiBhbGFybS5pc09rID8gJ+ehruWumicgOiAn56Gu6K6k5raI5oGvJyxcbiAgICAgIHN1Y2Nlc3M6IGFzeW5jIChyZXMpID0+IHtcbiAgICAgICAgaWYgKHJlcy5jb25maXJtICYmICFhbGFybS5pc09rKSB7XG4gICAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ehruiupOWRiuitpuS/oeaBrycgfSlcbiAgICAgICAgICBhd2FpdCBhcGkuYWxhcm1Db25maXJtZWQoYWxhcm0uX2lkKVxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBbYEFsYXJtWyR7a2V5fV0uaXNPa2BdOiB0cnVlXG4gICAgICAgICAgfSlcbiAgICAgICAgICB3eC5zZXRUYWJCYXJCYWRnZSh7IGluZGV4OiAxLCB0ZXh0OiB0aGlzLmRhdGEuQWxhcm0uZmlsdGVyKGVsID0+ICFlbC5pc09rKS5sZW5ndGgudG9TdHJpbmcoKSB9KVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOWFqOmDqOehruiupFxuICBhbGxRdWVzdCgpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IFwiVGlwc1wiLFxuICAgICAgY29udGVudDogXCLmmK/lkKbnoa7orqTlhajpg6jlkYrorabkv6Hmga8/XCIsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfnoa7orqTlkYrorabkv6Hmga8nIH0pXG4gICAgICAgICAgYXdhaXQgYXBpLmFsYXJtQ29uZmlybWVkKClcbiAgICAgICAgICB3eC5zdGFydFB1bGxEb3duUmVmcmVzaCgpXG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBvblNob3coKSB7XG4gICAgd3guc3RhcnRQdWxsRG93blJlZnJlc2goKVxuICB9LFxuICAvLyDkuIvmi4nliLfmlrBcbiAgYXN5bmMgb25QdWxsRG93blJlZnJlc2goKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRBbGFybUluZm8oKVxuICAgIHd4LnN0b3BQdWxsRG93blJlZnJlc2goKVxuICB9XG4gICxcbiAgZm9ybWF0dGltZSh0aW1lOiBudW1iZXIpIHtcbiAgICBjb25zdCBEYXRlcyA9IG5ldyBEYXRlKHRpbWUpXG4gICAgcmV0dXJuIGAke0RhdGVzLmdldE1vbnRoKCkgKyAxfS0ke0RhdGVzLmdldERhdGUoKX0gJHtEYXRlcy5nZXRIb3VycygpfToke0RhdGVzLmdldE1pbnV0ZXMoKX06JHtEYXRlcy5nZXRTZWNvbmRzKCl9YFxuICB9XG59KSJdfQ==