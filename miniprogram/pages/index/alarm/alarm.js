"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        Alarm: [],
        filter: '',
        date: '',
        dateShow: false,
        minDate: new Date(2020, 0, 1).getTime(),
        maxDate: Date.now()
    },
    onLoad: async function () {
        const date = new Date();
        const start = this.formatDate(date);
        const end = this.formatDate(date);
        this.setData({
            date: start + '-' + end
        });
        wx.getStorage({
            key: 'alarm_list',
            success: (el) => {
                this.setData({
                    Alarm: el.data
                });
                wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
            },
            fail: () => {
                this.getAlarmInfo();
            }
        });
    },
    async subMessage() {
        const res = await util_1.SubscribeMessage(['设备告警提醒']);
        this.setData({
            subMessageStat: res['8NX6ji8ABlNAOEMcU7v2jtD4sgCB7NMHguWzxZn3HO4'] === 'accept'
        });
    },
    async getAlarmInfo() {
        wx.showLoading({ title: '加载数据' });
        const [start, end] = this.data.date.split('-');
        const { ok, msg, arg } = await api_1.default.getAlarm(start + ' 00:00:00', end + " 23:59:59");
        wx.hideLoading();
        if (ok) {
            const Alarm = arg.map(el => {
                el.time = this.formattime(el.timeStamp);
                return el;
            });
            this.setData({
                Alarm
            });
            const alarmNum = Alarm.filter(el => !el.isOk).length;
            if (alarmNum > 0)
                wx.setTabBarBadge({ index: 1, text: alarmNum.toString() });
            else
                wx.removeTabBarBadge({ index: 1 });
            wx.setStorage({ key: 'alarm_list', data: Alarm });
        }
        else {
            wx.showModal({
                title: '发生错误',
                content: msg || '未知错误'
            });
        }
    },
    showCalendar() {
        this.setData({
            dateShow: true
        });
    },
    onClose() {
        this.setData({ dateShow: false });
    },
    formatDate(date) {
        date = new Date(date);
        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    },
    onConfirm(event) {
        const [start, end] = event.detail;
        this.setData({
            dateShow: false,
            date: `${this.formatDate(start)} - ${this.formatDate(end)}`,
        });
        this.getAlarmInfo();
    },
    showalarm(event) {
        const alarm = event.currentTarget.dataset.item;
        const key = event.currentTarget.dataset.key;
        wx.showModal({
            title: alarm.devName,
            content: alarm.msg,
            showCancel: !alarm.isOk,
            confirmText: alarm.isOk ? '确定' : '确认消息',
            success: async (res) => {
                if (res.confirm && !alarm.isOk) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.alarmConfirmed(alarm._id);
                    this.setData({
                        [`Alarm[${key}].isOk`]: true
                    });
                    this.subMessage();
                    wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
                    wx.hideLoading();
                }
            }
        });
    },
    allQuest() {
        wx.showModal({
            title: "Tips",
            content: "是否确认全部告警信息?",
            success: async (res) => {
                if (res.confirm) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.alarmConfirmed();
                    wx.startPullDownRefresh();
                    wx.hideLoading();
                    this.subMessage();
                }
            }
        });
    },
    onShow() {
        wx.startPullDownRefresh();
    },
    async onPullDownRefresh() {
        await this.getAlarmInfo();
        wx.stopPullDownRefresh();
    },
    formattime(time) {
        const Dates = new Date(time);
        return `${Dates.getMonth() + 1}-${Dates.getDate()} ${Dates.getHours()}:${Dates.getMinutes()}:${Dates.getSeconds()}`;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhbGFybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDhDQUFzRDtBQUV0RCw0Q0FBb0M7QUFDcEMsSUFBSSxDQUFDO0lBS0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLEVBQXVCO1FBQzlCLE1BQU0sRUFBRSxFQUFFO1FBQ1YsSUFBSSxFQUFFLEVBQUU7UUFDUixRQUFRLEVBQUUsS0FBSztRQUNmLE9BQU8sRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRTtRQUN2QyxPQUFPLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTtLQUNwQjtJQUtELE1BQU0sRUFBRSxLQUFLO1FBQ1gsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQTtRQUN2QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25DLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDakMsSUFBSSxDQUFDLE9BQU8sQ0FBQztZQUNYLElBQUksRUFBRSxLQUFLLEdBQUcsR0FBRyxHQUFHLEdBQUc7U0FDeEIsQ0FBQyxDQUFBO1FBQ0YsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNaLEdBQUcsRUFBRSxZQUFZO1lBQ2pCLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFO2dCQUNkLElBQUksQ0FBQyxPQUFPLENBQUM7b0JBQ1gsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJO2lCQUNmLENBQUMsQ0FBQTtnQkFDRixFQUFFLENBQUMsY0FBYyxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxD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SyxDQUFDLE9BQU8sRUFBRSxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUE7SUFDckgsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN1YnNjcmliZU1lc3NhZ2UgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiXG4vLyBtaW5pcHJvZ3JhbS9wYWdlcy9pbmRleC9hbGFybS9hbGFybS5qc1xuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcblBhZ2Uoe1xuXG4gIC8qKlxuICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICovXG4gIGRhdGE6IHtcbiAgICBBbGFybTogW10gYXMgdWFydEFsYXJtT2JqZWN0W10sXG4gICAgZmlsdGVyOiAnJyxcbiAgICBkYXRlOiAnJyxcbiAgICBkYXRlU2hvdzogZmFsc2UsXG4gICAgbWluRGF0ZTogbmV3IERhdGUoMjAyMCwgMCwgMSkuZ2V0VGltZSgpLFxuICAgIG1heERhdGU6IERhdGUubm93KClcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpXG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLmZvcm1hdERhdGUoZGF0ZSlcbiAgICBjb25zdCBlbmQgPSB0aGlzLmZvcm1hdERhdGUoZGF0ZSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZGF0ZTogc3RhcnQgKyAnLScgKyBlbmRcbiAgICB9KVxuICAgIHd4LmdldFN0b3JhZ2Uoe1xuICAgICAga2V5OiAnYWxhcm1fbGlzdCcsXG4gICAgICBzdWNjZXNzOiAoZWwpID0+IHtcbiAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICBBbGFybTogZWwuZGF0YVxuICAgICAgICB9KVxuICAgICAgICB3eC5zZXRUYWJCYXJCYWRnZSh7IGluZGV4OiAxLCB0ZXh0OiB0aGlzLmRhdGEuQWxhcm0uZmlsdGVyKGVsID0+ICFlbC5pc09rKS5sZW5ndGgudG9TdHJpbmcoKSB9KVxuICAgICAgfSxcbiAgICAgIGZhaWw6ICgpID0+IHtcbiAgICAgICAgdGhpcy5nZXRBbGFybUluZm8oKVxuICAgICAgfVxuICAgIH0pXG4gICAgLy/mo4Dmn6XlkYroraborqLpmIXnirbmgIFcbiAgICAvKiBjb25zdCB7IHN1YnNjcmlwdGlvbnNTZXR0aW5nIH0gPSBhd2FpdCB3eC5nZXRTZXR0aW5nKHtcbiAgICAgIHdpdGhTdWJzY3JpcHRpb25zOiB0cnVlXG4gICAgfSlcbiAgICBjb25zb2xlLmxvZyh7c3Vic2NyaXB0aW9uc1NldHRpbmd9KTtcbiAgICBcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgc3ViTWVzc2FnZVN0YXQ6IEJvb2xlYW4oc3Vic2NyaXB0aW9uc1NldHRpbmc/Lml0ZW1TZXR0aW5ncz8uWyc4Tlg2amk4QUJsTkFPRU1jVTd2Mmp0RDRzZ0NCN05NSGd1V3p4Wm4zSE80J10gPT09ICdhY2NlcHQnKVxuICAgIH0pICovXG4gIH0sXG4gIC8qKlxuICAgKiDorqLpmIXkuIvmrKHlkYroraZcbiAgICovXG4gIGFzeW5jIHN1Yk1lc3NhZ2UoKSB7XG4gICAgICBjb25zdCByZXMgPSBhd2FpdCBTdWJzY3JpYmVNZXNzYWdlKFsn6K6+5aSH5ZGK6K2m5o+Q6YaSJ10pXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBzdWJNZXNzYWdlU3RhdDogKHJlcyBhcyBhbnkpWyc4Tlg2amk4QUJsTkFPRU1jVTd2Mmp0RDRzZ0NCN05NSGd1V3p4Wm4zSE80J10gPT09ICdhY2NlcHQnXG4gICAgICB9KVxuXG4gIH0sXG4gIC8vIOiOt+WPluWRiuitpuS/oeaBr1xuICBhc3luYyBnZXRBbGFybUluZm8oKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+WKoOi9veaVsOaNricgfSlcbiAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSB0aGlzLmRhdGEuZGF0ZS5zcGxpdCgnLScpXG4gICAgY29uc3QgeyBvaywgbXNnLCBhcmcgfSA9IGF3YWl0IGFwaS5nZXRBbGFybShzdGFydCArICcgMDA6MDA6MDAnLCBlbmQgKyBcIiAyMzo1OTo1OVwiKVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICBpZiAob2spIHtcbiAgICAgIGNvbnN0IEFsYXJtID0gYXJnLm1hcChlbCA9PiB7XG4gICAgICAgIGVsLnRpbWUgPSB0aGlzLmZvcm1hdHRpbWUoZWwudGltZVN0YW1wKVxuICAgICAgICByZXR1cm4gZWxcbiAgICAgIH0pXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBBbGFybVxuICAgICAgfSlcbiAgICAgIC8vIOiuoeeul+acquehruiupOWRiuitpuaVsOmHj1xuICAgICAgY29uc3QgYWxhcm1OdW0gPSBBbGFybS5maWx0ZXIoZWwgPT4gIWVsLmlzT2spLmxlbmd0aFxuICAgICAgaWYgKGFsYXJtTnVtID4gMCkgd3guc2V0VGFiQmFyQmFkZ2UoeyBpbmRleDogMSwgdGV4dDogYWxhcm1OdW0udG9TdHJpbmcoKSB9KVxuICAgICAgZWxzZSB3eC5yZW1vdmVUYWJCYXJCYWRnZSh7IGluZGV4OiAxIH0pXG4gICAgICB3eC5zZXRTdG9yYWdlKHsga2V5OiAnYWxhcm1fbGlzdCcsIGRhdGE6IEFsYXJtIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn5Y+R55Sf6ZSZ6K+vJyxcbiAgICAgICAgY29udGVudDogbXNnIHx8ICfmnKrnn6XplJnor68nXG4gICAgICB9KVxuICAgIH1cbiAgfSxcbiAgLy8g5pi+56S65pel5pyf6YCJ5oup5ZmoXG4gIHNob3dDYWxlbmRhcigpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZGF0ZVNob3c6IHRydWVcbiAgICB9KVxuICB9LFxuICAvLyAg5YWz6Zet5pel5pyf6YCJ5oup5ZmoXG4gIG9uQ2xvc2UoKSB7XG4gICAgdGhpcy5zZXREYXRhKHsgZGF0ZVNob3c6IGZhbHNlIH0pO1xuICB9LFxuICBmb3JtYXREYXRlKGRhdGU6IERhdGUpIHtcbiAgICBkYXRlID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgcmV0dXJuIGAke2RhdGUuZ2V0RnVsbFllYXIoKX0vJHtkYXRlLmdldE1vbnRoKCkgKyAxfS8ke2RhdGUuZ2V0RGF0ZSgpfWA7XG4gIH0sXG4gIC8vIOehruWumuaXpeacn1xuICBvbkNvbmZpcm0oZXZlbnQ6IGFueSkge1xuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IGV2ZW50LmRldGFpbDtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZGF0ZVNob3c6IGZhbHNlLFxuICAgICAgZGF0ZTogYCR7dGhpcy5mb3JtYXREYXRlKHN0YXJ0KX0gLSAke3RoaXMuZm9ybWF0RGF0ZShlbmQpfWAsXG4gICAgfSk7XG4gICAgdGhpcy5nZXRBbGFybUluZm8oKVxuICB9LFxuICAvLyDnoa7orqTlkYrorabkv6Hmga9cbiAgc2hvd2FsYXJtKGV2ZW50OiB2YW50RXZlbnQ8dWFydEFsYXJtT2JqZWN0Pikge1xuICAgIGNvbnN0IGFsYXJtID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCBrZXkgPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQua2V5IGFzIG51bWJlclxuICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogYWxhcm0uZGV2TmFtZSxcbiAgICAgIGNvbnRlbnQ6IGFsYXJtLm1zZyxcbiAgICAgIHNob3dDYW5jZWw6ICFhbGFybS5pc09rLFxuICAgICAgLy8gY29uZmlybUNvbG9yOiAnZ3JlZW4nLFxuICAgICAgY29uZmlybVRleHQ6IGFsYXJtLmlzT2sgPyAn56Gu5a6aJyA6ICfnoa7orqTmtojmga8nLFxuICAgICAgc3VjY2VzczogYXN5bmMgKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLmNvbmZpcm0gJiYgIWFsYXJtLmlzT2spIHtcbiAgICAgICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn56Gu6K6k5ZGK6K2m5L+h5oGvJyB9KVxuICAgICAgICAgIGF3YWl0IGFwaS5hbGFybUNvbmZpcm1lZChhbGFybS5faWQpXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIFtgQWxhcm1bJHtrZXl9XS5pc09rYF06IHRydWVcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc3ViTWVzc2FnZSgpXG4gICAgICAgICAgd3guc2V0VGFiQmFyQmFkZ2UoeyBpbmRleDogMSwgdGV4dDogdGhpcy5kYXRhLkFsYXJtLmZpbHRlcihlbCA9PiAhZWwuaXNPaykubGVuZ3RoLnRvU3RyaW5nKCkgfSlcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDlhajpg6jnoa7orqRcbiAgYWxsUXVlc3QoKSB7XG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiBcIlRpcHNcIixcbiAgICAgIGNvbnRlbnQ6IFwi5piv5ZCm56Gu6K6k5YWo6YOo5ZGK6K2m5L+h5oGvP1wiLFxuICAgICAgc3VjY2VzczogYXN5bmMgKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLmNvbmZpcm0pIHtcbiAgICAgICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn56Gu6K6k5ZGK6K2m5L+h5oGvJyB9KVxuICAgICAgICAgIGF3YWl0IGFwaS5hbGFybUNvbmZpcm1lZCgpXG4gICAgICAgICAgd3guc3RhcnRQdWxsRG93blJlZnJlc2goKVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgICB0aGlzLnN1Yk1lc3NhZ2UoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICBvblNob3coKSB7XG4gICAgd3guc3RhcnRQdWxsRG93blJlZnJlc2goKVxuICB9LFxuICAvLyDkuIvmi4nliLfmlrBcbiAgYXN5bmMgb25QdWxsRG93blJlZnJlc2goKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRBbGFybUluZm8oKVxuICAgIHd4LnN0b3BQdWxsRG93blJlZnJlc2goKVxuICB9XG4gICxcbiAgZm9ybWF0dGltZSh0aW1lOiBudW1iZXIpIHtcbiAgICBjb25zdCBEYXRlcyA9IG5ldyBEYXRlKHRpbWUpXG4gICAgcmV0dXJuIGAke0RhdGVzLmdldE1vbnRoKCkgKyAxfS0ke0RhdGVzLmdldERhdGUoKX0gJHtEYXRlcy5nZXRIb3VycygpfToke0RhdGVzLmdldE1pbnV0ZXMoKX06JHtEYXRlcy5nZXRTZWNvbmRzKCl9YFxuICB9XG59KSJdfQ==