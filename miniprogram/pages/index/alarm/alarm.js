"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_1 = require("../../../utils/api");
Page({
    data: {
        Alarm: [],
        filter: '',
        date: '',
        dateShow: false,
        minDate: new Date(2020, 0, 1).getTime(),
        maxDate: Date.now()
    },
    onLoad: async function () {
        wx.showLoading({ title: '加载数据' });
        const date = new Date();
        date.setMonth(date.getMonth() - 1);
        const start = this.formatDate(date);
        const end = this.formatDate(new Date());
        this.setData({
            date: start + '-' + end
        });
        setTimeout(() => {
            this.getAlarmInfo().then(() => {
                wx.hideLoading();
            });
        }, 2000);
    },
    async subMessage() {
        wx.showModal({
            title: '订阅长期告警',
            content: '小程序限制,单次订阅只能发送一条订阅消息,如需长期订阅请关注关联公众号',
            success: async (res) => {
                if (res.confirm) {
                    const url = encodeURIComponent('http://mp.weixin.qq.com/s?__biz=MjM5MjA1MTgxOQ==&mid=304819939&idx=1&sn=d0bcd922033075afa2b5219fc95ebb1e&chksm=3173a9e7060420f1a98d0040d964a2f82af25289a731d1400c5224ca9bb3d225d737700700a8#rd');
                    wx.navigateTo({ url: '/pages/index/web/web?url=' + url });
                }
            }
        });
    },
    async getAlarmInfo() {
        const [start, end] = this.data.date.split('-');
        const { code, data, msg } = await api_1.default.getAlarm(start + ' 0:0:0', end + ' 23:59:59');
        if (code) {
            const Alarm = data
                .map(el => {
                el.time = this.formattime(el.timeStamp);
                return el;
            })
                .reverse();
            this.setData({
                Alarm: Alarm.slice(0, 10)
            });
            if (Alarm.length > 10) {
                setTimeout(() => {
                    this.setData({
                        Alarm: Alarm.slice(10, -1)
                    });
                }, 1000);
            }
            const alarmNum = Alarm.filter(el => !el.isOk).length;
            if (alarmNum > 0)
                wx.setTabBarBadge({ index: 1, text: alarmNum.toString() });
            else
                wx.removeTabBarBadge({ index: 1 });
            wx.setStorage({ key: 'alarm_list', data: Alarm });
        }
        else {
            wx.showModal({
                title: '发生错误',
                content: msg || '未知错误'
            });
        }
    },
    showCalendar() {
        this.setData({
            dateShow: true
        });
    },
    onClose() {
        this.setData({ dateShow: false });
    },
    formatDate(date) {
        date = new Date(date);
        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    },
    onConfirm(event) {
        const [start, end] = event.detail;
        this.setData({
            dateShow: false,
            date: `${this.formatDate(start)} - ${this.formatDate(end)}`,
        });
        this.getAlarmInfo();
    },
    showalarm(event) {
        const alarm = event.currentTarget.dataset.item;
        const key = event.currentTarget.dataset.key;
        wx.showModal({
            title: alarm.devName,
            content: alarm.msg,
            showCancel: !alarm.isOk,
            confirmText: alarm.isOk ? '确定' : '确认消息',
            success: async (res) => {
                if (res.confirm && !alarm.isOk) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.confrimAlarm(alarm._id);
                    this.setData({
                        [`Alarm[${key}].isOk`]: true
                    });
                    this.subMessage();
                    wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
                    wx.hideLoading();
                }
            }
        });
    },
    allQuest() {
        wx.showModal({
            title: "Tips",
            content: "是否确认全部告警信息?",
            success: async (res) => {
                if (res.confirm) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.confrimAlarm();
                    wx.startPullDownRefresh();
                    wx.hideLoading();
                    this.subMessage();
                }
            }
        });
    },
    async onPullDownRefresh() {
        wx.stopPullDownRefresh();
    },
    formattime(time) {
        const Dates = new Date(time);
        return `${Dates.getMonth() + 1}-${Dates.getDate()} ${Dates.getHours()}:${Dates.getMinutes()}:${Dates.getSeconds()}`;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhbGFybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDRDQUFvQztBQUNwQyxJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsRUFBNEI7UUFDbkMsTUFBTSxFQUFFLEVBQUU7UUFDVixJQUFJLEVBQUUsRUFBRTtRQUNSLFFBQVEsRUFBRSxLQUFLO1FBQ2YsT0FBTyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFO1FBQ3ZDLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO0tBQ3BCO0lBS0QsTUFBTSxFQUFFLEtBQUs7UUFDWCxFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUE7UUFDakMsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQTtRQUN2QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUNsQyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ25DLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFBO1FBQ3ZDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxJQUFJLEVBQUUsS0FBSyxHQUFHLEdBQUcsR0FBRyxHQUFHO1NBQ3hCLENBQUMsQ0FBQTtRQUNGLFVBQVUsQ0FBQyxHQUFHLEVBQUU7WUFDZCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRTtnQkFDNUIsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO1lBQ2xCLENBQUMsQ0FBQyxDQUFBO1FBQ0osQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFBO0lBRVYsQ0FBQztJQUlELEtBQUssQ0FBQyxVQUFVO1FBQ2QsRUFBRSxDQUFDLFNBQVMsQ0FBQztZQUNYLEtBQUssRUFBRSxRQUFRO1lBQ2YsT0FBTyxFQUFFLHFDQUFxQztZQUM5QyxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxFQUFFO2dCQUNyQixJQUFJLEdBQUcsQ0FBQyxPQUFPLEVBQUU7b0JBQ2YsTUFBTSxHQUFHLEdBQUcsa0JBQWtCLENBQUMsZ01BQWdNLENBQUMsQ0FBQTtvQkFDaE8sRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEdBQUcsRUFBRSwyQkFBMkIsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFBO2lCQUMxRDtZQUNILENBQUM7U0FDRixDQUFDLENBQUE7SUFFSixDQUFDO0lBRUQsS0FBSyxDQUFDLFlBQVk7UUFDaEIsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDOUMsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBRyxRQUFRLEVBQUUsR0FBRyxHQUFHLFdBQVcsQ0FBQyxDQUFBO1FBQ25GLElBQUksSUFBSSxFQUFFO1lBQ1IsTUFBTSxLQUFLLEdBQUcsSUFBSTtpQkFDZixHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUU7Z0JBQ1IsRUFBRSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtnQkFDdkMsT0FBTyxFQUFFLENBQUE7WUFDWCxDQUFDLENBQUM7aUJBQ0QsT0FBTyxFQUFFLENBQUE7WUFDWixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7YUFDMUIsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRTtnQkFDckIsVUFBVSxDQUFDLEdBQUcsRUFBRTtvQkFDZCxJQUFJLENBQUMsT0FBTyxDQUFDO3dCQUNYLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztxQkFDM0IsQ0FBQyxDQUFBO2dCQUNKLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQzthQUNWO1lBRUQsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQTtZQUNwRCxJQUFJLFFBQVEsR0FBRyxDQUFDO2dCQUFFLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFBOztnQkFDdkUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDdkMsRUFBRSxDQUFDLFVBQVUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxZQUFZLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7U0FDbEQ7YUFBTTtZQUNMLEVBQUUsQ0FBQyxTQUFTLENBQUM7Z0JBQ1gsS0FBSyxFQUFFLE1BQU07Z0JBQ2IsT0FBTyxFQUFFLEdBQUcsSUFBSSxNQUFNO2FBQ3ZCLENBQUMsQ0FBQTtTQUNIO0lBRUgsQ0FBQztJQUVELFlBQVk7UUFDVixJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsUUFBUSxFQUFFLElBQUk7U0FDZixDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsT0FBTztRQUNMLElBQUksQ0FBQyxPQUFPLENBQUMsRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUNwQyxDQUFDO0lBQ0QsVUFBVSxDQUFDLElBQVU7UUFDbkIsSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLE9BQU8sR0FBRyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztJQUMxRSxDQUFDO0lBRUQsU0FBUyxDQUFDLEtBQVU7UUFDbEIsTUFBTSxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxRQUFRLEVBQUUsS0FBSztZQUNmLElBQUksRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsRUFBRTtTQUM1RCxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUE7SUFDckIsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUFzQztRQUM5QyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUE7UUFDOUMsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsR0FBYSxDQUFBO1FBQ3JELEVBQUUsQ0FBQyxTQUFTLENBQUM7WUFDWCxLQUFLLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDcEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxHQUFHO1lBQ2xCLFVBQVUsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBRXZCLFdBQVcsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU07WUFDdkMsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtnQkFDckIsSUFBSSxHQUFHLENBQUMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRTtvQkFDOUIsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFBO29CQUNuQyxNQUFNLGFBQUcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDO3dCQUNYLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQyxFQUFFLElBQUk7cUJBQzdCLENBQUMsQ0FBQTtvQkFDRixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7b0JBQ2pCLEVBQUUsQ0FBQyxjQUFjLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFBO29CQUMvRixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7aUJBQ2pCO1lBQ0gsQ0FBQztTQUNGLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFFRCxRQUFRO1FBQ04sRUFBRSxDQUFDLFNBQVMsQ0FBQztZQUNYLEtBQUssRUFBRSxNQUFNO1lBQ2IsT0FBTyxFQUFFLGFBQWE7WUFDdEIsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsRUFBRTtnQkFDckIsSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFO29CQUNmLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtvQkFDbkMsTUFBTSxhQUFHLENBQUMsWUFBWSxFQUFFLENBQUE7b0JBQ3hCLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFBO29CQUN6QixFQUFFLENBQUMsV0FBVyxFQUFFLENBQUE7b0JBQ2hCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtpQkFDbEI7WUFDSCxDQUFDO1NBQ0YsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUdELEtBQUssQ0FBQyxpQkFBaUI7UUFDckIsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUE7SUFDMUIsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFZO1FBQ3JCLE1BQU0sS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVCLE9BQU8sR0FBRyxLQUFLLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRSxJQUFJLEtBQUssQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFBO0lBQ3JILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJzY3JpYmVNZXNzYWdlIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuLy8gbWluaXByb2dyYW0vcGFnZXMvaW5kZXgvYWxhcm0vYWxhcm0uanNcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5QYWdlKHtcblxuICAvKipcbiAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXG4gICAqL1xuICBkYXRhOiB7XG4gICAgQWxhcm06IFtdIGFzIFVhcnQudWFydEFsYXJtT2JqZWN0W10sXG4gICAgZmlsdGVyOiAnJyxcbiAgICBkYXRlOiAnJyxcbiAgICBkYXRlU2hvdzogZmFsc2UsXG4gICAgbWluRGF0ZTogbmV3IERhdGUoMjAyMCwgMCwgMSkuZ2V0VGltZSgpLFxuICAgIG1heERhdGU6IERhdGUubm93KClcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfliqDovb3mlbDmja4nIH0pXG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKClcbiAgICBkYXRlLnNldE1vbnRoKGRhdGUuZ2V0TW9udGgoKSAtIDEpXG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLmZvcm1hdERhdGUoZGF0ZSlcbiAgICBjb25zdCBlbmQgPSB0aGlzLmZvcm1hdERhdGUobmV3IERhdGUoKSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZGF0ZTogc3RhcnQgKyAnLScgKyBlbmRcbiAgICB9KVxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5nZXRBbGFybUluZm8oKS50aGVuKCgpID0+IHtcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgfSlcbiAgICB9LCAyMDAwKVxuXG4gIH0sXG4gIC8qKlxuICAgKiDorqLpmIXkuIvmrKHlkYroraZcbiAgICovXG4gIGFzeW5jIHN1Yk1lc3NhZ2UoKSB7XG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiAn6K6i6ZiF6ZW/5pyf5ZGK6K2mJyxcbiAgICAgIGNvbnRlbnQ6ICflsI/nqIvluo/pmZDliLYs5Y2V5qyh6K6i6ZiF5Y+q6IO95Y+R6YCB5LiA5p2h6K6i6ZiF5raI5oGvLOWmgumcgOmVv+acn+iuoumYheivt+WFs+azqOWFs+iBlOWFrOS8l+WPtycsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgIGNvbnN0IHVybCA9IGVuY29kZVVSSUNvbXBvbmVudCgnaHR0cDovL21wLndlaXhpbi5xcS5jb20vcz9fX2Jpej1Nak01TWpBMU1UZ3hPUT09Jm1pZD0zMDQ4MTk5MzkmaWR4PTEmc249ZDBiY2Q5MjIwMzMwNzVhZmEyYjUyMTlmYzk1ZWJiMWUmY2hrc209MzE3M2E5ZTcwNjA0MjBmMWE5OGQwMDQwZDk2NGEyZjgyYWYyNTI4OWE3MzFkMTQwMGM1MjI0Y2E5YmIzZDIyNWQ3Mzc3MDA3MDBhOCNyZCcpXG4gICAgICAgICAgd3gubmF2aWdhdGVUbyh7IHVybDogJy9wYWdlcy9pbmRleC93ZWIvd2ViP3VybD0nICsgdXJsIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuXG4gIH0sXG4gIC8vIOiOt+WPluWRiuitpuS/oeaBr1xuICBhc3luYyBnZXRBbGFybUluZm8oKSB7XG4gICAgY29uc3QgW3N0YXJ0LCBlbmRdID0gdGhpcy5kYXRhLmRhdGUuc3BsaXQoJy0nKVxuICAgIGNvbnN0IHsgY29kZSwgZGF0YSwgbXNnIH0gPSBhd2FpdCBhcGkuZ2V0QWxhcm0oc3RhcnQgKyAnIDA6MDowJywgZW5kICsgJyAyMzo1OTo1OScpXG4gICAgaWYgKGNvZGUpIHtcbiAgICAgIGNvbnN0IEFsYXJtID0gZGF0YVxuICAgICAgICAubWFwKGVsID0+IHtcbiAgICAgICAgICBlbC50aW1lID0gdGhpcy5mb3JtYXR0aW1lKGVsLnRpbWVTdGFtcClcbiAgICAgICAgICByZXR1cm4gZWxcbiAgICAgICAgfSlcbiAgICAgICAgLnJldmVyc2UoKVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgQWxhcm06IEFsYXJtLnNsaWNlKDAsIDEwKVxuICAgICAgfSlcbiAgICAgIGlmIChBbGFybS5sZW5ndGggPiAxMCkge1xuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgQWxhcm06IEFsYXJtLnNsaWNlKDEwLCAtMSlcbiAgICAgICAgICB9KVxuICAgICAgICB9LCAxMDAwKTtcbiAgICAgIH1cbiAgICAgIC8vIOiuoeeul+acquehruiupOWRiuitpuaVsOmHj1xuICAgICAgY29uc3QgYWxhcm1OdW0gPSBBbGFybS5maWx0ZXIoZWwgPT4gIWVsLmlzT2spLmxlbmd0aFxuICAgICAgaWYgKGFsYXJtTnVtID4gMCkgd3guc2V0VGFiQmFyQmFkZ2UoeyBpbmRleDogMSwgdGV4dDogYWxhcm1OdW0udG9TdHJpbmcoKSB9KVxuICAgICAgZWxzZSB3eC5yZW1vdmVUYWJCYXJCYWRnZSh7IGluZGV4OiAxIH0pXG4gICAgICB3eC5zZXRTdG9yYWdlKHsga2V5OiAnYWxhcm1fbGlzdCcsIGRhdGE6IEFsYXJtIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn5Y+R55Sf6ZSZ6K+vJyxcbiAgICAgICAgY29udGVudDogbXNnIHx8ICfmnKrnn6XplJnor68nXG4gICAgICB9KVxuICAgIH1cblxuICB9LFxuICAvLyDmmL7npLrml6XmnJ/pgInmi6nlmahcbiAgc2hvd0NhbGVuZGFyKCkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlU2hvdzogdHJ1ZVxuICAgIH0pXG4gIH0sXG4gIC8vICDlhbPpl63ml6XmnJ/pgInmi6nlmahcbiAgb25DbG9zZSgpIHtcbiAgICB0aGlzLnNldERhdGEoeyBkYXRlU2hvdzogZmFsc2UgfSk7XG4gIH0sXG4gIGZvcm1hdERhdGUoZGF0ZTogRGF0ZSkge1xuICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcbiAgICByZXR1cm4gYCR7ZGF0ZS5nZXRGdWxsWWVhcigpfS8ke2RhdGUuZ2V0TW9udGgoKSArIDF9LyR7ZGF0ZS5nZXREYXRlKCl9YDtcbiAgfSxcbiAgLy8g56Gu5a6a5pel5pyfXG4gIG9uQ29uZmlybShldmVudDogYW55KSB7XG4gICAgY29uc3QgW3N0YXJ0LCBlbmRdID0gZXZlbnQuZGV0YWlsO1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlU2hvdzogZmFsc2UsXG4gICAgICBkYXRlOiBgJHt0aGlzLmZvcm1hdERhdGUoc3RhcnQpfSAtICR7dGhpcy5mb3JtYXREYXRlKGVuZCl9YCxcbiAgICB9KTtcbiAgICB0aGlzLmdldEFsYXJtSW5mbygpXG4gIH0sXG4gIC8vIOehruiupOWRiuitpuS/oeaBr1xuICBzaG93YWxhcm0oZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LnVhcnRBbGFybU9iamVjdD4pIHtcbiAgICBjb25zdCBhbGFybSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3Qga2V5ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmtleSBhcyBudW1iZXJcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IGFsYXJtLmRldk5hbWUsXG4gICAgICBjb250ZW50OiBhbGFybS5tc2csXG4gICAgICBzaG93Q2FuY2VsOiAhYWxhcm0uaXNPayxcbiAgICAgIC8vIGNvbmZpcm1Db2xvcjogJ2dyZWVuJyxcbiAgICAgIGNvbmZpcm1UZXh0OiBhbGFybS5pc09rID8gJ+ehruWumicgOiAn56Gu6K6k5raI5oGvJyxcbiAgICAgIHN1Y2Nlc3M6IGFzeW5jIChyZXMpID0+IHtcbiAgICAgICAgaWYgKHJlcy5jb25maXJtICYmICFhbGFybS5pc09rKSB7XG4gICAgICAgICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ehruiupOWRiuitpuS/oeaBrycgfSlcbiAgICAgICAgICBhd2FpdCBhcGkuY29uZnJpbUFsYXJtKGFsYXJtLl9pZClcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgW2BBbGFybVske2tleX1dLmlzT2tgXTogdHJ1ZVxuICAgICAgICAgIH0pXG4gICAgICAgICAgdGhpcy5zdWJNZXNzYWdlKClcbiAgICAgICAgICB3eC5zZXRUYWJCYXJCYWRnZSh7IGluZGV4OiAxLCB0ZXh0OiB0aGlzLmRhdGEuQWxhcm0uZmlsdGVyKGVsID0+ICFlbC5pc09rKS5sZW5ndGgudG9TdHJpbmcoKSB9KVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOWFqOmDqOehruiupFxuICBhbGxRdWVzdCgpIHtcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IFwiVGlwc1wiLFxuICAgICAgY29udGVudDogXCLmmK/lkKbnoa7orqTlhajpg6jlkYrorabkv6Hmga8/XCIsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfnoa7orqTlkYrorabkv6Hmga8nIH0pXG4gICAgICAgICAgYXdhaXQgYXBpLmNvbmZyaW1BbGFybSgpXG4gICAgICAgICAgd3guc3RhcnRQdWxsRG93blJlZnJlc2goKVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgICB0aGlzLnN1Yk1lc3NhZ2UoKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICAvLyDkuIvmi4nliLfmlrBcbiAgYXN5bmMgb25QdWxsRG93blJlZnJlc2goKSB7XG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH1cbiAgLFxuICBmb3JtYXR0aW1lKHRpbWU6IG51bWJlcikge1xuICAgIGNvbnN0IERhdGVzID0gbmV3IERhdGUodGltZSlcbiAgICByZXR1cm4gYCR7RGF0ZXMuZ2V0TW9udGgoKSArIDF9LSR7RGF0ZXMuZ2V0RGF0ZSgpfSAke0RhdGVzLmdldEhvdXJzKCl9OiR7RGF0ZXMuZ2V0TWludXRlcygpfToke0RhdGVzLmdldFNlY29uZHMoKX1gXG4gIH1cbn0pIl19