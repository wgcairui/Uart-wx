"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const api_1 = require("../../../utils/api");
Page({
    data: {
        Alarm: [],
        filter: '',
        date: '',
        dateShow: false,
        minDate: new Date(2020, 0, 1).getTime(),
        maxDate: Date.now(),
        userInfo: {}
    },
    onLoad: async function () {
        wx.showLoading({ title: '加载数据' });
        const date = new Date();
        date.setMonth(date.getMonth() - 1);
        const start = this.formatDate(date);
        const end = this.formatDate(new Date());
        const user = await api_1.default.userInfo();
        this.setData({
            date: start + '-' + end,
            userInfo: user.data
        });
        setTimeout(() => {
            this.getAlarmInfo().then(() => {
                wx.hideLoading();
            });
        }, 2000);
    },
    async subMessage() {
        if (this.data.userInfo.wxId)
            return;
        wx.showModal({
            title: '订阅长期告警',
            content: '小程序限制,单次订阅只能发送一条订阅消息,如需长期订阅请关注关联公众号',
            success: async (res) => {
                if (res.confirm) {
                    const url = encodeURIComponent('http://mp.weixin.qq.com/s?__biz=MjM5MjA1MTgxOQ==&mid=304819939&idx=1&sn=d0bcd922033075afa2b5219fc95ebb1e&chksm=3173a9e7060420f1a98d0040d964a2f82af25289a731d1400c5224ca9bb3d225d737700700a8#rd');
                    wx.navigateTo({ url: '/pages/index/web/web?url=' + url });
                }
            }
        });
    },
    async getAlarmInfo() {
        const [start, end] = this.data.date.split('-');
        const { code, data, msg } = await api_1.default.getAlarm(start + ' 0:0:0', end + ' 23:59:59');
        if (code) {
            const Alarm = data
                .map(el => {
                el.time = this.formattime(el.timeStamp);
                return el;
            })
                .reverse();
            this.setData({
                Alarm: Alarm.slice(0, 10)
            });
            if (Alarm.length > 10) {
                setTimeout(() => {
                    this.setData({
                        Alarm: Alarm.slice(10, -1)
                    });
                }, 1000);
            }
            const alarmNum = Alarm.filter(el => !el.isOk).length;
            if (alarmNum > 0)
                wx.setTabBarBadge({ index: 1, text: alarmNum.toString() });
            else
                wx.removeTabBarBadge({ index: 1 });
            wx.setStorage({ key: 'alarm_list', data: Alarm });
        }
        else {
            wx.showModal({
                title: '发生错误',
                content: msg || '未知错误'
            });
        }
    },
    showCalendar() {
        this.setData({
            dateShow: true
        });
    },
    onClose() {
        this.setData({ dateShow: false });
    },
    formatDate(date) {
        date = new Date(date);
        return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
    },
    onConfirm(event) {
        const [start, end] = event.detail;
        this.setData({
            dateShow: false,
            date: `${this.formatDate(start)} - ${this.formatDate(end)}`,
        });
        this.getAlarmInfo();
    },
    showalarm(event) {
        const alarm = event.currentTarget.dataset.item;
        const key = event.currentTarget.dataset.key;
        wx.showModal({
            title: alarm.devName,
            content: alarm.msg,
            showCancel: !alarm.isOk,
            confirmText: alarm.isOk ? '确定' : '确认消息',
            success: async (res) => {
                if (res.confirm && !alarm.isOk) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.confrimAlarm(alarm._id);
                    this.setData({
                        [`Alarm[${key}].isOk`]: true
                    });
                    this.subMessage();
                    wx.setTabBarBadge({ index: 1, text: this.data.Alarm.filter(el => !el.isOk).length.toString() });
                    wx.hideLoading();
                }
            }
        });
    },
    allQuest() {
        wx.showModal({
            title: "Tips",
            content: "是否确认全部告警信息?",
            success: async (res) => {
                if (res.confirm) {
                    wx.showLoading({ title: '确认告警信息' });
                    await api_1.default.confrimAlarm();
                    wx.startPullDownRefresh();
                    wx.hideLoading();
                    this.subMessage();
                }
            }
        });
    },
    async onPullDownRefresh() {
        this.getAlarmInfo();
        wx.stopPullDownRefresh();
    },
    formattime(time) {
        const Dates = new Date(time);
        return `${Dates.getMonth() + 1}-${Dates.getDate()} ${Dates.getHours()}:${Dates.getMinutes()}:${Dates.getSeconds()}`;
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhbGFybS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDRDQUFvQztBQUVwQyxJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsRUFBNEI7UUFDbkMsTUFBTSxFQUFFLEVBQUU7UUFDVixJQUFJLEVBQUUsRUFBRTtRQUNSLFFBQVEsRUFBRSxLQUFLO1FBQ2YsT0FBTyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFO1FBQ3ZDLE9BQU8sRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1FBQ25CLFFBQVEsRUFBRSxFQUFtQjtLQUM5QjtJQUtELE1BQU0sRUFBRSxLQUFLO1FBQ1gsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFBO1FBQ2pDLE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUE7UUFDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUE7UUFDbEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUNuQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksSUFBSSxFQUFFLENBQUMsQ0FBQTtRQUV2QyxNQUFNLElBQUksR0FBRyxNQUFNLGFBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtRQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsSUFBSSxFQUFFLEtBQUssR0FBRyxHQUFHLEdBQUcsR0FBRztZQUN2QixRQUFRLEVBQUUsSUFBSSxDQUFDLElBQUk7U0FDcEIsQ0FBQyxDQUFBO1FBQ0YsVUFBVSxDQUFDLEdBQUcsRUFBRTtZQUNkLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FB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QUFFLENBQUE7aUJBQ2xCO1lBQ0gsQ0FBQztTQUNGLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFLRCxLQUFLLENBQUMsaUJBQWlCO1FBQ3JCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtRQUNuQixFQUFFLENBQUMsbUJBQW1CLEVBQUUsQ0FBQTtJQUMxQixDQUFDO0lBR0QsVUFBVSxDQUFDLElBQVk7UUFDckIsTUFBTSxLQUFLLEdBQUcsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUIsT0FBTyxHQUFHLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLE9BQU8sRUFBRSxJQUFJLEtBQUssQ0FBQyxRQUFRLEVBQUUsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUE7SUFDckgsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1pbmlwcm9ncmFtL3BhZ2VzL2luZGV4L2FsYXJtL2FsYXJtLmpzXG5pbXBvcnQgYXBpIGZyb20gXCIuLi8uLi8uLi91dGlscy9hcGlcIlxuXG5QYWdlKHtcblxuICAvKipcbiAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXG4gICAqL1xuICBkYXRhOiB7XG4gICAgQWxhcm06IFtdIGFzIFVhcnQudWFydEFsYXJtT2JqZWN0W10sXG4gICAgZmlsdGVyOiAnJyxcbiAgICBkYXRlOiAnJyxcbiAgICBkYXRlU2hvdzogZmFsc2UsXG4gICAgbWluRGF0ZTogbmV3IERhdGUoMjAyMCwgMCwgMSkuZ2V0VGltZSgpLFxuICAgIG1heERhdGU6IERhdGUubm93KCksXG4gICAgdXNlckluZm86IHt9IGFzIFVhcnQuVXNlckluZm9cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfliqDovb3mlbDmja4nIH0pXG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKClcbiAgICBkYXRlLnNldE1vbnRoKGRhdGUuZ2V0TW9udGgoKSAtIDEpXG4gICAgY29uc3Qgc3RhcnQgPSB0aGlzLmZvcm1hdERhdGUoZGF0ZSlcbiAgICBjb25zdCBlbmQgPSB0aGlzLmZvcm1hdERhdGUobmV3IERhdGUoKSlcbiAgICAvL1xuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBhcGkudXNlckluZm8oKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBkYXRlOiBzdGFydCArICctJyArIGVuZCxcbiAgICAgIHVzZXJJbmZvOiB1c2VyLmRhdGFcbiAgICB9KVxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5nZXRBbGFybUluZm8oKS50aGVuKCgpID0+IHtcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgfSlcbiAgICB9LCAyMDAwKVxuXG5cblxuICB9LFxuICAvKipcbiAgICog6K6i6ZiF5LiL5qyh5ZGK6K2mXG4gICAqL1xuICBhc3luYyBzdWJNZXNzYWdlKCkge1xuICAgIGlmICh0aGlzLmRhdGEudXNlckluZm8ud3hJZCkgcmV0dXJuXG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiAn6K6i6ZiF6ZW/5pyf5ZGK6K2mJyxcbiAgICAgIGNvbnRlbnQ6ICflsI/nqIvluo/pmZDliLYs5Y2V5qyh6K6i6ZiF5Y+q6IO95Y+R6YCB5LiA5p2h6K6i6ZiF5raI5oGvLOWmgumcgOmVv+acn+iuoumYheivt+WFs+azqOWFs+iBlOWFrOS8l+WPtycsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgIGNvbnN0IHVybCA9IGVuY29kZVVSSUNvbXBvbmVudCgnaHR0cDovL21wLndlaXhpbi5xcS5jb20vcz9fX2Jpej1Nak01TWpBMU1UZ3hPUT09Jm1pZD0zMDQ4MTk5MzkmaWR4PTEmc249ZDBiY2Q5MjIwMzMwNzVhZmEyYjUyMTlmYzk1ZWJiMWUmY2hrc209MzE3M2E5ZTcwNjA0MjBmMWE5OGQwMDQwZDk2NGEyZjgyYWYyNTI4OWE3MzFkMTQwMGM1MjI0Y2E5YmIzZDIyNWQ3Mzc3MDA3MDBhOCNyZCcpXG4gICAgICAgICAgd3gubmF2aWdhdGVUbyh7IHVybDogJy9wYWdlcy9pbmRleC93ZWIvd2ViP3VybD0nICsgdXJsIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDojrflj5blkYrorabkv6Hmga9cbiAgYXN5bmMgZ2V0QWxhcm1JbmZvKCkge1xuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IHRoaXMuZGF0YS5kYXRlLnNwbGl0KCctJylcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEsIG1zZyB9ID0gYXdhaXQgYXBpLmdldEFsYXJtKHN0YXJ0ICsgJyAwOjA6MCcsIGVuZCArICcgMjM6NTk6NTknKVxuICAgIGlmIChjb2RlKSB7XG4gICAgICBjb25zdCBBbGFybSA9IGRhdGFcbiAgICAgICAgLm1hcChlbCA9PiB7XG4gICAgICAgICAgZWwudGltZSA9IHRoaXMuZm9ybWF0dGltZShlbC50aW1lU3RhbXApXG4gICAgICAgICAgcmV0dXJuIGVsXG4gICAgICAgIH0pXG4gICAgICAgIC5yZXZlcnNlKClcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIEFsYXJtOiBBbGFybS5zbGljZSgwLCAxMClcbiAgICAgIH0pXG4gICAgICBpZiAoQWxhcm0ubGVuZ3RoID4gMTApIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIEFsYXJtOiBBbGFybS5zbGljZSgxMCwgLTEpXG4gICAgICAgICAgfSlcbiAgICAgICAgfSwgMTAwMCk7XG4gICAgICB9XG4gICAgICAvLyDorqHnrpfmnKrnoa7orqTlkYrorabmlbDph49cbiAgICAgIGNvbnN0IGFsYXJtTnVtID0gQWxhcm0uZmlsdGVyKGVsID0+ICFlbC5pc09rKS5sZW5ndGhcbiAgICAgIGlmIChhbGFybU51bSA+IDApIHd4LnNldFRhYkJhckJhZGdlKHsgaW5kZXg6IDEsIHRleHQ6IGFsYXJtTnVtLnRvU3RyaW5nKCkgfSlcbiAgICAgIGVsc2Ugd3gucmVtb3ZlVGFiQmFyQmFkZ2UoeyBpbmRleDogMSB9KVxuICAgICAgd3guc2V0U3RvcmFnZSh7IGtleTogJ2FsYXJtX2xpc3QnLCBkYXRhOiBBbGFybSB9KVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ+WPkeeUn+mUmeivrycsXG4gICAgICAgIGNvbnRlbnQ6IG1zZyB8fCAn5pyq55+l6ZSZ6K+vJ1xuICAgICAgfSlcbiAgICB9XG5cbiAgfSxcbiAgLy8g5pi+56S65pel5pyf6YCJ5oup5ZmoXG4gIHNob3dDYWxlbmRhcigpIHtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZGF0ZVNob3c6IHRydWVcbiAgICB9KVxuICB9LFxuICAvLyAg5YWz6Zet5pel5pyf6YCJ5oup5ZmoXG4gIG9uQ2xvc2UoKSB7XG4gICAgdGhpcy5zZXREYXRhKHsgZGF0ZVNob3c6IGZhbHNlIH0pO1xuICB9LFxuICBmb3JtYXREYXRlKGRhdGU6IERhdGUpIHtcbiAgICBkYXRlID0gbmV3IERhdGUoZGF0ZSk7XG4gICAgcmV0dXJuIGAke2RhdGUuZ2V0RnVsbFllYXIoKX0vJHtkYXRlLmdldE1vbnRoKCkgKyAxfS8ke2RhdGUuZ2V0RGF0ZSgpfWA7XG4gIH0sXG4gIC8vIOehruWumuaXpeacn1xuICBvbkNvbmZpcm0oZXZlbnQ6IGFueSkge1xuICAgIGNvbnN0IFtzdGFydCwgZW5kXSA9IGV2ZW50LmRldGFpbDtcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZGF0ZVNob3c6IGZhbHNlLFxuICAgICAgZGF0ZTogYCR7dGhpcy5mb3JtYXREYXRlKHN0YXJ0KX0gLSAke3RoaXMuZm9ybWF0RGF0ZShlbmQpfWAsXG4gICAgfSk7XG4gICAgdGhpcy5nZXRBbGFybUluZm8oKVxuICB9LFxuICAvLyDnoa7orqTlkYrorabkv6Hmga9cbiAgc2hvd2FsYXJtKGV2ZW50OiB2YW50RXZlbnQ8VWFydC51YXJ0QWxhcm1PYmplY3QgJiB7IF9pZDogc3RyaW5nIH0+KSB7XG4gICAgY29uc3QgYWxhcm0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IGtleSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5rZXkgYXMgbnVtYmVyXG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiBhbGFybS5kZXZOYW1lLFxuICAgICAgY29udGVudDogYWxhcm0ubXNnLFxuICAgICAgc2hvd0NhbmNlbDogIWFsYXJtLmlzT2ssXG4gICAgICAvLyBjb25maXJtQ29sb3I6ICdncmVlbicsXG4gICAgICBjb25maXJtVGV4dDogYWxhcm0uaXNPayA/ICfnoa7lrponIDogJ+ehruiupOa2iOaBrycsXG4gICAgICBzdWNjZXNzOiBhc3luYyAocmVzKSA9PiB7XG4gICAgICAgIGlmIChyZXMuY29uZmlybSAmJiAhYWxhcm0uaXNPaykge1xuICAgICAgICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfnoa7orqTlkYrorabkv6Hmga8nIH0pXG4gICAgICAgICAgYXdhaXQgYXBpLmNvbmZyaW1BbGFybShhbGFybS5faWQpXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIFtgQWxhcm1bJHtrZXl9XS5pc09rYF06IHRydWVcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc3ViTWVzc2FnZSgpXG4gICAgICAgICAgd3guc2V0VGFiQmFyQmFkZ2UoeyBpbmRleDogMSwgdGV4dDogdGhpcy5kYXRhLkFsYXJtLmZpbHRlcihlbCA9PiAhZWwuaXNPaykubGVuZ3RoLnRvU3RyaW5nKCkgfSlcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDlhajpg6jnoa7orqRcbiAgYWxsUXVlc3QoKSB7XG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiBcIlRpcHNcIixcbiAgICAgIGNvbnRlbnQ6IFwi5piv5ZCm56Gu6K6k5YWo6YOo5ZGK6K2m5L+h5oGvP1wiLFxuICAgICAgc3VjY2VzczogYXN5bmMgKHJlcykgPT4ge1xuICAgICAgICBpZiAocmVzLmNvbmZpcm0pIHtcbiAgICAgICAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn56Gu6K6k5ZGK6K2m5L+h5oGvJyB9KVxuICAgICAgICAgIGF3YWl0IGFwaS5jb25mcmltQWxhcm0oKVxuICAgICAgICAgIHd4LnN0YXJ0UHVsbERvd25SZWZyZXNoKClcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgICAgdGhpcy5zdWJNZXNzYWdlKClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cblxuXG4gIC8vIOS4i+aLieWIt+aWsFxuICBhc3luYyBvblB1bGxEb3duUmVmcmVzaCgpIHtcbiAgICB0aGlzLmdldEFsYXJtSW5mbygpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH0sXG5cbiAgXG4gIGZvcm1hdHRpbWUodGltZTogbnVtYmVyKSB7XG4gICAgY29uc3QgRGF0ZXMgPSBuZXcgRGF0ZSh0aW1lKVxuICAgIHJldHVybiBgJHtEYXRlcy5nZXRNb250aCgpICsgMX0tJHtEYXRlcy5nZXREYXRlKCl9ICR7RGF0ZXMuZ2V0SG91cnMoKX06JHtEYXRlcy5nZXRNaW51dGVzKCl9OiR7RGF0ZXMuZ2V0U2Vjb25kcygpfWBcbiAgfVxufSkiXX0=