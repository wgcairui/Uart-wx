"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const unitCache_1 = require("../../../utils/unitCache");
const api_1 = require("../../../utils/api");
const util_1 = require("../../../utils/util");
Page({
    data: {
        active: 0,
        protocol: '',
        usersetup: {},
        syssetup: {},
        Protocols: {},
        showTag: [],
        alarmStat: [],
        Threshold: []
    },
    onLoad: async function (options) {
        const protocol = options.protocol;
        if (!protocol) {
            wx.navigateTo({
                url: '/pages/index/alarmSetting/index'
            });
            return;
        }
        const active = Number(options.type) || 0;
        this.setData({
            active: active,
            protocol
        });
        await this.getUserProtocolSetup();
        if (active === 1)
            this.updateThre();
        if (active === 2)
            this.updateAlarm();
    },
    async getUserProtocolSetup() {
        wx.showLoading({ title: '获取协议配置' });
        const userSetup = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        const sysSetup = await api_1.default.getAlarmProtocol(this.data.protocol);
        const Protocols = await api_1.default.getProtocol(this.data.protocol);
        wx.hideLoading();
        if (userSetup && sysSetup) {
            this.setData({
                usersetup: userSetup.data,
                syssetup: sysSetup.data,
                Protocols: Protocols.data,
                showTag: userSetup.data.ShowTag
            });
        }
        else {
            wx.showModal({
                title: "Error",
                content: '设备协议b不支持配置'
            });
        }
    },
    parseProtocol() {
        const protocolArray = this.data.Protocols.instruct.map(instruct => {
            return instruct.formResize.map(el => ({ [el.name]: el.isState ? unitCache_1.default.getunitObject(1, el.unit) : {} }));
        }).reduce((pre, cur) => {
            return [...pre, ...cur];
        });
        return Object.assign({}, ...protocolArray);
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: '协议配置-' + event.detail.title });
        switch (event.detail.title) {
            case "参数限值":
                this.updateThre();
                break;
            case "参数状态":
                this.updateAlarm();
                break;
        }
    },
    updateThre() {
        const { usersetup, syssetup } = this.data;
        const sys_ThresholdMap = new Map(syssetup.Threshold.map(el => [el.name, el]));
        if (usersetup?.Threshold) {
            [...this.data.Threshold, ...usersetup.Threshold].forEach((val) => {
                sys_ThresholdMap.set(val.name, val);
            });
        }
        this.setData({
            Threshold: Array.from(sys_ThresholdMap.values())
        });
    },
    updateAlarm() {
        const { usersetup, syssetup } = this.data;
        const sys_alarmStatMap = new Map(syssetup.AlarmStat.map(el => [el.name, el]));
        if (usersetup?.AlarmStat) {
            [...usersetup.AlarmStat, ...this.data.alarmStat].forEach(val => {
                sys_alarmStatMap.set(val.name, val);
            });
        }
        const parse = this.parseProtocol();
        sys_alarmStatMap.forEach((el, key) => {
            el.parse = parse[key];
        });
        this.setData({
            alarmStat: Array.from(sys_alarmStatMap.values())
        });
    },
    async ShowTagonChange(event) {
        console.log({ event });
        const tags = event.detail;
        this.setData({
            showTag: tags
        });
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'ShowTag', tags || [])
            .then(res => {
            wx.showToast({
                title: res.code === 200 ? '显示参数修改成功' : '修改失败',
                icon: res.code === 200 ? 'success' : 'error',
            });
        });
    },
    ShowTagtoggle(_event) {
    },
    async AlarmStatonChange(event) {
        const item = event.currentTarget.dataset.item;
        const value = event.detail;
        const index = this.data.alarmStat.findIndex(el => el.name === item.name);
        this.setData({
            ["alarmStat[" + index + "].alarmStat"]: value
        });
        const data = this.data.alarmStat[index];
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'AlarmStat', data)
            .then(res => {
            wx.showToast({
                title: res.code === 200 ? '状态参数修改成功' : '修改失败',
                icon: res.code === 200 ? 'success' : 'error',
            });
        });
    },
    ThresholdClick(event) {
        const item = event.currentTarget.dataset.item;
        const index = event.currentTarget.dataset.index;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/threshold/threshold' + (0, util_1.ObjectToStrquery)({ ...item }),
            events: {
                modifyThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data })
                        .then(res => {
                        wx.showToast({
                            title: res.code === 200 ? '约束参数修改成功' : '修改失败',
                            icon: res.code === 200 ? 'success' : 'error',
                        });
                    });
                    this.setData({
                        [`Threshold[${index}]`]: { ...data, icon: "star" }
                    });
                }
            }
        });
    },
    addThreshold() {
        const ua = this.data.usersetup?.AlarmStat || [];
        const keys = new Set([...this.data.alarmStat.map(el => el.name), ...ua.map(el => el.name)]);
        wx.navigateTo({
            url: '/pages/index/alarmSetting/addThreshold/addThreshold' + (0, util_1.ObjectToStrquery)({ protocol: this.data.protocol, keys: Array.from(keys) }),
            events: {
                addThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data });
                    const newThre = this.data.Threshold.concat(data);
                    this.setData({
                        Threshold: newThre
                    });
                }
            }
        });
    },
    async saveSetup() {
        const { usersetup, alarmStat, Threshold, protocol } = this.data;
        {
            const userShowtags = usersetup.ShowTag || [];
            const showtag = this.data.showTag || [];
            if (userShowtags.sort().join("") !== showtag.sort().join('')) {
                await api_1.default.setUserSetupProtocol(protocol, 'ShowTag', showtag || []);
            }
        }
        {
            const userAlarm = usersetup.AlarmStat || [];
            const alarm = alarmStat || [];
            const b1 = userAlarm.map(el => el.name).sort().join('') !== alarm.map(el => el.name).sort().join('');
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
            }
            else if (alarm.length !== 0) {
                const ua = userAlarm.sort();
                const ka = alarm.sort();
                const compare = ua.every((el, index) => el.alarmStat.sort().join('') !== ka[index].alarmStat.sort().join(''));
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
                }
            }
        }
        {
            const userThre = usersetup.Threshold || [];
            const thre = Threshold || [];
            const b1 = userThre.map(el => el.name).sort().join('') !== thre.map(el => el.name).sort().join('');
            const data = thre.map(el => ({ name: el.name, min: el.min, max: el.max }));
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
            }
            else if (thre.length !== 0) {
                const ua = userThre.sort();
                const ka = thre.sort();
                const compare = ua.every((el, index) => el.min !== ka[index].min || el.max !== ka[index].max);
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
                }
            }
        }
    },
    onUnload: function () {
    },
    onPullDownRefresh: async function () {
        await this.getUserProtocolSetup();
        wx.stopPullDownRefresh();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm1TZXR0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxhcm1TZXR0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0RBQWdEO0FBQ2hELDRDQUFvQztBQUNwQyw4Q0FBc0Q7QUFFdEQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLENBQUM7UUFDVCxRQUFRLEVBQUUsRUFBRTtRQUNaLFNBQVMsRUFBRSxFQUFvQztRQUMvQyxRQUFRLEVBQUUsRUFBb0M7UUFDOUMsU0FBUyxFQUFFLEVBQW1CO1FBQzlCLE9BQU8sRUFBRSxFQUFjO1FBQ3ZCLFNBQVMsRUFBRSxFQUE4QjtRQUN6QyxTQUFTLEVBQUUsRUFBc0I7S0FDbEM7SUFLRCxNQUFNLEVBQUUsS0FBSyxXQUFXLE9BQVk7UUFDbEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQTtRQUNqQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDZCxFQUFFLENBQUMsVUFBVSxDQUFDO2dCQUNaLEdBQUcsRUFBRSxpQ0FBaUM7YUFDdkMsQ0FBQyxDQUFBO1lBQ0YsT0FBTTtRQUNSLENBQUM7UUFDRCxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsTUFBTSxFQUFFLE1BQU07WUFDZCxRQUFRO1NBQ1QsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtRQUNqQyxJQUFJLE1BQU0sS0FBSyxDQUFDO1lBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFBO1FBQ25DLElBQUksTUFBTSxLQUFLLENBQUM7WUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDdEMsQ0FBQztJQUdELEtBQUssQ0FBQyxvQkFBb0I7UUFDeEIsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxR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V0FBVyxFQUFFLElBQUksQ0FBQyxDQUFBO2dCQUM3RCxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBS0QsUUFBUSxFQUFFO0lBRVYsQ0FBQztJQUtELGlCQUFpQixFQUFFLEtBQUs7UUFDdEIsTUFBTSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQTtRQUNqQyxFQUFFLENBQUMsbUJBQW1CLEVBQUUsQ0FBQTtJQUMxQixDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHVuaXRDYWNoZSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdW5pdENhY2hlXCJcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5pbXBvcnQgeyBPYmplY3RUb1N0cnF1ZXJ5IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuXG5QYWdlKHtcbiAgZGF0YToge1xuICAgIGFjdGl2ZTogMCxcbiAgICBwcm90b2NvbDogJycsXG4gICAgdXNlcnNldHVwOiB7fSBhcyBVYXJ0LlByb3RvY29sQ29uc3RhbnRUaHJlc2hvbGQsXG4gICAgc3lzc2V0dXA6IHt9IGFzIFVhcnQuUHJvdG9jb2xDb25zdGFudFRocmVzaG9sZCxcbiAgICBQcm90b2NvbHM6IHt9IGFzIFVhcnQucHJvdG9jb2wsXG4gICAgc2hvd1RhZzogW10gYXMgc3RyaW5nW10sXG4gICAgYWxhcm1TdGF0OiBbXSBhcyBVYXJ0LkNvbnN0YW50QWxhcm1TdGF0W10sXG4gICAgVGhyZXNob2xkOiBbXSBhcyBVYXJ0LlRocmVzaG9sZFtdXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XG4gICAqL1xuICBvbkxvYWQ6IGFzeW5jIGZ1bmN0aW9uIChvcHRpb25zOiBhbnkpIHtcbiAgICBjb25zdCBwcm90b2NvbCA9IG9wdGlvbnMucHJvdG9jb2xcbiAgICBpZiAoIXByb3RvY29sKSB7XG4gICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtU2V0dGluZy9pbmRleCdcbiAgICAgIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgY29uc3QgYWN0aXZlID0gTnVtYmVyKG9wdGlvbnMudHlwZSkgfHwgMFxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBhY3RpdmU6IGFjdGl2ZSxcbiAgICAgIHByb3RvY29sXG4gICAgfSlcbiAgICBhd2FpdCB0aGlzLmdldFVzZXJQcm90b2NvbFNldHVwKClcbiAgICBpZiAoYWN0aXZlID09PSAxKSB0aGlzLnVwZGF0ZVRocmUoKVxuICAgIGlmIChhY3RpdmUgPT09IDIpIHRoaXMudXBkYXRlQWxhcm0oKVxuICB9LFxuXG4gIC8vIOiOt+WPlueUqOaIt+WNj+iurumFjee9rlxuICBhc3luYyBnZXRVc2VyUHJvdG9jb2xTZXR1cCgpIHtcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn6I635Y+W5Y2P6K6u6YWN572uJyB9KVxuICAgIGNvbnN0IHVzZXJTZXR1cCA9IGF3YWl0IGFwaS5nZXRVc2VyQWxhcm1Qcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wpXG4gICAgY29uc3Qgc3lzU2V0dXAgPSBhd2FpdCBhcGkuZ2V0QWxhcm1Qcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wpXG4gICAgY29uc3QgUHJvdG9jb2xzID0gYXdhaXQgYXBpLmdldFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKHVzZXJTZXR1cCAmJiBzeXNTZXR1cCkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgdXNlcnNldHVwOiB1c2VyU2V0dXAuZGF0YSxcbiAgICAgICAgc3lzc2V0dXA6IHN5c1NldHVwLmRhdGEsXG4gICAgICAgIFByb3RvY29sczogUHJvdG9jb2xzLmRhdGEsXG4gICAgICAgIHNob3dUYWc6IHVzZXJTZXR1cC5kYXRhLlNob3dUYWdcbiAgICAgIH0pXG5cbiAgICB9IGVsc2Uge1xuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6IFwiRXJyb3JcIixcbiAgICAgICAgY29udGVudDogJ+iuvuWkh+WNj+iurmLkuI3mlK/mjIHphY3nva4nXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICAvLyDov5Tlm57ljY/orq7lj4LmlbDlr7nosaHop6PmnpBcbiAgcGFyc2VQcm90b2NvbCgpIHtcbiAgICBjb25zdCBwcm90b2NvbEFycmF5ID0gdGhpcy5kYXRhLlByb3RvY29scy5pbnN0cnVjdC5tYXAoaW5zdHJ1Y3QgPT4ge1xuICAgICAgcmV0dXJuIGluc3RydWN0LmZvcm1SZXNpemUubWFwKGVsID0+ICh7IFtlbC5uYW1lXTogZWwuaXNTdGF0ZSA/IHVuaXRDYWNoZS5nZXR1bml0T2JqZWN0KDEsIGVsLnVuaXQgYXMgc3RyaW5nKSA6IHt9IH0pKVxuICAgIH0pLnJlZHVjZSgocHJlLCBjdXIpID0+IHtcbiAgICAgIHJldHVybiBbLi4ucHJlLCAuLi5jdXJdXG4gICAgfSlcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgLi4ucHJvdG9jb2xBcnJheSkgYXMgeyBbeDogc3RyaW5nXTogeyBbeDogc3RyaW5nXTogc3RyaW5nIH1bXSB9XG4gIH0sXG4gIC8vIOS/ruaUueagh+mimFxuICB0YWJjbGljayhldmVudDogdmFudEV2ZW50KSB7XG4gICAgd3guc2V0TmF2aWdhdGlvbkJhclRpdGxlKHsgdGl0bGU6ICfljY/orq7phY3nva4tJyArIGV2ZW50LmRldGFpbC50aXRsZSB9KVxuICAgIHN3aXRjaCAoZXZlbnQuZGV0YWlsLnRpdGxlKSB7XG4gICAgICBjYXNlIFwi5Y+C5pWw6ZmQ5YC8XCI6XG4gICAgICAgIHRoaXMudXBkYXRlVGhyZSgpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlIFwi5Y+C5pWw54q25oCBXCI6XG4gICAgICAgIHRoaXMudXBkYXRlQWxhcm0oKVxuICAgICAgICBicmVha1xuICAgIH1cbiAgfSxcbiAgLy8g5pu05pawdGhyZeWIl+ihqFxuICB1cGRhdGVUaHJlKCkge1xuICAgIGNvbnN0IHsgdXNlcnNldHVwLCBzeXNzZXR1cCB9ID0gdGhpcy5kYXRhXG4gICAgY29uc3Qgc3lzX1RocmVzaG9sZE1hcCA9IG5ldyBNYXAoc3lzc2V0dXAuVGhyZXNob2xkLm1hcChlbCA9PiBbZWwubmFtZSwgZWxdKSlcbiAgICBpZiAodXNlcnNldHVwPy5UaHJlc2hvbGQpIHtcbiAgICAgIC8vIOi/reS7o+eUqOaIt+mFjee9ru+8jOimhuebluezu+e7n+mFjee9rlxuICAgICAgWy4uLnRoaXMuZGF0YS5UaHJlc2hvbGQsIC4uLnVzZXJzZXR1cC5UaHJlc2hvbGRdLmZvckVhY2goKHZhbCkgPT4ge1xuICAgICAgICBzeXNfVGhyZXNob2xkTWFwLnNldCh2YWwubmFtZSwgdmFsKVxuICAgICAgfSlcbiAgICB9XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIFRocmVzaG9sZDogQXJyYXkuZnJvbShzeXNfVGhyZXNob2xkTWFwLnZhbHVlcygpKVxuICAgIH0pXG4gIH0sXG4gIC8vIOabtOaWsGFsYXJt5YiX6KGoXG4gIHVwZGF0ZUFsYXJtKCkge1xuICAgIGNvbnN0IHsgdXNlcnNldHVwLCBzeXNzZXR1cCB9ID0gdGhpcy5kYXRhXG4gICAgY29uc3Qgc3lzX2FsYXJtU3RhdE1hcCA9IG5ldyBNYXAoc3lzc2V0dXAuQWxhcm1TdGF0Lm1hcChlbCA9PiBbZWwubmFtZSwgZWxdKSlcbiAgICBpZiAodXNlcnNldHVwPy5BbGFybVN0YXQpIHtcbiAgICAgIFsuLi51c2Vyc2V0dXAuQWxhcm1TdGF0LCAuLi50aGlzLmRhdGEuYWxhcm1TdGF0XS5mb3JFYWNoKHZhbCA9PiB7XG4gICAgICAgIHN5c19hbGFybVN0YXRNYXAuc2V0KHZhbC5uYW1lLCB2YWwpXG4gICAgICB9KVxuICAgIH1cbiAgICBjb25zdCBwYXJzZSA9IHRoaXMucGFyc2VQcm90b2NvbCgpXG4gICAgc3lzX2FsYXJtU3RhdE1hcC5mb3JFYWNoKChlbDphbnksIGtleSkgPT4ge1xuICAgICAgZWwucGFyc2UgPSBwYXJzZVtrZXldXG4gICAgfSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgYWxhcm1TdGF0OiBBcnJheS5mcm9tKHN5c19hbGFybVN0YXRNYXAudmFsdWVzKCkpXG4gICAgfSlcbiAgfSxcbiAgLy8gIOebkeWQrOaYvuekuuWPguaVsOWPmOWMllxuICBhc3luYyBTaG93VGFnb25DaGFuZ2UoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIGNvbnNvbGUubG9nKHsgZXZlbnQgfSk7XG5cbiAgICBjb25zdCB0YWdzID0gZXZlbnQuZGV0YWlsIGFzIHN0cmluZ1tdXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHNob3dUYWc6IHRhZ3NcbiAgICB9KVxuICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wsICdTaG93VGFnJywgdGFncyB8fCBbXSlcbiAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgICAgdGl0bGU6IHJlcy5jb2RlID09PSAyMDAgPyAn5pi+56S65Y+C5pWw5L+u5pS55oiQ5YqfJyA6ICfkv67mlLnlpLHotKUnLFxuICAgICAgICAgIGljb246cmVzLmNvZGUgPT09IDIwMCA/ICdzdWNjZXNzJyA6ICdlcnJvcicsXG4gICAgICAgIH0pXG4gICAgICB9KVxuICB9LFxuICAvLyDkv67mlLnmmL7npLrlj4LmlbDlj5jljJblgLxcbiAgU2hvd1RhZ3RvZ2dsZShfZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIC8vY29uc29sZS5sb2coZXZlbnQpO1xuXG4gICAgLyogY29uc3QgeyBpbmRleCB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgIGNvbnN0IGNoZWNrYm94ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoYC5jaGVja2JveGVzLSR7aW5kZXh9YCk7XG4gICAgY2hlY2tiLnRvZ2dsZSgpOyAqL1xuICB9LFxuICAvLyDnm5HlkKzlj4LmlbDnirbmgIHlj5jljJZcbiAgYXN5bmMgQWxhcm1TdGF0b25DaGFuZ2UoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LkNvbnN0YW50QWxhcm1TdGF0Pikge1xuICAgIGNvbnN0IGl0ZW0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHZhbHVlID0gZXZlbnQuZGV0YWlsIGFzIHN0cmluZ1tdXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmRhdGEuYWxhcm1TdGF0LmZpbmRJbmRleChlbCA9PiBlbC5uYW1lID09PSBpdGVtLm5hbWUpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIFtcImFsYXJtU3RhdFtcIiArIGluZGV4ICsgXCJdLmFsYXJtU3RhdFwiXTogdmFsdWVcbiAgICB9KVxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGEuYWxhcm1TdGF0W2luZGV4XVxuICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wsICdBbGFybVN0YXQnLCBkYXRhKVxuICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICB0aXRsZTogcmVzLmNvZGUgPT09IDIwMCA/ICfnirbmgIHlj4LmlbDkv67mlLnmiJDlip8nIDogJ+S/ruaUueWksei0pScsXG4gICAgICAgIGljb246cmVzLmNvZGUgPT09IDIwMCA/ICdzdWNjZXNzJyA6ICdlcnJvcicsXG4gICAgICB9KVxuICAgIH0pXG5cbiAgfSxcbiAgLy8g6Lez6L2s5Yiw5Y+C5pWw6ZmQ5YC85L+u5pS56aG16Z2iXG4gIFRocmVzaG9sZENsaWNrKGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UaHJlc2hvbGQ+KSB7XG4gICAgY29uc3QgaXRlbSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3QgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5kZXhcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9hbGFybVNldHRpbmcvdGhyZXNob2xkL3RocmVzaG9sZCcgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgLi4uaXRlbSB9KSxcbiAgICAgIGV2ZW50czoge1xuICAgICAgICBtb2RpZnlUaHJlc2hvbGQ6IGFzeW5jIChkYXRhOiBVYXJ0LlRocmVzaG9sZCkgPT4ge1xuICAgICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wsIFwiVGhyZXNob2xkXCIsIHsgdHlwZTogJ2FkZCcsIGRhdGEgfSlcbiAgICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgdGl0bGU6IHJlcy5jb2RlID09PSAyMDAgPyAn57qm5p2f5Y+C5pWw5L+u5pS55oiQ5YqfJyA6ICfkv67mlLnlpLHotKUnLFxuICAgICAgICAgICAgICBpY29uOnJlcy5jb2RlID09PSAyMDAgPyAnc3VjY2VzcycgOiAnZXJyb3InLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBbYFRocmVzaG9sZFske2luZGV4fV1gXTogeyAuLi5kYXRhLCBpY29uOiBcInN0YXJcIiB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOi3s+i9rOWIsOaWsOWinuWPguaVsOmZkOWAvOmhtemdolxuICBhZGRUaHJlc2hvbGQoKSB7XG4gICAgLy8g6I635Y+W546w5pyJ55qEdGhyZeWQjeensFxuICAgIGNvbnN0IHVhID0gdGhpcy5kYXRhLnVzZXJzZXR1cD8uQWxhcm1TdGF0IHx8IFtdXG4gICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoWy4uLnRoaXMuZGF0YS5hbGFybVN0YXQubWFwKGVsID0+IGVsLm5hbWUpLCAuLi51YS5tYXAoZWwgPT4gZWwubmFtZSldKVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtU2V0dGluZy9hZGRUaHJlc2hvbGQvYWRkVGhyZXNob2xkJyArIE9iamVjdFRvU3RycXVlcnkoeyBwcm90b2NvbDogdGhpcy5kYXRhLnByb3RvY29sLCBrZXlzOiBBcnJheS5mcm9tKGtleXMpIH0pLFxuICAgICAgZXZlbnRzOiB7XG4gICAgICAgIGFkZFRocmVzaG9sZDogYXN5bmMgKGRhdGE6IFVhcnQuVGhyZXNob2xkKSA9PiB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbCwgXCJUaHJlc2hvbGRcIiwgeyB0eXBlOiAnYWRkJywgZGF0YSB9KVxuICAgICAgICAgIGNvbnN0IG5ld1RocmUgPSB0aGlzLmRhdGEuVGhyZXNob2xkLmNvbmNhdChkYXRhKVxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBUaHJlc2hvbGQ6IG5ld1RocmVcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLy8g5L+d5a2Y6YWN572uXG4gIGFzeW5jIHNhdmVTZXR1cCgpIHtcbiAgICBjb25zdCB7IHVzZXJzZXR1cCwgYWxhcm1TdGF0LCBUaHJlc2hvbGQsIHByb3RvY29sIH0gPSB0aGlzLmRhdGFcbiAgICAvLyDmm7TmlrDnlKjmiLdzaG93VGFnc+mFjee9rlxuICAgIHtcbiAgICAgIGNvbnN0IHVzZXJTaG93dGFncyA9IHVzZXJzZXR1cC5TaG93VGFnIHx8IFtdXG4gICAgICBjb25zdCBzaG93dGFnID0gdGhpcy5kYXRhLnNob3dUYWcgfHwgW11cbiAgICAgIGlmICh1c2VyU2hvd3RhZ3Muc29ydCgpLmpvaW4oXCJcIikgIT09IHNob3d0YWcuc29ydCgpLmpvaW4oJycpKSB7XG4gICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbChwcm90b2NvbCwgJ1Nob3dUYWcnLCBzaG93dGFnIHx8IFtdKVxuICAgICAgfVxuICAgIH1cbiAgICAvLyDmm7TmlrDnlKjmiLdhbGFybVN0YXTphY3nva5cbiAgICB7XG4gICAgICAvLyDmr5TovoPlkI3np7Bqb2lu5piv5ZCm5LiA6Ie077yM5LiA6Ie055qE6K+d5qOA5p+l6ZSu5piv5ZCm5LiA6Ie077yM5LiN5LiA6Ie055u05o6l5pu05paw77yM6ZSu5LiA6Ie05YiZ5q+U6L6D5YC877yM5YC85LiN5LiA6Ie05Lmf5pu05pawXG4gICAgICBjb25zdCB1c2VyQWxhcm0gPSB1c2Vyc2V0dXAuQWxhcm1TdGF0IHx8IFtdXG4gICAgICBjb25zdCBhbGFybSA9IGFsYXJtU3RhdCB8fCBbXVxuICAgICAgY29uc3QgYjEgPSB1c2VyQWxhcm0ubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKSAhPT0gYWxhcm0ubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKVxuICAgICAgaWYgKGIxKSB7XG4gICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbChwcm90b2NvbCwgJ0FsYXJtU3RhdCcsIGFsYXJtU3RhdClcbiAgICAgIH0gZWxzZSBpZiAoYWxhcm0ubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIGNvbnN0IHVhID0gdXNlckFsYXJtLnNvcnQoKVxuICAgICAgICBjb25zdCBrYSA9IGFsYXJtLnNvcnQoKVxuICAgICAgICBjb25zdCBjb21wYXJlID0gdWEuZXZlcnkoKGVsLCBpbmRleCkgPT4gZWwuYWxhcm1TdGF0LnNvcnQoKS5qb2luKCcnKSAhPT0ga2FbaW5kZXhdLmFsYXJtU3RhdC5zb3J0KCkuam9pbignJykpXG4gICAgICAgIGlmIChjb21wYXJlKSB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCAnQWxhcm1TdGF0JywgYWxhcm1TdGF0KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIC8vIOabtOaWsOeUqOaIt3RocmVhZOmFjee9rlxuICAgIHtcbiAgICAgIC8vIOavlOi+g+WQjeensGpvaW7mmK/lkKbkuIDoh7TvvIzkuIDoh7TnmoTor53mo4Dmn6XplK7mmK/lkKbkuIDoh7TvvIzkuI3kuIDoh7Tnm7TmjqXmm7TmlrDvvIzplK7kuIDoh7TliJnmr5TovoPlgLzvvIzlgLzkuI3kuIDoh7TkuZ/mm7TmlrBcbiAgICAgIGNvbnN0IHVzZXJUaHJlID0gdXNlcnNldHVwLlRocmVzaG9sZCB8fCBbXVxuICAgICAgY29uc3QgdGhyZSA9IFRocmVzaG9sZCB8fCBbXVxuICAgICAgY29uc3QgYjEgPSB1c2VyVGhyZS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpICE9PSB0aHJlLm1hcChlbCA9PiBlbC5uYW1lKS5zb3J0KCkuam9pbignJylcbiAgICAgIGNvbnN0IGRhdGEgPSB0aHJlLm1hcChlbCA9PiAoeyBuYW1lOiBlbC5uYW1lLCBtaW46IGVsLm1pbiwgbWF4OiBlbC5tYXggfSkpXG4gICAgICBpZiAoYjEpIHtcbiAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCBcIlRocmVzaG9sZFwiLCBkYXRhKVxuICAgICAgfSBlbHNlIGlmICh0aHJlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICBjb25zdCB1YSA9IHVzZXJUaHJlLnNvcnQoKVxuICAgICAgICBjb25zdCBrYSA9IHRocmUuc29ydCgpXG4gICAgICAgIGNvbnN0IGNvbXBhcmUgPSB1YS5ldmVyeSgoZWwsIGluZGV4KSA9PiBlbC5taW4gIT09IGthW2luZGV4XS5taW4gfHwgZWwubWF4ICE9PSBrYVtpbmRleF0ubWF4KVxuICAgICAgICBpZiAoY29tcGFyZSkge1xuICAgICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbChwcm90b2NvbCwgXCJUaHJlc2hvbGRcIiwgZGF0YSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cbiAgICovXG4gIG9uVW5sb2FkOiBmdW5jdGlvbiAoKSB7XG4gICAgLy90aGlzLnNhdmVTZXR1cCgpXG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IHRoaXMuZ2V0VXNlclByb3RvY29sU2V0dXAoKVxuICAgIHd4LnN0b3BQdWxsRG93blJlZnJlc2goKVxuICB9XG59KSJdfQ==