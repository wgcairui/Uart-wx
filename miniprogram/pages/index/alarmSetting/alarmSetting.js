"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const unitCache_1 = require("../../../utils/unitCache");
const api_1 = require("../../../utils/api");
const util_1 = require("../../../utils/util");
Page({
    data: {
        active: 0,
        protocol: '',
        usersetup: {},
        syssetup: {},
        Protocols: {},
        showTag: [],
        alarmStat: [],
        Threshold: []
    },
    onLoad: async function (options) {
        const protocol = options.protocol;
        if (!protocol) {
            wx.navigateTo({
                url: '/pages/index/alarmSetting/index'
            });
            return;
        }
        const active = Number(options.type) || 0;
        this.setData({
            active: active,
            protocol
        });
        await this.getUserProtocolSetup();
        if (active === 1)
            this.updateThre();
        if (active === 2)
            this.updateAlarm();
    },
    async getUserProtocolSetup() {
        wx.showLoading({ title: '获取协议配置' });
        const userSetup = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        const sysSetup = await api_1.default.getAlarmProtocol(this.data.protocol);
        const Protocols = await api_1.default.getProtocol(this.data.protocol);
        wx.hideLoading();
        if (userSetup && sysSetup) {
            this.setData({
                usersetup: userSetup.data,
                syssetup: sysSetup.data,
                Protocols: Protocols.data,
                showTag: userSetup.data.ShowTag
            });
        }
        else {
            wx.showModal({
                title: "Error",
                content: '设备协议b不支持配置'
            });
        }
    },
    parseProtocol() {
        const protocolArray = this.data.Protocols.instruct.map(instruct => {
            return instruct.formResize.map(el => ({ [el.name]: el.isState ? unitCache_1.default.getunitObject(1, el.unit) : {} }));
        }).reduce((pre, cur) => {
            return [...pre, ...cur];
        });
        return Object.assign({}, ...protocolArray);
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: '协议配置-' + event.detail.title });
        switch (event.detail.title) {
            case "参数限值":
                this.updateThre();
                break;
            case "参数状态":
                this.updateAlarm();
                break;
        }
    },
    updateThre() {
        const { usersetup, syssetup } = this.data;
        const sys_ThresholdMap = new Map(syssetup.Threshold.map(el => [el.name, el]));
        if (usersetup?.Threshold) {
            [...this.data.Threshold, ...usersetup.Threshold].forEach((val) => {
                sys_ThresholdMap.set(val.name, val);
            });
        }
        this.setData({
            Threshold: Array.from(sys_ThresholdMap.values())
        });
    },
    updateAlarm() {
        const { usersetup, syssetup } = this.data;
        const sys_alarmStatMap = new Map(syssetup.AlarmStat.map(el => [el.name, el]));
        if (usersetup?.AlarmStat) {
            [...usersetup.AlarmStat, ...this.data.alarmStat].forEach(val => {
                sys_alarmStatMap.set(val.name, val);
            });
        }
        const parse = this.parseProtocol();
        sys_alarmStatMap.forEach((el, key) => {
            el.parse = parse[key];
        });
        this.setData({
            alarmStat: Array.from(sys_alarmStatMap.values())
        });
    },
    async ShowTagonChange(event) {
        console.log({ event });
        const tags = event.detail;
        this.setData({
            showTag: tags
        });
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'ShowTag', tags || []);
    },
    ShowTagtoggle(event) {
    },
    async AlarmStatonChange(event) {
        const item = event.currentTarget.dataset.item;
        const value = event.detail;
        const index = this.data.alarmStat.findIndex(el => el.name === item.name);
        this.setData({
            ["alarmStat[" + index + "].alarmStat"]: value
        });
        const data = this.data.alarmStat[index];
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'AlarmStat', data);
    },
    ThresholdClick(event) {
        const item = event.currentTarget.dataset.item;
        const index = event.currentTarget.dataset.index;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/threshold/threshold' + (0, util_1.ObjectToStrquery)({ ...item }),
            events: {
                modifyThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data });
                    this.setData({
                        [`Threshold[${index}]`]: { ...data, icon: "star" }
                    });
                }
            }
        });
    },
    addThreshold() {
        const ua = this.data.usersetup?.AlarmStat || [];
        const keys = new Set([...this.data.alarmStat.map(el => el.name), ...ua.map(el => el.name)]);
        wx.navigateTo({
            url: '/pages/index/alarmSetting/addThreshold/addThreshold' + (0, util_1.ObjectToStrquery)({ protocol: this.data.protocol, keys: Array.from(keys) }),
            events: {
                addThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data });
                    const newThre = this.data.Threshold.concat(data);
                    this.setData({
                        Threshold: newThre
                    });
                }
            }
        });
    },
    async saveSetup() {
        const { usersetup, alarmStat, Threshold, protocol } = this.data;
        {
            const userShowtags = usersetup.ShowTag || [];
            const showtag = this.data.showTag || [];
            if (userShowtags.sort().join("") !== showtag.sort().join('')) {
                await api_1.default.setUserSetupProtocol(protocol, 'ShowTag', showtag || []);
            }
        }
        {
            const userAlarm = usersetup.AlarmStat || [];
            const alarm = alarmStat || [];
            const b1 = userAlarm.map(el => el.name).sort().join('') !== alarm.map(el => el.name).sort().join('');
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
            }
            else if (alarm.length !== 0) {
                const ua = userAlarm.sort();
                const ka = alarm.sort();
                const compare = ua.every((el, index) => el.alarmStat.sort().join('') !== ka[index].alarmStat.sort().join(''));
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
                }
            }
        }
        {
            const userThre = usersetup.Threshold || [];
            const thre = Threshold || [];
            const b1 = userThre.map(el => el.name).sort().join('') !== thre.map(el => el.name).sort().join('');
            const data = thre.map(el => ({ name: el.name, min: el.min, max: el.max }));
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
            }
            else if (thre.length !== 0) {
                const ua = userThre.sort();
                const ka = thre.sort();
                const compare = ua.every((el, index) => el.min !== ka[index].min || el.max !== ka[index].max);
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
                }
            }
        }
    },
    onUnload: function () {
    },
    onPullDownRefresh: async function () {
        await this.getUserProtocolSetup();
        wx.stopPullDownRefresh();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm1TZXR0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxhcm1TZXR0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0RBQWdEO0FBQ2hELDRDQUFvQztBQUNwQyw4Q0FBc0Q7QUFFdEQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLENBQUM7UUFDVCxRQUFRLEVBQUUsRUFBRTtRQUNaLFNBQVMsRUFBRSxFQUFvQztRQUMvQyxRQUFRLEVBQUUsRUFBb0M7UUFDOUMsU0FBUyxFQUFFLEVBQW1CO1FBQzlCLE9BQU8sRUFBRSxFQUFjO1FBQ3ZCLFNBQVMsRUFBRSxFQUE4QjtRQUN6QyxTQUFTLEVBQUUsRUFBc0I7S0FDbEM7SUFLRCxNQUFNLEVBQUUsS0FBSyxXQUFXLE9BQVk7UUFDbEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQTtRQUNqQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDWixHQUFHLEVBQUUsaUNBQWlDO2FBQ3ZDLENBQUMsQ0FBQTtZQUNGLE9BQU07U0FDUDtRQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxNQUFNLEVBQUUsTUFBTTtZQUNkLFFBQVE7U0FDVCxDQUFDLENBQUE7UUFDRixNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFBO1FBQ2pDLElBQUksTUFBTSxLQUFLLENBQUM7WUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7UUFDbkMsSUFBSSxNQUFNLEtBQUssQ0FBQztZQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUN0QyxDQUFDO0lBR0QsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxD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QUFFLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQTtpQkFDNUQ7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUtELFFBQVEsRUFBRTtJQUVWLENBQUM7SUFLRCxpQkFBaUIsRUFBRSxLQUFLO1FBQ3RCLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUE7UUFDakMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLENBQUE7SUFDMUIsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB1bml0Q2FjaGUgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3VuaXRDYWNoZVwiXG5pbXBvcnQgYXBpIGZyb20gXCIuLi8uLi8uLi91dGlscy9hcGlcIlxuaW1wb3J0IHsgT2JqZWN0VG9TdHJxdWVyeSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy91dGlsXCJcblxuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICBhY3RpdmU6IDAsXG4gICAgcHJvdG9jb2w6ICcnLFxuICAgIHVzZXJzZXR1cDoge30gYXMgVWFydC5Qcm90b2NvbENvbnN0YW50VGhyZXNob2xkLFxuICAgIHN5c3NldHVwOiB7fSBhcyBVYXJ0LlByb3RvY29sQ29uc3RhbnRUaHJlc2hvbGQsXG4gICAgUHJvdG9jb2xzOiB7fSBhcyBVYXJ0LnByb3RvY29sLFxuICAgIHNob3dUYWc6IFtdIGFzIHN0cmluZ1tdLFxuICAgIGFsYXJtU3RhdDogW10gYXMgVWFydC5Db25zdGFudEFsYXJtU3RhdFtdLFxuICAgIFRocmVzaG9sZDogW10gYXMgVWFydC5UaHJlc2hvbGRbXVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWKoOi9vVxuICAgKi9cbiAgb25Mb2FkOiBhc3luYyBmdW5jdGlvbiAob3B0aW9uczogYW55KSB7XG4gICAgY29uc3QgcHJvdG9jb2wgPSBvcHRpb25zLnByb3RvY29sXG4gICAgaWYgKCFwcm90b2NvbCkge1xuICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgIHVybDogJy9wYWdlcy9pbmRleC9hbGFybVNldHRpbmcvaW5kZXgnXG4gICAgICB9KVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IGFjdGl2ZSA9IE51bWJlcihvcHRpb25zLnR5cGUpIHx8IDBcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgYWN0aXZlOiBhY3RpdmUsXG4gICAgICBwcm90b2NvbFxuICAgIH0pXG4gICAgYXdhaXQgdGhpcy5nZXRVc2VyUHJvdG9jb2xTZXR1cCgpXG4gICAgaWYgKGFjdGl2ZSA9PT0gMSkgdGhpcy51cGRhdGVUaHJlKClcbiAgICBpZiAoYWN0aXZlID09PSAyKSB0aGlzLnVwZGF0ZUFsYXJtKClcbiAgfSxcblxuICAvLyDojrflj5bnlKjmiLfljY/orq7phY3nva5cbiAgYXN5bmMgZ2V0VXNlclByb3RvY29sU2V0dXAoKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+iOt+WPluWNj+iurumFjee9ricgfSlcbiAgICBjb25zdCB1c2VyU2V0dXAgPSBhd2FpdCBhcGkuZ2V0VXNlckFsYXJtUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIGNvbnN0IHN5c1NldHVwID0gYXdhaXQgYXBpLmdldEFsYXJtUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIGNvbnN0IFByb3RvY29scyA9IGF3YWl0IGFwaS5nZXRQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICAgIGlmICh1c2VyU2V0dXAgJiYgc3lzU2V0dXApIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHVzZXJzZXR1cDogdXNlclNldHVwLmRhdGEsXG4gICAgICAgIHN5c3NldHVwOiBzeXNTZXR1cC5kYXRhLFxuICAgICAgICBQcm90b2NvbHM6IFByb3RvY29scy5kYXRhLFxuICAgICAgICBzaG93VGFnOiB1c2VyU2V0dXAuZGF0YS5TaG93VGFnXG4gICAgICB9KVxuXG4gICAgfSBlbHNlIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiBcIkVycm9yXCIsXG4gICAgICAgIGNvbnRlbnQ6ICforr7lpIfljY/orq5i5LiN5pSv5oyB6YWN572uJ1xuICAgICAgfSlcbiAgICB9XG4gIH0sXG5cbiAgLy8g6L+U5Zue5Y2P6K6u5Y+C5pWw5a+56LGh6Kej5p6QXG4gIHBhcnNlUHJvdG9jb2woKSB7XG4gICAgY29uc3QgcHJvdG9jb2xBcnJheSA9IHRoaXMuZGF0YS5Qcm90b2NvbHMuaW5zdHJ1Y3QubWFwKGluc3RydWN0ID0+IHtcbiAgICAgIHJldHVybiBpbnN0cnVjdC5mb3JtUmVzaXplLm1hcChlbCA9PiAoeyBbZWwubmFtZV06IGVsLmlzU3RhdGUgPyB1bml0Q2FjaGUuZ2V0dW5pdE9iamVjdCgxLCBlbC51bml0IGFzIHN0cmluZykgOiB7fSB9KSlcbiAgICB9KS5yZWR1Y2UoKHByZSwgY3VyKSA9PiB7XG4gICAgICByZXR1cm4gWy4uLnByZSwgLi4uY3VyXVxuICAgIH0pXG4gICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oe30sIC4uLnByb3RvY29sQXJyYXkpIGFzIHsgW3g6IHN0cmluZ106IHsgW3g6IHN0cmluZ106IHN0cmluZyB9W10gfVxuICB9LFxuICAvLyDkv67mlLnmoIfpophcbiAgdGFiY2xpY2soZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7IHRpdGxlOiAn5Y2P6K6u6YWN572uLScgKyBldmVudC5kZXRhaWwudGl0bGUgfSlcbiAgICBzd2l0Y2ggKGV2ZW50LmRldGFpbC50aXRsZSkge1xuICAgICAgY2FzZSBcIuWPguaVsOmZkOWAvFwiOlxuICAgICAgICB0aGlzLnVwZGF0ZVRocmUoKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSBcIuWPguaVsOeKtuaAgVwiOlxuICAgICAgICB0aGlzLnVwZGF0ZUFsYXJtKClcbiAgICAgICAgYnJlYWtcbiAgICB9XG4gIH0sXG4gIC8vIOabtOaWsHRocmXliJfooahcbiAgdXBkYXRlVGhyZSgpIHtcbiAgICBjb25zdCB7IHVzZXJzZXR1cCwgc3lzc2V0dXAgfSA9IHRoaXMuZGF0YVxuICAgIGNvbnN0IHN5c19UaHJlc2hvbGRNYXAgPSBuZXcgTWFwKHN5c3NldHVwLlRocmVzaG9sZC5tYXAoZWwgPT4gW2VsLm5hbWUsIGVsXSkpXG4gICAgaWYgKHVzZXJzZXR1cD8uVGhyZXNob2xkKSB7XG4gICAgICAvLyDov63ku6PnlKjmiLfphY3nva7vvIzopobnm5bns7vnu5/phY3nva5cbiAgICAgIFsuLi50aGlzLmRhdGEuVGhyZXNob2xkLCAuLi51c2Vyc2V0dXAuVGhyZXNob2xkXS5mb3JFYWNoKCh2YWwpID0+IHtcbiAgICAgICAgc3lzX1RocmVzaG9sZE1hcC5zZXQodmFsLm5hbWUsIHZhbClcbiAgICAgIH0pXG4gICAgfVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBUaHJlc2hvbGQ6IEFycmF5LmZyb20oc3lzX1RocmVzaG9sZE1hcC52YWx1ZXMoKSlcbiAgICB9KVxuICB9LFxuICAvLyDmm7TmlrBhbGFybeWIl+ihqFxuICB1cGRhdGVBbGFybSgpIHtcbiAgICBjb25zdCB7IHVzZXJzZXR1cCwgc3lzc2V0dXAgfSA9IHRoaXMuZGF0YVxuICAgIGNvbnN0IHN5c19hbGFybVN0YXRNYXAgPSBuZXcgTWFwKHN5c3NldHVwLkFsYXJtU3RhdC5tYXAoZWwgPT4gW2VsLm5hbWUsIGVsXSkpXG4gICAgaWYgKHVzZXJzZXR1cD8uQWxhcm1TdGF0KSB7XG4gICAgICBbLi4udXNlcnNldHVwLkFsYXJtU3RhdCwgLi4udGhpcy5kYXRhLmFsYXJtU3RhdF0uZm9yRWFjaCh2YWwgPT4ge1xuICAgICAgICBzeXNfYWxhcm1TdGF0TWFwLnNldCh2YWwubmFtZSwgdmFsKVxuICAgICAgfSlcbiAgICB9XG4gICAgY29uc3QgcGFyc2UgPSB0aGlzLnBhcnNlUHJvdG9jb2woKVxuICAgIHN5c19hbGFybVN0YXRNYXAuZm9yRWFjaCgoZWwsIGtleSkgPT4ge1xuICAgICAgZWwucGFyc2UgPSBwYXJzZVtrZXldXG4gICAgfSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgYWxhcm1TdGF0OiBBcnJheS5mcm9tKHN5c19hbGFybVN0YXRNYXAudmFsdWVzKCkpXG4gICAgfSlcbiAgfSxcbiAgLy8gIOebkeWQrOaYvuekuuWPguaVsOWPmOWMllxuICBhc3luYyBTaG93VGFnb25DaGFuZ2UoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIGNvbnNvbGUubG9nKHtldmVudH0pO1xuICAgIFxuICAgIGNvbnN0IHRhZ3MgPSBldmVudC5kZXRhaWwgYXMgc3RyaW5nW11cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgc2hvd1RhZzogdGFnc1xuICAgIH0pXG4gICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbCwgJ1Nob3dUYWcnLCB0YWdzIHx8IFtdKVxuICB9LFxuICAvLyDkv67mlLnmmL7npLrlj4LmlbDlj5jljJblgLxcbiAgU2hvd1RhZ3RvZ2dsZShldmVudDogdmFudEV2ZW50KSB7XG4gICAgLy9jb25zb2xlLmxvZyhldmVudCk7XG4gICAgXG4gICAgLyogY29uc3QgeyBpbmRleCB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgIGNvbnN0IGNoZWNrYm94ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoYC5jaGVja2JveGVzLSR7aW5kZXh9YCk7XG4gICAgY2hlY2tiLnRvZ2dsZSgpOyAqL1xuICB9LFxuICAvLyDnm5HlkKzlj4LmlbDnirbmgIHlj5jljJZcbiAgYXN5bmMgQWxhcm1TdGF0b25DaGFuZ2UoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LkNvbnN0YW50QWxhcm1TdGF0Pikge1xuICAgIGNvbnN0IGl0ZW0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHZhbHVlID0gZXZlbnQuZGV0YWlsIGFzIHN0cmluZ1tdXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmRhdGEuYWxhcm1TdGF0LmZpbmRJbmRleChlbCA9PiBlbC5uYW1lID09PSBpdGVtLm5hbWUpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIFtcImFsYXJtU3RhdFtcIiArIGluZGV4ICsgXCJdLmFsYXJtU3RhdFwiXTogdmFsdWVcbiAgICB9KVxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGEuYWxhcm1TdGF0W2luZGV4XVxuICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wsICdBbGFybVN0YXQnLCBkYXRhKVxuXG4gIH0sXG4gIC8vIOi3s+i9rOWIsOWPguaVsOmZkOWAvOS/ruaUuemhtemdolxuICBUaHJlc2hvbGRDbGljayhldmVudDogdmFudEV2ZW50PFVhcnQuVGhyZXNob2xkPikge1xuICAgIGNvbnN0IGl0ZW0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IGluZGV4ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0LmluZGV4XG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL3RocmVzaG9sZC90aHJlc2hvbGQnICsgT2JqZWN0VG9TdHJxdWVyeSh7IC4uLml0ZW0gfSksXG4gICAgICBldmVudHM6IHtcbiAgICAgICAgbW9kaWZ5VGhyZXNob2xkOiBhc3luYyAoZGF0YTogVWFydC5UaHJlc2hvbGQpID0+IHtcbiAgICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sLCBcIlRocmVzaG9sZFwiLCB7IHR5cGU6ICdhZGQnLCBkYXRhIH0pXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIFtgVGhyZXNob2xkWyR7aW5kZXh9XWBdOiB7IC4uLmRhdGEsIGljb246IFwic3RhclwiIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLy8g6Lez6L2s5Yiw5paw5aKe5Y+C5pWw6ZmQ5YC86aG16Z2iXG4gIGFkZFRocmVzaG9sZCgpIHtcbiAgICAvLyDojrflj5bnjrDmnInnmoR0aHJl5ZCN56ewXG4gICAgY29uc3QgdWEgPSB0aGlzLmRhdGEudXNlcnNldHVwPy5BbGFybVN0YXQgfHwgW11cbiAgICBjb25zdCBrZXlzID0gbmV3IFNldChbLi4udGhpcy5kYXRhLmFsYXJtU3RhdC5tYXAoZWwgPT4gZWwubmFtZSksIC4uLnVhLm1hcChlbCA9PiBlbC5uYW1lKV0pXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL2FkZFRocmVzaG9sZC9hZGRUaHJlc2hvbGQnICsgT2JqZWN0VG9TdHJxdWVyeSh7IHByb3RvY29sOiB0aGlzLmRhdGEucHJvdG9jb2wsIGtleXM6IEFycmF5LmZyb20oa2V5cykgfSksXG4gICAgICBldmVudHM6IHtcbiAgICAgICAgYWRkVGhyZXNob2xkOiBhc3luYyAoZGF0YTogVWFydC5UaHJlc2hvbGQpID0+IHtcbiAgICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sLCBcIlRocmVzaG9sZFwiLCB7IHR5cGU6ICdhZGQnLCBkYXRhIH0pXG4gICAgICAgICAgY29uc3QgbmV3VGhyZSA9IHRoaXMuZGF0YS5UaHJlc2hvbGQuY29uY2F0KGRhdGEpXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIFRocmVzaG9sZDogbmV3VGhyZVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDkv53lrZjphY3nva5cbiAgYXN5bmMgc2F2ZVNldHVwKCkge1xuICAgIGNvbnN0IHsgdXNlcnNldHVwLCBhbGFybVN0YXQsIFRocmVzaG9sZCwgcHJvdG9jb2wgfSA9IHRoaXMuZGF0YVxuICAgIC8vIOabtOaWsOeUqOaIt3Nob3dUYWdz6YWN572uXG4gICAge1xuICAgICAgY29uc3QgdXNlclNob3d0YWdzID0gdXNlcnNldHVwLlNob3dUYWcgfHwgW11cbiAgICAgIGNvbnN0IHNob3d0YWcgPSB0aGlzLmRhdGEuc2hvd1RhZyB8fCBbXVxuICAgICAgaWYgKHVzZXJTaG93dGFncy5zb3J0KCkuam9pbihcIlwiKSAhPT0gc2hvd3RhZy5zb3J0KCkuam9pbignJykpIHtcbiAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCAnU2hvd1RhZycsIHNob3d0YWcgfHwgW10pXG4gICAgICB9XG4gICAgfVxuICAgIC8vIOabtOaWsOeUqOaIt2FsYXJtU3RhdOmFjee9rlxuICAgIHtcbiAgICAgIC8vIOavlOi+g+WQjeensGpvaW7mmK/lkKbkuIDoh7TvvIzkuIDoh7TnmoTor53mo4Dmn6XplK7mmK/lkKbkuIDoh7TvvIzkuI3kuIDoh7Tnm7TmjqXmm7TmlrDvvIzplK7kuIDoh7TliJnmr5TovoPlgLzvvIzlgLzkuI3kuIDoh7TkuZ/mm7TmlrBcbiAgICAgIGNvbnN0IHVzZXJBbGFybSA9IHVzZXJzZXR1cC5BbGFybVN0YXQgfHwgW11cbiAgICAgIGNvbnN0IGFsYXJtID0gYWxhcm1TdGF0IHx8IFtdXG4gICAgICBjb25zdCBiMSA9IHVzZXJBbGFybS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpICE9PSBhbGFybS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpXG4gICAgICBpZiAoYjEpIHtcbiAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCAnQWxhcm1TdGF0JywgYWxhcm1TdGF0KVxuICAgICAgfSBlbHNlIGlmIChhbGFybS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgY29uc3QgdWEgPSB1c2VyQWxhcm0uc29ydCgpXG4gICAgICAgIGNvbnN0IGthID0gYWxhcm0uc29ydCgpXG4gICAgICAgIGNvbnN0IGNvbXBhcmUgPSB1YS5ldmVyeSgoZWwsIGluZGV4KSA9PiBlbC5hbGFybVN0YXQuc29ydCgpLmpvaW4oJycpICE9PSBrYVtpbmRleF0uYWxhcm1TdGF0LnNvcnQoKS5qb2luKCcnKSlcbiAgICAgICAgaWYgKGNvbXBhcmUpIHtcbiAgICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wocHJvdG9jb2wsICdBbGFybVN0YXQnLCBhbGFybVN0YXQpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8g5pu05paw55So5oi3dGhyZWFk6YWN572uXG4gICAge1xuICAgICAgLy8g5q+U6L6D5ZCN56ewam9pbuaYr+WQpuS4gOiHtO+8jOS4gOiHtOeahOivneajgOafpemUruaYr+WQpuS4gOiHtO+8jOS4jeS4gOiHtOebtOaOpeabtOaWsO+8jOmUruS4gOiHtOWImeavlOi+g+WAvO+8jOWAvOS4jeS4gOiHtOS5n+abtOaWsFxuICAgICAgY29uc3QgdXNlclRocmUgPSB1c2Vyc2V0dXAuVGhyZXNob2xkIHx8IFtdXG4gICAgICBjb25zdCB0aHJlID0gVGhyZXNob2xkIHx8IFtdXG4gICAgICBjb25zdCBiMSA9IHVzZXJUaHJlLm1hcChlbCA9PiBlbC5uYW1lKS5zb3J0KCkuam9pbignJykgIT09IHRocmUubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKVxuICAgICAgY29uc3QgZGF0YSA9IHRocmUubWFwKGVsID0+ICh7IG5hbWU6IGVsLm5hbWUsIG1pbjogZWwubWluLCBtYXg6IGVsLm1heCB9KSlcbiAgICAgIGlmIChiMSkge1xuICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wocHJvdG9jb2wsIFwiVGhyZXNob2xkXCIsIGRhdGEpXG4gICAgICB9IGVsc2UgaWYgKHRocmUubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIGNvbnN0IHVhID0gdXNlclRocmUuc29ydCgpXG4gICAgICAgIGNvbnN0IGthID0gdGhyZS5zb3J0KClcbiAgICAgICAgY29uc3QgY29tcGFyZSA9IHVhLmV2ZXJ5KChlbCwgaW5kZXgpID0+IGVsLm1pbiAhPT0ga2FbaW5kZXhdLm1pbiB8fCBlbC5tYXggIT09IGthW2luZGV4XS5tYXgpXG4gICAgICAgIGlmIChjb21wYXJlKSB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCBcIlRocmVzaG9sZFwiLCBkYXRhKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWNuOi9vVxuICAgKi9cbiAgb25VbmxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICAvL3RoaXMuc2F2ZVNldHVwKClcbiAgfSxcblxuICAvKipcbiAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICovXG4gIG9uUHVsbERvd25SZWZyZXNoOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRVc2VyUHJvdG9jb2xTZXR1cCgpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH1cbn0pIl19