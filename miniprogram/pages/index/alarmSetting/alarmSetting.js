"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const unitCache_1 = require("../../../utils/unitCache");
const api_1 = require("../../../utils/api");
const util_1 = require("../../../utils/util");
Page({
    data: {
        active: 0,
        protocol: '',
        usersetup: {},
        syssetup: {},
        Protocols: {},
        showTag: [],
        alarmStat: [],
        Threshold: []
    },
    onLoad: async function (options) {
        const protocol = options.protocol;
        if (!protocol) {
            wx.navigateTo({
                url: '/pages/index/alarmSetting/index'
            });
            return;
        }
        const active = Number(options.type) || 0;
        this.setData({
            active: active,
            protocol
        });
        await this.getUserProtocolSetup();
        if (active === 1)
            this.updateThre();
        if (active === 2)
            this.updateAlarm();
    },
    async getUserProtocolSetup() {
        wx.showLoading({ title: '获取协议配置' });
        const userSetup = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        const sysSetup = await api_1.default.getAlarmProtocol(this.data.protocol);
        const Protocols = await api_1.default.getProtocol(this.data.protocol);
        wx.hideLoading();
        if (userSetup && sysSetup) {
            this.setData({
                usersetup: userSetup.data,
                syssetup: sysSetup.data,
                Protocols: Protocols.data,
                showTag: userSetup.data.ShowTag
            });
        }
        else {
            wx.showModal({
                title: "Error",
                content: '设备协议b不支持配置'
            });
        }
    },
    parseProtocol() {
        const protocolArray = this.data.Protocols.instruct.map(instruct => {
            return instruct.formResize.map(el => ({ [el.name]: el.isState ? unitCache_1.default.getunitObject(1, el.unit) : {} }));
        }).reduce((pre, cur) => {
            return [...pre, ...cur];
        });
        return Object.assign({}, ...protocolArray);
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: '协议配置-' + event.detail.title });
        switch (event.detail.title) {
            case "参数限值":
                this.updateThre();
                break;
            case "参数状态":
                this.updateAlarm();
                break;
        }
    },
    updateThre() {
        const { usersetup, syssetup } = this.data;
        const sys_ThresholdMap = new Map(syssetup.Threshold.map(el => [el.name, el]));
        if (usersetup?.Threshold) {
            [...this.data.Threshold, ...usersetup.Threshold].forEach((val) => {
                sys_ThresholdMap.set(val.name, val);
            });
        }
        this.setData({
            Threshold: Array.from(sys_ThresholdMap.values())
        });
    },
    updateAlarm() {
        const { usersetup, syssetup } = this.data;
        const sys_alarmStatMap = new Map(syssetup.AlarmStat.map(el => [el.name, el]));
        if (usersetup?.AlarmStat) {
            [...usersetup.AlarmStat, ...this.data.alarmStat].forEach(val => {
                sys_alarmStatMap.set(val.name, val);
            });
        }
        const parse = this.parseProtocol();
        sys_alarmStatMap.forEach((el, key) => {
            el.parse = parse[key];
        });
        this.setData({
            alarmStat: Array.from(sys_alarmStatMap.values())
        });
    },
    async ShowTagonChange(event) {
        console.log({ event });
        const tags = event.detail;
        this.setData({
            showTag: tags
        });
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'ShowTag', tags || [])
            .then(res => {
            wx.showToast({
                title: res.code === 200 ? '显示参数修改成功' : '修改失败',
                icon: res.code === 200 ? 'success' : 'error',
            });
        });
    },
    ShowTagtoggle(event) {
    },
    async AlarmStatonChange(event) {
        const item = event.currentTarget.dataset.item;
        const value = event.detail;
        const index = this.data.alarmStat.findIndex(el => el.name === item.name);
        this.setData({
            ["alarmStat[" + index + "].alarmStat"]: value
        });
        const data = this.data.alarmStat[index];
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'AlarmStat', data)
            .then(res => {
            wx.showToast({
                title: res.code === 200 ? '状态参数修改成功' : '修改失败',
                icon: res.code === 200 ? 'success' : 'error',
            });
        });
    },
    ThresholdClick(event) {
        const item = event.currentTarget.dataset.item;
        const index = event.currentTarget.dataset.index;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/threshold/threshold' + (0, util_1.ObjectToStrquery)({ ...item }),
            events: {
                modifyThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data })
                        .then(res => {
                        wx.showToast({
                            title: res.code === 200 ? '约束参数修改成功' : '修改失败',
                            icon: res.code === 200 ? 'success' : 'error',
                        });
                    });
                    this.setData({
                        [`Threshold[${index}]`]: { ...data, icon: "star" }
                    });
                }
            }
        });
    },
    addThreshold() {
        const ua = this.data.usersetup?.AlarmStat || [];
        const keys = new Set([...this.data.alarmStat.map(el => el.name), ...ua.map(el => el.name)]);
        wx.navigateTo({
            url: '/pages/index/alarmSetting/addThreshold/addThreshold' + (0, util_1.ObjectToStrquery)({ protocol: this.data.protocol, keys: Array.from(keys) }),
            events: {
                addThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data });
                    const newThre = this.data.Threshold.concat(data);
                    this.setData({
                        Threshold: newThre
                    });
                }
            }
        });
    },
    async saveSetup() {
        const { usersetup, alarmStat, Threshold, protocol } = this.data;
        {
            const userShowtags = usersetup.ShowTag || [];
            const showtag = this.data.showTag || [];
            if (userShowtags.sort().join("") !== showtag.sort().join('')) {
                await api_1.default.setUserSetupProtocol(protocol, 'ShowTag', showtag || []);
            }
        }
        {
            const userAlarm = usersetup.AlarmStat || [];
            const alarm = alarmStat || [];
            const b1 = userAlarm.map(el => el.name).sort().join('') !== alarm.map(el => el.name).sort().join('');
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
            }
            else if (alarm.length !== 0) {
                const ua = userAlarm.sort();
                const ka = alarm.sort();
                const compare = ua.every((el, index) => el.alarmStat.sort().join('') !== ka[index].alarmStat.sort().join(''));
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
                }
            }
        }
        {
            const userThre = usersetup.Threshold || [];
            const thre = Threshold || [];
            const b1 = userThre.map(el => el.name).sort().join('') !== thre.map(el => el.name).sort().join('');
            const data = thre.map(el => ({ name: el.name, min: el.min, max: el.max }));
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
            }
            else if (thre.length !== 0) {
                const ua = userThre.sort();
                const ka = thre.sort();
                const compare = ua.every((el, index) => el.min !== ka[index].min || el.max !== ka[index].max);
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
                }
            }
        }
    },
    onUnload: function () {
    },
    onPullDownRefresh: async function () {
        await this.getUserProtocolSetup();
        wx.stopPullDownRefresh();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm1TZXR0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxhcm1TZXR0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0RBQWdEO0FBQ2hELDRDQUFvQztBQUNwQyw4Q0FBc0Q7QUFFdEQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLENBQUM7UUFDVCxRQUFRLEVBQUUsRUFBRTtRQUNaLFNBQVMsRUFBRSxFQUFvQztRQUMvQyxRQUFRLEVBQUUsRUFBb0M7UUFDOUMsU0FBUyxFQUFFLEVBQW1CO1FBQzlCLE9BQU8sRUFBRSxFQUFjO1FBQ3ZCLFNBQVMsRUFBRSxFQUE4QjtRQUN6QyxTQUFTLEVBQUUsRUFBc0I7S0FDbEM7SUFLRCxNQUFNLEVBQUUsS0FBSyxXQUFXLE9BQVk7UUFDbEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQTtRQUNqQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDWixHQUFHLEVBQUUsaUNBQWlDO2FBQ3ZDLENBQUMsQ0FBQTtZQUNGLE9BQU07U0FDUDtRQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxNQUFNLEVBQUUsTUFBTTtZQUNkLFFBQVE7U0FDVCxDQUFDLENBQUE7UUFDRixNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFBO1FBQ2pDLElBQUksTUFBTSxLQUFLLENBQUM7WUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7UUFDbkMsSUFBSSxNQUFNLEtBQUssQ0FBQztZQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUN0QyxDQUFDO0lBR0QsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxD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QUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO0lBQzFCLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdW5pdENhY2hlIGZyb20gXCIuLi8uLi8uLi91dGlscy91bml0Q2FjaGVcIlxuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcbmltcG9ydCB7IE9iamVjdFRvU3RycXVlcnkgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiXG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgYWN0aXZlOiAwLFxuICAgIHByb3RvY29sOiAnJyxcbiAgICB1c2Vyc2V0dXA6IHt9IGFzIFVhcnQuUHJvdG9jb2xDb25zdGFudFRocmVzaG9sZCxcbiAgICBzeXNzZXR1cDoge30gYXMgVWFydC5Qcm90b2NvbENvbnN0YW50VGhyZXNob2xkLFxuICAgIFByb3RvY29sczoge30gYXMgVWFydC5wcm90b2NvbCxcbiAgICBzaG93VGFnOiBbXSBhcyBzdHJpbmdbXSxcbiAgICBhbGFybVN0YXQ6IFtdIGFzIFVhcnQuQ29uc3RhbnRBbGFybVN0YXRbXSxcbiAgICBUaHJlc2hvbGQ6IFtdIGFzIFVhcnQuVGhyZXNob2xkW11cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogYXN5bmMgZnVuY3Rpb24gKG9wdGlvbnM6IGFueSkge1xuICAgIGNvbnN0IHByb3RvY29sID0gb3B0aW9ucy5wcm90b2NvbFxuICAgIGlmICghcHJvdG9jb2wpIHtcbiAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL2luZGV4J1xuICAgICAgfSlcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBhY3RpdmUgPSBOdW1iZXIob3B0aW9ucy50eXBlKSB8fCAwXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFjdGl2ZTogYWN0aXZlLFxuICAgICAgcHJvdG9jb2xcbiAgICB9KVxuICAgIGF3YWl0IHRoaXMuZ2V0VXNlclByb3RvY29sU2V0dXAoKVxuICAgIGlmIChhY3RpdmUgPT09IDEpIHRoaXMudXBkYXRlVGhyZSgpXG4gICAgaWYgKGFjdGl2ZSA9PT0gMikgdGhpcy51cGRhdGVBbGFybSgpXG4gIH0sXG5cbiAgLy8g6I635Y+W55So5oi35Y2P6K6u6YWN572uXG4gIGFzeW5jIGdldFVzZXJQcm90b2NvbFNldHVwKCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bljY/orq7phY3nva4nIH0pXG4gICAgY29uc3QgdXNlclNldHVwID0gYXdhaXQgYXBpLmdldFVzZXJBbGFybVByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICBjb25zdCBzeXNTZXR1cCA9IGF3YWl0IGFwaS5nZXRBbGFybVByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICBjb25zdCBQcm90b2NvbHMgPSBhd2FpdCBhcGkuZ2V0UHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICBpZiAodXNlclNldHVwICYmIHN5c1NldHVwKSB7XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICB1c2Vyc2V0dXA6IHVzZXJTZXR1cC5kYXRhLFxuICAgICAgICBzeXNzZXR1cDogc3lzU2V0dXAuZGF0YSxcbiAgICAgICAgUHJvdG9jb2xzOiBQcm90b2NvbHMuZGF0YSxcbiAgICAgICAgc2hvd1RhZzogdXNlclNldHVwLmRhdGEuU2hvd1RhZ1xuICAgICAgfSlcblxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogXCJFcnJvclwiLFxuICAgICAgICBjb250ZW50OiAn6K6+5aSH5Y2P6K6uYuS4jeaUr+aMgemFjee9ridcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIC8vIOi/lOWbnuWNj+iuruWPguaVsOWvueixoeino+aekFxuICBwYXJzZVByb3RvY29sKCkge1xuICAgIGNvbnN0IHByb3RvY29sQXJyYXkgPSB0aGlzLmRhdGEuUHJvdG9jb2xzLmluc3RydWN0Lm1hcChpbnN0cnVjdCA9PiB7XG4gICAgICByZXR1cm4gaW5zdHJ1Y3QuZm9ybVJlc2l6ZS5tYXAoZWwgPT4gKHsgW2VsLm5hbWVdOiBlbC5pc1N0YXRlID8gdW5pdENhY2hlLmdldHVuaXRPYmplY3QoMSwgZWwudW5pdCBhcyBzdHJpbmcpIDoge30gfSkpXG4gICAgfSkucmVkdWNlKChwcmUsIGN1cikgPT4ge1xuICAgICAgcmV0dXJuIFsuLi5wcmUsIC4uLmN1cl1cbiAgICB9KVxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCAuLi5wcm90b2NvbEFycmF5KSBhcyB7IFt4OiBzdHJpbmddOiB7IFt4OiBzdHJpbmddOiBzdHJpbmcgfVtdIH1cbiAgfSxcbiAgLy8g5L+u5pS55qCH6aKYXG4gIHRhYmNsaWNrKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogJ+WNj+iurumFjee9ri0nICsgZXZlbnQuZGV0YWlsLnRpdGxlIH0pXG4gICAgc3dpdGNoIChldmVudC5kZXRhaWwudGl0bGUpIHtcbiAgICAgIGNhc2UgXCLlj4LmlbDpmZDlgLxcIjpcbiAgICAgICAgdGhpcy51cGRhdGVUaHJlKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgXCLlj4LmlbDnirbmgIFcIjpcbiAgICAgICAgdGhpcy51cGRhdGVBbGFybSgpXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9LFxuICAvLyDmm7TmlrB0aHJl5YiX6KGoXG4gIHVwZGF0ZVRocmUoKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIHN5c3NldHVwIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCBzeXNfVGhyZXNob2xkTWFwID0gbmV3IE1hcChzeXNzZXR1cC5UaHJlc2hvbGQubWFwKGVsID0+IFtlbC5uYW1lLCBlbF0pKVxuICAgIGlmICh1c2Vyc2V0dXA/LlRocmVzaG9sZCkge1xuICAgICAgLy8g6L+t5Luj55So5oi36YWN572u77yM6KaG55uW57O757uf6YWN572uXG4gICAgICBbLi4udGhpcy5kYXRhLlRocmVzaG9sZCwgLi4udXNlcnNldHVwLlRocmVzaG9sZF0uZm9yRWFjaCgodmFsKSA9PiB7XG4gICAgICAgIHN5c19UaHJlc2hvbGRNYXAuc2V0KHZhbC5uYW1lLCB2YWwpXG4gICAgICB9KVxuICAgIH1cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgVGhyZXNob2xkOiBBcnJheS5mcm9tKHN5c19UaHJlc2hvbGRNYXAudmFsdWVzKCkpXG4gICAgfSlcbiAgfSxcbiAgLy8g5pu05pawYWxhcm3liJfooahcbiAgdXBkYXRlQWxhcm0oKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIHN5c3NldHVwIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCBzeXNfYWxhcm1TdGF0TWFwID0gbmV3IE1hcChzeXNzZXR1cC5BbGFybVN0YXQubWFwKGVsID0+IFtlbC5uYW1lLCBlbF0pKVxuICAgIGlmICh1c2Vyc2V0dXA/LkFsYXJtU3RhdCkge1xuICAgICAgWy4uLnVzZXJzZXR1cC5BbGFybVN0YXQsIC4uLnRoaXMuZGF0YS5hbGFybVN0YXRdLmZvckVhY2godmFsID0+IHtcbiAgICAgICAgc3lzX2FsYXJtU3RhdE1hcC5zZXQodmFsLm5hbWUsIHZhbClcbiAgICAgIH0pXG4gICAgfVxuICAgIGNvbnN0IHBhcnNlID0gdGhpcy5wYXJzZVByb3RvY29sKClcbiAgICBzeXNfYWxhcm1TdGF0TWFwLmZvckVhY2goKGVsLCBrZXkpID0+IHtcbiAgICAgIGVsLnBhcnNlID0gcGFyc2Vba2V5XVxuICAgIH0pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFsYXJtU3RhdDogQXJyYXkuZnJvbShzeXNfYWxhcm1TdGF0TWFwLnZhbHVlcygpKVxuICAgIH0pXG4gIH0sXG4gIC8vICDnm5HlkKzmmL7npLrlj4LmlbDlj5jljJZcbiAgYXN5bmMgU2hvd1RhZ29uQ2hhbmdlKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICBjb25zb2xlLmxvZyh7IGV2ZW50IH0pO1xuXG4gICAgY29uc3QgdGFncyA9IGV2ZW50LmRldGFpbCBhcyBzdHJpbmdbXVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBzaG93VGFnOiB0YWdzXG4gICAgfSlcbiAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sLCAnU2hvd1RhZycsIHRhZ3MgfHwgW10pXG4gICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgIHRpdGxlOiByZXMuY29kZSA9PT0gMjAwID8gJ+aYvuekuuWPguaVsOS/ruaUueaIkOWKnycgOiAn5L+u5pS55aSx6LSlJyxcbiAgICAgICAgICBpY29uOnJlcy5jb2RlID09PSAyMDAgPyAnc3VjY2VzcycgOiAnZXJyb3InLFxuICAgICAgICB9KVxuICAgICAgfSlcbiAgfSxcbiAgLy8g5L+u5pS55pi+56S65Y+C5pWw5Y+Y5YyW5YC8XG4gIFNob3dUYWd0b2dnbGUoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIC8vY29uc29sZS5sb2coZXZlbnQpO1xuXG4gICAgLyogY29uc3QgeyBpbmRleCB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgIGNvbnN0IGNoZWNrYm94ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoYC5jaGVja2JveGVzLSR7aW5kZXh9YCk7XG4gICAgY2hlY2tiLnRvZ2dsZSgpOyAqL1xuICB9LFxuICAvLyDnm5HlkKzlj4LmlbDnirbmgIHlj5jljJZcbiAgYXN5bmMgQWxhcm1TdGF0b25DaGFuZ2UoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LkNvbnN0YW50QWxhcm1TdGF0Pikge1xuICAgIGNvbnN0IGl0ZW0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHZhbHVlID0gZXZlbnQuZGV0YWlsIGFzIHN0cmluZ1tdXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmRhdGEuYWxhcm1TdGF0LmZpbmRJbmRleChlbCA9PiBlbC5uYW1lID09PSBpdGVtLm5hbWUpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIFtcImFsYXJtU3RhdFtcIiArIGluZGV4ICsgXCJdLmFsYXJtU3RhdFwiXTogdmFsdWVcbiAgICB9KVxuICAgIGNvbnN0IGRhdGEgPSB0aGlzLmRhdGEuYWxhcm1TdGF0W2luZGV4XVxuICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wsICdBbGFybVN0YXQnLCBkYXRhKVxuICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICB0aXRsZTogcmVzLmNvZGUgPT09IDIwMCA/ICfnirbmgIHlj4LmlbDkv67mlLnmiJDlip8nIDogJ+S/ruaUueWksei0pScsXG4gICAgICAgIGljb246cmVzLmNvZGUgPT09IDIwMCA/ICdzdWNjZXNzJyA6ICdlcnJvcicsXG4gICAgICB9KVxuICAgIH0pXG5cbiAgfSxcbiAgLy8g6Lez6L2s5Yiw5Y+C5pWw6ZmQ5YC85L+u5pS56aG16Z2iXG4gIFRocmVzaG9sZENsaWNrKGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UaHJlc2hvbGQ+KSB7XG4gICAgY29uc3QgaXRlbSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3QgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5kZXhcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9hbGFybVNldHRpbmcvdGhyZXNob2xkL3RocmVzaG9sZCcgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgLi4uaXRlbSB9KSxcbiAgICAgIGV2ZW50czoge1xuICAgICAgICBtb2RpZnlUaHJlc2hvbGQ6IGFzeW5jIChkYXRhOiBVYXJ0LlRocmVzaG9sZCkgPT4ge1xuICAgICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbCh0aGlzLmRhdGEucHJvdG9jb2wsIFwiVGhyZXNob2xkXCIsIHsgdHlwZTogJ2FkZCcsIGRhdGEgfSlcbiAgICAgICAgICAudGhlbihyZXMgPT4ge1xuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICAgICAgdGl0bGU6IHJlcy5jb2RlID09PSAyMDAgPyAn57qm5p2f5Y+C5pWw5L+u5pS55oiQ5YqfJyA6ICfkv67mlLnlpLHotKUnLFxuICAgICAgICAgICAgICBpY29uOnJlcy5jb2RlID09PSAyMDAgPyAnc3VjY2VzcycgOiAnZXJyb3InLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9KVxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBbYFRocmVzaG9sZFske2luZGV4fV1gXTogeyAuLi5kYXRhLCBpY29uOiBcInN0YXJcIiB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOi3s+i9rOWIsOaWsOWinuWPguaVsOmZkOWAvOmhtemdolxuICBhZGRUaHJlc2hvbGQoKSB7XG4gICAgLy8g6I635Y+W546w5pyJ55qEdGhyZeWQjeensFxuICAgIGNvbnN0IHVhID0gdGhpcy5kYXRhLnVzZXJzZXR1cD8uQWxhcm1TdGF0IHx8IFtdXG4gICAgY29uc3Qga2V5cyA9IG5ldyBTZXQoWy4uLnRoaXMuZGF0YS5hbGFybVN0YXQubWFwKGVsID0+IGVsLm5hbWUpLCAuLi51YS5tYXAoZWwgPT4gZWwubmFtZSldKVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtU2V0dGluZy9hZGRUaHJlc2hvbGQvYWRkVGhyZXNob2xkJyArIE9iamVjdFRvU3RycXVlcnkoeyBwcm90b2NvbDogdGhpcy5kYXRhLnByb3RvY29sLCBrZXlzOiBBcnJheS5mcm9tKGtleXMpIH0pLFxuICAgICAgZXZlbnRzOiB7XG4gICAgICAgIGFkZFRocmVzaG9sZDogYXN5bmMgKGRhdGE6IFVhcnQuVGhyZXNob2xkKSA9PiB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbCwgXCJUaHJlc2hvbGRcIiwgeyB0eXBlOiAnYWRkJywgZGF0YSB9KVxuICAgICAgICAgIGNvbnN0IG5ld1RocmUgPSB0aGlzLmRhdGEuVGhyZXNob2xkLmNvbmNhdChkYXRhKVxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICBUaHJlc2hvbGQ6IG5ld1RocmVcbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLy8g5L+d5a2Y6YWN572uXG4gIGFzeW5jIHNhdmVTZXR1cCgpIHtcbiAgICBjb25zdCB7IHVzZXJzZXR1cCwgYWxhcm1TdGF0LCBUaHJlc2hvbGQsIHByb3RvY29sIH0gPSB0aGlzLmRhdGFcbiAgICAvLyDmm7TmlrDnlKjmiLdzaG93VGFnc+mFjee9rlxuICAgIHtcbiAgICAgIGNvbnN0IHVzZXJTaG93dGFncyA9IHVzZXJzZXR1cC5TaG93VGFnIHx8IFtdXG4gICAgICBjb25zdCBzaG93dGFnID0gdGhpcy5kYXRhLnNob3dUYWcgfHwgW11cbiAgICAgIGlmICh1c2VyU2hvd3RhZ3Muc29ydCgpLmpvaW4oXCJcIikgIT09IHNob3d0YWcuc29ydCgpLmpvaW4oJycpKSB7XG4gICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbChwcm90b2NvbCwgJ1Nob3dUYWcnLCBzaG93dGFnIHx8IFtdKVxuICAgICAgfVxuICAgIH1cbiAgICAvLyDmm7TmlrDnlKjmiLdhbGFybVN0YXTphY3nva5cbiAgICB7XG4gICAgICAvLyDmr5TovoPlkI3np7Bqb2lu5piv5ZCm5LiA6Ie077yM5LiA6Ie055qE6K+d5qOA5p+l6ZSu5piv5ZCm5LiA6Ie077yM5LiN5LiA6Ie055u05o6l5pu05paw77yM6ZSu5LiA6Ie05YiZ5q+U6L6D5YC877yM5YC85LiN5LiA6Ie05Lmf5pu05pawXG4gICAgICBjb25zdCB1c2VyQWxhcm0gPSB1c2Vyc2V0dXAuQWxhcm1TdGF0IHx8IFtdXG4gICAgICBjb25zdCBhbGFybSA9IGFsYXJtU3RhdCB8fCBbXVxuICAgICAgY29uc3QgYjEgPSB1c2VyQWxhcm0ubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKSAhPT0gYWxhcm0ubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKVxuICAgICAgaWYgKGIxKSB7XG4gICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbChwcm90b2NvbCwgJ0FsYXJtU3RhdCcsIGFsYXJtU3RhdClcbiAgICAgIH0gZWxzZSBpZiAoYWxhcm0ubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIGNvbnN0IHVhID0gdXNlckFsYXJtLnNvcnQoKVxuICAgICAgICBjb25zdCBrYSA9IGFsYXJtLnNvcnQoKVxuICAgICAgICBjb25zdCBjb21wYXJlID0gdWEuZXZlcnkoKGVsLCBpbmRleCkgPT4gZWwuYWxhcm1TdGF0LnNvcnQoKS5qb2luKCcnKSAhPT0ga2FbaW5kZXhdLmFsYXJtU3RhdC5zb3J0KCkuam9pbignJykpXG4gICAgICAgIGlmIChjb21wYXJlKSB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCAnQWxhcm1TdGF0JywgYWxhcm1TdGF0KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIC8vIOabtOaWsOeUqOaIt3RocmVhZOmFjee9rlxuICAgIHtcbiAgICAgIC8vIOavlOi+g+WQjeensGpvaW7mmK/lkKbkuIDoh7TvvIzkuIDoh7TnmoTor53mo4Dmn6XplK7mmK/lkKbkuIDoh7TvvIzkuI3kuIDoh7Tnm7TmjqXmm7TmlrDvvIzplK7kuIDoh7TliJnmr5TovoPlgLzvvIzlgLzkuI3kuIDoh7TkuZ/mm7TmlrBcbiAgICAgIGNvbnN0IHVzZXJUaHJlID0gdXNlcnNldHVwLlRocmVzaG9sZCB8fCBbXVxuICAgICAgY29uc3QgdGhyZSA9IFRocmVzaG9sZCB8fCBbXVxuICAgICAgY29uc3QgYjEgPSB1c2VyVGhyZS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpICE9PSB0aHJlLm1hcChlbCA9PiBlbC5uYW1lKS5zb3J0KCkuam9pbignJylcbiAgICAgIGNvbnN0IGRhdGEgPSB0aHJlLm1hcChlbCA9PiAoeyBuYW1lOiBlbC5uYW1lLCBtaW46IGVsLm1pbiwgbWF4OiBlbC5tYXggfSkpXG4gICAgICBpZiAoYjEpIHtcbiAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCBcIlRocmVzaG9sZFwiLCBkYXRhKVxuICAgICAgfSBlbHNlIGlmICh0aHJlLmxlbmd0aCAhPT0gMCkge1xuICAgICAgICBjb25zdCB1YSA9IHVzZXJUaHJlLnNvcnQoKVxuICAgICAgICBjb25zdCBrYSA9IHRocmUuc29ydCgpXG4gICAgICAgIGNvbnN0IGNvbXBhcmUgPSB1YS5ldmVyeSgoZWwsIGluZGV4KSA9PiBlbC5taW4gIT09IGthW2luZGV4XS5taW4gfHwgZWwubWF4ICE9PSBrYVtpbmRleF0ubWF4KVxuICAgICAgICBpZiAoY29tcGFyZSkge1xuICAgICAgICAgIGF3YWl0IGFwaS5zZXRVc2VyU2V0dXBQcm90b2NvbChwcm90b2NvbCwgXCJUaHJlc2hvbGRcIiwgZGF0YSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cbiAgICovXG4gIG9uVW5sb2FkOiBmdW5jdGlvbiAoKSB7XG4gICAgLy90aGlzLnNhdmVTZXR1cCgpXG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IHRoaXMuZ2V0VXNlclByb3RvY29sU2V0dXAoKVxuICAgIHd4LnN0b3BQdWxsRG93blJlZnJlc2goKVxuICB9XG59KSJdfQ==