"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const unitCache_1 = require("../../../utils/unitCache");
const api_1 = require("../../../utils/api");
const util_1 = require("../../../utils/util");
Page({
    data: {
        active: 0,
        protocol: '',
        usersetup: {},
        syssetup: {},
        Protocols: {},
        showTag: [],
        alarmStat: [],
        Threshold: []
    },
    onLoad: async function (options) {
        const protocol = options.protocol;
        if (!protocol) {
            wx.navigateTo({
                url: '/pages/index/alarmSetting/index'
            });
            return;
        }
        const active = Number(options.type) || 0;
        this.setData({
            active: active,
            protocol
        });
        await this.getUserProtocolSetup();
        if (active === 1)
            this.updateThre();
        if (active === 2)
            this.updateAlarm();
    },
    async getUserProtocolSetup() {
        wx.showLoading({ title: '获取协议配置' });
        const userSetup = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        const sysSetup = await api_1.default.getAlarmProtocol(this.data.protocol);
        const Protocols = await api_1.default.getProtocol(this.data.protocol);
        wx.hideLoading();
        if (userSetup && sysSetup) {
            this.setData({
                usersetup: userSetup.data,
                syssetup: sysSetup.data,
                Protocols: Protocols.data,
                showTag: userSetup.data.ShowTag
            });
        }
        else {
            wx.showModal({
                title: "Error",
                content: '设备协议b不支持配置'
            });
        }
    },
    parseProtocol() {
        const protocolArray = this.data.Protocols.instruct.map(instruct => {
            return instruct.formResize.map(el => ({ [el.name]: el.isState ? unitCache_1.default.getunitObject(1, el.unit) : {} }));
        }).reduce((pre, cur) => {
            return [...pre, ...cur];
        });
        return Object.assign({}, ...protocolArray);
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: '协议配置-' + event.detail.title });
        switch (event.detail.title) {
            case "参数限值":
                this.updateThre();
                break;
            case "参数状态":
                this.updateAlarm();
                break;
        }
    },
    updateThre() {
        const { usersetup, syssetup } = this.data;
        const sys_ThresholdMap = new Map(syssetup.Threshold.map(el => [el.name, el]));
        if (usersetup?.Threshold) {
            [...this.data.Threshold, ...usersetup.Threshold].forEach((val) => {
                sys_ThresholdMap.set(val.name, val);
            });
        }
        this.setData({
            Threshold: Array.from(sys_ThresholdMap.values())
        });
    },
    updateAlarm() {
        const { usersetup, syssetup } = this.data;
        const sys_alarmStatMap = new Map(syssetup.AlarmStat.map(el => [el.name, el]));
        if (usersetup?.AlarmStat) {
            [...usersetup.AlarmStat, ...this.data.alarmStat].forEach(val => {
                sys_alarmStatMap.set(val.name, val);
            });
        }
        const parse = this.parseProtocol();
        sys_alarmStatMap.forEach((el, key) => {
            el.parse = parse[key];
        });
        this.setData({
            alarmStat: Array.from(sys_alarmStatMap.values())
        });
    },
    async ShowTagonChange(event) {
        console.log({ event });
        const tags = event.detail;
        this.setData({
            showTag: tags
        });
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'ShowTag', tags || [])
            .then(res => {
            wx.showToast({
                title: res.code === 200 ? '显示参数修改成功' : '修改失败',
                icon: res.code === 200 ? 'success' : 'error',
            });
        });
    },
    ShowTagtoggle(_event) {
    },
    async AlarmStatonChange(event) {
        const item = event.currentTarget.dataset.item;
        const value = event.detail;
        const index = this.data.alarmStat.findIndex(el => el.name === item.name);
        this.setData({
            ["alarmStat[" + index + "].alarmStat"]: value
        });
        const data = this.data.alarmStat[index];
        await api_1.default.setUserSetupProtocol(this.data.protocol, 'AlarmStat', data)
            .then(res => {
            wx.showToast({
                title: res.code === 200 ? '状态参数修改成功' : '修改失败',
                icon: res.code === 200 ? 'success' : 'error',
            });
        });
    },
    ThresholdClick(event) {
        const item = event.currentTarget.dataset.item;
        const index = event.currentTarget.dataset.index;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/threshold/threshold' + (0, util_1.ObjectToStrquery)({ ...item }),
            events: {
                modifyThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data })
                        .then(res => {
                        wx.showToast({
                            title: res.code === 200 ? '约束参数修改成功' : '修改失败',
                            icon: res.code === 200 ? 'success' : 'error',
                        });
                    });
                    this.setData({
                        [`Threshold[${index}]`]: { ...data, icon: "star" }
                    });
                }
            }
        });
    },
    addThreshold() {
        const ua = this.data.usersetup?.AlarmStat || [];
        const keys = new Set([...this.data.alarmStat.map(el => el.name), ...ua.map(el => el.name)]);
        wx.navigateTo({
            url: '/pages/index/alarmSetting/addThreshold/addThreshold' + (0, util_1.ObjectToStrquery)({ protocol: this.data.protocol, keys: Array.from(keys) }),
            events: {
                addThreshold: async (data) => {
                    await api_1.default.setUserSetupProtocol(this.data.protocol, "Threshold", { type: 'add', data });
                    const newThre = this.data.Threshold.concat(data);
                    this.setData({
                        Threshold: newThre
                    });
                }
            }
        });
    },
    async saveSetup() {
        const { usersetup, alarmStat, Threshold, protocol } = this.data;
        {
            const userShowtags = usersetup.ShowTag || [];
            const showtag = this.data.showTag || [];
            if (userShowtags.sort().join("") !== showtag.sort().join('')) {
                await api_1.default.setUserSetupProtocol(protocol, 'ShowTag', showtag || []);
            }
        }
        {
            const userAlarm = usersetup.AlarmStat || [];
            const alarm = alarmStat || [];
            const b1 = userAlarm.map(el => el.name).sort().join('') !== alarm.map(el => el.name).sort().join('');
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
            }
            else if (alarm.length !== 0) {
                const ua = userAlarm.sort();
                const ka = alarm.sort();
                const compare = ua.every((el, index) => el.alarmStat.sort().join('') !== ka[index].alarmStat.sort().join(''));
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, 'AlarmStat', alarmStat);
                }
            }
        }
        {
            const userThre = usersetup.Threshold || [];
            const thre = Threshold || [];
            const b1 = userThre.map(el => el.name).sort().join('') !== thre.map(el => el.name).sort().join('');
            const data = thre.map(el => ({ name: el.name, min: el.min, max: el.max }));
            if (b1) {
                await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
            }
            else if (thre.length !== 0) {
                const ua = userThre.sort();
                const ka = thre.sort();
                const compare = ua.every((el, index) => el.min !== ka[index].min || el.max !== ka[index].max);
                if (compare) {
                    await api_1.default.setUserSetupProtocol(protocol, "Threshold", data);
                }
            }
        }
    },
    onUnload: function () {
    },
    onPullDownRefresh: async function () {
        await this.getUserProtocolSetup();
        wx.stopPullDownRefresh();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm1TZXR0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxhcm1TZXR0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0RBQWdEO0FBQ2hELDRDQUFvQztBQUNwQyw4Q0FBc0Q7QUFFdEQsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLENBQUM7UUFDVCxRQUFRLEVBQUUsRUFBRTtRQUNaLFNBQVMsRUFBRSxFQUFvQztRQUMvQyxRQUFRLEVBQUUsRUFBb0M7UUFDOUMsU0FBUyxFQUFFLEVBQW1CO1FBQzlCLE9BQU8sRUFBRSxFQUFjO1FBQ3ZCLFNBQVMsRUFBRSxFQUE4QjtRQUN6QyxTQUFTLEVBQUUsRUFBc0I7S0FDbEM7SUFLRCxNQUFNLEVBQUUsS0FBSyxXQUFXLE9BQVk7UUFDbEMsTUFBTSxRQUFRLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQTtRQUNqQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBQ2IsRUFBRSxDQUFDLFVBQVUsQ0FBQztnQkFDWixHQUFHLEVBQUUsaUNBQWlDO2FBQ3ZDLENBQUMsQ0FBQTtZQUNGLE9BQU07U0FDUDtRQUNELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxNQUFNLEVBQUUsTUFBTTtZQUNkLFFBQVE7U0FDVCxDQUFDLENBQUE7UUFDRixNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFBO1FBQ2pDLElBQUksTUFBTSxLQUFLLENBQUM7WUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7UUFDbkMsSUFBSSxNQUFNLEtBQUssQ0FBQztZQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQTtJQUN0QyxDQUFDO0lBR0QsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixFQUFFLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBRSxD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QUUsQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO0lBQzFCLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdW5pdENhY2hlIGZyb20gXCIuLi8uLi8uLi91dGlscy91bml0Q2FjaGVcIlxuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcbmltcG9ydCB7IE9iamVjdFRvU3RycXVlcnkgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiXG5cblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgYWN0aXZlOiAwLFxuICAgIHByb3RvY29sOiAnJyxcbiAgICB1c2Vyc2V0dXA6IHt9IGFzIFVhcnQuUHJvdG9jb2xDb25zdGFudFRocmVzaG9sZCxcbiAgICBzeXNzZXR1cDoge30gYXMgVWFydC5Qcm90b2NvbENvbnN0YW50VGhyZXNob2xkLFxuICAgIFByb3RvY29sczoge30gYXMgVWFydC5wcm90b2NvbCxcbiAgICBzaG93VGFnOiBbXSBhcyBzdHJpbmdbXSxcbiAgICBhbGFybVN0YXQ6IFtdIGFzIFVhcnQuQ29uc3RhbnRBbGFybVN0YXRbXSxcbiAgICBUaHJlc2hvbGQ6IFtdIGFzIFVhcnQuVGhyZXNob2xkW11cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogYXN5bmMgZnVuY3Rpb24gKG9wdGlvbnM6IGFueSkge1xuICAgIGNvbnN0IHByb3RvY29sID0gb3B0aW9ucy5wcm90b2NvbFxuICAgIGlmICghcHJvdG9jb2wpIHtcbiAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL2luZGV4J1xuICAgICAgfSlcbiAgICAgIHJldHVyblxuICAgIH1cbiAgICBjb25zdCBhY3RpdmUgPSBOdW1iZXIob3B0aW9ucy50eXBlKSB8fCAwXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFjdGl2ZTogYWN0aXZlLFxuICAgICAgcHJvdG9jb2xcbiAgICB9KVxuICAgIGF3YWl0IHRoaXMuZ2V0VXNlclByb3RvY29sU2V0dXAoKVxuICAgIGlmIChhY3RpdmUgPT09IDEpIHRoaXMudXBkYXRlVGhyZSgpXG4gICAgaWYgKGFjdGl2ZSA9PT0gMikgdGhpcy51cGRhdGVBbGFybSgpXG4gIH0sXG5cbiAgLy8g6I635Y+W55So5oi35Y2P6K6u6YWN572uXG4gIGFzeW5jIGdldFVzZXJQcm90b2NvbFNldHVwKCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bljY/orq7phY3nva4nIH0pXG4gICAgY29uc3QgdXNlclNldHVwID0gYXdhaXQgYXBpLmdldFVzZXJBbGFybVByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICBjb25zdCBzeXNTZXR1cCA9IGF3YWl0IGFwaS5nZXRBbGFybVByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICBjb25zdCBQcm90b2NvbHMgPSBhd2FpdCBhcGkuZ2V0UHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICBpZiAodXNlclNldHVwICYmIHN5c1NldHVwKSB7XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICB1c2Vyc2V0dXA6IHVzZXJTZXR1cC5kYXRhLFxuICAgICAgICBzeXNzZXR1cDogc3lzU2V0dXAuZGF0YSxcbiAgICAgICAgUHJvdG9jb2xzOiBQcm90b2NvbHMuZGF0YSxcbiAgICAgICAgc2hvd1RhZzogdXNlclNldHVwLmRhdGEuU2hvd1RhZ1xuICAgICAgfSlcblxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogXCJFcnJvclwiLFxuICAgICAgICBjb250ZW50OiAn6K6+5aSH5Y2P6K6uYuS4jeaUr+aMgemFjee9ridcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIC8vIOi/lOWbnuWNj+iuruWPguaVsOWvueixoeino+aekFxuICBwYXJzZVByb3RvY29sKCkge1xuICAgIGNvbnN0IHByb3RvY29sQXJyYXkgPSB0aGlzLmRhdGEuUHJvdG9jb2xzLmluc3RydWN0Lm1hcChpbnN0cnVjdCA9PiB7XG4gICAgICByZXR1cm4gaW5zdHJ1Y3QuZm9ybVJlc2l6ZS5tYXAoZWwgPT4gKHsgW2VsLm5hbWVdOiBlbC5pc1N0YXRlID8gdW5pdENhY2hlLmdldHVuaXRPYmplY3QoMSwgZWwudW5pdCBhcyBzdHJpbmcpIDoge30gfSkpXG4gICAgfSkucmVkdWNlKChwcmUsIGN1cikgPT4ge1xuICAgICAgcmV0dXJuIFsuLi5wcmUsIC4uLmN1cl1cbiAgICB9KVxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCAuLi5wcm90b2NvbEFycmF5KSBhcyB7IFt4OiBzdHJpbmddOiB7IFt4OiBzdHJpbmddOiBzdHJpbmcgfVtdIH1cbiAgfSxcbiAgLy8g5L+u5pS55qCH6aKYXG4gIHRhYmNsaWNrKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogJ+WNj+iurumFjee9ri0nICsgZXZlbnQuZGV0YWlsLnRpdGxlIH0pXG4gICAgc3dpdGNoIChldmVudC5kZXRhaWwudGl0bGUpIHtcbiAgICAgIGNhc2UgXCLlj4LmlbDpmZDlgLxcIjpcbiAgICAgICAgdGhpcy51cGRhdGVUaHJlKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgXCLlj4LmlbDnirbmgIFcIjpcbiAgICAgICAgdGhpcy51cGRhdGVBbGFybSgpXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9LFxuICAvLyDmm7TmlrB0aHJl5YiX6KGoXG4gIHVwZGF0ZVRocmUoKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIHN5c3NldHVwIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCBzeXNfVGhyZXNob2xkTWFwID0gbmV3IE1hcChzeXNzZXR1cC5UaHJlc2hvbGQubWFwKGVsID0+IFtlbC5uYW1lLCBlbF0pKVxuICAgIGlmICh1c2Vyc2V0dXA/LlRocmVzaG9sZCkge1xuICAgICAgLy8g6L+t5Luj55So5oi36YWN572u77yM6KaG55uW57O757uf6YWN572uXG4gICAgICBbLi4udGhpcy5kYXRhLlRocmVzaG9sZCwgLi4udXNlcnNldHVwLlRocmVzaG9sZF0uZm9yRWFjaCgodmFsKSA9PiB7XG4gICAgICAgIHN5c19UaHJlc2hvbGRNYXAuc2V0KHZhbC5uYW1lLCB2YWwpXG4gICAgICB9KVxuICAgIH1cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgVGhyZXNob2xkOiBBcnJheS5mcm9tKHN5c19UaHJlc2hvbGRNYXAudmFsdWVzKCkpXG4gICAgfSlcbiAgfSxcbiAgLy8g5pu05pawYWxhcm3liJfooahcbiAgdXBkYXRlQWxhcm0oKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIHN5c3NldHVwIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCBzeXNfYWxhcm1TdGF0TWFwID0gbmV3IE1hcChzeXNzZXR1cC5BbGFybVN0YXQubWFwKGVsID0+IFtlbC5uYW1lLCBlbF0pKVxuICAgIGlmICh1c2Vyc2V0dXA/LkFsYXJtU3RhdCkge1xuICAgICAgWy4uLnVzZXJzZXR1cC5BbGFybVN0YXQsIC4uLnRoaXMuZGF0YS5hbGFybVN0YXRdLmZvckVhY2godmFsID0+IHtcbiAgICAgICAgc3lzX2FsYXJtU3RhdE1hcC5zZXQodmFsLm5hbWUsIHZhbClcbiAgICAgIH0pXG4gICAgfVxuICAgIGNvbnN0IHBhcnNlID0gdGhpcy5wYXJzZVByb3RvY29sKClcbiAgICBzeXNfYWxhcm1TdGF0TWFwLmZvckVhY2goKGVsOmFueSwga2V5KSA9PiB7XG4gICAgICBlbC5wYXJzZSA9IHBhcnNlW2tleV1cbiAgICB9KVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBhbGFybVN0YXQ6IEFycmF5LmZyb20oc3lzX2FsYXJtU3RhdE1hcC52YWx1ZXMoKSlcbiAgICB9KVxuICB9LFxuICAvLyAg55uR5ZCs5pi+56S65Y+C5pWw5Y+Y5YyWXG4gIGFzeW5jIFNob3dUYWdvbkNoYW5nZShldmVudDogdmFudEV2ZW50KSB7XG4gICAgY29uc29sZS5sb2coeyBldmVudCB9KTtcblxuICAgIGNvbnN0IHRhZ3MgPSBldmVudC5kZXRhaWwgYXMgc3RyaW5nW11cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgc2hvd1RhZzogdGFnc1xuICAgIH0pXG4gICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbCwgJ1Nob3dUYWcnLCB0YWdzIHx8IFtdKVxuICAgICAgLnRoZW4ocmVzID0+IHtcbiAgICAgICAgd3guc2hvd1RvYXN0KHtcbiAgICAgICAgICB0aXRsZTogcmVzLmNvZGUgPT09IDIwMCA/ICfmmL7npLrlj4LmlbDkv67mlLnmiJDlip8nIDogJ+S/ruaUueWksei0pScsXG4gICAgICAgICAgaWNvbjpyZXMuY29kZSA9PT0gMjAwID8gJ3N1Y2Nlc3MnIDogJ2Vycm9yJyxcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gIH0sXG4gIC8vIOS/ruaUueaYvuekuuWPguaVsOWPmOWMluWAvFxuICBTaG93VGFndG9nZ2xlKF9ldmVudDogdmFudEV2ZW50KSB7XG4gICAgLy9jb25zb2xlLmxvZyhldmVudCk7XG5cbiAgICAvKiBjb25zdCB7IGluZGV4IH0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQ7XG4gICAgY29uc3QgY2hlY2tib3ggPSB0aGlzLnNlbGVjdENvbXBvbmVudChgLmNoZWNrYm94ZXMtJHtpbmRleH1gKTtcbiAgICBjaGVja2IudG9nZ2xlKCk7ICovXG4gIH0sXG4gIC8vIOebkeWQrOWPguaVsOeKtuaAgeWPmOWMllxuICBhc3luYyBBbGFybVN0YXRvbkNoYW5nZShldmVudDogdmFudEV2ZW50PFVhcnQuQ29uc3RhbnRBbGFybVN0YXQ+KSB7XG4gICAgY29uc3QgaXRlbSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3QgdmFsdWUgPSBldmVudC5kZXRhaWwgYXMgc3RyaW5nW11cbiAgICBjb25zdCBpbmRleCA9IHRoaXMuZGF0YS5hbGFybVN0YXQuZmluZEluZGV4KGVsID0+IGVsLm5hbWUgPT09IGl0ZW0ubmFtZSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgW1wiYWxhcm1TdGF0W1wiICsgaW5kZXggKyBcIl0uYWxhcm1TdGF0XCJdOiB2YWx1ZVxuICAgIH0pXG4gICAgY29uc3QgZGF0YSA9IHRoaXMuZGF0YS5hbGFybVN0YXRbaW5kZXhdXG4gICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbCwgJ0FsYXJtU3RhdCcsIGRhdGEpXG4gICAgLnRoZW4ocmVzID0+IHtcbiAgICAgIHd4LnNob3dUb2FzdCh7XG4gICAgICAgIHRpdGxlOiByZXMuY29kZSA9PT0gMjAwID8gJ+eKtuaAgeWPguaVsOS/ruaUueaIkOWKnycgOiAn5L+u5pS55aSx6LSlJyxcbiAgICAgICAgaWNvbjpyZXMuY29kZSA9PT0gMjAwID8gJ3N1Y2Nlc3MnIDogJ2Vycm9yJyxcbiAgICAgIH0pXG4gICAgfSlcblxuICB9LFxuICAvLyDot7PovazliLDlj4LmlbDpmZDlgLzkv67mlLnpobXpnaJcbiAgVGhyZXNob2xkQ2xpY2soZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LlRocmVzaG9sZD4pIHtcbiAgICBjb25zdCBpdGVtID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCBpbmRleCA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pbmRleFxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtU2V0dGluZy90aHJlc2hvbGQvdGhyZXNob2xkJyArIE9iamVjdFRvU3RycXVlcnkoeyAuLi5pdGVtIH0pLFxuICAgICAgZXZlbnRzOiB7XG4gICAgICAgIG1vZGlmeVRocmVzaG9sZDogYXN5bmMgKGRhdGE6IFVhcnQuVGhyZXNob2xkKSA9PiB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbCwgXCJUaHJlc2hvbGRcIiwgeyB0eXBlOiAnYWRkJywgZGF0YSB9KVxuICAgICAgICAgIC50aGVuKHJlcyA9PiB7XG4gICAgICAgICAgICB3eC5zaG93VG9hc3Qoe1xuICAgICAgICAgICAgICB0aXRsZTogcmVzLmNvZGUgPT09IDIwMCA/ICfnuqbmnZ/lj4LmlbDkv67mlLnmiJDlip8nIDogJ+S/ruaUueWksei0pScsXG4gICAgICAgICAgICAgIGljb246cmVzLmNvZGUgPT09IDIwMCA/ICdzdWNjZXNzJyA6ICdlcnJvcicsXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0pXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIFtgVGhyZXNob2xkWyR7aW5kZXh9XWBdOiB7IC4uLmRhdGEsIGljb246IFwic3RhclwiIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcbiAgLy8g6Lez6L2s5Yiw5paw5aKe5Y+C5pWw6ZmQ5YC86aG16Z2iXG4gIGFkZFRocmVzaG9sZCgpIHtcbiAgICAvLyDojrflj5bnjrDmnInnmoR0aHJl5ZCN56ewXG4gICAgY29uc3QgdWEgPSB0aGlzLmRhdGEudXNlcnNldHVwPy5BbGFybVN0YXQgfHwgW11cbiAgICBjb25zdCBrZXlzID0gbmV3IFNldChbLi4udGhpcy5kYXRhLmFsYXJtU3RhdC5tYXAoZWwgPT4gZWwubmFtZSksIC4uLnVhLm1hcChlbCA9PiBlbC5uYW1lKV0pXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL2FkZFRocmVzaG9sZC9hZGRUaHJlc2hvbGQnICsgT2JqZWN0VG9TdHJxdWVyeSh7IHByb3RvY29sOiB0aGlzLmRhdGEucHJvdG9jb2wsIGtleXM6IEFycmF5LmZyb20oa2V5cykgfSksXG4gICAgICBldmVudHM6IHtcbiAgICAgICAgYWRkVGhyZXNob2xkOiBhc3luYyAoZGF0YTogVWFydC5UaHJlc2hvbGQpID0+IHtcbiAgICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sLCBcIlRocmVzaG9sZFwiLCB7IHR5cGU6ICdhZGQnLCBkYXRhIH0pXG4gICAgICAgICAgY29uc3QgbmV3VGhyZSA9IHRoaXMuZGF0YS5UaHJlc2hvbGQuY29uY2F0KGRhdGEpXG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIFRocmVzaG9sZDogbmV3VGhyZVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDkv53lrZjphY3nva5cbiAgYXN5bmMgc2F2ZVNldHVwKCkge1xuICAgIGNvbnN0IHsgdXNlcnNldHVwLCBhbGFybVN0YXQsIFRocmVzaG9sZCwgcHJvdG9jb2wgfSA9IHRoaXMuZGF0YVxuICAgIC8vIOabtOaWsOeUqOaIt3Nob3dUYWdz6YWN572uXG4gICAge1xuICAgICAgY29uc3QgdXNlclNob3d0YWdzID0gdXNlcnNldHVwLlNob3dUYWcgfHwgW11cbiAgICAgIGNvbnN0IHNob3d0YWcgPSB0aGlzLmRhdGEuc2hvd1RhZyB8fCBbXVxuICAgICAgaWYgKHVzZXJTaG93dGFncy5zb3J0KCkuam9pbihcIlwiKSAhPT0gc2hvd3RhZy5zb3J0KCkuam9pbignJykpIHtcbiAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCAnU2hvd1RhZycsIHNob3d0YWcgfHwgW10pXG4gICAgICB9XG4gICAgfVxuICAgIC8vIOabtOaWsOeUqOaIt2FsYXJtU3RhdOmFjee9rlxuICAgIHtcbiAgICAgIC8vIOavlOi+g+WQjeensGpvaW7mmK/lkKbkuIDoh7TvvIzkuIDoh7TnmoTor53mo4Dmn6XplK7mmK/lkKbkuIDoh7TvvIzkuI3kuIDoh7Tnm7TmjqXmm7TmlrDvvIzplK7kuIDoh7TliJnmr5TovoPlgLzvvIzlgLzkuI3kuIDoh7TkuZ/mm7TmlrBcbiAgICAgIGNvbnN0IHVzZXJBbGFybSA9IHVzZXJzZXR1cC5BbGFybVN0YXQgfHwgW11cbiAgICAgIGNvbnN0IGFsYXJtID0gYWxhcm1TdGF0IHx8IFtdXG4gICAgICBjb25zdCBiMSA9IHVzZXJBbGFybS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpICE9PSBhbGFybS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpXG4gICAgICBpZiAoYjEpIHtcbiAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCAnQWxhcm1TdGF0JywgYWxhcm1TdGF0KVxuICAgICAgfSBlbHNlIGlmIChhbGFybS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgY29uc3QgdWEgPSB1c2VyQWxhcm0uc29ydCgpXG4gICAgICAgIGNvbnN0IGthID0gYWxhcm0uc29ydCgpXG4gICAgICAgIGNvbnN0IGNvbXBhcmUgPSB1YS5ldmVyeSgoZWwsIGluZGV4KSA9PiBlbC5hbGFybVN0YXQuc29ydCgpLmpvaW4oJycpICE9PSBrYVtpbmRleF0uYWxhcm1TdGF0LnNvcnQoKS5qb2luKCcnKSlcbiAgICAgICAgaWYgKGNvbXBhcmUpIHtcbiAgICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wocHJvdG9jb2wsICdBbGFybVN0YXQnLCBhbGFybVN0YXQpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgLy8g5pu05paw55So5oi3dGhyZWFk6YWN572uXG4gICAge1xuICAgICAgLy8g5q+U6L6D5ZCN56ewam9pbuaYr+WQpuS4gOiHtO+8jOS4gOiHtOeahOivneajgOafpemUruaYr+WQpuS4gOiHtO+8jOS4jeS4gOiHtOebtOaOpeabtOaWsO+8jOmUruS4gOiHtOWImeavlOi+g+WAvO+8jOWAvOS4jeS4gOiHtOS5n+abtOaWsFxuICAgICAgY29uc3QgdXNlclRocmUgPSB1c2Vyc2V0dXAuVGhyZXNob2xkIHx8IFtdXG4gICAgICBjb25zdCB0aHJlID0gVGhyZXNob2xkIHx8IFtdXG4gICAgICBjb25zdCBiMSA9IHVzZXJUaHJlLm1hcChlbCA9PiBlbC5uYW1lKS5zb3J0KCkuam9pbignJykgIT09IHRocmUubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKVxuICAgICAgY29uc3QgZGF0YSA9IHRocmUubWFwKGVsID0+ICh7IG5hbWU6IGVsLm5hbWUsIG1pbjogZWwubWluLCBtYXg6IGVsLm1heCB9KSlcbiAgICAgIGlmIChiMSkge1xuICAgICAgICBhd2FpdCBhcGkuc2V0VXNlclNldHVwUHJvdG9jb2wocHJvdG9jb2wsIFwiVGhyZXNob2xkXCIsIGRhdGEpXG4gICAgICB9IGVsc2UgaWYgKHRocmUubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIGNvbnN0IHVhID0gdXNlclRocmUuc29ydCgpXG4gICAgICAgIGNvbnN0IGthID0gdGhyZS5zb3J0KClcbiAgICAgICAgY29uc3QgY29tcGFyZSA9IHVhLmV2ZXJ5KChlbCwgaW5kZXgpID0+IGVsLm1pbiAhPT0ga2FbaW5kZXhdLm1pbiB8fCBlbC5tYXggIT09IGthW2luZGV4XS5tYXgpXG4gICAgICAgIGlmIChjb21wYXJlKSB7XG4gICAgICAgICAgYXdhaXQgYXBpLnNldFVzZXJTZXR1cFByb3RvY29sKHByb3RvY29sLCBcIlRocmVzaG9sZFwiLCBkYXRhKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWNuOi9vVxuICAgKi9cbiAgb25VbmxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICAvL3RoaXMuc2F2ZVNldHVwKClcbiAgfSxcblxuICAvKipcbiAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICovXG4gIG9uUHVsbERvd25SZWZyZXNoOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRVc2VyUHJvdG9jb2xTZXR1cCgpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH1cbn0pIl19