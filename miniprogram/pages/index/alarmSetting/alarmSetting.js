"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const unitCache_1 = require("../../../utils/unitCache");
const api_1 = require("../../../utils/api");
const util_1 = require("../../../utils/util");
Page({
    data: {
        active: 0,
        protocol: '',
        usersetup: {} || undefined,
        syssetup: {},
        Protocols: {},
        showTag: [],
        alarmStat: [] || undefined,
        Threshold: [] || undefined
    },
    onLoad: async function (options) {
        const protocol = options.protocol;
        if (!protocol) {
            wx.navigateTo({
                url: '/pages/index/alarmSetting/index'
            });
        }
        else {
            const active = Number(options.type) || 0;
            this.setData({
                active: active,
                protocol
            });
            await this.getUserProtocolSetup();
            if (active === 1)
                this.updateThre();
            if (active === 2)
                this.updateAlarm();
        }
    },
    async getUserProtocolSetup() {
        wx.showLoading({ title: '获取协议配置' });
        const { ok, arg } = await api_1.default.getUserDevConstant(this.data.protocol);
        wx.hideLoading();
        if (ok && arg) {
            this.setData({
                usersetup: arg.user || {},
                syssetup: arg.sys,
                Protocols: arg.protocol,
                showTag: arg?.user?.ShowTag || []
            });
            wx.setStorage({
                key: 'protocolSetup' + this.data.protocol,
                data: arg.protocol
            });
        }
        else {
            wx.showModal({
                title: "Error",
                content: '设备协议b不支持配置'
            });
        }
    },
    parseProtocol() {
        const protocolArray = this.data.Protocols.instruct.map(instruct => {
            return instruct.formResize.map(el => ({ [el.name]: el.isState ? unitCache_1.default.getunitObject(1, el.unit) : {} }));
        }).reduce((pre, cur) => {
            return [...pre, ...cur];
        });
        return Object.assign({}, ...protocolArray);
    },
    tabclick(event) {
        wx.setNavigationBarTitle({ title: '协议配置-' + event.detail.title });
        switch (event.detail.title) {
            case "参数限值":
                this.updateThre();
                break;
            case "参数状态":
                this.updateAlarm();
                break;
        }
    },
    updateThre() {
        const { usersetup, syssetup } = this.data;
        const sys_ThresholdMap = new Map(syssetup.Threshold.map(el => [el.name, el]));
        if (usersetup?.Threshold) {
            [...this.data.Threshold, ...usersetup.Threshold].forEach((val) => {
                sys_ThresholdMap.set(val.name, val);
            });
        }
        this.setData({
            Threshold: Array.from(sys_ThresholdMap.values())
        });
    },
    updateAlarm() {
        const { usersetup, syssetup } = this.data;
        const sys_alarmStatMap = new Map(syssetup.AlarmStat.map(el => [el.name, el]));
        if (usersetup?.AlarmStat) {
            [...usersetup.AlarmStat, ...this.data.alarmStat].forEach(val => {
                sys_alarmStatMap.set(val.name, val);
            });
        }
        const parse = this.parseProtocol();
        sys_alarmStatMap.forEach((el, key) => {
            el.parse = parse[key];
        });
        this.setData({
            alarmStat: Array.from(sys_alarmStatMap.values())
        });
    },
    async ShowTagonChange(event) {
        const tags = event.detail;
        this.setData({
            showTag: tags
        });
    },
    ShowTagtoggle(event) {
        const { index } = event.currentTarget.dataset;
        const checkbox = this.selectComponent(`.checkboxes-${index}`);
        checkbox.toggle();
    },
    async AlarmStatonChange(event) {
        const item = event.currentTarget.dataset.item;
        const value = event.detail;
        const index = this.data.alarmStat.findIndex(el => el.name === item.name);
        this.setData({
            ["alarmStat[" + index + "].alarmStat"]: value
        });
    },
    ThresholdClick(event) {
        const item = event.currentTarget.dataset.item;
        const index = event.currentTarget.dataset.index;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/threshold/threshold' + util_1.ObjectToStrquery({ ...item }),
            events: {
                modifyThreshold: (data) => {
                    this.setData({
                        [`Threshold[${index}]`]: { ...data, icon: "star" }
                    });
                }
            }
        });
    },
    addThreshold() {
        const ua = this.data.usersetup?.AlarmStat || [];
        const keys = new Set([...this.data.alarmStat.map(el => el.name), ...ua.map(el => el.name)]);
        wx.navigateTo({
            url: '/pages/index/alarmSetting/addThreshold/addThreshold' + util_1.ObjectToStrquery({ protocol: this.data.protocol, keys: Array.from(keys) }),
            events: {
                addThreshold: (data) => {
                    const newThre = this.data.Threshold.concat(data);
                    this.setData({
                        Threshold: newThre
                    });
                }
            }
        });
    },
    async saveSetup() {
        const { usersetup, alarmStat, Threshold, protocol } = this.data;
        {
            const userShowtags = usersetup.ShowTag || [];
            const showtag = this.data.showTag || [];
            if (userShowtags.sort().join("") !== showtag.sort().join('')) {
                await api_1.default.pushThreshold(showtag || [], 'ShowTag', protocol);
            }
        }
        {
            const userAlarm = usersetup.AlarmStat || [];
            const alarm = alarmStat || [];
            const b1 = userAlarm.map(el => el.name).sort().join('') !== alarm.map(el => el.name).sort().join('');
            if (b1) {
                await api_1.default.pushThreshold(alarmStat, 'AlarmStat', protocol);
            }
            else if (alarm.length !== 0) {
                const ua = userAlarm.sort();
                const ka = alarm.sort();
                const compare = ua.every((el, index) => el.alarmStat.sort().join('') !== ka[index].alarmStat.sort().join(''));
                if (compare) {
                    await api_1.default.pushThreshold(alarmStat, 'AlarmStat', protocol);
                }
            }
        }
        {
            const userThre = usersetup.Threshold || [];
            const thre = Threshold || [];
            const b1 = userThre.map(el => el.name).sort().join('') !== thre.map(el => el.name).sort().join('');
            if (b1) {
                await api_1.default.pushThreshold(thre.map(el => ({ name: el.name, min: el.min, max: el.max })), "Threshold", protocol);
            }
            else if (thre.length !== 0) {
                const ua = userThre.sort();
                const ka = thre.sort();
                const compare = ua.every((el, index) => el.min !== ka[index].min || el.max !== ka[index].max);
                if (compare) {
                    await api_1.default.pushThreshold(thre.map(el => ({ name: el.name, min: el.min, max: el.max })), "Threshold", protocol);
                }
            }
        }
    },
    onUnload: function () {
        this.saveSetup();
    },
    onPullDownRefresh: async function () {
        await this.getUserProtocolSetup();
        wx.stopPullDownRefresh();
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxhcm1TZXR0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxhcm1TZXR0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsd0RBQWdEO0FBQ2hELDRDQUFvQztBQUNwQyw4Q0FBc0Q7QUFHdEQsSUFBSSxDQUFDO0lBSUgsSUFBSSxFQUFFO1FBQ0osTUFBTSxFQUFFLENBQUM7UUFDVCxRQUFRLEVBQUUsRUFBRTtRQUNaLFNBQVMsRUFBRSxFQUErQixJQUFJLFNBQVM7UUFDdkQsUUFBUSxFQUFFLEVBQStCO1FBQ3pDLFNBQVMsRUFBRSxFQUFjO1FBQ3pCLE9BQU8sRUFBRSxFQUFjO1FBQ3ZCLFNBQVMsRUFBRSxFQUF5QixJQUFJLFNBQVM7UUFDakQsU0FBUyxFQUFFLEVBQWlCLElBQUksU0FBUztLQUMxQztJQUtELE1BQU0sRUFBRSxLQUFLLFdBQVcsT0FBTztRQUM3QixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFBO1FBQ2pDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDYixFQUFFLENBQUMsVUFBVSxDQUFDO2dCQUNaLEdBQUcsRUFBRSxpQ0FBaUM7YUFDdkMsQ0FBQyxDQUFBO1NBQ0g7YUFBTTtZQUNMLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3hDLElBQUksQ0FBQyxPQUFPLENBQUM7Z0JBQ1gsTUFBTSxFQUFFLE1BQU07Z0JBQ2QsUUFBUTthQUNULENBQUMsQ0FBQTtZQUNGLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUE7WUFDakMsSUFBSSxNQUFNLEtBQUssQ0FBQztnQkFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDbkMsSUFBSSxNQUFNLEtBQUssQ0FBQztnQkFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7U0FjckM7SUFDSCxDQUFDO0lBR0QsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixFQUFFLENBQUMsV0FB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cm9tIFwiLi4vLi4vLi4vdXRpbHMvdW5pdENhY2hlXCJcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5pbXBvcnQgeyBPYmplY3RUb1N0cnF1ZXJ5IH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuXG4vLyBtaW5pcHJvZ3JhbS9wYWdlcy9pbmRleC9hbGFybVNldHRpbmcvYWxhcm1TZXR0aW5nLmpzXG5QYWdlKHtcbiAgLyoqXG4gICAqIOmhtemdoueahOWIneWni+aVsOaNrlxuICAgKi9cbiAgZGF0YToge1xuICAgIGFjdGl2ZTogMCxcbiAgICBwcm90b2NvbDogJycsXG4gICAgdXNlcnNldHVwOiB7fSBhcyBQcm90b2NvbENvbnN0YW50VGhyZXNob2xkIHx8IHVuZGVmaW5lZCxcbiAgICBzeXNzZXR1cDoge30gYXMgUHJvdG9jb2xDb25zdGFudFRocmVzaG9sZCxcbiAgICBQcm90b2NvbHM6IHt9IGFzIHByb3RvY29sLFxuICAgIHNob3dUYWc6IFtdIGFzIHN0cmluZ1tdLFxuICAgIGFsYXJtU3RhdDogW10gYXMgQ29uc3RhbnRBbGFybVN0YXRbXSB8fCB1bmRlZmluZWQsXG4gICAgVGhyZXNob2xkOiBbXSBhcyBUaHJlc2hvbGRbXSB8fCB1bmRlZmluZWRcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogYXN5bmMgZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICBjb25zdCBwcm90b2NvbCA9IG9wdGlvbnMucHJvdG9jb2xcbiAgICBpZiAoIXByb3RvY29sKSB7XG4gICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtU2V0dGluZy9pbmRleCdcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGFjdGl2ZSA9IE51bWJlcihvcHRpb25zLnR5cGUpIHx8IDBcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGFjdGl2ZTogYWN0aXZlLFxuICAgICAgICBwcm90b2NvbFxuICAgICAgfSlcbiAgICAgIGF3YWl0IHRoaXMuZ2V0VXNlclByb3RvY29sU2V0dXAoKVxuICAgICAgaWYgKGFjdGl2ZSA9PT0gMSkgdGhpcy51cGRhdGVUaHJlKClcbiAgICAgIGlmIChhY3RpdmUgPT09IDIpIHRoaXMudXBkYXRlQWxhcm0oKVxuICAgICAgLyogd3guZ2V0U3RvcmFnZSh7XG4gICAgICAgIGtleTogJ3Byb3RvY29sU2V0dXAnICsgcHJvdG9jb2wsXG4gICAgICAgIHN1Y2Nlc3M6IChyZXMpID0+IHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgdXNlcnNldHVwOiByZXMuZGF0YS51c2VyLFxuICAgICAgICAgICAgc3lzc2V0dXA6IHJlcy5kYXRhLnN5cyxcbiAgICAgICAgICAgIFByb3RvY29sczogcmVzLmRhdGEucHJvdG9jb2xcbiAgICAgICAgICB9KVxuICAgICAgICB9LFxuICAgICAgICBmYWlsOiAoX2UpID0+IHtcbiAgICAgICAgICB0aGlzLmdldFVzZXJQcm90b2NvbFNldHVwKClcbiAgICAgICAgfVxuICAgICAgfSkgKi9cbiAgICB9XG4gIH0sXG5cbiAgLy8g6I635Y+W55So5oi35Y2P6K6u6YWN572uXG4gIGFzeW5jIGdldFVzZXJQcm90b2NvbFNldHVwKCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bljY/orq7phY3nva4nIH0pXG4gICAgY29uc3QgeyBvaywgYXJnIH0gPSBhd2FpdCBhcGkuZ2V0VXNlckRldkNvbnN0YW50KHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgaWYgKG9rICYmIGFyZykge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgdXNlcnNldHVwOiBhcmcudXNlciB8fCB7fSxcbiAgICAgICAgc3lzc2V0dXA6IGFyZy5zeXMsXG4gICAgICAgIFByb3RvY29sczogYXJnLnByb3RvY29sLFxuICAgICAgICBzaG93VGFnOiBhcmc/LnVzZXI/LlNob3dUYWcgfHwgW11cbiAgICAgIH0pXG4gICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAga2V5OiAncHJvdG9jb2xTZXR1cCcgKyB0aGlzLmRhdGEucHJvdG9jb2wsXG4gICAgICAgIGRhdGE6IGFyZy5wcm90b2NvbFxuICAgICAgfSlcblxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogXCJFcnJvclwiLFxuICAgICAgICBjb250ZW50OiAn6K6+5aSH5Y2P6K6uYuS4jeaUr+aMgemFjee9ridcbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIC8vIOi/lOWbnuWNj+iuruWPguaVsOWvueixoeino+aekFxuICBwYXJzZVByb3RvY29sKCkge1xuICAgIGNvbnN0IHByb3RvY29sQXJyYXkgPSB0aGlzLmRhdGEuUHJvdG9jb2xzLmluc3RydWN0Lm1hcChpbnN0cnVjdCA9PiB7XG4gICAgICByZXR1cm4gaW5zdHJ1Y3QuZm9ybVJlc2l6ZS5tYXAoZWwgPT4gKHsgW2VsLm5hbWVdOiBlbC5pc1N0YXRlID8gdW5pdENhY2hlLmdldHVuaXRPYmplY3QoMSwgZWwudW5pdCBhcyBzdHJpbmcpIDoge30gfSkpXG4gICAgfSkucmVkdWNlKChwcmUsIGN1cikgPT4ge1xuICAgICAgcmV0dXJuIFsuLi5wcmUsIC4uLmN1cl1cbiAgICB9KVxuICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCAuLi5wcm90b2NvbEFycmF5KSBhcyB7IFt4OiBzdHJpbmddOiB7IFt4OiBzdHJpbmddOiBzdHJpbmcgfVtdIH1cbiAgfSxcbiAgLy8g5L+u5pS55qCH6aKYXG4gIHRhYmNsaWNrKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogJ+WNj+iurumFjee9ri0nICsgZXZlbnQuZGV0YWlsLnRpdGxlIH0pXG4gICAgc3dpdGNoIChldmVudC5kZXRhaWwudGl0bGUpIHtcbiAgICAgIGNhc2UgXCLlj4LmlbDpmZDlgLxcIjpcbiAgICAgICAgdGhpcy51cGRhdGVUaHJlKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgXCLlj4LmlbDnirbmgIFcIjpcbiAgICAgICAgdGhpcy51cGRhdGVBbGFybSgpXG4gICAgICAgIGJyZWFrXG4gICAgfVxuICB9LFxuICAvLyDmm7TmlrB0aHJl5YiX6KGoXG4gIHVwZGF0ZVRocmUoKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIHN5c3NldHVwIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCBzeXNfVGhyZXNob2xkTWFwID0gbmV3IE1hcChzeXNzZXR1cC5UaHJlc2hvbGQubWFwKGVsID0+IFtlbC5uYW1lLCBlbF0pKVxuICAgIGlmICh1c2Vyc2V0dXA/LlRocmVzaG9sZCkge1xuICAgICAgLy8g6L+t5Luj55So5oi36YWN572u77yM6KaG55uW57O757uf6YWN572uXG4gICAgICBbLi4udGhpcy5kYXRhLlRocmVzaG9sZCwgLi4udXNlcnNldHVwLlRocmVzaG9sZF0uZm9yRWFjaCgodmFsKSA9PiB7XG4gICAgICAgIHN5c19UaHJlc2hvbGRNYXAuc2V0KHZhbC5uYW1lLCB2YWwpXG4gICAgICB9KVxuICAgIH1cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgVGhyZXNob2xkOiBBcnJheS5mcm9tKHN5c19UaHJlc2hvbGRNYXAudmFsdWVzKCkpXG4gICAgfSlcbiAgfSxcbiAgLy8g5pu05pawYWxhcm3liJfooahcbiAgdXBkYXRlQWxhcm0oKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIHN5c3NldHVwIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCBzeXNfYWxhcm1TdGF0TWFwID0gbmV3IE1hcChzeXNzZXR1cC5BbGFybVN0YXQubWFwKGVsID0+IFtlbC5uYW1lLCBlbF0pKVxuICAgIGlmICh1c2Vyc2V0dXA/LkFsYXJtU3RhdCkge1xuICAgICAgWy4uLnVzZXJzZXR1cC5BbGFybVN0YXQsIC4uLnRoaXMuZGF0YS5hbGFybVN0YXRdLmZvckVhY2godmFsID0+IHtcbiAgICAgICAgc3lzX2FsYXJtU3RhdE1hcC5zZXQodmFsLm5hbWUsIHZhbClcbiAgICAgIH0pXG4gICAgfVxuICAgIGNvbnN0IHBhcnNlID0gdGhpcy5wYXJzZVByb3RvY29sKClcbiAgICBzeXNfYWxhcm1TdGF0TWFwLmZvckVhY2goKGVsLCBrZXkpID0+IHtcbiAgICAgIGVsLnBhcnNlID0gcGFyc2Vba2V5XVxuICAgIH0pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGFsYXJtU3RhdDogQXJyYXkuZnJvbShzeXNfYWxhcm1TdGF0TWFwLnZhbHVlcygpKVxuICAgIH0pXG4gIH0sXG4gIC8vICDnm5HlkKzmmL7npLrlj4LmlbDlj5jljJZcbiAgYXN5bmMgU2hvd1RhZ29uQ2hhbmdlKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICBjb25zdCB0YWdzID0gZXZlbnQuZGV0YWlsIGFzIHN0cmluZ1tdXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHNob3dUYWc6IHRhZ3NcbiAgICB9KVxuICB9LFxuICAvLyDkv67mlLnmmL7npLrlj4LmlbDlj5jljJblgLxcbiAgU2hvd1RhZ3RvZ2dsZShldmVudDogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgeyBpbmRleCB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0O1xuICAgIGNvbnN0IGNoZWNrYm94ID0gdGhpcy5zZWxlY3RDb21wb25lbnQoYC5jaGVja2JveGVzLSR7aW5kZXh9YCk7XG4gICAgY2hlY2tib3gudG9nZ2xlKCk7XG4gIH0sXG4gIC8vIOebkeWQrOWPguaVsOeKtuaAgeWPmOWMllxuICBhc3luYyBBbGFybVN0YXRvbkNoYW5nZShldmVudDogdmFudEV2ZW50PENvbnN0YW50QWxhcm1TdGF0Pikge1xuICAgIGNvbnN0IGl0ZW0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHZhbHVlID0gZXZlbnQuZGV0YWlsIGFzIHN0cmluZ1tdXG4gICAgY29uc3QgaW5kZXggPSB0aGlzLmRhdGEuYWxhcm1TdGF0LmZpbmRJbmRleChlbCA9PiBlbC5uYW1lID09PSBpdGVtLm5hbWUpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIFtcImFsYXJtU3RhdFtcIiArIGluZGV4ICsgXCJdLmFsYXJtU3RhdFwiXTogdmFsdWVcbiAgICB9KVxuICB9LFxuICAvLyDot7PovazliLDlj4LmlbDpmZDlgLzkv67mlLnpobXpnaJcbiAgVGhyZXNob2xkQ2xpY2soZXZlbnQ6IHZhbnRFdmVudDxUaHJlc2hvbGQ+KSB7XG4gICAgY29uc3QgaXRlbSA9IGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC5pdGVtXG4gICAgY29uc3QgaW5kZXggPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaW5kZXhcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9hbGFybVNldHRpbmcvdGhyZXNob2xkL3RocmVzaG9sZCcgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgLi4uaXRlbSB9KSxcbiAgICAgIGV2ZW50czoge1xuICAgICAgICBtb2RpZnlUaHJlc2hvbGQ6IChkYXRhOiBUaHJlc2hvbGQpID0+IHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgW2BUaHJlc2hvbGRbJHtpbmRleH1dYF06IHsgLi4uZGF0YSwgaWNvbjogXCJzdGFyXCIgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuICAvLyDot7PovazliLDmlrDlop7lj4LmlbDpmZDlgLzpobXpnaJcbiAgYWRkVGhyZXNob2xkKCkge1xuICAgIC8vIOiOt+WPlueOsOacieeahHRocmXlkI3np7BcbiAgICBjb25zdCB1YSA9IHRoaXMuZGF0YS51c2Vyc2V0dXA/LkFsYXJtU3RhdCB8fCBbXVxuICAgIGNvbnN0IGtleXMgPSBuZXcgU2V0KFsuLi50aGlzLmRhdGEuYWxhcm1TdGF0Lm1hcChlbCA9PiBlbC5uYW1lKSwgLi4udWEubWFwKGVsID0+IGVsLm5hbWUpXSlcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9hbGFybVNldHRpbmcvYWRkVGhyZXNob2xkL2FkZFRocmVzaG9sZCcgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgcHJvdG9jb2w6IHRoaXMuZGF0YS5wcm90b2NvbCwga2V5czogQXJyYXkuZnJvbShrZXlzKSB9KSxcbiAgICAgIGV2ZW50czoge1xuICAgICAgICBhZGRUaHJlc2hvbGQ6IChkYXRhOiBUaHJlc2hvbGQpID0+IHtcbiAgICAgICAgICBjb25zdCBuZXdUaHJlID0gdGhpcy5kYXRhLlRocmVzaG9sZC5jb25jYXQoZGF0YSlcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgVGhyZXNob2xkOiBuZXdUaHJlXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG4gIC8vIOS/neWtmOmFjee9rlxuICBhc3luYyBzYXZlU2V0dXAoKSB7XG4gICAgY29uc3QgeyB1c2Vyc2V0dXAsIGFsYXJtU3RhdCwgVGhyZXNob2xkLCBwcm90b2NvbCB9ID0gdGhpcy5kYXRhXG4gICAgLy8g5pu05paw55So5oi3c2hvd1RhZ3PphY3nva5cbiAgICB7XG4gICAgICBjb25zdCB1c2VyU2hvd3RhZ3MgPSB1c2Vyc2V0dXAuU2hvd1RhZyB8fCBbXVxuICAgICAgY29uc3Qgc2hvd3RhZyA9IHRoaXMuZGF0YS5zaG93VGFnIHx8IFtdXG4gICAgICBpZiAodXNlclNob3d0YWdzLnNvcnQoKS5qb2luKFwiXCIpICE9PSBzaG93dGFnLnNvcnQoKS5qb2luKCcnKSkge1xuICAgICAgICBhd2FpdCBhcGkucHVzaFRocmVzaG9sZChzaG93dGFnIHx8IFtdLCAnU2hvd1RhZycsIHByb3RvY29sKVxuICAgICAgfVxuICAgIH1cbiAgICAvLyDmm7TmlrDnlKjmiLdhbGFybVN0YXTphY3nva5cbiAgICB7XG4gICAgICAvLyDmr5TovoPlkI3np7Bqb2lu5piv5ZCm5LiA6Ie077yM5LiA6Ie055qE6K+d5qOA5p+l6ZSu5piv5ZCm5LiA6Ie077yM5LiN5LiA6Ie055u05o6l5pu05paw77yM6ZSu5LiA6Ie05YiZ5q+U6L6D5YC877yM5YC85LiN5LiA6Ie05Lmf5pu05pawXG4gICAgICBjb25zdCB1c2VyQWxhcm0gPSB1c2Vyc2V0dXAuQWxhcm1TdGF0IHx8IFtdXG4gICAgICBjb25zdCBhbGFybSA9IGFsYXJtU3RhdCB8fCBbXVxuICAgICAgY29uc3QgYjEgPSB1c2VyQWxhcm0ubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKSAhPT0gYWxhcm0ubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKVxuICAgICAgaWYgKGIxKSB7XG4gICAgICAgIGF3YWl0IGFwaS5wdXNoVGhyZXNob2xkKGFsYXJtU3RhdCwgJ0FsYXJtU3RhdCcsIHByb3RvY29sKVxuICAgICAgfSBlbHNlIGlmIChhbGFybS5sZW5ndGggIT09IDApIHtcbiAgICAgICAgY29uc3QgdWEgPSB1c2VyQWxhcm0uc29ydCgpXG4gICAgICAgIGNvbnN0IGthID0gYWxhcm0uc29ydCgpXG4gICAgICAgIGNvbnN0IGNvbXBhcmUgPSB1YS5ldmVyeSgoZWwsIGluZGV4KSA9PiBlbC5hbGFybVN0YXQuc29ydCgpLmpvaW4oJycpICE9PSBrYVtpbmRleF0uYWxhcm1TdGF0LnNvcnQoKS5qb2luKCcnKSlcbiAgICAgICAgaWYgKGNvbXBhcmUpIHtcbiAgICAgICAgICBhd2FpdCBhcGkucHVzaFRocmVzaG9sZChhbGFybVN0YXQsICdBbGFybVN0YXQnLCBwcm90b2NvbClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICAvLyDmm7TmlrDnlKjmiLd0aHJlYWTphY3nva5cbiAgICB7XG4gICAgICAvLyDmr5TovoPlkI3np7Bqb2lu5piv5ZCm5LiA6Ie077yM5LiA6Ie055qE6K+d5qOA5p+l6ZSu5piv5ZCm5LiA6Ie077yM5LiN5LiA6Ie055u05o6l5pu05paw77yM6ZSu5LiA6Ie05YiZ5q+U6L6D5YC877yM5YC85LiN5LiA6Ie05Lmf5pu05pawXG4gICAgICBjb25zdCB1c2VyVGhyZSA9IHVzZXJzZXR1cC5UaHJlc2hvbGQgfHwgW11cbiAgICAgIGNvbnN0IHRocmUgPSBUaHJlc2hvbGQgfHwgW11cbiAgICAgIGNvbnN0IGIxID0gdXNlclRocmUubWFwKGVsID0+IGVsLm5hbWUpLnNvcnQoKS5qb2luKCcnKSAhPT0gdGhyZS5tYXAoZWwgPT4gZWwubmFtZSkuc29ydCgpLmpvaW4oJycpXG4gICAgICBpZiAoYjEpIHtcbiAgICAgICAgYXdhaXQgYXBpLnB1c2hUaHJlc2hvbGQodGhyZS5tYXAoZWwgPT4gKHsgbmFtZTogZWwubmFtZSwgbWluOiBlbC5taW4sIG1heDogZWwubWF4IH0pKSwgXCJUaHJlc2hvbGRcIiwgcHJvdG9jb2wpXG4gICAgICB9IGVsc2UgaWYgKHRocmUubGVuZ3RoICE9PSAwKSB7XG4gICAgICAgIGNvbnN0IHVhID0gdXNlclRocmUuc29ydCgpXG4gICAgICAgIGNvbnN0IGthID0gdGhyZS5zb3J0KClcbiAgICAgICAgY29uc3QgY29tcGFyZSA9IHVhLmV2ZXJ5KChlbCwgaW5kZXgpID0+IGVsLm1pbiAhPT0ga2FbaW5kZXhdLm1pbiB8fCBlbC5tYXggIT09IGthW2luZGV4XS5tYXgpXG4gICAgICAgIGlmIChjb21wYXJlKSB7XG4gICAgICAgICAgYXdhaXQgYXBpLnB1c2hUaHJlc2hvbGQodGhyZS5tYXAoZWwgPT4gKHsgbmFtZTogZWwubmFtZSwgbWluOiBlbC5taW4sIG1heDogZWwubWF4IH0pKSwgXCJUaHJlc2hvbGRcIiwgcHJvdG9jb2wpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuICAgIHRoaXMuc2F2ZVNldHVwKClcbiAgfSxcblxuICAvKipcbiAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICovXG4gIG9uUHVsbERvd25SZWZyZXNoOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5nZXRVc2VyUHJvdG9jb2xTZXR1cCgpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH1cbn0pIl19