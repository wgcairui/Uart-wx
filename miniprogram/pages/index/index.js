"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../utils/util");
const api_1 = require("../../utils/api");
Page({
    data: {
        ready: false,
        DTUs: [],
        dtuItem: [],
        state: '',
        alarm: '',
        alarmNum: 0,
        alarmData: [],
        Vm: [],
        confirm: false,
        sub: false
    },
    devPics: {
        "UPS": '/assert/ups.png',
        "温湿度": '/assert/th.png',
        "电量仪": '/assert/em.png',
        "空调": '/assert/air.png'
    },
    onLoad(query) {
        wx.showLoading({ title: 'loading' });
        wx.login({
            success: async (login) => {
                const { code, data } = await api_1.default.login({ js_code: login.code, scene: query.scene ? decodeURIComponent(query.scene) : '' });
                if (code) {
                    const user = await api_1.default.userInfo();
                    wx.hideLoading();
                    switch (user.data.userGroup) {
                        case "admin":
                        case "root":
                            wx.reLaunch({ url: "/pages/admin/index" });
                            break;
                        default:
                            this.setData({ ready: true, sub: Boolean(user.data.wxId) });
                            this.start();
                            break;
                    }
                }
                else {
                    wx.hideLoading();
                    wx.reLaunch({ url: "/pages/login/login?openid=" + data.openid + "&unionid=" + data.unionid });
                }
            }
        });
    },
    start() {
        this.bindDev();
    },
    async subMessage() {
        const url = encodeURIComponent('http://mp.weixin.qq.com/s?__biz=MjM5MjA1MTgxOQ==&mid=304819939&idx=1&sn=d0bcd922033075afa2b5219fc95ebb1e&chksm=3173a9e7060420f1a98d0040d964a2f82af25289a731d1400c5224ca9bb3d225d737700700a8#rd');
        wx.navigateTo({ url: '/pages/index/web/web?url=' + url });
    },
    async bindDev() {
        wx.showLoading({ title: '获取DTU' });
        const { code, data } = await api_1.default.BindDev();
        wx.hideLoading();
        wx.stopPullDownRefresh();
        if (code) {
            if (data.UTs.length === 0) {
                this.setData({
                    DTUs: [],
                    dtuItem: []
                });
                if (!this.data.confirm) {
                    wx.showModal({
                        title: '添加设备',
                        content: '您还没有任何设备，是否添加设备?',
                        success: (res) => {
                            if (res.confirm) {
                                wx.navigateTo({
                                    url: '/pages/index/bindDev/bindDev'
                                });
                            }
                            else {
                                this.setData({
                                    confirm: true
                                });
                            }
                        }
                    });
                }
            }
            else {
                this.sortDevs(data.UTs);
                api_1.default.getAlarmunconfirmed().then(({ data: len }) => {
                    if (Number(len) > 0) {
                        this.setData({
                            alarm: `有${len}条未确认的告警信息，点击查看?`,
                            alarmNum: Number(len)
                        });
                    }
                    else {
                        this.setData({
                            alarm: ``,
                            alarmNum: Number(len),
                            alarmData: []
                        });
                    }
                });
            }
        }
    },
    sortDevs(UTs) {
        wx.setStorage({
            key: 'Uts',
            data: UTs
        });
        this.countDev(UTs);
        const devs = UTs.map(dtu => {
            return dtu.mountDevs.map(dev => ({ ...dev, pic: this.devPics[dev.Type], dtu: dtu.name, online: dev.online && dtu.online }));
        }).flat();
        this.setData({
            DTUs: UTs,
            dtuItem: devs
        });
    },
    toDev(event) {
        const { DevMac } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/index/dtu/dtu' + util_1.ObjectToStrquery({ mac: DevMac })
        });
    },
    showMountDevData(event) {
        const { pid, mountDev, protocol, dtu, Type } = event.currentTarget.dataset.item;
        const { DevMac } = this.data.DTUs.find(el => el.name === dtu);
        wx.navigateTo({
            url: '/pages/index/devs/devs' + util_1.ObjectToStrquery({ pid: String(pid), mountDev, protocol, DevMac, Type })
        });
    },
    seeAlarm() {
        wx.switchTab({ url: '/pages/index/alarm/alarm?num=' + this.data.alarmNum });
    },
    countDev(terminals) {
        const terminal_all = terminals.length;
        const terminal_on = terminals.map(el => el.online).filter(el => el).length;
        const monutDev_all = terminals.map(el => el.mountDevs.length).reduce((pre, cur) => pre + cur);
        const mountDev_on = terminals.map(el => el.mountDevs.filter(el2 => el2.online)).reduce((pre, cur) => [...pre, ...cur]).length;
        const state = `DTU:(全部${terminal_all}/在线${terminal_on}),挂载设备:(全部${monutDev_all}/在线${mountDev_on})`;
        this.setData({
            state
        });
    },
    async onPullDownRefresh() {
        await this.bindDev();
        this.countDev(this.data.DTUs);
        this.start();
        wx.stopPullDownRefresh();
    },
    bindload(event) {
        console.log(`公众号加载success,状态:${event.detail.errMsg}`);
    },
    binderror(event) {
        console.log(`公众号加载error,状态:${event.detail.errMsg}`);
    },
    async addVm() {
        const { ok, arg } = await api_1.default.addVm();
        if (ok) {
            this.setData({
                Vm: arg
            });
            this.sortDevs(arg);
        }
    },
    onShow() {
        if (this.data.ready) {
            this.bindDev();
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDJDQUFvRDtBQUNwRCx5Q0FBa0M7QUFFbEMsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLEtBQUs7UUFFWixJQUFJLEVBQUUsRUFBcUI7UUFFM0IsT0FBTyxFQUFFLEVBQThCO1FBRXZDLEtBQUssRUFBRSxFQUFFO1FBRVQsS0FBSyxFQUFFLEVBQUU7UUFFVCxRQUFRLEVBQUUsQ0FBQztRQUVYLFNBQVMsRUFBRSxFQUE0QjtRQUV2QyxFQUFFLEVBQUUsRUFBcUI7UUFDekIsT0FBTyxFQUFFLEtBQUs7UUFFZCxHQUFHLEVBQUUsS0FBSztLQUNYO0lBRUQsT0FBTyxFQUFFO1FBQ1AsS0FBSyxFQUFFLGlCQUFpQjtRQUN4QixLQUFLLEVBQUUsZ0JBQWdCO1FBQ3ZCLEtBQUssRUFBRSxnQkFBZ0I7UUFDdkIsSUFBSSxFQUFFLGlCQUFpQjtLQUNFO0lBQzNCLE1BQU0sQ0FBQyxLQUFVO1FBQ2YsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFBO1FBQ3BDLEVBQUUsQ0FBQyxLQUFLLENBQUM7WUFDUCxPQUFPLEVBQUUsS0FBSyxFQUFDLEtBQUssRUFBQyxFQUFFO2dCQUVyQixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sYUFBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7Z0JBQzFILElBQUksSUFBSSxFQUFFO29CQUNSLE1BQU0sSUFBSSxHQUFHLE1BQU0sYUFBRyxDQUFDLFFBQVEsRUFBRSxD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R0FBRyxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsS0FBSyxFQUFFLENBQUE7UUFDckMsSUFBSSxFQUFFLEVBQUU7WUFDTixJQUFJLENBQUMsT0FBTyxDQUFDO2dCQUNYLEVBQUUsRUFBRSxHQUFHO2FBQ1IsQ0FBQyxDQUFBO1lBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQTtTQUNuQjtJQUNILENBQUM7SUFDRCxNQUFNO1FBQ0osSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNuQixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUE7U0FDZjtJQUNILENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbmRleC50c1xuaW1wb3J0IHsgT2JqZWN0VG9TdHJxdWVyeSB9IGZyb20gXCIuLi8uLi91dGlscy91dGlsXCI7XG5pbXBvcnQgYXBpIGZyb20gXCIuLi8uLi91dGlscy9hcGlcIjtcbi8vIOiOt+WPluW6lOeUqOWunuS+i1xuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICByZWFkeTogZmFsc2UsXG4gICAgLyoqIERUVeiuvuWkh+S/oeaBryAqL1xuICAgIERUVXM6IFtdIGFzIFVhcnQuVGVybWluYWxbXSxcbiAgICAvLyDliLfpgInmjILovb3orr7lpIfliJfooahcbiAgICBkdHVJdGVtOiBbXSBhcyBVYXJ0LlRlcm1pbmFsTW91bnREZXZzW10sXG4gICAgLy8g5oyC6L2954q25oCB5L+h5oGvXG4gICAgc3RhdGU6ICcnLFxuICAgIC8vIOWRiuitpueKtuaAgeS/oeaBr1xuICAgIGFsYXJtOiAnJyxcbiAgICAvLyDmnKrnoa7orqTlkYrorabmlbDph49cbiAgICBhbGFybU51bTogMCxcbiAgICAvLyDkupTmnaHlhoXlkYrorabmlbDmja5cbiAgICBhbGFybURhdGE6IFtdIGFzIFVhcnQudWFydEFsYXJtT2JqZWN0W10sXG4gICAgLy8g6Jma5ouf6K6+5aSHXG4gICAgVm06IFtdIGFzIFVhcnQuVGVybWluYWxbXSxcbiAgICBjb25maXJtOiBmYWxzZSxcbiAgICAvLyDmmK/lkKborqLpmIVcbiAgICBzdWI6IGZhbHNlXG4gIH0sXG5cbiAgZGV2UGljczoge1xuICAgIFwiVVBTXCI6ICcvYXNzZXJ0L3Vwcy5wbmcnLFxuICAgIFwi5rip5rm/5bqmXCI6ICcvYXNzZXJ0L3RoLnBuZycsXG4gICAgXCLnlLXph4/ku6pcIjogJy9hc3NlcnQvZW0ucG5nJyxcbiAgICBcIuepuuiwg1wiOiAnL2Fzc2VydC9haXIucG5nJ1xuICB9IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz4sXG4gIG9uTG9hZChxdWVyeTogYW55KSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgd3gubG9naW4oe1xuICAgICAgc3VjY2VzczogYXN5bmMgbG9naW4gPT4ge1xuICAgICAgICAvLyDlj5HpgIHnvZHnu5zor7fmsYLvvIzojrflj5blnKjnur/otKbmiLdcbiAgICAgICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkubG9naW4oeyBqc19jb2RlOiBsb2dpbi5jb2RlLCBzY2VuZTogcXVlcnkuc2NlbmUgPyBkZWNvZGVVUklDb21wb25lbnQocXVlcnkuc2NlbmUpIDogJycgfSlcbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgYXBpLnVzZXJJbmZvKClcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG5cbiAgICAgICAgICAvLyDliKTmlq11c2Vy55So5oi357uELOWmguaenOaYr2FkbWlu5YiZ6Lez6L2s5Yiw5LiT5pyJ6aG16Z2iXG4gICAgICAgICAgc3dpdGNoICh1c2VyLmRhdGEudXNlckdyb3VwKSB7XG4gICAgICAgICAgICBjYXNlIFwiYWRtaW5cIjpcbiAgICAgICAgICAgIGNhc2UgXCJyb290XCI6XG4gICAgICAgICAgICAgIHd4LnJlTGF1bmNoKHsgdXJsOiBcIi9wYWdlcy9hZG1pbi9pbmRleFwiIH0pXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLnNldERhdGEoeyByZWFkeTogdHJ1ZSwgc3ViOiBCb29sZWFuKHVzZXIuZGF0YS53eElkKSB9KVxuICAgICAgICAgICAgICB0aGlzLnN0YXJ0KClcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICAgIHd4LnJlTGF1bmNoKHsgdXJsOiBcIi9wYWdlcy9sb2dpbi9sb2dpbj9vcGVuaWQ9XCIgKyAoZGF0YSBhcyBhbnkpLm9wZW5pZCArIFwiJnVuaW9uaWQ9XCIgKyAoZGF0YSBhcyBhbnkpLnVuaW9uaWQgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgLy8g55m75b2V6L+Q6KGMXG4gIHN0YXJ0KCkge1xuICAgIHRoaXMuYmluZERldigpXG5cbiAgfSxcblxuICAvKipcbiAgICog6K6i6ZiF5LiL5qyh5ZGK6K2mXG4gICAqL1xuICBhc3luYyBzdWJNZXNzYWdlKCkge1xuICAgIGNvbnN0IHVybCA9IGVuY29kZVVSSUNvbXBvbmVudCgnaHR0cDovL21wLndlaXhpbi5xcS5jb20vcz9fX2Jpej1Nak01TWpBMU1UZ3hPUT09Jm1pZD0zMDQ4MTk5MzkmaWR4PTEmc249ZDBiY2Q5MjIwMzMwNzVhZmEyYjUyMTlmYzk1ZWJiMWUmY2hrc209MzE3M2E5ZTcwNjA0MjBmMWE5OGQwMDQwZDk2NGEyZjgyYWYyNTI4OWE3MzFkMTQwMGM1MjI0Y2E5YmIzZDIyNWQ3Mzc3MDA3MDBhOCNyZCcpXG4gICAgd3gubmF2aWdhdGVUbyh7IHVybDogJy9wYWdlcy9pbmRleC93ZWIvd2ViP3VybD0nICsgdXJsIH0pXG4gIH0sXG5cbiAgLy8g6I635Y+W55So5oi357uR5a6a6K6+5aSHXG4gIGFzeW5jIGJpbmREZXYoKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+iOt+WPlkRUVScgfSlcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5CaW5kRGV2KClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gICAgaWYgKGNvZGUpIHtcblxuICAgICAgaWYgKGRhdGEuVVRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIERUVXM6IFtdLFxuICAgICAgICAgIGR0dUl0ZW06IFtdXG4gICAgICAgIH0pXG4gICAgICAgIGlmICghdGhpcy5kYXRhLmNvbmZpcm0pIHtcbiAgICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgICAgdGl0bGU6ICfmt7vliqDorr7lpIcnLFxuICAgICAgICAgICAgY29udGVudDogJ+aCqOi/mOayoeacieS7u+S9leiuvuWkh++8jOaYr+WQpua3u+WKoOiuvuWkhz8nLFxuICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzLmNvbmZpcm0pIHtcbiAgICAgICAgICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICAgICAgICAgIHVybDogJy9wYWdlcy9pbmRleC9iaW5kRGV2L2JpbmREZXYnXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgICAgY29uZmlybTogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLy90aGlzLmFkZFZtKClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc29ydERldnMoZGF0YS5VVHMpXG4gICAgICAgIC8vIOiOt+WPluacquivu+WPlueahGFsYXJt5pWw6YePXG4gICAgICAgIGFwaS5nZXRBbGFybXVuY29uZmlybWVkKCkudGhlbigoeyBkYXRhOiBsZW4gfSkgPT4ge1xuICAgICAgICAgIGlmIChOdW1iZXIobGVuKSA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgIGFsYXJtOiBg5pyJJHtsZW595p2h5pyq56Gu6K6k55qE5ZGK6K2m5L+h5oGv77yM54K55Ye75p+l55yLP2AsXG4gICAgICAgICAgICAgIGFsYXJtTnVtOiBOdW1iZXIobGVuKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgYWxhcm06IGBgLFxuICAgICAgICAgICAgICBhbGFybU51bTogTnVtYmVyKGxlbiksXG4gICAgICAgICAgICAgIGFsYXJtRGF0YTogW11cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvLyDlpITnkIborr7lpIfliIbnsbtcbiAgc29ydERldnMoVVRzOiBVYXJ0LlRlcm1pbmFsW10pIHtcbiAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgIGtleTogJ1V0cycsXG4gICAgICBkYXRhOiBVVHNcbiAgICB9KVxuICAgIHRoaXMuY291bnREZXYoVVRzKVxuICAgIGNvbnN0IGRldnMgPSBVVHMubWFwKGR0dSA9PiB7XG4gICAgICByZXR1cm4gZHR1Lm1vdW50RGV2cy5tYXAoZGV2ID0+ICh7IC4uLmRldiwgcGljOiB0aGlzLmRldlBpY3NbZGV2LlR5cGVdLCBkdHU6IGR0dS5uYW1lLCBvbmxpbmU6IGRldi5vbmxpbmUgJiYgZHR1Lm9ubGluZSB9KSlcbiAgICB9KS5mbGF0KClcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgRFRVczogVVRzLFxuICAgICAgZHR1SXRlbTogZGV2c1xuICAgIH0pXG4gIH0sXG5cbiAgLy8g5p+l55yL5oyC6L29XG4gIHRvRGV2KGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UZXJtaW5hbD4pIHtcbiAgICBjb25zdCB7IERldk1hYyB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9kdHUvZHR1JyArIE9iamVjdFRvU3RycXVlcnkoeyBtYWM6IERldk1hYyB9KVxuICAgIH0pXG4gIH0sXG5cbiAgLy8g5p+l55yL6K6+5aSH5pWw5o2uXG4gIHNob3dNb3VudERldkRhdGEoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LlRlcm1pbmFsTW91bnREZXZzICYgeyBkdHU6IHN0cmluZyB9Pikge1xuICAgIGNvbnN0IHsgcGlkLCBtb3VudERldiwgcHJvdG9jb2wsIGR0dSwgVHlwZSB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCB7IERldk1hYyB9ID0gdGhpcy5kYXRhLkRUVXMuZmluZChlbCA9PiBlbC5uYW1lID09PSBkdHUpIVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2RldnMvZGV2cycgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgcGlkOiBTdHJpbmcocGlkKSwgbW91bnREZXYsIHByb3RvY29sLCBEZXZNYWMsIFR5cGUgfSlcbiAgICB9KVxuICB9LFxuICAvLyDmn6XnnIvlkYroraZcbiAgc2VlQWxhcm0oKSB7XG4gICAgd3guc3dpdGNoVGFiKHsgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtL2FsYXJtP251bT0nICsgdGhpcy5kYXRhLmFsYXJtTnVtIH0pXG4gIH0sXG4gIC8vIOe7n+iuoeaJgOacieiuvuWkh+eKtuaAgVxuICBjb3VudERldih0ZXJtaW5hbHM6IFVhcnQuVGVybWluYWxbXSkge1xuXG4gICAgY29uc3QgdGVybWluYWxfYWxsID0gdGVybWluYWxzLmxlbmd0aFxuICAgIGNvbnN0IHRlcm1pbmFsX29uID0gdGVybWluYWxzLm1hcChlbCA9PiBlbC5vbmxpbmUpLmZpbHRlcihlbCA9PiBlbCkubGVuZ3RoXG4gICAgY29uc3QgbW9udXREZXZfYWxsID0gdGVybWluYWxzLm1hcChlbCA9PiBlbC5tb3VudERldnMubGVuZ3RoKS5yZWR1Y2UoKHByZSwgY3VyKSA9PiBwcmUgKyBjdXIpXG4gICAgY29uc3QgbW91bnREZXZfb24gPSB0ZXJtaW5hbHMubWFwKGVsID0+IGVsLm1vdW50RGV2cy5maWx0ZXIoZWwyID0+IGVsMi5vbmxpbmUpKS5yZWR1Y2UoKHByZSwgY3VyKSA9PiBbLi4ucHJlLCAuLi5jdXJdKS5sZW5ndGhcbiAgICAvLyBjb25zb2xlLmxvZyh7IHRlcm1pbmFsX2FsbCwgdGVybWluYWxfb24sIG1vbnV0RGV2X2FsbCwgbW91bnREZXZfb24gfSk7XG4gICAgY29uc3Qgc3RhdGUgPSBgRFRVOijlhajpg6gke3Rlcm1pbmFsX2FsbH0v5Zyo57q/JHt0ZXJtaW5hbF9vbn0pLOaMgui9veiuvuWkhzoo5YWo6YOoJHttb251dERldl9hbGx9L+WcqOe6vyR7bW91bnREZXZfb259KWBcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgc3RhdGVcbiAgICB9KVxuICB9LFxuICAvL21hYz05OEQ4NjNDQzg3MEQmcGlkPTAmbW91bnREZXY9RzJLXG4gIGFzeW5jIG9uUHVsbERvd25SZWZyZXNoKCkge1xuICAgIGF3YWl0IHRoaXMuYmluZERldigpXG4gICAgdGhpcy5jb3VudERldih0aGlzLmRhdGEuRFRVcylcbiAgICB0aGlzLnN0YXJ0KClcbiAgICB3eC5zdG9wUHVsbERvd25SZWZyZXNoKClcbiAgfSxcbiAgLy9cbiAgYmluZGxvYWQoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIGNvbnNvbGUubG9nKGDlhazkvJflj7fliqDovb1zdWNjZXNzLOeKtuaAgToke2V2ZW50LmRldGFpbC5lcnJNc2d9YCk7XG4gIH0sXG4gIGJpbmRlcnJvcihldmVudDogdmFudEV2ZW50KSB7XG4gICAgY29uc29sZS5sb2coYOWFrOS8l+WPt+WKoOi9vWVycm9yLOeKtuaAgToke2V2ZW50LmRldGFpbC5lcnJNc2d9YCk7XG4gIH0sXG5cbiAgLy8g5re75Yqg6Jma5ouf6K6+5aSHXG4gIGFzeW5jIGFkZFZtKCkge1xuICAgIGNvbnN0IHsgb2ssIGFyZyB9ID0gYXdhaXQgYXBpLmFkZFZtKClcbiAgICBpZiAob2spIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFZtOiBhcmdcbiAgICAgIH0pXG4gICAgICB0aGlzLnNvcnREZXZzKGFyZylcbiAgICB9XG4gIH0sXG4gIG9uU2hvdygpIHtcbiAgICBpZiAodGhpcy5kYXRhLnJlYWR5KSB7XG4gICAgICB0aGlzLmJpbmREZXYoKVxuICAgIH1cbiAgfVxufSlcbiJdfQ==