"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../utils/util");
const api_1 = require("../../utils/api");
Page({
    data: {
        ready: false,
        DTUs: [],
        dtuItem: [],
        state: '',
        alarm: '',
        alarmNum: 0,
        alarmData: [],
        Vm: [],
        confirm: false,
        sub: false
    },
    devPics: {
        "UPS": '/assert/ups.png',
        "温湿度": '/assert/th.png',
        "电量仪": '/assert/em.png',
        "空调": '/assert/air.png'
    },
    onLoad(query) {
        wx.showLoading({ title: 'loading' });
        wx.login({
            success: async (login) => {
                const { code, data } = await api_1.default.login({ js_code: login.code, scene: query.scene ? decodeURIComponent(query.scene) : '' });
                if (code) {
                    const user = await api_1.default.userInfo();
                    wx.hideLoading();
                    switch (user.data.userGroup) {
                        case "admin":
                        case "root":
                            wx.reLaunch({ url: "/pages/admin/index" });
                            break;
                        default:
                            this.setData({ ready: true, sub: Boolean(user.data.wxId) });
                            this.start();
                            break;
                    }
                }
                else {
                    wx.hideLoading();
                    wx.reLaunch({ url: "/pages/login/login?openid=" + data.openid + "&unionid=" + data.unionid });
                }
            }
        });
    },
    start() {
        this.bindDev();
        api_1.default.onMessage('MacUpdate', (mac) => {
            console.log(`listen MacUpdate,mac:${mac}`);
            this.bindDev();
        });
    },
    async subMessage() {
        const url = encodeURIComponent('http://mp.weixin.qq.com/s?__biz=MjM5MjA1MTgxOQ==&mid=304819939&idx=1&sn=d0bcd922033075afa2b5219fc95ebb1e&chksm=3173a9e7060420f1a98d0040d964a2f82af25289a731d1400c5224ca9bb3d225d737700700a8#rd');
        wx.navigateTo({ url: '/pages/index/web/web?url=' + url });
    },
    async bindDev() {
        wx.showLoading({ title: '获取DTU' });
        const { code, data } = await api_1.default.BindDev();
        wx.hideLoading();
        wx.stopPullDownRefresh();
        if (code) {
            if (data.UTs.length === 0) {
                this.setData({
                    DTUs: [],
                    dtuItem: []
                });
                if (!this.data.confirm) {
                    wx.showModal({
                        title: '添加设备',
                        content: '您还没有任何设备，是否添加设备?',
                        success: (res) => {
                            if (res.confirm) {
                                wx.navigateTo({
                                    url: '/pages/index/bindDev/bindDev'
                                });
                            }
                            else {
                                this.setData({
                                    confirm: true
                                });
                            }
                        }
                    });
                }
            }
            else {
                this.sortDevs(data.UTs);
                api_1.default.getAlarmunconfirmed().then(({ data: len }) => {
                    if (Number(len) > 0) {
                        this.setData({
                            alarm: `有${len}条未确认的告警信息，点击查看?`,
                            alarmNum: Number(len)
                        });
                    }
                    else {
                        this.setData({
                            alarm: ``,
                            alarmNum: Number(len),
                            alarmData: []
                        });
                    }
                });
            }
        }
    },
    sortDevs(UTs) {
        wx.setStorage({
            key: 'Uts',
            data: UTs
        });
        this.countDev(UTs);
        const devs = UTs.map(dtu => {
            return dtu.mountDevs.map(dev => ({ ...dev, pic: this.devPics[dev.Type], dtu: dtu.name, online: dev.online && dtu.online }));
        }).flat();
        this.setData({
            DTUs: UTs,
            dtuItem: devs
        });
    },
    toDev(event) {
        const { DevMac } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/index/dtu/dtu' + (0, util_1.ObjectToStrquery)({ mac: DevMac })
        });
    },
    showMountDevData(event) {
        const { pid, mountDev, protocol, dtu, Type } = event.currentTarget.dataset.item;
        const { DevMac } = this.data.DTUs.find(el => el.name === dtu);
        wx.navigateTo({
            url: '/pages/index/devs/devs' + (0, util_1.ObjectToStrquery)({ pid: String(pid), mountDev, protocol, DevMac, Type })
        });
    },
    seeAlarm() {
        wx.switchTab({ url: '/pages/index/alarm/alarm?num=' + this.data.alarmNum });
    },
    countDev(terminals) {
        const terminal_all = terminals.length;
        const terminal_on = terminals.map(el => el.online).filter(el => el).length;
        const monutDev_all = terminals.map(el => el.mountDevs.length).reduce((pre, cur) => pre + cur);
        const mountDev_on = terminals.map(el => el.mountDevs.filter(el2 => el2.online)).reduce((pre, cur) => [...pre, ...cur]).length;
        const state = `DTU:(全部${terminal_all}/在线${terminal_on}),挂载设备:(全部${monutDev_all}/在线${mountDev_on})`;
        this.setData({
            state
        });
    },
    async onPullDownRefresh() {
        await this.bindDev();
        this.countDev(this.data.DTUs);
        this.start();
        wx.stopPullDownRefresh();
    },
    bindload(event) {
        console.log(`公众号加载success,状态:${event.detail.errMsg}`);
    },
    binderror(event) {
        console.log(`公众号加载error,状态:${event.detail.errMsg}`);
    },
    async addVm() {
        const { ok, arg } = await api_1.default.addVm();
        if (ok) {
            this.setData({
                Vm: arg
            });
            this.sortDevs(arg);
        }
    },
    onShow() {
        if (this.data.ready) {
            this.bindDev();
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDJDQUFvRDtBQUNwRCx5Q0FBa0M7QUFFbEMsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLEtBQUs7UUFFWixJQUFJLEVBQUUsRUFBcUI7UUFFM0IsT0FBTyxFQUFFLEVBQThCO1FBRXZDLEtBQUssRUFBRSxFQUFFO1FBRVQsS0FBSyxFQUFFLEVBQUU7UUFFVCxRQUFRLEVBQUUsQ0FBQztRQUVYLFNBQVMsRUFBRSxFQUE0QjtRQUV2QyxFQUFFLEVBQUUsRUFBcUI7UUFDekIsT0FBTyxFQUFFLEtBQUs7UUFFZCxHQUFHLEVBQUUsS0FBSztLQUNYO0lBRUQsT0FBTyxFQUFFO1FBQ1AsS0FBSyxFQUFFLGlCQUFpQjtRQUN4QixLQUFLLEVBQUUsZ0JBQWdCO1FBQ3ZCLEtBQUssRUFBRSxnQkFBZ0I7UUFDdkIsSUFBSSxFQUFFLGlCQUFpQjtLQUNFO0lBQzNCLE1BQU0sQ0FBQyxLQUFVO1FBQ2YsRUFBRSxDQUFDLFdBQVcsQ0FBQyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFBO1FBQ3BDLEVBQUUsQ0FBQyxLQUFLLENBQUM7WUFDUCxPQUFPLEVBQUUsS0FBSyxFQUFDLEtBQUssRUFBQyxFQUFFO2dCQUVyQixNQUFNLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxHQUFHLE1BQU0sYUFBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUE7Z0JBQzFILElBQUksSUFBSSxFQUFFO29CQUNSLE1BQU0sSUFBSSxHQUFHLE1BQU0sYUFBRyxDQUFDLFFBQVEsRUFBRSxD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QUMsQ0FBQztJQUN4RCxDQUFDO0lBQ0QsU0FBUyxDQUFDLEtBQWdCO1FBQ3hCLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBR0QsS0FBSyxDQUFDLEtBQUs7UUFDVCxNQUFNLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLE1BQU0sYUFBRyxDQUFDLEtBQUssRUFBRSxDQUFBO1FBQ3JDLElBQUksRUFBRSxFQUFFO1lBQ04sSUFBSSxDQUFDLE9BQU8sQ0FBQztnQkFDWCxFQUFFLEVBQUUsR0FBRzthQUNSLENBQUMsQ0FBQTtZQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUE7U0FDbkI7SUFDSCxDQUFDO0lBQ0QsTUFBTTtRQUNKLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDbkIsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO1NBQ2Y7SUFDSCxDQUFDO0NBQ0YsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gaW5kZXgudHNcbmltcG9ydCB7IE9iamVjdFRvU3RycXVlcnkgfSBmcm9tIFwiLi4vLi4vdXRpbHMvdXRpbFwiO1xuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vdXRpbHMvYXBpXCI7XG4vLyDojrflj5blupTnlKjlrp7kvotcblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgcmVhZHk6IGZhbHNlLFxuICAgIC8qKiBEVFXorr7lpIfkv6Hmga8gKi9cbiAgICBEVFVzOiBbXSBhcyBVYXJ0LlRlcm1pbmFsW10sXG4gICAgLy8g5Yi36YCJ5oyC6L296K6+5aSH5YiX6KGoXG4gICAgZHR1SXRlbTogW10gYXMgVWFydC5UZXJtaW5hbE1vdW50RGV2c1tdLFxuICAgIC8vIOaMgui9veeKtuaAgeS/oeaBr1xuICAgIHN0YXRlOiAnJyxcbiAgICAvLyDlkYrorabnirbmgIHkv6Hmga9cbiAgICBhbGFybTogJycsXG4gICAgLy8g5pyq56Gu6K6k5ZGK6K2m5pWw6YePXG4gICAgYWxhcm1OdW06IDAsXG4gICAgLy8g5LqU5p2h5YaF5ZGK6K2m5pWw5o2uXG4gICAgYWxhcm1EYXRhOiBbXSBhcyBVYXJ0LnVhcnRBbGFybU9iamVjdFtdLFxuICAgIC8vIOiZmuaLn+iuvuWkh1xuICAgIFZtOiBbXSBhcyBVYXJ0LlRlcm1pbmFsW10sXG4gICAgY29uZmlybTogZmFsc2UsXG4gICAgLy8g5piv5ZCm6K6i6ZiFXG4gICAgc3ViOiBmYWxzZVxuICB9LFxuXG4gIGRldlBpY3M6IHtcbiAgICBcIlVQU1wiOiAnL2Fzc2VydC91cHMucG5nJyxcbiAgICBcIua4qea5v+W6plwiOiAnL2Fzc2VydC90aC5wbmcnLFxuICAgIFwi55S16YeP5LuqXCI6ICcvYXNzZXJ0L2VtLnBuZycsXG4gICAgXCLnqbrosINcIjogJy9hc3NlcnQvYWlyLnBuZydcbiAgfSBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+LFxuICBvbkxvYWQocXVlcnk6IGFueSkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICdsb2FkaW5nJyB9KVxuICAgIHd4LmxvZ2luKHtcbiAgICAgIHN1Y2Nlc3M6IGFzeW5jIGxvZ2luID0+IHtcbiAgICAgICAgLy8g5Y+R6YCB572R57uc6K+35rGC77yM6I635Y+W5Zyo57q/6LSm5oi3XG4gICAgICAgIGNvbnN0IHsgY29kZSwgZGF0YSB9ID0gYXdhaXQgYXBpLmxvZ2luKHsganNfY29kZTogbG9naW4uY29kZSwgc2NlbmU6IHF1ZXJ5LnNjZW5lID8gZGVjb2RlVVJJQ29tcG9uZW50KHF1ZXJ5LnNjZW5lKSA6ICcnIH0pXG4gICAgICAgIGlmIChjb2RlKSB7XG4gICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IGFwaS51c2VySW5mbygpXG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuXG4gICAgICAgICAgLy8g5Yik5patdXNlcueUqOaIt+e7hCzlpoLmnpzmmK9hZG1pbuWImei3s+i9rOWIsOS4k+aciemhtemdolxuICAgICAgICAgIHN3aXRjaCAodXNlci5kYXRhLnVzZXJHcm91cCkge1xuICAgICAgICAgICAgY2FzZSBcImFkbWluXCI6XG4gICAgICAgICAgICBjYXNlIFwicm9vdFwiOlxuICAgICAgICAgICAgICB3eC5yZUxhdW5jaCh7IHVybDogXCIvcGFnZXMvYWRtaW4vaW5kZXhcIiB9KVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHsgcmVhZHk6IHRydWUsIHN1YjogQm9vbGVhbih1c2VyLmRhdGEud3hJZCkgfSlcbiAgICAgICAgICAgICAgdGhpcy5zdGFydCgpXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgICB3eC5yZUxhdW5jaCh7IHVybDogXCIvcGFnZXMvbG9naW4vbG9naW4/b3BlbmlkPVwiICsgKGRhdGEgYXMgYW55KS5vcGVuaWQgKyBcIiZ1bmlvbmlkPVwiICsgKGRhdGEgYXMgYW55KS51bmlvbmlkIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KVxuICB9LFxuXG4gIC8vIOeZu+W9lei/kOihjFxuICBzdGFydCgpIHtcbiAgICB0aGlzLmJpbmREZXYoKVxuICAgIGFwaS5vbk1lc3NhZ2U8c3RyaW5nPignTWFjVXBkYXRlJywobWFjKT0+e1xuICAgICAgY29uc29sZS5sb2coYGxpc3RlbiBNYWNVcGRhdGUsbWFjOiR7bWFjfWApO1xuICAgICAgdGhpcy5iaW5kRGV2KClcbiAgICB9KVxuICB9LFxuXG4gIC8qKlxuICAgKiDorqLpmIXkuIvmrKHlkYroraZcbiAgICovXG4gIGFzeW5jIHN1Yk1lc3NhZ2UoKSB7XG4gICAgY29uc3QgdXJsID0gZW5jb2RlVVJJQ29tcG9uZW50KCdodHRwOi8vbXAud2VpeGluLnFxLmNvbS9zP19fYml6PU1qTTVNakExTVRneE9RPT0mbWlkPTMwNDgxOTkzOSZpZHg9MSZzbj1kMGJjZDkyMjAzMzA3NWFmYTJiNTIxOWZjOTVlYmIxZSZjaGtzbT0zMTczYTllNzA2MDQyMGYxYTk4ZDAwNDBkOTY0YTJmODJhZjI1Mjg5YTczMWQxNDAwYzUyMjRjYTliYjNkMjI1ZDczNzcwMDcwMGE4I3JkJylcbiAgICB3eC5uYXZpZ2F0ZVRvKHsgdXJsOiAnL3BhZ2VzL2luZGV4L3dlYi93ZWI/dXJsPScgKyB1cmwgfSlcbiAgfSxcblxuICAvLyDojrflj5bnlKjmiLfnu5Hlrprorr7lpIdcbiAgYXN5bmMgYmluZERldigpIHtcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn6I635Y+WRFRVJyB9KVxuICAgIGNvbnN0IHsgY29kZSwgZGF0YSB9ID0gYXdhaXQgYXBpLkJpbmREZXYoKVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICB3eC5zdG9wUHVsbERvd25SZWZyZXNoKClcbiAgICBpZiAoY29kZSkge1xuXG4gICAgICBpZiAoZGF0YS5VVHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgRFRVczogW10sXG4gICAgICAgICAgZHR1SXRlbTogW11cbiAgICAgICAgfSlcbiAgICAgICAgaWYgKCF0aGlzLmRhdGEuY29uZmlybSkge1xuICAgICAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgICAgICB0aXRsZTogJ+a3u+WKoOiuvuWkhycsXG4gICAgICAgICAgICBjb250ZW50OiAn5oKo6L+Y5rKh5pyJ5Lu75L2V6K6+5aSH77yM5piv5ZCm5re75Yqg6K6+5aSHPycsXG4gICAgICAgICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgICAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICAgICAgICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2JpbmREZXYvYmluZERldidcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgICBjb25maXJtOiB0cnVlXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAvL3RoaXMuYWRkVm0oKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5zb3J0RGV2cyhkYXRhLlVUcylcbiAgICAgICAgLy8g6I635Y+W5pyq6K+75Y+W55qEYWxhcm3mlbDph49cbiAgICAgICAgYXBpLmdldEFsYXJtdW5jb25maXJtZWQoKS50aGVuKCh7IGRhdGE6IGxlbiB9KSA9PiB7XG4gICAgICAgICAgaWYgKE51bWJlcihsZW4pID4gMCkge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgYWxhcm06IGDmnIkke2xlbn3mnaHmnKrnoa7orqTnmoTlkYrorabkv6Hmga/vvIzngrnlh7vmn6XnnIs/YCxcbiAgICAgICAgICAgICAgYWxhcm1OdW06IE51bWJlcihsZW4pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICBhbGFybTogYGAsXG4gICAgICAgICAgICAgIGFsYXJtTnVtOiBOdW1iZXIobGVuKSxcbiAgICAgICAgICAgICAgYWxhcm1EYXRhOiBbXVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfVxuICB9LFxuXG4gIC8vIOWkhOeQhuiuvuWkh+WIhuexu1xuICBzb3J0RGV2cyhVVHM6IFVhcnQuVGVybWluYWxbXSkge1xuICAgIHd4LnNldFN0b3JhZ2Uoe1xuICAgICAga2V5OiAnVXRzJyxcbiAgICAgIGRhdGE6IFVUc1xuICAgIH0pXG4gICAgdGhpcy5jb3VudERldihVVHMpXG4gICAgY29uc3QgZGV2cyA9IFVUcy5tYXAoZHR1ID0+IHtcbiAgICAgIHJldHVybiBkdHUubW91bnREZXZzLm1hcChkZXYgPT4gKHsgLi4uZGV2LCBwaWM6IHRoaXMuZGV2UGljc1tkZXYuVHlwZV0sIGR0dTogZHR1Lm5hbWUsIG9ubGluZTogZGV2Lm9ubGluZSAmJiBkdHUub25saW5lIH0pKVxuICAgIH0pLmZsYXQoKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBEVFVzOiBVVHMsXG4gICAgICBkdHVJdGVtOiBkZXZzXG4gICAgfSlcbiAgfSxcblxuICAvLyDmn6XnnIvmjILovb1cbiAgdG9EZXYoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LlRlcm1pbmFsPikge1xuICAgIGNvbnN0IHsgRGV2TWFjIH0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2R0dS9kdHUnICsgT2JqZWN0VG9TdHJxdWVyeSh7IG1hYzogRGV2TWFjIH0pXG4gICAgfSlcbiAgfSxcblxuICAvLyDmn6XnnIvorr7lpIfmlbDmja5cbiAgc2hvd01vdW50RGV2RGF0YShldmVudDogdmFudEV2ZW50PFVhcnQuVGVybWluYWxNb3VudERldnMgJiB7IGR0dTogc3RyaW5nIH0+KSB7XG4gICAgY29uc3QgeyBwaWQsIG1vdW50RGV2LCBwcm90b2NvbCwgZHR1LCBUeXBlIH0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHsgRGV2TWFjIH0gPSB0aGlzLmRhdGEuRFRVcy5maW5kKGVsID0+IGVsLm5hbWUgPT09IGR0dSkhXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvZGV2cy9kZXZzJyArIE9iamVjdFRvU3RycXVlcnkoeyBwaWQ6IFN0cmluZyhwaWQpLCBtb3VudERldiwgcHJvdG9jb2wsIERldk1hYywgVHlwZSB9KVxuICAgIH0pXG4gIH0sXG4gIC8vIOafpeeci+WRiuitplxuICBzZWVBbGFybSgpIHtcbiAgICB3eC5zd2l0Y2hUYWIoeyB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm0vYWxhcm0/bnVtPScgKyB0aGlzLmRhdGEuYWxhcm1OdW0gfSlcbiAgfSxcbiAgLy8g57uf6K6h5omA5pyJ6K6+5aSH54q25oCBXG4gIGNvdW50RGV2KHRlcm1pbmFsczogVWFydC5UZXJtaW5hbFtdKSB7XG5cbiAgICBjb25zdCB0ZXJtaW5hbF9hbGwgPSB0ZXJtaW5hbHMubGVuZ3RoXG4gICAgY29uc3QgdGVybWluYWxfb24gPSB0ZXJtaW5hbHMubWFwKGVsID0+IGVsLm9ubGluZSkuZmlsdGVyKGVsID0+IGVsKS5sZW5ndGhcbiAgICBjb25zdCBtb251dERldl9hbGwgPSB0ZXJtaW5hbHMubWFwKGVsID0+IGVsLm1vdW50RGV2cy5sZW5ndGgpLnJlZHVjZSgocHJlLCBjdXIpID0+IHByZSArIGN1cilcbiAgICBjb25zdCBtb3VudERldl9vbiA9IHRlcm1pbmFscy5tYXAoZWwgPT4gZWwubW91bnREZXZzLmZpbHRlcihlbDIgPT4gZWwyLm9ubGluZSkpLnJlZHVjZSgocHJlLCBjdXIpID0+IFsuLi5wcmUsIC4uLmN1cl0pLmxlbmd0aFxuICAgIC8vIGNvbnNvbGUubG9nKHsgdGVybWluYWxfYWxsLCB0ZXJtaW5hbF9vbiwgbW9udXREZXZfYWxsLCBtb3VudERldl9vbiB9KTtcbiAgICBjb25zdCBzdGF0ZSA9IGBEVFU6KOWFqOmDqCR7dGVybWluYWxfYWxsfS/lnKjnur8ke3Rlcm1pbmFsX29ufSks5oyC6L296K6+5aSHOijlhajpg6gke21vbnV0RGV2X2FsbH0v5Zyo57q/JHttb3VudERldl9vbn0pYFxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBzdGF0ZVxuICAgIH0pXG4gIH0sXG4gIC8vbWFjPTk4RDg2M0NDODcwRCZwaWQ9MCZtb3VudERldj1HMktcbiAgYXN5bmMgb25QdWxsRG93blJlZnJlc2goKSB7XG4gICAgYXdhaXQgdGhpcy5iaW5kRGV2KClcbiAgICB0aGlzLmNvdW50RGV2KHRoaXMuZGF0YS5EVFVzKVxuICAgIHRoaXMuc3RhcnQoKVxuICAgIHd4LnN0b3BQdWxsRG93blJlZnJlc2goKVxuICB9LFxuICAvL1xuICBiaW5kbG9hZChldmVudDogdmFudEV2ZW50KSB7XG4gICAgY29uc29sZS5sb2coYOWFrOS8l+WPt+WKoOi9vXN1Y2Nlc3Ms54q25oCBOiR7ZXZlbnQuZGV0YWlsLmVyck1zZ31gKTtcbiAgfSxcbiAgYmluZGVycm9yKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICBjb25zb2xlLmxvZyhg5YWs5LyX5Y+35Yqg6L29ZXJyb3Is54q25oCBOiR7ZXZlbnQuZGV0YWlsLmVyck1zZ31gKTtcbiAgfSxcblxuICAvLyDmt7vliqDomZrmi5/orr7lpIdcbiAgYXN5bmMgYWRkVm0oKSB7XG4gICAgY29uc3QgeyBvaywgYXJnIH0gPSBhd2FpdCBhcGkuYWRkVm0oKVxuICAgIGlmIChvaykge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgVm06IGFyZ1xuICAgICAgfSlcbiAgICAgIHRoaXMuc29ydERldnMoYXJnKVxuICAgIH1cbiAgfSxcbiAgb25TaG93KCkge1xuICAgIGlmICh0aGlzLmRhdGEucmVhZHkpIHtcbiAgICAgIHRoaXMuYmluZERldigpXG4gICAgfVxuICB9XG59KVxuIl19