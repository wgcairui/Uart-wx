"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../utils/util");
const api_1 = require("../../utils/api");
Page({
    data: {
        ready: false,
        DTUs: [],
        dtuItem: [],
        state: '',
        alarm: '',
        alarmNum: 0,
        alarmData: [],
        Vm: [],
        confirm: false
    },
    devPics: {
        "UPS": '/assert/ups.png',
        "温湿度": '/assert/th.png',
        "电量仪": '/assert/em.png',
        "空调": '/assert/air.png'
    },
    onLoad(query) {
        wx.showLoading({ title: 'loading' });
        wx.login({
            success: async (login) => {
                const { code, data } = await api_1.default.login({ js_code: login.code, scene: query.scene ? decodeURIComponent(query.scene) : '' });
                if (code) {
                    const user = await api_1.default.userInfo();
                    wx.hideLoading();
                    console.log(user);
                    switch (user.data.userGroup) {
                        case "admin":
                        case "root":
                            wx.reLaunch({ url: "/pages/admin/index" });
                            break;
                        default:
                            this.setData({ ready: true });
                            this.start();
                            break;
                    }
                }
                else {
                    wx.hideLoading();
                    wx.reLaunch({ url: "/pages/login/login?openid=" + data.openid + "&unionid=" + data.unionid });
                }
            }
        });
    },
    start() {
        this.bindDev();
    },
    async bindDev() {
        wx.showLoading({ title: '获取DTU' });
        const { code, data } = await api_1.default.BindDev();
        wx.hideLoading();
        wx.stopPullDownRefresh();
        if (code) {
            if (data.UTs.length === 0) {
                this.setData({
                    DTUs: [],
                    dtuItem: []
                });
                if (!this.data.confirm) {
                    wx.showModal({
                        title: '添加设备',
                        content: '您还没有任何设备，是否添加设备?',
                        success: (res) => {
                            if (res.confirm) {
                                wx.navigateTo({
                                    url: '/pages/index/bindDev/bindDev'
                                });
                            }
                            else {
                                this.setData({
                                    confirm: true
                                });
                            }
                        }
                    });
                }
            }
            else {
                this.sortDevs(data.UTs);
                api_1.default.getAlarmunconfirmed().then(({ data: len }) => {
                    if (Number(len) > 0) {
                        this.setData({
                            alarm: `有${len}条未确认的告警信息，点击查看?`,
                            alarmNum: Number(len)
                        });
                    }
                    else {
                        this.setData({
                            alarm: ``,
                            alarmNum: Number(len),
                            alarmData: []
                        });
                    }
                });
            }
        }
    },
    sortDevs(UTs) {
        wx.setStorage({
            key: 'Uts',
            data: UTs
        });
        this.countDev(UTs);
        const devs = UTs.map(dtu => {
            return dtu.mountDevs.map(dev => {
                dev.online = dev.online && dtu.online;
                dev.pic = this.devPics[dev.Type];
                dev.dtu = dtu.name;
                return dev;
            });
        }).flat();
        this.setData({
            DTUs: UTs,
            dtuItem: devs
        });
    },
    toDev(event) {
        const { DevMac } = event.currentTarget.dataset.item;
        wx.navigateTo({
            url: '/pages/index/dtu/dtu' + util_1.ObjectToStrquery({ mac: DevMac })
        });
    },
    showMountDevData(event) {
        const { pid, mountDev, protocol, dtu, Type } = event.currentTarget.dataset.item;
        const { DevMac } = this.data.DTUs.find(el => el.name === dtu);
        wx.navigateTo({
            url: '/pages/index/devs/devs' + util_1.ObjectToStrquery({ pid: String(pid), mountDev, protocol, DevMac, Type })
        });
    },
    seeAlarm() {
        wx.switchTab({ url: '/pages/index/alarm/alarm?num=' + this.data.alarmNum });
    },
    countDev(terminals) {
        const terminal_all = terminals.length;
        const terminal_on = terminals.map(el => el.online).filter(el => el).length;
        const monutDev_all = terminals.map(el => el.mountDevs.length).reduce((pre, cur) => pre + cur);
        const mountDev_on = terminals.map(el => el.mountDevs.filter(el2 => el2.online)).reduce((pre, cur) => [...pre, ...cur]).length;
        const state = `DTU:(全部${terminal_all}/在线${terminal_on}),挂载设备:(全部${monutDev_all}/在线${mountDev_on})`;
        this.setData({
            state
        });
    },
    async onPullDownRefresh() {
        await this.bindDev();
        this.countDev(this.data.DTUs);
        this.start();
        wx.stopPullDownRefresh();
    },
    bindload(event) {
        console.log(`公众号加载success,状态:${event.detail.errMsg}`);
    },
    binderror(event) {
        console.log(`公众号加载error,状态:${event.detail.errMsg}`);
    },
    async addVm() {
        const { ok, arg } = await api_1.default.addVm();
        if (ok) {
            this.setData({
                Vm: arg
            });
            this.sortDevs(arg);
        }
    },
    onShow() {
        if (this.data.ready) {
            this.bindDev();
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDJDQUErRDtBQUMvRCx5Q0FBa0M7QUFFbEMsSUFBSSxDQUFDO0lBQ0gsSUFBSSxFQUFFO1FBQ0osS0FBSyxFQUFFLEtBQUs7UUFFWixJQUFJLEVBQUUsRUFBcUI7UUFFM0IsT0FBTyxFQUFFLEVBQThCO1FBRXZDLEtBQUssRUFBRSxFQUFFO1FBRVQsS0FBSyxFQUFFLEVBQUU7UUFFVCxRQUFRLEVBQUUsQ0FBQztRQUVYLFNBQVMsRUFBRSxFQUE0QjtRQUV2QyxFQUFFLEVBQUUsRUFBcUI7UUFDekIsT0FBTyxFQUFFLEtBQUs7S0FDZjtJQUVELE9BQU8sRUFBRTtRQUNQLEtBQUssRUFBRSxpQkFBaUI7UUFDeEIsS0FBSyxFQUFFLGdCQUFnQjtRQUN2QixLQUFLLEVBQUUsZ0JBQWdCO1FBQ3ZCLElBQUksRUFBRSxpQkFBaUI7S0FDeEI7SUFDRCxNQUFNLENBQUMsS0FBVTtRQUNmLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQTtRQUNwQyxFQUFFLENBQUMsS0FBSyxDQUFDO1lBQ1AsT0FBTyxFQUFFLEtBQUssRUFBQyxLQUFLLEVBQUMsRUFBRTtnQkFFckIsTUFBTSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxNQUFNLGFBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO2dCQUMxSCxJQUFJLElBQUksRUFBRTtvQkFDUixNQUFNLElBQUksR0FBRyxNQUFNLGFBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQTtvQkFDakMsRUFBRSxDQUFD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QUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFBO1NBQ25CO0lBQ0gsQ0FBQztJQUNELE1BQU07UUFDSixJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ25CLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtTQUNmO0lBQ0gsQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIGluZGV4LnRzXG5pbXBvcnQgeyBPYmplY3RUb1N0cnF1ZXJ5LCBwYXJzZVRpbWUgfSBmcm9tIFwiLi4vLi4vdXRpbHMvdXRpbFwiO1xuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vdXRpbHMvYXBpXCI7XG4vLyDojrflj5blupTnlKjlrp7kvotcblBhZ2Uoe1xuICBkYXRhOiB7XG4gICAgcmVhZHk6IGZhbHNlLFxuICAgIC8qKiBEVFXorr7lpIfkv6Hmga8gKi9cbiAgICBEVFVzOiBbXSBhcyBVYXJ0LlRlcm1pbmFsW10sXG4gICAgLy8g5Yi36YCJ5oyC6L296K6+5aSH5YiX6KGoXG4gICAgZHR1SXRlbTogW10gYXMgVWFydC5UZXJtaW5hbE1vdW50RGV2c1tdLFxuICAgIC8vIOaMgui9veeKtuaAgeS/oeaBr1xuICAgIHN0YXRlOiAnJyxcbiAgICAvLyDlkYrorabnirbmgIHkv6Hmga9cbiAgICBhbGFybTogJycsXG4gICAgLy8g5pyq56Gu6K6k5ZGK6K2m5pWw6YePXG4gICAgYWxhcm1OdW06IDAsXG4gICAgLy8g5LqU5p2h5YaF5ZGK6K2m5pWw5o2uXG4gICAgYWxhcm1EYXRhOiBbXSBhcyBVYXJ0LnVhcnRBbGFybU9iamVjdFtdLFxuICAgIC8vIOiZmuaLn+iuvuWkh1xuICAgIFZtOiBbXSBhcyBVYXJ0LlRlcm1pbmFsW10sXG4gICAgY29uZmlybTogZmFsc2VcbiAgfSxcblxuICBkZXZQaWNzOiB7XG4gICAgXCJVUFNcIjogJy9hc3NlcnQvdXBzLnBuZycsXG4gICAgXCLmuKnmub/luqZcIjogJy9hc3NlcnQvdGgucG5nJyxcbiAgICBcIueUtemHj+S7qlwiOiAnL2Fzc2VydC9lbS5wbmcnLFxuICAgIFwi56m66LCDXCI6ICcvYXNzZXJ0L2Fpci5wbmcnXG4gIH0sXG4gIG9uTG9hZChxdWVyeTogYW55KSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ2xvYWRpbmcnIH0pXG4gICAgd3gubG9naW4oe1xuICAgICAgc3VjY2VzczogYXN5bmMgbG9naW4gPT4ge1xuICAgICAgICAvLyDlj5HpgIHnvZHnu5zor7fmsYLvvIzojrflj5blnKjnur/otKbmiLdcbiAgICAgICAgY29uc3QgeyBjb2RlLCBkYXRhIH0gPSBhd2FpdCBhcGkubG9naW4oeyBqc19jb2RlOiBsb2dpbi5jb2RlLCBzY2VuZTogcXVlcnkuc2NlbmUgPyBkZWNvZGVVUklDb21wb25lbnQocXVlcnkuc2NlbmUpIDogJycgfSlcbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgYXBpLnVzZXJJbmZvKClcbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgICAgY29uc29sZS5sb2codXNlcik7XG5cbiAgICAgICAgICAvLyDliKTmlq11c2Vy55So5oi357uELOWmguaenOaYr2FkbWlu5YiZ6Lez6L2s5Yiw5LiT5pyJ6aG16Z2iXG4gICAgICAgICAgc3dpdGNoICh1c2VyLmRhdGEudXNlckdyb3VwKSB7XG4gICAgICAgICAgICBjYXNlIFwiYWRtaW5cIjpcbiAgICAgICAgICAgIGNhc2UgXCJyb290XCI6XG4gICAgICAgICAgICAgIHd4LnJlTGF1bmNoKHsgdXJsOiBcIi9wYWdlcy9hZG1pbi9pbmRleFwiIH0pXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLnNldERhdGEoeyByZWFkeTogdHJ1ZSB9KVxuICAgICAgICAgICAgICB0aGlzLnN0YXJ0KClcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICAgIHd4LnJlTGF1bmNoKHsgdXJsOiBcIi9wYWdlcy9sb2dpbi9sb2dpbj9vcGVuaWQ9XCIgKyAoZGF0YSBhcyBhbnkpLm9wZW5pZCArIFwiJnVuaW9uaWQ9XCIgKyAoZGF0YSBhcyBhbnkpLnVuaW9uaWQgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgLy8g55m75b2V6L+Q6KGMXG4gIHN0YXJ0KCkge1xuICAgIHRoaXMuYmluZERldigpXG5cbiAgfSxcbiAgLy8g6I635Y+W55So5oi357uR5a6a6K6+5aSHXG4gIGFzeW5jIGJpbmREZXYoKSB7XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+iOt+WPlkRUVScgfSlcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEgfSA9IGF3YWl0IGFwaS5CaW5kRGV2KClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gICAgaWYgKGNvZGUpIHtcblxuICAgICAgaWYgKGRhdGEuVVRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgIERUVXM6IFtdLFxuICAgICAgICAgIGR0dUl0ZW06IFtdXG4gICAgICAgIH0pXG4gICAgICAgIGlmICghdGhpcy5kYXRhLmNvbmZpcm0pIHtcbiAgICAgICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICAgICAgdGl0bGU6ICfmt7vliqDorr7lpIcnLFxuICAgICAgICAgICAgY29udGVudDogJ+aCqOi/mOayoeacieS7u+S9leiuvuWkh++8jOaYr+WQpua3u+WKoOiuvuWkhz8nLFxuICAgICAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzLmNvbmZpcm0pIHtcbiAgICAgICAgICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICAgICAgICAgIHVybDogJy9wYWdlcy9pbmRleC9iaW5kRGV2L2JpbmREZXYnXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgICAgY29uZmlybTogdHJ1ZVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLy90aGlzLmFkZFZtKClcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc29ydERldnMoZGF0YS5VVHMpXG4gICAgICAgIC8vIOiOt+WPluacquivu+WPlueahGFsYXJt5pWw6YePXG4gICAgICAgIGFwaS5nZXRBbGFybXVuY29uZmlybWVkKCkudGhlbigoeyBkYXRhOiBsZW4gfSkgPT4ge1xuICAgICAgICAgIGlmIChOdW1iZXIobGVuKSA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgIGFsYXJtOiBg5pyJJHtsZW595p2h5pyq56Gu6K6k55qE5ZGK6K2m5L+h5oGv77yM54K55Ye75p+l55yLP2AsXG4gICAgICAgICAgICAgIGFsYXJtTnVtOiBOdW1iZXIobGVuKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgYWxhcm06IGBgLFxuICAgICAgICAgICAgICBhbGFybU51bTogTnVtYmVyKGxlbiksXG4gICAgICAgICAgICAgIGFsYXJtRGF0YTogW11cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICAvLyDlpITnkIborr7lpIfliIbnsbtcbiAgc29ydERldnMoVVRzOiBVYXJ0LlRlcm1pbmFsW10pIHtcbiAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgIGtleTogJ1V0cycsXG4gICAgICBkYXRhOiBVVHNcbiAgICB9KVxuICAgIHRoaXMuY291bnREZXYoVVRzKVxuICAgIGNvbnN0IGRldnMgPSBVVHMubWFwKGR0dSA9PiB7XG4gICAgICByZXR1cm4gZHR1Lm1vdW50RGV2cy5tYXAoZGV2ID0+IHtcbiAgICAgICAgZGV2Lm9ubGluZSA9IGRldi5vbmxpbmUgJiYgZHR1Lm9ubGluZVxuICAgICAgICBkZXYucGljID0gKHRoaXMuZGV2UGljcyBhcyBhbnkpW2Rldi5UeXBlXVxuICAgICAgICBkZXYuZHR1ID0gZHR1Lm5hbWVcbiAgICAgICAgcmV0dXJuIGRldlxuICAgICAgfSlcbiAgICB9KS5mbGF0KClcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgRFRVczogVVRzLFxuICAgICAgZHR1SXRlbTogZGV2c1xuICAgIH0pXG4gIH0sXG5cbiAgLy8g5p+l55yL5oyC6L29XG4gIHRvRGV2KGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UZXJtaW5hbD4pIHtcbiAgICBjb25zdCB7IERldk1hYyB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9kdHUvZHR1JyArIE9iamVjdFRvU3RycXVlcnkoeyBtYWM6IERldk1hYyB9KVxuICAgIH0pXG4gIH0sXG5cbiAgLy8g5p+l55yL6K6+5aSH5pWw5o2uXG4gIHNob3dNb3VudERldkRhdGEoZXZlbnQ6IHZhbnRFdmVudDxVYXJ0LlRlcm1pbmFsTW91bnREZXZzPikge1xuICAgIGNvbnN0IHsgcGlkLCBtb3VudERldiwgcHJvdG9jb2wsIGR0dSwgVHlwZSB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCB7IERldk1hYyB9ID0gdGhpcy5kYXRhLkRUVXMuZmluZChlbCA9PiBlbC5uYW1lID09PSBkdHUpIVxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2RldnMvZGV2cycgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgcGlkOiBTdHJpbmcocGlkKSwgbW91bnREZXYsIHByb3RvY29sLCBEZXZNYWMsIFR5cGUgfSlcbiAgICB9KVxuICB9LFxuICAvLyDmn6XnnIvlkYroraZcbiAgc2VlQWxhcm0oKSB7XG4gICAgd3guc3dpdGNoVGFiKHsgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtL2FsYXJtP251bT0nICsgdGhpcy5kYXRhLmFsYXJtTnVtIH0pXG4gIH0sXG4gIC8vIOe7n+iuoeaJgOacieiuvuWkh+eKtuaAgVxuICBjb3VudERldih0ZXJtaW5hbHM6IFVhcnQuVGVybWluYWxbXSkge1xuXG4gICAgY29uc3QgdGVybWluYWxfYWxsID0gdGVybWluYWxzLmxlbmd0aFxuICAgIGNvbnN0IHRlcm1pbmFsX29uID0gdGVybWluYWxzLm1hcChlbCA9PiBlbC5vbmxpbmUpLmZpbHRlcihlbCA9PiBlbCkubGVuZ3RoXG4gICAgY29uc3QgbW9udXREZXZfYWxsID0gdGVybWluYWxzLm1hcChlbCA9PiBlbC5tb3VudERldnMubGVuZ3RoKS5yZWR1Y2UoKHByZSwgY3VyKSA9PiBwcmUgKyBjdXIpXG4gICAgY29uc3QgbW91bnREZXZfb24gPSB0ZXJtaW5hbHMubWFwKGVsID0+IGVsLm1vdW50RGV2cy5maWx0ZXIoZWwyID0+IGVsMi5vbmxpbmUpKS5yZWR1Y2UoKHByZSwgY3VyKSA9PiBbLi4ucHJlLCAuLi5jdXJdKS5sZW5ndGhcbiAgICAvLyBjb25zb2xlLmxvZyh7IHRlcm1pbmFsX2FsbCwgdGVybWluYWxfb24sIG1vbnV0RGV2X2FsbCwgbW91bnREZXZfb24gfSk7XG4gICAgY29uc3Qgc3RhdGUgPSBgRFRVOijlhajpg6gke3Rlcm1pbmFsX2FsbH0v5Zyo57q/JHt0ZXJtaW5hbF9vbn0pLOaMgui9veiuvuWkhzoo5YWo6YOoJHttb251dERldl9hbGx9L+WcqOe6vyR7bW91bnREZXZfb259KWBcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgc3RhdGVcbiAgICB9KVxuICB9LFxuICAvL21hYz05OEQ4NjNDQzg3MEQmcGlkPTAmbW91bnREZXY9RzJLXG4gIGFzeW5jIG9uUHVsbERvd25SZWZyZXNoKCkge1xuICAgIGF3YWl0IHRoaXMuYmluZERldigpXG4gICAgdGhpcy5jb3VudERldih0aGlzLmRhdGEuRFRVcylcbiAgICB0aGlzLnN0YXJ0KClcbiAgICB3eC5zdG9wUHVsbERvd25SZWZyZXNoKClcbiAgfSxcbiAgLy9cbiAgYmluZGxvYWQoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIGNvbnNvbGUubG9nKGDlhazkvJflj7fliqDovb1zdWNjZXNzLOeKtuaAgToke2V2ZW50LmRldGFpbC5lcnJNc2d9YCk7XG4gIH0sXG4gIGJpbmRlcnJvcihldmVudDogdmFudEV2ZW50KSB7XG4gICAgY29uc29sZS5sb2coYOWFrOS8l+WPt+WKoOi9vWVycm9yLOeKtuaAgToke2V2ZW50LmRldGFpbC5lcnJNc2d9YCk7XG4gIH0sXG5cbiAgLy8g5re75Yqg6Jma5ouf6K6+5aSHXG4gIGFzeW5jIGFkZFZtKCkge1xuICAgIGNvbnN0IHsgb2ssIGFyZyB9ID0gYXdhaXQgYXBpLmFkZFZtKClcbiAgICBpZiAob2spIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFZtOiBhcmdcbiAgICAgIH0pXG4gICAgICB0aGlzLnNvcnREZXZzKGFyZylcbiAgICB9XG4gIH0sXG4gIG9uU2hvdygpIHtcbiAgICBpZiAodGhpcy5kYXRhLnJlYWR5KSB7XG4gICAgICB0aGlzLmJpbmREZXYoKVxuICAgIH1cbiAgfVxufSlcbiJdfQ==