"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        pid: '',
        mountDev: "",
        result: {},
        filter: '',
        protocol: '',
        Type: '',
        Constant: {},
        upsPic: 'http://www.ladishb.com/upload/342021__ups.gif',
        th: {
            temperature: '0',
            humidity: '0',
        },
        _oprateStat: false
    },
    onLoad: function (options) {
        wx.setNavigationBarTitle({ title: options.mountDev || options.mac || '' });
        this.setData({
            mac: options.DevMac,
            pid: options.pid,
            protocol: options.protocol,
            mountDev: options.mountDev,
            Type: options.Type
        });
        api_1.default.onMessage(options.DevMac + options.pid, () => {
            console.log('获取运行数据:' + options.DevMac + options.pid);
            this.GetDevsRunInfo();
        });
    },
    async onReady() {
        wx.showLoading({ title: '获取运行数据' });
        const sys = await api_1.default.getAlarmProtocol(this.data.protocol);
        const user = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        if (sys.code) {
            this.setData({
                "Constant.sys": sys.data
            });
        }
        if (user.code) {
            this.setData({
                "Constant.user": user.data,
                "Constant.show": new Set([sys.data || [], user.data])
            });
        }
        this.setData({
            "Constant.show": new Set([sys.data?.ShowTag || [], user.data?.ShowTag || []].flat())
        });
        await this.GetDevsRunInfo();
        wx.hideLoading();
    },
    onShow: function () {
    },
    onHide: function () {
        api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
    },
    onUnload: function () {
        api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
    },
    onPullDownRefresh: async function () {
        await this.GetDevsRunInfo();
        wx.stopPullDownRefresh();
    },
    async GetDevsRunInfo() {
        const { mac, pid, filter } = this.data;
        const { code, data, msg } = await api_1.default.getTerminalData(mac, pid);
        if (code && data.result) {
            const regStr = new RegExp(filter);
            data.result = data.result.filter(el => this.data.Constant.show.has(el.name) && (!filter || regStr.test(el.name)));
            data.time = (0, util_1.parseTime)(data.time);
            this.setData({
                result: data,
            });
            switch (this.data.Type) {
                case "UPS":
                    const workMode = data.result.find(el => el.name === this.data.Constant.sys.Constant.WorkMode)?.parseValue;
                    switch (workMode) {
                        case "电池模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups1.gif'
                            });
                            break;
                        case "旁路模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups2.gif'
                            });
                            break;
                        case "在线模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups3.gif'
                            });
                            break;
                        default:
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups.gif'
                            });
                            break;
                    }
                    break;
                case "温湿度":
                    const { Temperature, Humidity } = this.data.Constant.sys.Constant;
                    this.setData({
                        th: {
                            temperature: data.result.find(el => el.name === Temperature)?.parseValue,
                            humidity: data.result.find(el => el.name === Humidity)?.parseValue
                        }
                    });
                    break;
            }
        }
        else {
            api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
            wx.showModal({
                title: 'Error',
                content: msg,
                success: () => {
                    api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
                }
            });
        }
    },
    filter(e) {
        const filter = e.detail.filter;
        const regStr = new RegExp(filter);
        const result = this.data.result.result?.filter(el => regStr.test(el.name));
        this.setData({
            filter,
            "result.result": result
        });
    },
    toline(e) {
        const url = '/pages/index/line/line' + (0, util_1.ObjectToStrquery)({ name: e.detail.name, mac: this.data.mac, pid: this.data.pid, protocol: this.data.protocol });
        console.log(url);
        wx.navigateTo({
            url
        });
    },
    async oprate(e) {
        if (this.data._oprateStat)
            return;
        const item = e.detail;
        if (item.value.includes("%i") && !item.val && item.val !== 0) {
            wx.navigateTo({
                url: '/pages/util/setVal/setVal' + (0, util_1.ObjectToStrquery)({ item }),
                events: {
                    valueOk: (value) => {
                        item.val = value.val;
                        this.oprate({ detail: item });
                    }
                }
            });
            return;
        }
        wx.showLoading({ title: '正在发送' });
        this.setData({
            _oprateStat: true
        });
        const { code, data, msg } = await api_1.default.SendProcotolInstructSet({ mountDev: this.data.mountDev, pid: Number(this.data.pid), protocol: this.data.protocol, DevMac: this.data.mac }, item);
        this.setData({
            _oprateStat: false
        });
        wx.hideLoading();
        wx.showModal({
            title: code ? 'Success' : 'Error',
            content: code ? data.msg : msg
        });
    },
    alarm(e) {
        const type = e.detail.type;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/alarmSetting' + (0, util_1.ObjectToStrquery)({ type, protocol: this.data.protocol })
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRldnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw4Q0FBaUU7QUFDakUsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQU1ILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsR0FBRyxFQUFFLEVBQUU7UUFDUCxRQUFRLEVBQUUsRUFBRTtRQUNaLE1BQU0sRUFBRSxFQUEwQjtRQUNsQyxNQUFNLEVBQUUsRUFBRTtRQUVWLFFBQVEsRUFBRSxFQUFFO1FBQ1osSUFBSSxFQUFFLEVBQUU7UUFDUixRQUFRLEVBQUUsRUFJVDtRQUNELE1BQU0sRUFBRSwrQ0FBK0M7UUFDdkQsRUFBRSxFQUFFO1lBQ0YsV0FBVyxFQUFFLEdBQUc7WUFDaEIsUUFBUSxFQUFFLEdBQUc7U0FDZDtRQUNELFdBQVcsRUFBRSxLQUFLO0tBQ25CO0lBS0QsTUFBTSxFQUFFLFVBQVUsT0FBcUY7UUFDckcsRUFBRSxDQUFDLHFCQUFxQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQzFFLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDbkIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1lBQ2hCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtZQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7WUFDMUIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1NBQ25CLENBQUMsQ0FBQTtRQUVGLGFBQUcsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtZQUMvQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FB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QUFBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gbWluaXByb2dyYW0vcGFnZXMvaW5kZXgvZGV2cy9kZXZzLmpzXG5pbXBvcnQgeyBPYmplY3RUb1N0cnF1ZXJ5LCBwYXJzZVRpbWUgfSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvdXRpbFwiXG5pbXBvcnQgYXBpIGZyb20gXCIuLi8uLi8uLi91dGlscy9hcGlcIlxuUGFnZSh7XG5cbiAgLyoqXG4gICAqIOmhtemdoueahOWIneWni+aVsOaNrlxuICAgKi9cblxuICBkYXRhOiB7XG4gICAgbWFjOiAnJyxcbiAgICBwaWQ6ICcnLFxuICAgIG1vdW50RGV2OiBcIlwiLFxuICAgIHJlc3VsdDoge30gYXMgVWFydC5xdWVyeVJlc3VsdFNhdmUsXG4gICAgZmlsdGVyOiAnJyxcbiAgICAvL2ludGVydmFsOiAwIGFzIGFueSxcbiAgICBwcm90b2NvbDogJycsXG4gICAgVHlwZTogJycsXG4gICAgQ29uc3RhbnQ6IHt9IGFzIHtcbiAgICAgIHN5czogVWFydC5Qcm90b2NvbENvbnN0YW50VGhyZXNob2xkLFxuICAgICAgdXNlcjogVWFydC5Qcm90b2NvbENvbnN0YW50VGhyZXNob2xkLFxuICAgICAgc2hvdzogU2V0PHN0cmluZz5cbiAgICB9LFxuICAgIHVwc1BpYzogJ2h0dHA6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzM0MjAyMV9fdXBzLmdpZicsXG4gICAgdGg6IHtcbiAgICAgIHRlbXBlcmF0dXJlOiAnMCcsXG4gICAgICBodW1pZGl0eTogJzAnLFxuICAgIH0sXG4gICAgX29wcmF0ZVN0YXQ6IGZhbHNlXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Yqg6L29XG4gICAqL1xuICBvbkxvYWQ6IGZ1bmN0aW9uIChvcHRpb25zOiB7IG1vdW50RGV2OiBhbnk7IG1hYzogYW55OyBEZXZNYWM6IGFueTsgcGlkOiBhbnk7IHByb3RvY29sOiBhbnk7IFR5cGU6IGFueSB9KSB7XG4gICAgd3guc2V0TmF2aWdhdGlvbkJhclRpdGxlKHsgdGl0bGU6IG9wdGlvbnMubW91bnREZXYgfHwgb3B0aW9ucy5tYWMgfHwgJycgfSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgbWFjOiBvcHRpb25zLkRldk1hYyxcbiAgICAgIHBpZDogb3B0aW9ucy5waWQsXG4gICAgICBwcm90b2NvbDogb3B0aW9ucy5wcm90b2NvbCxcbiAgICAgIG1vdW50RGV2OiBvcHRpb25zLm1vdW50RGV2LFxuICAgICAgVHlwZTogb3B0aW9ucy5UeXBlXG4gICAgfSlcblxuICAgIGFwaS5vbk1lc3NhZ2Uob3B0aW9ucy5EZXZNYWMgKyBvcHRpb25zLnBpZCwgKCkgPT4ge1xuICAgICAgY29uc29sZS5sb2coJ+iOt+WPlui/kOihjOaVsOaNrjonK29wdGlvbnMuRGV2TWFjICsgb3B0aW9ucy5waWQpO1xuICAgICAgdGhpcy5HZXREZXZzUnVuSW5mbygpXG4gICAgfSlcbiAgfSxcbiAgYXN5bmMgb25SZWFkeSgpIHtcbiAgICB3eC5zaG93TG9hZGluZyh7IHRpdGxlOiAn6I635Y+W6L+Q6KGM5pWw5o2uJyB9KVxuICAgIGNvbnN0IHN5cyA9IGF3YWl0IGFwaS5nZXRBbGFybVByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgYXBpLmdldFVzZXJBbGFybVByb3RvY29sKHRoaXMuZGF0YS5wcm90b2NvbClcbiAgICBpZiAoc3lzLmNvZGUpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFwiQ29uc3RhbnQuc3lzXCI6IHN5cy5kYXRhXG4gICAgICB9KVxuICAgIH1cbiAgICBpZiAodXNlci5jb2RlKSB7XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBcIkNvbnN0YW50LnVzZXJcIjogdXNlci5kYXRhLFxuICAgICAgICBcIkNvbnN0YW50LnNob3dcIjogbmV3IFNldChbc3lzLmRhdGEgfHwgW10sIHVzZXIuZGF0YV0pXG4gICAgICB9KVxuICAgIH1cbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgXCJDb25zdGFudC5zaG93XCI6IG5ldyBTZXQoW3N5cy5kYXRhPy5TaG93VGFnIHx8IFtdLCB1c2VyLmRhdGE/LlNob3dUYWcgfHwgW11dLmZsYXQoKSlcbiAgICB9KVxuXG4gICAgYXdhaXQgdGhpcy5HZXREZXZzUnVuSW5mbygpXG4gICAgd3guaGlkZUxvYWRpbmcoKVxuICB9LFxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLmmL7npLpcbiAgICovXG4gIG9uU2hvdzogZnVuY3Rpb24gKCkge1xuICAgIC8qIHRoaXMuc2V0RGF0YSh7XG4gICAgICBpbnRlcnZhbDogc2V0SW50ZXJ2YWwoKCkgPT4gdGhpcy5HZXREZXZzUnVuSW5mbygpLCA1MDAwKVxuICAgIH0pICovXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i6ZqQ6JePXG4gICAqL1xuICBvbkhpZGU6IGZ1bmN0aW9uICgpIHtcbiAgICBhcGkub2ZmV3MoJ01hY0RhdGVVcGRhdGUnICsgdGhpcy5vcHRpb25zLkRldk1hYyArIHRoaXMub3B0aW9ucy5waWQpXG4gIH0sXG5cbiAgLyoqXG4gICAqIOeUn+WRveWRqOacn+WHveaVsC0t55uR5ZCs6aG16Z2i5Y246L29XG4gICAqL1xuICBvblVubG9hZDogZnVuY3Rpb24gKCkge1xuICAgIGFwaS5vZmZXcygnTWFjRGF0ZVVwZGF0ZScgKyB0aGlzLm9wdGlvbnMuRGV2TWFjICsgdGhpcy5vcHRpb25zLnBpZClcblxuICB9LFxuXG4gIC8qKlxuICAgKiDpobXpnaLnm7jlhbPkuovku7blpITnkIblh73mlbAtLeebkeWQrOeUqOaIt+S4i+aLieWKqOS9nFxuICAgKi9cbiAgb25QdWxsRG93blJlZnJlc2g6IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBhd2FpdCB0aGlzLkdldERldnNSdW5JbmZvKClcbiAgICB3eC5zdG9wUHVsbERvd25SZWZyZXNoKClcbiAgfSxcblxuXG4gIGFzeW5jIEdldERldnNSdW5JbmZvKCkge1xuICAgIGNvbnN0IHsgbWFjLCBwaWQsIGZpbHRlciB9ID0gdGhpcy5kYXRhXG4gICAgY29uc3QgeyBjb2RlLCBkYXRhLCBtc2cgfSA9IGF3YWl0IGFwaS5nZXRUZXJtaW5hbERhdGEobWFjLCBwaWQpXG4gICAgaWYgKGNvZGUgJiYgZGF0YS5yZXN1bHQpIHtcbiAgICAgIGNvbnN0IHJlZ1N0ciA9IG5ldyBSZWdFeHAoZmlsdGVyKVxuICAgICAgZGF0YS5yZXN1bHQgPSBkYXRhLnJlc3VsdC5maWx0ZXIoZWwgPT4gdGhpcy5kYXRhLkNvbnN0YW50LnNob3cuaGFzKGVsLm5hbWUpICYmICghZmlsdGVyIHx8IHJlZ1N0ci50ZXN0KGVsLm5hbWUpKSlcbiAgICAgIGRhdGEudGltZSA9IHBhcnNlVGltZShkYXRhLnRpbWUpXG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICByZXN1bHQ6IGRhdGEsXG4gICAgICB9KSBcbiAgICAgIHN3aXRjaCAodGhpcy5kYXRhLlR5cGUpIHtcbiAgICAgICAgY2FzZSBcIlVQU1wiOlxuICAgICAgICAgIGNvbnN0IHdvcmtNb2RlID0gZGF0YS5yZXN1bHQuZmluZChlbCA9PiBlbC5uYW1lID09PSB0aGlzLmRhdGEuQ29uc3RhbnQuc3lzLkNvbnN0YW50LldvcmtNb2RlKT8ucGFyc2VWYWx1ZSBhcyBzdHJpbmdcbiAgICAgICAgICBzd2l0Y2ggKHdvcmtNb2RlKSB7XG4gICAgICAgICAgICBjYXNlIFwi55S15rGg5qih5byPXCI6XG4gICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMxLmdpZidcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGNhc2UgXCLml4Hot6/mqKHlvI9cIjpcbiAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICB1cHNQaWM6ICdodHRwOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC8zNDIwMjFfX3VwczIuZ2lmJ1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSBcIuWcqOe6v+aooeW8j1wiOlxuICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHVwc1BpYzogJ2h0dHA6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzM0MjAyMV9fdXBzMy5naWYnXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHVwc1BpYzogJ2h0dHA6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzM0MjAyMV9fdXBzLmdpZidcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgXCLmuKnmub/luqZcIjpcbiAgICAgICAgICBjb25zdCB7IFRlbXBlcmF0dXJlLCBIdW1pZGl0eSB9ID0gdGhpcy5kYXRhLkNvbnN0YW50LnN5cy5Db25zdGFudFxuICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICB0aDoge1xuICAgICAgICAgICAgICB0ZW1wZXJhdHVyZTogZGF0YS5yZXN1bHQuZmluZChlbCA9PiBlbC5uYW1lID09PSBUZW1wZXJhdHVyZSk/LnBhcnNlVmFsdWUhLFxuICAgICAgICAgICAgICBodW1pZGl0eTogZGF0YS5yZXN1bHQuZmluZChlbCA9PiBlbC5uYW1lID09PSBIdW1pZGl0eSk/LnBhcnNlVmFsdWUhXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgICBicmVha1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBjbGVhckludGVydmFsKHRoaXMuZGF0YS5pbnRlcnZhbClcbiAgICAgIGFwaS5vZmZXcygnTWFjRGF0ZVVwZGF0ZScgKyB0aGlzLm9wdGlvbnMuRGV2TWFjICsgdGhpcy5vcHRpb25zLnBpZClcblxuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICdFcnJvcicsXG4gICAgICAgIGNvbnRlbnQ6IG1zZyxcbiAgICAgICAgc3VjY2VzczogKCkgPT4ge1xuICAgICAgICAgIC8vIGNsZWFySW50ZXJ2YWwodGhpcy5kYXRhLmludGVydmFsKVxuICAgICAgICAgIGFwaS5vZmZXcygnTWFjRGF0ZVVwZGF0ZScgKyB0aGlzLm9wdGlvbnMuRGV2TWFjICsgdGhpcy5vcHRpb25zLnBpZClcbiAgICAgICAgICAvL3d4Lm5hdmlnYXRlQmFjaygpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9LFxuICAvLyDliLfpgInlj4LmlbBcbiAgZmlsdGVyKGU6IHZhbnRFdmVudCkge1xuICAgIGNvbnN0IGZpbHRlciA9IGUuZGV0YWlsLmZpbHRlclxuICAgIGNvbnN0IHJlZ1N0ciA9IG5ldyBSZWdFeHAoZmlsdGVyKVxuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuZGF0YS5yZXN1bHQucmVzdWx0Py5maWx0ZXIoZWwgPT4gcmVnU3RyLnRlc3QoZWwubmFtZSkpXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIGZpbHRlcixcbiAgICAgIFwicmVzdWx0LnJlc3VsdFwiOiByZXN1bHRcbiAgICB9KVxuICB9LFxuICAvLyDlr7zoiKrliLDlm77ooahcbiAgdG9saW5lKGU6IHZhbnRFdmVudCkge1xuICAgIGNvbnN0IHVybCA9ICcvcGFnZXMvaW5kZXgvbGluZS9saW5lJyArIE9iamVjdFRvU3RycXVlcnkoeyBuYW1lOiBlLmRldGFpbC5uYW1lLCBtYWM6IHRoaXMuZGF0YS5tYWMsIHBpZDogdGhpcy5kYXRhLnBpZCwgcHJvdG9jb2w6IHRoaXMuZGF0YS5wcm90b2NvbCB9KVxuICAgIGNvbnNvbGUubG9nKHVybCk7XG5cbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybFxuICAgIH0pXG4gIH0sXG5cbiAgLy8g5Y+R6YCB5pON5L2c5oyH5LukXG4gIGFzeW5jIG9wcmF0ZShlOiBQaWNrPHZhbnRFdmVudDxVYXJ0Lk9wcmF0ZUluc3RydWN0PiwgJ2RldGFpbCc+KSB7XG4gICAgaWYgKHRoaXMuZGF0YS5fb3ByYXRlU3RhdCkgcmV0dXJuXG4gICAgY29uc3QgaXRlbTogVWFydC5PcHJhdGVJbnN0cnVjdCA9IGUuZGV0YWlsXG4gICAgaWYgKGl0ZW0udmFsdWUuaW5jbHVkZXMoXCIlaVwiKSAmJiAhaXRlbS52YWwgJiYgaXRlbS52YWwgIT09IDApIHtcbiAgICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgICB1cmw6ICcvcGFnZXMvdXRpbC9zZXRWYWwvc2V0VmFsJyArIE9iamVjdFRvU3RycXVlcnkoeyBpdGVtIH0pLFxuICAgICAgICBldmVudHM6IHtcbiAgICAgICAgICB2YWx1ZU9rOiAodmFsdWU6IHsgdmFsOiBudW1iZXIgfSkgPT4ge1xuICAgICAgICAgICAgaXRlbS52YWwgPSB2YWx1ZS52YWxcbiAgICAgICAgICAgIHRoaXMub3ByYXRlKHsgZGV0YWlsOiBpdGVtIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfmraPlnKjlj5HpgIEnIH0pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIF9vcHJhdGVTdGF0OiB0cnVlXG4gICAgfSlcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEsIG1zZyB9ID0gYXdhaXQgYXBpLlNlbmRQcm9jb3RvbEluc3RydWN0U2V0KHsgbW91bnREZXY6IHRoaXMuZGF0YS5tb3VudERldiwgcGlkOiBOdW1iZXIodGhpcy5kYXRhLnBpZCksIHByb3RvY29sOiB0aGlzLmRhdGEucHJvdG9jb2wsIERldk1hYzogdGhpcy5kYXRhLm1hYyB9IGFzIGFueSwgaXRlbSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgX29wcmF0ZVN0YXQ6IGZhbHNlXG4gICAgfSlcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgLy8g5aaC5p6c6K6+5aSH5pyq6YCa6L+H5qCh6aqM77yM5YiZ6Lez6L2s5Yiw5qCh6aqM55+t5L+h6aqM6K+B56CB6aG16Z2iXG4gICAgLyogaWYgKG9rID09PSA0KSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ+adg+mZkOmqjOivgScsXG4gICAgICAgIGNvbnRlbnQ6ICfmk43kvZzmjIfku6TpnIDopoHpqozor4HmgqjnmoTorr7lpIcs5piv5ZCm6YCa6L+H55+t5L+h5byA5aeL6aqM6K+B77yfJyxcbiAgICAgICAgc3VjY2VzczogKHJlcykgPT4ge1xuICAgICAgICAgIGlmIChyZXMuY29uZmlybSkge1xuICAgICAgICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgICAgICAgIHVybDogJy9wYWdlcy91dGlsL3Ntc1ZhbGlkYXRpb24vc21zVmFsaWRhdGlvbicsXG4gICAgICAgICAgICAgIGV2ZW50czoge1xuICAgICAgICAgICAgICAgIHZhbGlkYXRpb25TdWNjZXNzOiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnc21zIHZhbGlkYXRpb24gc3VjY2VzcycpO1xuICAgICAgICAgICAgICAgICAgdGhpcy5vcHJhdGUoeyBkZXRhaWw6IGl0ZW0gfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0gICovXG4gICAgd3guc2hvd01vZGFsKHtcbiAgICAgIHRpdGxlOiBjb2RlID8gJ1N1Y2Nlc3MnIDogJ0Vycm9yJyxcbiAgICAgIGNvbnRlbnQ6IGNvZGUgPyBkYXRhLm1zZyA6IG1zZ1xuICAgIH0pXG5cbiAgfSxcbiAgLy8g6Lez6L2s5ZGK6K2m6K6+572uXG4gIGFsYXJtKGU6IHZhbnRFdmVudCkge1xuICAgIGNvbnN0IHR5cGUgPSBlLmRldGFpbC50eXBlIGFzIHN0cmluZ1xuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsOiAnL3BhZ2VzL2luZGV4L2FsYXJtU2V0dGluZy9hbGFybVNldHRpbmcnICsgT2JqZWN0VG9TdHJxdWVyeSh7IHR5cGUsIHByb3RvY29sOiB0aGlzLmRhdGEucHJvdG9jb2wgfSlcbiAgICB9KVxuICB9XG59KSJdfQ==