"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        pid: '',
        mountDev: "",
        result: {},
        filter: '',
        protocol: '',
        Type: '',
        Constant: {},
        upsPic: 'http://www.ladishb.com/upload/342021__ups.gif',
        th: {
            temperature: '0',
            humidity: '0',
        },
        _oprateStat: false
    },
    onLoad: function (options) {
        wx.setNavigationBarTitle({ title: options.mountDev || options.mac || '' });
        this.setData({
            mac: options.DevMac,
            pid: options.pid,
            protocol: options.protocol,
            mountDev: options.mountDev,
            Type: options.Type
        });
        api_1.default.onMessage(options.DevMac + options.pid, () => {
            console.log('获取运行数据:' + options.DevMac + options.pid);
            this.GetDevsRunInfo();
        });
    },
    async onReady() {
        wx.showLoading({ title: '获取运行数据' });
        const sys = await api_1.default.getAlarmProtocol(this.data.protocol);
        const user = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        if (sys.code) {
            this.setData({
                "Constant.sys": sys.data
            });
        }
        if (user.code) {
            this.setData({
                "Constant.user": user.data,
            });
        }
        if (user.data?.ShowTag?.length > 0) {
            this.setData({
                "Constant.show": new Set(user.data?.ShowTag)
            });
        }
        else if (sys.data?.ShowTag?.length > 0) {
            this.setData({
                "Constant.show": new Set(sys.data?.ShowTag)
            });
        }
        else {
            this.setData({
                "Constant.show": new Set()
            });
        }
        await this.GetDevsRunInfo();
        wx.hideLoading();
    },
    onShow: function () {
    },
    onHide: function () {
        api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
    },
    onUnload: function () {
        api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
    },
    onPullDownRefresh: async function () {
        await this.GetDevsRunInfo();
        wx.stopPullDownRefresh();
    },
    async GetDevsRunInfo() {
        const { mac, pid, filter } = this.data;
        const { code, data, msg } = await api_1.default.getTerminalData(mac, pid);
        if (code && data.result) {
            const regStr = new RegExp(filter);
            data.result = data.result.filter(el => (this.data.Constant.show.size === 0 || this.data.Constant.show.has(el.name)) && (!filter || regStr.test(el.name)));
            data.time = (0, util_1.parseTime)(data.time);
            this.setData({
                result: data,
            });
            switch (this.data.Type) {
                case "UPS":
                    const workMode = data.result.find(el => el.name === this.data.Constant.sys.Constant.WorkMode)?.parseValue;
                    switch (workMode) {
                        case "电池模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups1.gif'
                            });
                            break;
                        case "旁路模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups2.gif'
                            });
                            break;
                        case "在线模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups3.gif'
                            });
                            break;
                        default:
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups.gif'
                            });
                            break;
                    }
                    break;
                case "温湿度":
                    const { Temperature, Humidity } = this.data.Constant.sys.Constant;
                    this.setData({
                        th: {
                            temperature: data.result.find(el => el.name === Temperature)?.parseValue,
                            humidity: data.result.find(el => el.name === Humidity)?.parseValue
                        }
                    });
                    break;
            }
        }
        else {
            api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
            wx.showModal({
                title: 'Error',
                content: msg,
                success: () => {
                    api_1.default.offWs('MacDateUpdate' + this.options.DevMac + this.options.pid);
                }
            });
        }
    },
    filter(e) {
        const filter = e.detail.filter;
        const regStr = new RegExp(filter);
        const result = this.data.result.result?.filter(el => regStr.test(el.name));
        this.setData({
            filter,
            "result.result": result
        });
    },
    toline(e) {
        const url = '/pages/index/line/line' + (0, util_1.ObjectToStrquery)({ name: e.detail.name, mac: this.data.mac, pid: this.data.pid, protocol: this.data.protocol });
        console.log(url);
        wx.navigateTo({
            url
        });
    },
    async oprate(e) {
        if (this.data._oprateStat)
            return;
        const item = e.detail;
        if (item.value.includes("%i") && !item.val && item.val !== 0) {
            wx.navigateTo({
                url: '/pages/util/setVal/setVal' + (0, util_1.ObjectToStrquery)({ item }),
                events: {
                    valueOk: (value) => {
                        item.val = value.val;
                        this.oprate({ detail: item });
                    }
                }
            });
            return;
        }
        wx.showLoading({ title: '正在发送' });
        this.setData({
            _oprateStat: true
        });
        const { code, data, msg } = await api_1.default.SendProcotolInstructSet({ mountDev: this.data.mountDev, pid: Number(this.data.pid), protocol: this.data.protocol, DevMac: this.data.mac }, item);
        this.setData({
            _oprateStat: false
        });
        wx.hideLoading();
        wx.showModal({
            title: code ? 'Success' : 'Error',
            content: code ? data.msg : msg
        });
    },
    alarm(e) {
        const type = e.detail.type;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/alarmSetting' + (0, util_1.ObjectToStrquery)({ type, protocol: this.data.protocol })
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRldnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw4Q0FBaUU7QUFDakUsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQU1ILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsR0FBRyxFQUFFLEVBQUU7UUFDUCxRQUFRLEVBQUUsRUFBRTtRQUNaLE1BQU0sRUFBRSxFQUEwQjtRQUNsQyxNQUFNLEVBQUUsRUFBRTtRQUVWLFFBQVEsRUFBRSxFQUFFO1FBQ1osSUFBSSxFQUFFLEVBQUU7UUFDUixRQUFRLEVBQUUsRUFJVDtRQUNELE1BQU0sRUFBRSwrQ0FBK0M7UUFDdkQsRUFBRSxFQUFFO1lBQ0YsV0FBVyxFQUFFLEdBQUc7WUFDaEIsUUFBUSxFQUFFLEdBQUc7U0FDZDtRQUNELFdBQVcsRUFBRSxLQUFLO0tBQ25CO0lBS0QsTUFBTSxFQUFFLFVBQVUsT0FBcUY7UUFDckcsRUFBRSxDQUFDLHFCQUFxQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQzFFLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDbkIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1lBQ2hCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtZQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7WUFDMUIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1NBQ25CLENBQUMsQ0FBQTtRQUVGLGFBQUcsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRTtZQUMvQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBQyxPQUFPLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FB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LElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRztTQUMvQixDQUFDLENBQUE7SUFFSixDQUFDO0lBRUQsS0FBSyxDQUFDLENBQVk7UUFDaEIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFjLENBQUE7UUFDcEMsRUFBRSxDQUFDLFVBQVUsQ0FBQztZQUNaLEdBQUcsRUFBRSx3Q0FBd0MsR0FBRyxJQUFBLHVCQUFnQixFQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3pHLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBtaW5pcHJvZ3JhbS9wYWdlcy9pbmRleC9kZXZzL2RldnMuanNcbmltcG9ydCB7IE9iamVjdFRvU3RycXVlcnksIHBhcnNlVGltZSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy91dGlsXCJcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5QYWdlKHtcblxuICAvKipcbiAgICog6aG16Z2i55qE5Yid5aeL5pWw5o2uXG4gICAqL1xuXG4gIGRhdGE6IHtcbiAgICBtYWM6ICcnLFxuICAgIHBpZDogJycsXG4gICAgbW91bnREZXY6IFwiXCIsXG4gICAgcmVzdWx0OiB7fSBhcyBVYXJ0LnF1ZXJ5UmVzdWx0U2F2ZSxcbiAgICBmaWx0ZXI6ICcnLFxuICAgIC8vaW50ZXJ2YWw6IDAgYXMgYW55LFxuICAgIHByb3RvY29sOiAnJyxcbiAgICBUeXBlOiAnJyxcbiAgICBDb25zdGFudDoge30gYXMge1xuICAgICAgc3lzOiBVYXJ0LlByb3RvY29sQ29uc3RhbnRUaHJlc2hvbGQsXG4gICAgICB1c2VyOiBVYXJ0LlByb3RvY29sQ29uc3RhbnRUaHJlc2hvbGQsXG4gICAgICBzaG93OiBTZXQ8c3RyaW5nPlxuICAgIH0sXG4gICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMuZ2lmJyxcbiAgICB0aDoge1xuICAgICAgdGVtcGVyYXR1cmU6ICcwJyxcbiAgICAgIGh1bWlkaXR5OiAnMCcsXG4gICAgfSxcbiAgICBfb3ByYXRlU3RhdDogZmFsc2VcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnM6IHsgbW91bnREZXY6IGFueTsgbWFjOiBhbnk7IERldk1hYzogYW55OyBwaWQ6IGFueTsgcHJvdG9jb2w6IGFueTsgVHlwZTogYW55IH0pIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogb3B0aW9ucy5tb3VudERldiB8fCBvcHRpb25zLm1hYyB8fCAnJyB9KVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBtYWM6IG9wdGlvbnMuRGV2TWFjLFxuICAgICAgcGlkOiBvcHRpb25zLnBpZCxcbiAgICAgIHByb3RvY29sOiBvcHRpb25zLnByb3RvY29sLFxuICAgICAgbW91bnREZXY6IG9wdGlvbnMubW91bnREZXYsXG4gICAgICBUeXBlOiBvcHRpb25zLlR5cGVcbiAgICB9KVxuXG4gICAgYXBpLm9uTWVzc2FnZShvcHRpb25zLkRldk1hYyArIG9wdGlvbnMucGlkLCAoKSA9PiB7XG4gICAgICBjb25zb2xlLmxvZygn6I635Y+W6L+Q6KGM5pWw5o2uOicrb3B0aW9ucy5EZXZNYWMgKyBvcHRpb25zLnBpZCk7XG4gICAgICB0aGlzLkdldERldnNSdW5JbmZvKClcbiAgICB9KVxuICB9LFxuICBhc3luYyBvblJlYWR5KCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bov5DooYzmlbDmja4nIH0pXG4gICAgY29uc3Qgc3lzID0gYXdhaXQgYXBpLmdldEFsYXJtUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBhcGkuZ2V0VXNlckFsYXJtUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIGlmIChzeXMuY29kZSkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgXCJDb25zdGFudC5zeXNcIjogc3lzLmRhdGFcbiAgICAgIH0pXG4gICAgfVxuICAgIGlmICh1c2VyLmNvZGUpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFwiQ29uc3RhbnQudXNlclwiOiB1c2VyLmRhdGEsXG4gICAgICB9KVxuICAgICAgXG4gICAgICBcbiAgICB9XG4gICAgaWYodXNlci5kYXRhPy5TaG93VGFnPy5sZW5ndGggPiAwKXtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFwiQ29uc3RhbnQuc2hvd1wiOiBuZXcgU2V0KHVzZXIuZGF0YT8uU2hvd1RhZylcbiAgICAgIH0pXG4gICAgfWVsc2UgaWYoc3lzLmRhdGE/LlNob3dUYWc/Lmxlbmd0aCA+IDApe1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgXCJDb25zdGFudC5zaG93XCI6IG5ldyBTZXQoc3lzLmRhdGE/LlNob3dUYWcpXG4gICAgICB9KVxuICAgIH1lbHNle1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgXCJDb25zdGFudC5zaG93XCI6IG5ldyBTZXQoKVxuICAgICAgfSlcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLkdldERldnNSdW5JbmZvKClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gIH0sXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG4gICAgLyogdGhpcy5zZXREYXRhKHtcbiAgICAgIGludGVydmFsOiBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLkdldERldnNSdW5JbmZvKCksIDUwMDApXG4gICAgfSkgKi9cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLpmpDol49cbiAgICovXG4gIG9uSGlkZTogZnVuY3Rpb24gKCkge1xuICAgIGFwaS5vZmZXcygnTWFjRGF0ZVVwZGF0ZScgKyB0aGlzLm9wdGlvbnMuRGV2TWFjICsgdGhpcy5vcHRpb25zLnBpZClcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLljbjovb1cbiAgICovXG4gIG9uVW5sb2FkOiBmdW5jdGlvbiAoKSB7XG4gICAgYXBpLm9mZldzKCdNYWNEYXRlVXBkYXRlJyArIHRoaXMub3B0aW9ucy5EZXZNYWMgKyB0aGlzLm9wdGlvbnMucGlkKVxuXG4gIH0sXG5cbiAgLyoqXG4gICAqIOmhtemdouebuOWFs+S6i+S7tuWkhOeQhuWHveaVsC0t55uR5ZCs55So5oi35LiL5ouJ5Yqo5L2cXG4gICAqL1xuICBvblB1bGxEb3duUmVmcmVzaDogYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IHRoaXMuR2V0RGV2c1J1bkluZm8oKVxuICAgIHd4LnN0b3BQdWxsRG93blJlZnJlc2goKVxuICB9LFxuXG5cbiAgYXN5bmMgR2V0RGV2c1J1bkluZm8oKSB7XG4gICAgY29uc3QgeyBtYWMsIHBpZCwgZmlsdGVyIH0gPSB0aGlzLmRhdGFcbiAgICBjb25zdCB7IGNvZGUsIGRhdGEsIG1zZyB9ID0gYXdhaXQgYXBpLmdldFRlcm1pbmFsRGF0YShtYWMsIHBpZClcbiAgICBpZiAoY29kZSAmJiBkYXRhLnJlc3VsdCkge1xuICAgICAgY29uc3QgcmVnU3RyID0gbmV3IFJlZ0V4cChmaWx0ZXIpXG4gICAgICBkYXRhLnJlc3VsdCA9IGRhdGEucmVzdWx0LmZpbHRlcihlbCA9Pih0aGlzLmRhdGEuQ29uc3RhbnQuc2hvdy5zaXplID09PSAwIHx8IHRoaXMuZGF0YS5Db25zdGFudC5zaG93LmhhcyhlbC5uYW1lKSkgJiYgKCFmaWx0ZXIgfHwgcmVnU3RyLnRlc3QoZWwubmFtZSkpKVxuICAgICAgZGF0YS50aW1lID0gcGFyc2VUaW1lKGRhdGEudGltZSlcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIHJlc3VsdDogZGF0YSxcbiAgICAgIH0pIFxuICAgICAgc3dpdGNoICh0aGlzLmRhdGEuVHlwZSkge1xuICAgICAgICBjYXNlIFwiVVBTXCI6XG4gICAgICAgICAgY29uc3Qgd29ya01vZGUgPSBkYXRhLnJlc3VsdC5maW5kKGVsID0+IGVsLm5hbWUgPT09IHRoaXMuZGF0YS5Db25zdGFudC5zeXMuQ29uc3RhbnQuV29ya01vZGUpPy5wYXJzZVZhbHVlIGFzIHN0cmluZ1xuICAgICAgICAgIHN3aXRjaCAod29ya01vZGUpIHtcbiAgICAgICAgICAgIGNhc2UgXCLnlLXmsaDmqKHlvI9cIjpcbiAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICB1cHNQaWM6ICdodHRwOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC8zNDIwMjFfX3VwczEuZ2lmJ1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSBcIuaXgei3r+aooeW8j1wiOlxuICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHVwc1BpYzogJ2h0dHA6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzM0MjAyMV9fdXBzMi5naWYnXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBjYXNlIFwi5Zyo57q/5qih5byPXCI6XG4gICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMzLmdpZidcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMuZ2lmJ1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBcIua4qea5v+W6plwiOlxuICAgICAgICAgIGNvbnN0IHsgVGVtcGVyYXR1cmUsIEh1bWlkaXR5IH0gPSB0aGlzLmRhdGEuQ29uc3RhbnQuc3lzLkNvbnN0YW50XG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHRoOiB7XG4gICAgICAgICAgICAgIHRlbXBlcmF0dXJlOiBkYXRhLnJlc3VsdC5maW5kKGVsID0+IGVsLm5hbWUgPT09IFRlbXBlcmF0dXJlKT8ucGFyc2VWYWx1ZSEsXG4gICAgICAgICAgICAgIGh1bWlkaXR5OiBkYXRhLnJlc3VsdC5maW5kKGVsID0+IGVsLm5hbWUgPT09IEh1bWlkaXR5KT8ucGFyc2VWYWx1ZSFcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGNsZWFySW50ZXJ2YWwodGhpcy5kYXRhLmludGVydmFsKVxuICAgICAgYXBpLm9mZldzKCdNYWNEYXRlVXBkYXRlJyArIHRoaXMub3B0aW9ucy5EZXZNYWMgKyB0aGlzLm9wdGlvbnMucGlkKVxuXG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogJ0Vycm9yJyxcbiAgICAgICAgY29udGVudDogbXNnLFxuICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XG4gICAgICAgICAgLy8gY2xlYXJJbnRlcnZhbCh0aGlzLmRhdGEuaW50ZXJ2YWwpXG4gICAgICAgICAgYXBpLm9mZldzKCdNYWNEYXRlVXBkYXRlJyArIHRoaXMub3B0aW9ucy5EZXZNYWMgKyB0aGlzLm9wdGlvbnMucGlkKVxuICAgICAgICAgIC8vd3gubmF2aWdhdGVCYWNrKClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH0sXG4gIC8vIOWIt+mAieWPguaVsFxuICBmaWx0ZXIoZTogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgZmlsdGVyID0gZS5kZXRhaWwuZmlsdGVyXG4gICAgY29uc3QgcmVnU3RyID0gbmV3IFJlZ0V4cChmaWx0ZXIpXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kYXRhLnJlc3VsdC5yZXN1bHQ/LmZpbHRlcihlbCA9PiByZWdTdHIudGVzdChlbC5uYW1lKSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZmlsdGVyLFxuICAgICAgXCJyZXN1bHQucmVzdWx0XCI6IHJlc3VsdFxuICAgIH0pXG4gIH0sXG4gIC8vIOWvvOiIquWIsOWbvuihqFxuICB0b2xpbmUoZTogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgdXJsID0gJy9wYWdlcy9pbmRleC9saW5lL2xpbmUnICsgT2JqZWN0VG9TdHJxdWVyeSh7IG5hbWU6IGUuZGV0YWlsLm5hbWUsIG1hYzogdGhpcy5kYXRhLm1hYywgcGlkOiB0aGlzLmRhdGEucGlkLCBwcm90b2NvbDogdGhpcy5kYXRhLnByb3RvY29sIH0pXG4gICAgY29uc29sZS5sb2codXJsKTtcblxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsXG4gICAgfSlcbiAgfSxcblxuICAvLyDlj5HpgIHmk43kvZzmjIfku6RcbiAgYXN5bmMgb3ByYXRlKGU6IFBpY2s8dmFudEV2ZW50PFVhcnQuT3ByYXRlSW5zdHJ1Y3Q+LCAnZGV0YWlsJz4pIHtcbiAgICBpZiAodGhpcy5kYXRhLl9vcHJhdGVTdGF0KSByZXR1cm5cbiAgICBjb25zdCBpdGVtOiBVYXJ0Lk9wcmF0ZUluc3RydWN0ID0gZS5kZXRhaWxcbiAgICBpZiAoaXRlbS52YWx1ZS5pbmNsdWRlcyhcIiVpXCIpICYmICFpdGVtLnZhbCAmJiBpdGVtLnZhbCAhPT0gMCkge1xuICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgIHVybDogJy9wYWdlcy91dGlsL3NldFZhbC9zZXRWYWwnICsgT2JqZWN0VG9TdHJxdWVyeSh7IGl0ZW0gfSksXG4gICAgICAgIGV2ZW50czoge1xuICAgICAgICAgIHZhbHVlT2s6ICh2YWx1ZTogeyB2YWw6IG51bWJlciB9KSA9PiB7XG4gICAgICAgICAgICBpdGVtLnZhbCA9IHZhbHVlLnZhbFxuICAgICAgICAgICAgdGhpcy5vcHJhdGUoeyBkZXRhaWw6IGl0ZW0gfSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ato+WcqOWPkemAgScgfSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgX29wcmF0ZVN0YXQ6IHRydWVcbiAgICB9KVxuICAgIGNvbnN0IHsgY29kZSwgZGF0YSwgbXNnIH0gPSBhd2FpdCBhcGkuU2VuZFByb2NvdG9sSW5zdHJ1Y3RTZXQoeyBtb3VudERldjogdGhpcy5kYXRhLm1vdW50RGV2LCBwaWQ6IE51bWJlcih0aGlzLmRhdGEucGlkKSwgcHJvdG9jb2w6IHRoaXMuZGF0YS5wcm90b2NvbCwgRGV2TWFjOiB0aGlzLmRhdGEubWFjIH0gYXMgYW55LCBpdGVtKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBfb3ByYXRlU3RhdDogZmFsc2VcbiAgICB9KVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAvLyDlpoLmnpzorr7lpIfmnKrpgJrov4fmoKHpqozvvIzliJnot7PovazliLDmoKHpqoznn63kv6Hpqozor4HnoIHpobXpnaJcbiAgICAvKiBpZiAob2sgPT09IDQpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn5p2D6ZmQ6aqM6K+BJyxcbiAgICAgICAgY29udGVudDogJ+aTjeS9nOaMh+S7pOmcgOimgemqjOivgeaCqOeahOiuvuWkhyzmmK/lkKbpgJrov4fnn63kv6HlvIDlp4vpqozor4HvvJ8nLFxuICAgICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XG4gICAgICAgICAgaWYgKHJlcy5jb25maXJtKSB7XG4gICAgICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICAgICAgdXJsOiAnL3BhZ2VzL3V0aWwvc21zVmFsaWRhdGlvbi9zbXNWYWxpZGF0aW9uJyxcbiAgICAgICAgICAgICAgZXZlbnRzOiB7XG4gICAgICAgICAgICAgICAgdmFsaWRhdGlvblN1Y2Nlc3M6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzbXMgdmFsaWRhdGlvbiBzdWNjZXNzJyk7XG4gICAgICAgICAgICAgICAgICB0aGlzLm9wcmF0ZSh7IGRldGFpbDogaXRlbSB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSAgKi9cbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IGNvZGUgPyAnU3VjY2VzcycgOiAnRXJyb3InLFxuICAgICAgY29udGVudDogY29kZSA/IGRhdGEubXNnIDogbXNnXG4gICAgfSlcblxuICB9LFxuICAvLyDot7PovazlkYroraborr7nva5cbiAgYWxhcm0oZTogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgdHlwZSA9IGUuZGV0YWlsLnR5cGUgYXMgc3RyaW5nXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL2FsYXJtU2V0dGluZycgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgdHlwZSwgcHJvdG9jb2w6IHRoaXMuZGF0YS5wcm90b2NvbCB9KVxuICAgIH0pXG4gIH1cbn0pIl19