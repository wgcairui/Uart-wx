"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        pid: '',
        mountDev: "",
        result: {},
        filter: '',
        interval: 0,
        protocol: '',
        Type: '',
        Constant: {},
        upsPic: 'http://www.ladishb.com/upload/342021__ups.gif',
        th: {
            temperature: '0',
            humidity: '0',
        },
        _oprateStat: false
    },
    onLoad: function (options) {
        wx.setNavigationBarTitle({ title: options.mountDev || options.mac || '' });
        this.setData({
            mac: options.DevMac,
            pid: options.pid,
            protocol: options.protocol,
            mountDev: options.mountDev,
            Type: options.Type
        });
    },
    async onReady() {
        wx.showLoading({ title: '获取运行数据' });
        const sys = await api_1.default.getAlarmProtocol(this.data.protocol);
        const user = await api_1.default.getUserAlarmProtocol(this.data.protocol);
        if (sys.code) {
            this.setData({
                "Constant.sys": sys.data
            });
        }
        if (user.code) {
            this.setData({
                "Constant.user": user.data,
                "Constant.show": new Set([sys.data || [], user.data])
            });
        }
        this.setData({
            "Constant.show": new Set([sys.data?.ShowTag || [], user.data?.ShowTag || []].flat())
        });
        await this.GetDevsRunInfo();
        wx.hideLoading();
    },
    onShow: function () {
    },
    onHide: function () {
        clearInterval(this.data.interval);
    },
    onUnload: function () {
        clearInterval(this.data.interval);
    },
    onPullDownRefresh: async function () {
        await this.GetDevsRunInfo();
        wx.stopPullDownRefresh();
    },
    async GetDevsRunInfo() {
        const { mac, pid, filter } = this.data;
        const { code, data, msg } = await api_1.default.getTerminalData(mac, pid);
        if (code && data.result) {
            const regStr = new RegExp(filter);
            data.result = data.result.filter(el => this.data.Constant.show.has(el.name) && (!filter || regStr.test(el.name)));
            data.time = util_1.parseTime(data.time);
            this.setData({
                result: data,
                interval: setTimeout(() => {
                    this.GetDevsRunInfo();
                }, data.Interval && data.Interval >= 2000 ? data.Interval : 5000)
            });
            switch (this.data.Type) {
                case "UPS":
                    const workMode = data.result.find(el => el.name === this.data.Constant.sys.Constant.WorkMode)?.parseValue;
                    switch (workMode) {
                        case "电池模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups1.gif'
                            });
                            break;
                        case "旁路模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups2.gif'
                            });
                            break;
                        case "在线模式":
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups3.gif'
                            });
                            break;
                        default:
                            this.setData({
                                upsPic: 'http://www.ladishb.com/upload/342021__ups.gif'
                            });
                            break;
                    }
                    break;
                case "温湿度":
                    const { Temperature, Humidity } = this.data.Constant.sys.Constant;
                    this.setData({
                        th: {
                            temperature: data.result.find(el => el.name === Temperature)?.parseValue,
                            humidity: data.result.find(el => el.name === Humidity)?.parseValue
                        }
                    });
                    break;
            }
        }
        else {
            clearInterval(this.data.interval);
            wx.showModal({
                title: 'Error',
                content: msg,
                success: () => {
                    clearInterval(this.data.interval);
                }
            });
        }
    },
    filter(e) {
        const filter = e.detail.filter;
        const regStr = new RegExp(filter);
        const result = this.data.result.result?.filter(el => regStr.test(el.name));
        this.setData({
            filter,
            "result.result": result
        });
    },
    toline(e) {
        const url = '/pages/index/line/line' + util_1.ObjectToStrquery({ name: e.detail.name, mac: this.data.mac, pid: this.data.pid, protocol: this.data.protocol });
        console.log(url);
        wx.navigateTo({
            url
        });
    },
    async oprate(e) {
        if (this.data._oprateStat)
            return;
        const item = e.detail;
        if (item.value.includes("%i") && !item.val && item.val !== 0) {
            wx.navigateTo({
                url: '/pages/util/setVal/setVal' + util_1.ObjectToStrquery({ item }),
                events: {
                    valueOk: (value) => {
                        item.val = value.val;
                        this.oprate({ detail: item });
                    }
                }
            });
            return;
        }
        wx.showLoading({ title: '正在发送' });
        this.setData({
            _oprateStat: true
        });
        const { code, data, msg } = await api_1.default.SendProcotolInstructSet({ mountDev: this.data.mountDev, pid: Number(this.data.pid), protocol: this.data.protocol, DevMac: this.data.mac }, item);
        this.setData({
            _oprateStat: false
        });
        wx.hideLoading();
        wx.showModal({
            title: code ? 'Success' : 'Error',
            content: code ? data.msg : msg
        });
    },
    alarm(e) {
        const type = e.detail.type;
        wx.navigateTo({
            url: '/pages/index/alarmSetting/alarmSetting' + util_1.ObjectToStrquery({ type, protocol: this.data.protocol })
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRldnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSw4Q0FBaUU7QUFDakUsNENBQW9DO0FBQ3BDLElBQUksQ0FBQztJQU1ILElBQUksRUFBRTtRQUNKLEdBQUcsRUFBRSxFQUFFO1FBQ1AsR0FBRyxFQUFFLEVBQUU7UUFDUCxRQUFRLEVBQUUsRUFBRTtRQUNaLE1BQU0sRUFBRSxFQUEwQjtRQUNsQyxNQUFNLEVBQUUsRUFBRTtRQUNWLFFBQVEsRUFBRSxDQUFRO1FBQ2xCLFFBQVEsRUFBRSxFQUFFO1FBQ1osSUFBSSxFQUFFLEVBQUU7UUFDUixRQUFRLEVBQUUsRUFJVDtRQUNELE1BQU0sRUFBRSwrQ0FBK0M7UUFDdkQsRUFBRSxFQUFFO1lBQ0YsV0FBVyxFQUFFLEdBQUc7WUFDaEIsUUFBUSxFQUFFLEdBQUc7U0FDZDtRQUNELFdBQVcsRUFBRSxLQUFLO0tBQ25CO0lBS0QsTUFBTSxFQUFFLFVBQVUsT0FBcUY7UUFDckcsRUFBRSxDQUFDLHFCQUFxQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxRQUFRLElBQUksT0FBTyxDQUFDLEdBQUcsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFBO1FBQzFFLElBQUksQ0FBQyxPQUFPLENBQUM7WUFDWCxHQUFHLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDbkIsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1lBQ2hCLFFBQVEsRUFBRSxPQUFPLENBQUMsUUFBUTtZQUMxQixRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVE7WUFDMUIsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJO1NBQ25CLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFDRCxLQUFLLENBQUMsT0FBTztRQUNYLEVBQUUsQ0FBQyxXQUFXLENBQUMsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQTtRQUNuQyxNQUFNLEdBQUcsR0FBRyxNQUFNLGFBQUcsQ0FBQyxnQkFBZ0Is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Q0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQVMsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUM3TCxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsV0FBVyxFQUFFLEtBQUs7U0FDbkIsQ0FBQyxDQUFBO1FBQ0YsRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBcUJoQixFQUFFLENBQUMsU0FBUyxDQUFDO1lBQ1gsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxPQUFPO1lBQ2pDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUc7U0FDL0IsQ0FBQyxDQUFBO0lBRUosQ0FBQztJQUVELEtBQUssQ0FBQyxDQUFZO1FBQ2hCLE1BQU0sSUFBSSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBYyxDQUFBO1FBQ3BDLEVBQUUsQ0FBQyxVQUFVLENBQUM7WUFDWixHQUFHLEVBQUUsd0NBQXdDLEdBQUcsdUJBQWdCLENBQUMsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7U0FDekcsQ0FBQyxDQUFBO0lBQ0osQ0FBQztDQUNGLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8vIG1pbmlwcm9ncmFtL3BhZ2VzL2luZGV4L2RldnMvZGV2cy5qc1xuaW1wb3J0IHsgT2JqZWN0VG9TdHJxdWVyeSwgcGFyc2VUaW1lIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcblBhZ2Uoe1xuXG4gIC8qKlxuICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICovXG5cbiAgZGF0YToge1xuICAgIG1hYzogJycsXG4gICAgcGlkOiAnJyxcbiAgICBtb3VudERldjogXCJcIixcbiAgICByZXN1bHQ6IHt9IGFzIFVhcnQucXVlcnlSZXN1bHRTYXZlLFxuICAgIGZpbHRlcjogJycsXG4gICAgaW50ZXJ2YWw6IDAgYXMgYW55LFxuICAgIHByb3RvY29sOiAnJyxcbiAgICBUeXBlOiAnJyxcbiAgICBDb25zdGFudDoge30gYXMge1xuICAgICAgc3lzOiBVYXJ0LlByb3RvY29sQ29uc3RhbnRUaHJlc2hvbGQsXG4gICAgICB1c2VyOiBVYXJ0LlByb3RvY29sQ29uc3RhbnRUaHJlc2hvbGQsXG4gICAgICBzaG93OiBTZXQ8c3RyaW5nPlxuICAgIH0sXG4gICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMuZ2lmJyxcbiAgICB0aDoge1xuICAgICAgdGVtcGVyYXR1cmU6ICcwJyxcbiAgICAgIGh1bWlkaXR5OiAnMCcsXG4gICAgfSxcbiAgICBfb3ByYXRlU3RhdDogZmFsc2VcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnM6IHsgbW91bnREZXY6IGFueTsgbWFjOiBhbnk7IERldk1hYzogYW55OyBwaWQ6IGFueTsgcHJvdG9jb2w6IGFueTsgVHlwZTogYW55IH0pIHtcbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogb3B0aW9ucy5tb3VudERldiB8fCBvcHRpb25zLm1hYyB8fCAnJyB9KVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBtYWM6IG9wdGlvbnMuRGV2TWFjLFxuICAgICAgcGlkOiBvcHRpb25zLnBpZCxcbiAgICAgIHByb3RvY29sOiBvcHRpb25zLnByb3RvY29sLFxuICAgICAgbW91bnREZXY6IG9wdGlvbnMubW91bnREZXYsXG4gICAgICBUeXBlOiBvcHRpb25zLlR5cGVcbiAgICB9KVxuICB9LFxuICBhc3luYyBvblJlYWR5KCkge1xuICAgIHd4LnNob3dMb2FkaW5nKHsgdGl0bGU6ICfojrflj5bov5DooYzmlbDmja4nIH0pXG4gICAgY29uc3Qgc3lzID0gYXdhaXQgYXBpLmdldEFsYXJtUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBhcGkuZ2V0VXNlckFsYXJtUHJvdG9jb2wodGhpcy5kYXRhLnByb3RvY29sKVxuICAgIGlmIChzeXMuY29kZSkge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgXCJDb25zdGFudC5zeXNcIjogc3lzLmRhdGFcbiAgICAgIH0pXG4gICAgfVxuICAgIGlmICh1c2VyLmNvZGUpIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFwiQ29uc3RhbnQudXNlclwiOiB1c2VyLmRhdGEsXG4gICAgICAgIFwiQ29uc3RhbnQuc2hvd1wiOiBuZXcgU2V0KFtzeXMuZGF0YSB8fCBbXSwgdXNlci5kYXRhXSlcbiAgICAgIH0pXG4gICAgfVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBcIkNvbnN0YW50LnNob3dcIjogbmV3IFNldChbc3lzLmRhdGE/LlNob3dUYWcgfHwgW10sIHVzZXIuZGF0YT8uU2hvd1RhZyB8fCBbXV0uZmxhdCgpKVxuICAgIH0pXG5cbiAgICBhd2FpdCB0aGlzLkdldERldnNSdW5JbmZvKClcbiAgICB3eC5oaWRlTG9hZGluZygpXG4gIH0sXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouaYvuekulxuICAgKi9cbiAgb25TaG93OiBmdW5jdGlvbiAoKSB7XG4gICAgLyogdGhpcy5zZXREYXRhKHtcbiAgICAgIGludGVydmFsOiBzZXRJbnRlcnZhbCgoKSA9PiB0aGlzLkdldERldnNSdW5JbmZvKCksIDUwMDApXG4gICAgfSkgKi9cbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLpmpDol49cbiAgICovXG4gIG9uSGlkZTogZnVuY3Rpb24gKCkge1xuICAgIGNsZWFySW50ZXJ2YWwodGhpcy5kYXRhLmludGVydmFsKVxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWNuOi9vVxuICAgKi9cbiAgb25VbmxvYWQ6IGZ1bmN0aW9uICgpIHtcbiAgICBjbGVhckludGVydmFsKHRoaXMuZGF0YS5pbnRlcnZhbClcbiAgfSxcblxuICAvKipcbiAgICog6aG16Z2i55u45YWz5LqL5Lu25aSE55CG5Ye95pWwLS3nm5HlkKznlKjmiLfkuIvmi4nliqjkvZxcbiAgICovXG4gIG9uUHVsbERvd25SZWZyZXNoOiBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgdGhpcy5HZXREZXZzUnVuSW5mbygpXG4gICAgd3guc3RvcFB1bGxEb3duUmVmcmVzaCgpXG4gIH0sXG5cblxuICBhc3luYyBHZXREZXZzUnVuSW5mbygpIHtcbiAgICBjb25zdCB7IG1hYywgcGlkLCBmaWx0ZXIgfSA9IHRoaXMuZGF0YVxuICAgIGNvbnN0IHsgY29kZSwgZGF0YSwgbXNnIH0gPSBhd2FpdCBhcGkuZ2V0VGVybWluYWxEYXRhKG1hYywgcGlkKVxuICAgIGlmIChjb2RlICYmIGRhdGEucmVzdWx0KSB7XG4gICAgICBjb25zdCByZWdTdHIgPSBuZXcgUmVnRXhwKGZpbHRlcilcbiAgICAgIGRhdGEucmVzdWx0ID0gZGF0YS5yZXN1bHQuZmlsdGVyKGVsID0+IHRoaXMuZGF0YS5Db25zdGFudC5zaG93LmhhcyhlbC5uYW1lKSAmJiAoIWZpbHRlciB8fCByZWdTdHIudGVzdChlbC5uYW1lKSkpXG4gICAgICBkYXRhLnRpbWUgPSBwYXJzZVRpbWUoZGF0YS50aW1lKVxuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgcmVzdWx0OiBkYXRhLFxuICAgICAgICBpbnRlcnZhbDogc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgdGhpcy5HZXREZXZzUnVuSW5mbygpXG4gICAgICAgIH0sIGRhdGEuSW50ZXJ2YWwgJiYgZGF0YS5JbnRlcnZhbCA+PSAyMDAwID8gZGF0YS5JbnRlcnZhbCA6IDUwMDApXG4gICAgICB9KVxuICAgICAgLy9cblxuICAgICAgc3dpdGNoICh0aGlzLmRhdGEuVHlwZSkge1xuICAgICAgICBjYXNlIFwiVVBTXCI6XG4gICAgICAgICAgY29uc3Qgd29ya01vZGUgPSBkYXRhLnJlc3VsdC5maW5kKGVsID0+IGVsLm5hbWUgPT09IHRoaXMuZGF0YS5Db25zdGFudC5zeXMuQ29uc3RhbnQuV29ya01vZGUpPy5wYXJzZVZhbHVlIGFzIHN0cmluZ1xuICAgICAgICAgIHN3aXRjaCAod29ya01vZGUpIHtcbiAgICAgICAgICAgIGNhc2UgXCLnlLXmsaDmqKHlvI9cIjpcbiAgICAgICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgICAgICB1cHNQaWM6ICdodHRwOi8vd3d3LmxhZGlzaGIuY29tL3VwbG9hZC8zNDIwMjFfX3VwczEuZ2lmJ1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICBicmVha1xuICAgICAgICAgICAgY2FzZSBcIuaXgei3r+aooeW8j1wiOlxuICAgICAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgICAgIHVwc1BpYzogJ2h0dHA6Ly93d3cubGFkaXNoYi5jb20vdXBsb2FkLzM0MjAyMV9fdXBzMi5naWYnXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIGJyZWFrXG4gICAgICAgICAgICBjYXNlIFwi5Zyo57q/5qih5byPXCI6XG4gICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMzLmdpZidcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgYnJlYWtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgICAgICAgICAgdXBzUGljOiAnaHR0cDovL3d3dy5sYWRpc2hiLmNvbS91cGxvYWQvMzQyMDIxX191cHMuZ2lmJ1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSBcIua4qea5v+W6plwiOlxuICAgICAgICAgIGNvbnN0IHsgVGVtcGVyYXR1cmUsIEh1bWlkaXR5IH0gPSB0aGlzLmRhdGEuQ29uc3RhbnQuc3lzLkNvbnN0YW50XG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIHRoOiB7XG4gICAgICAgICAgICAgIHRlbXBlcmF0dXJlOiBkYXRhLnJlc3VsdC5maW5kKGVsID0+IGVsLm5hbWUgPT09IFRlbXBlcmF0dXJlKT8ucGFyc2VWYWx1ZSEsXG4gICAgICAgICAgICAgIGh1bWlkaXR5OiBkYXRhLnJlc3VsdC5maW5kKGVsID0+IGVsLm5hbWUgPT09IEh1bWlkaXR5KT8ucGFyc2VWYWx1ZSFcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIGJyZWFrXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5kYXRhLmludGVydmFsKVxuICAgICAgd3guc2hvd01vZGFsKHtcbiAgICAgICAgdGl0bGU6ICdFcnJvcicsXG4gICAgICAgIGNvbnRlbnQ6IG1zZyxcbiAgICAgICAgc3VjY2VzczogKCkgPT4ge1xuICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5kYXRhLmludGVydmFsKVxuICAgICAgICAgIC8vd3gubmF2aWdhdGVCYWNrKClcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICB9XG4gIH0sXG4gIC8vIOWIt+mAieWPguaVsFxuICBmaWx0ZXIoZTogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgZmlsdGVyID0gZS5kZXRhaWwuZmlsdGVyXG4gICAgY29uc3QgcmVnU3RyID0gbmV3IFJlZ0V4cChmaWx0ZXIpXG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5kYXRhLnJlc3VsdC5yZXN1bHQ/LmZpbHRlcihlbCA9PiByZWdTdHIudGVzdChlbC5uYW1lKSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgZmlsdGVyLFxuICAgICAgXCJyZXN1bHQucmVzdWx0XCI6IHJlc3VsdFxuICAgIH0pXG4gIH0sXG4gIC8vIOWvvOiIquWIsOWbvuihqFxuICB0b2xpbmUoZTogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgdXJsID0gJy9wYWdlcy9pbmRleC9saW5lL2xpbmUnICsgT2JqZWN0VG9TdHJxdWVyeSh7IG5hbWU6IGUuZGV0YWlsLm5hbWUsIG1hYzogdGhpcy5kYXRhLm1hYywgcGlkOiB0aGlzLmRhdGEucGlkLCBwcm90b2NvbDogdGhpcy5kYXRhLnByb3RvY29sIH0pXG4gICAgY29uc29sZS5sb2codXJsKTtcblxuICAgIHd4Lm5hdmlnYXRlVG8oe1xuICAgICAgdXJsXG4gICAgfSlcbiAgfSxcblxuICAvLyDlj5HpgIHmk43kvZzmjIfku6RcbiAgYXN5bmMgb3ByYXRlKGU6IFBpY2s8dmFudEV2ZW50PFVhcnQuT3ByYXRlSW5zdHJ1Y3Q+LCAnZGV0YWlsJz4pIHtcbiAgICBpZiAodGhpcy5kYXRhLl9vcHJhdGVTdGF0KSByZXR1cm5cbiAgICBjb25zdCBpdGVtOiBVYXJ0Lk9wcmF0ZUluc3RydWN0ID0gZS5kZXRhaWxcbiAgICBpZiAoaXRlbS52YWx1ZS5pbmNsdWRlcyhcIiVpXCIpICYmICFpdGVtLnZhbCAmJiBpdGVtLnZhbCAhPT0gMCkge1xuICAgICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICAgIHVybDogJy9wYWdlcy91dGlsL3NldFZhbC9zZXRWYWwnICsgT2JqZWN0VG9TdHJxdWVyeSh7IGl0ZW0gfSksXG4gICAgICAgIGV2ZW50czoge1xuICAgICAgICAgIHZhbHVlT2s6ICh2YWx1ZTogeyB2YWw6IG51bWJlciB9KSA9PiB7XG4gICAgICAgICAgICBpdGVtLnZhbCA9IHZhbHVlLnZhbFxuICAgICAgICAgICAgdGhpcy5vcHJhdGUoeyBkZXRhaWw6IGl0ZW0gfSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICByZXR1cm5cbiAgICB9XG4gICAgd3guc2hvd0xvYWRpbmcoeyB0aXRsZTogJ+ato+WcqOWPkemAgScgfSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgX29wcmF0ZVN0YXQ6IHRydWVcbiAgICB9KVxuICAgIGNvbnN0IHsgY29kZSwgZGF0YSwgbXNnIH0gPSBhd2FpdCBhcGkuU2VuZFByb2NvdG9sSW5zdHJ1Y3RTZXQoeyBtb3VudERldjogdGhpcy5kYXRhLm1vdW50RGV2LCBwaWQ6IE51bWJlcih0aGlzLmRhdGEucGlkKSwgcHJvdG9jb2w6IHRoaXMuZGF0YS5wcm90b2NvbCwgRGV2TWFjOiB0aGlzLmRhdGEubWFjIH0gYXMgYW55LCBpdGVtKVxuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBfb3ByYXRlU3RhdDogZmFsc2VcbiAgICB9KVxuICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAvLyDlpoLmnpzorr7lpIfmnKrpgJrov4fmoKHpqozvvIzliJnot7PovazliLDmoKHpqoznn63kv6Hpqozor4HnoIHpobXpnaJcbiAgICAvKiBpZiAob2sgPT09IDQpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiAn5p2D6ZmQ6aqM6K+BJyxcbiAgICAgICAgY29udGVudDogJ+aTjeS9nOaMh+S7pOmcgOimgemqjOivgeaCqOeahOiuvuWkhyzmmK/lkKbpgJrov4fnn63kv6HlvIDlp4vpqozor4HvvJ8nLFxuICAgICAgICBzdWNjZXNzOiAocmVzKSA9PiB7XG4gICAgICAgICAgaWYgKHJlcy5jb25maXJtKSB7XG4gICAgICAgICAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgICAgICAgICAgdXJsOiAnL3BhZ2VzL3V0aWwvc21zVmFsaWRhdGlvbi9zbXNWYWxpZGF0aW9uJyxcbiAgICAgICAgICAgICAgZXZlbnRzOiB7XG4gICAgICAgICAgICAgICAgdmFsaWRhdGlvblN1Y2Nlc3M6ICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdzbXMgdmFsaWRhdGlvbiBzdWNjZXNzJyk7XG4gICAgICAgICAgICAgICAgICB0aGlzLm9wcmF0ZSh7IGRldGFpbDogaXRlbSB9KVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSAgKi9cbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6IGNvZGUgPyAnU3VjY2VzcycgOiAnRXJyb3InLFxuICAgICAgY29udGVudDogY29kZSA/IGRhdGEubXNnIDogbXNnXG4gICAgfSlcblxuICB9LFxuICAvLyDot7PovazlkYroraborr7nva5cbiAgYWxhcm0oZTogdmFudEV2ZW50KSB7XG4gICAgY29uc3QgdHlwZSA9IGUuZGV0YWlsLnR5cGUgYXMgc3RyaW5nXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvYWxhcm1TZXR0aW5nL2FsYXJtU2V0dGluZycgKyBPYmplY3RUb1N0cnF1ZXJ5KHsgdHlwZSwgcHJvdG9jb2w6IHRoaXMuZGF0YS5wcm90b2NvbCB9KVxuICAgIH0pXG4gIH1cbn0pIl19