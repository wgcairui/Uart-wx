"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        terminal: {},
        dtuItem: [],
        jwSupport: false,
        longitude: '',
        latitude: '',
        markers: [],
        address: '',
        recommend: '',
        devPics: {
            "UPS": '/assert/ups.png',
            "温湿度": '/assert/th.png',
            "电量仪": '/assert/em.png',
            "空调": '/assert/air.png'
        },
    },
    onLoad: function (options) {
        this.setData({
            mac: options.mac
        });
        this.start();
    },
    async start() {
        const { data: terminal } = await api_1.default.getTerminal(this.data.mac);
        const jw = terminal.jw && terminal.jw.length > 10 ? terminal.jw.split(',') : false;
        terminal.uptime = util_1.parseTime(terminal.uptime);
        const devs = terminal.mountDevs.map(dev => {
            dev.pic = this.data.devPics[dev.Type];
            return dev;
        });
        this.setData({
            terminal,
            dtuItem: devs,
            jwSupport: Boolean(jw),
        });
        if (jw) {
            const mark = {
                iconPath: "../../../assert/mark.png",
                latitude: Number(jw[1]),
                longitude: Number(jw[0]),
                title: terminal.name,
                width: 50,
                height: 50
            };
            this.setData({
                longitude: jw[0],
                latitude: jw[1],
                markers: [mark]
            });
            api_1.default.getGPSaddress([jw[1], jw[0]].join(',')).then(({ code, data, msg }) => {
                if (code) {
                    this.setData({
                        address: data.address,
                        recommend: data.formatted_addresses.recommend
                    });
                }
                else {
                    wx.showToast({ title: msg });
                }
            });
        }
        wx.setNavigationBarTitle({ title: terminal.name || terminal.DevMac });
    },
    showMountDevData(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        const { DevMac } = this.data.terminal;
        wx.navigateTo({
            url: '/pages/index/devs/devs' + util_1.ObjectToStrquery({ pid: String(pid), mountDev, protocol, DevMac, Type })
        });
    },
    markertap(_e) {
    },
    async nameChange(event) {
        const value = event.detail.value;
        const { code, msg } = await api_1.default.modifyTerminal(this.data.terminal.DevMac, value);
        if (!code) {
            wx.showModal({
                title: "Error",
                content: msg
            });
        }
        else {
            this.setData({
                "terminal.name": value
            });
            wx.setStorage({
                key: this.data.terminal._id,
                data: this.data.terminal
            });
        }
    },
    updateGps() {
        const setupGps = this.setupGps;
        wx.showModal({
            title: 'Tip',
            content: '是否把DTU定位更新为当前地址?',
            success(ok) {
                wx.showLoading({
                    title: '请稍等'
                });
                if (ok.confirm) {
                    wx.getSetting({
                        success(res) {
                            if (!res.authSetting["scope.userLocation"]) {
                                wx.authorize({
                                    scope: "scope.userLocation",
                                    success() {
                                        setupGps();
                                    }
                                });
                            }
                            else {
                                setupGps();
                            }
                        }
                    });
                }
            }
        });
    },
    setupGps() {
        const { terminal } = this.data;
        wx.getLocation({
            success: (location) => {
                terminal.jw = [location.longitude.toFixed(5), location.latitude.toFixed(5)].join(',');
                wx.hideLoading();
                wx.setStorage({
                    key: terminal._id,
                    data: terminal,
                    success: () => {
                        this.start();
                    }
                });
                api_1.default.updateGps(terminal.DevMac, terminal.jw).then(el => {
                    if (el.code) {
                        wx.showToast({ title: '更新定位成功' });
                    }
                    else {
                        wx.showToast({ title: el.msg, icon: 'none' });
                    }
                    wx.hideLoading();
                });
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHR1LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHR1LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQWlFO0FBQ2pFLDRDQUFvQztBQUdwQyxJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUU7UUFDSixHQUFHLEVBQUUsRUFBRTtRQUNQLFFBQVEsRUFBRSxFQUFtQjtRQUM3QixPQUFPLEVBQUUsRUFBOEI7UUFDdkMsU0FBUyxFQUFFLEtBQUs7UUFDaEIsU0FBUyxFQUFFLEVBQUU7UUFDYixRQUFRLEVBQUUsRUFBRTtRQUNaLE9BQU8sRUFBRSxFQUFXO1FBQ3BCLE9BQU8sRUFBRSxFQUFFO1FBQ1gsU0FBUyxFQUFFLEVBQUU7UUFDYixPQUFPLEVBQUU7WUFDUCxLQUFLLEVBQUUsaUJBQWlCO1lBQ3hCLEtBQUssRUFBRSxnQkFBZ0I7WUFDdkIsS0FBSyxFQUFFLGdCQUFnQjtZQUN2QixJQUFJLEVBQUUsaUJBQWlCO1NBQ3hCO0tBQ0Y7SUFLRCxNQUFNLEVBQUUsVUFBVSxPQUF3QjtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1NBQ2pCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDL0QsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLEVBQUUsSUFBSSxRQUFRLENBQUMsRUFBRSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7UUFFbEYsUUFBUSxDQUFDLE1BQU0sR0FBRyxnQkFBUyxDQUFD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bnQiOlsiaW1wb3J0IHsgT2JqZWN0VG9TdHJxdWVyeSwgcGFyc2VUaW1lIH0gZnJvbSBcIi4uLy4uLy4uL3V0aWxzL3V0aWxcIlxuaW1wb3J0IGFwaSBmcm9tIFwiLi4vLi4vLi4vdXRpbHMvYXBpXCJcblxuLy8gbWluaXByb2dyYW0vcGFnZXMvaW5kZXgvZHR1L2R0dS5qc1xuUGFnZSh7XG5cbiAgLyoqXG4gICAqIOmhtemdoueahOWIneWni+aVsOaNrlxuICAgKi9cbiAgZGF0YToge1xuICAgIG1hYzogJycsXG4gICAgdGVybWluYWw6IHt9IGFzIFVhcnQuVGVybWluYWwsXG4gICAgZHR1SXRlbTogW10gYXMgVWFydC5UZXJtaW5hbE1vdW50RGV2c1tdLFxuICAgIGp3U3VwcG9ydDogZmFsc2UsXG4gICAgbG9uZ2l0dWRlOiAnJyxcbiAgICBsYXRpdHVkZTogJycsXG4gICAgbWFya2VyczogW10gYXMgYW55W10sXG4gICAgYWRkcmVzczogJycsXG4gICAgcmVjb21tZW5kOiAnJyxcbiAgICBkZXZQaWNzOiB7XG4gICAgICBcIlVQU1wiOiAnL2Fzc2VydC91cHMucG5nJyxcbiAgICAgIFwi5rip5rm/5bqmXCI6ICcvYXNzZXJ0L3RoLnBuZycsXG4gICAgICBcIueUtemHj+S7qlwiOiAnL2Fzc2VydC9lbS5wbmcnLFxuICAgICAgXCLnqbrosINcIjogJy9hc3NlcnQvYWlyLnBuZydcbiAgICB9LFxuICB9LFxuXG4gIC8qKlxuICAgKiDnlJ/lkb3lkajmnJ/lh73mlbAtLeebkeWQrOmhtemdouWKoOi9vVxuICAgKi9cbiAgb25Mb2FkOiBmdW5jdGlvbiAob3B0aW9uczogeyBtYWM6IHN0cmluZyB9KSB7XG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIG1hYzogb3B0aW9ucy5tYWNcbiAgICB9KVxuICAgIHRoaXMuc3RhcnQoKVxuICB9LFxuXG4gIGFzeW5jIHN0YXJ0KCkge1xuICAgIGNvbnN0IHsgZGF0YTogdGVybWluYWwgfSA9IGF3YWl0IGFwaS5nZXRUZXJtaW5hbCh0aGlzLmRhdGEubWFjKVxuICAgIGNvbnN0IGp3ID0gdGVybWluYWwuancgJiYgdGVybWluYWwuancubGVuZ3RoID4gMTAgPyB0ZXJtaW5hbC5qdy5zcGxpdCgnLCcpIDogZmFsc2VcbiAgICAvLyBjb25zb2xlLmxvZyhqdyk7XG4gICAgdGVybWluYWwudXB0aW1lID0gcGFyc2VUaW1lKHRlcm1pbmFsLnVwdGltZSlcbiAgICAvL1xuICAgIGNvbnN0IGRldnMgPSB0ZXJtaW5hbC5tb3VudERldnMubWFwKGRldiA9PiB7XG4gICAgICBkZXYucGljID0gKHRoaXMuZGF0YS5kZXZQaWNzIGFzIGFueSlbZGV2LlR5cGVdXG4gICAgICByZXR1cm4gZGV2XG4gICAgfSlcbiAgICB0aGlzLnNldERhdGEoe1xuICAgICAgdGVybWluYWwsXG4gICAgICBkdHVJdGVtOiBkZXZzLFxuICAgICAgandTdXBwb3J0OiBCb29sZWFuKGp3KSxcbiAgICB9KVxuICAgIGlmIChqdykge1xuICAgICAgY29uc3QgbWFyayA9IHtcbiAgICAgICAgaWNvblBhdGg6IFwiLi4vLi4vLi4vYXNzZXJ0L21hcmsucG5nXCIsXG4gICAgICAgIGxhdGl0dWRlOiBOdW1iZXIoandbMV0pLFxuICAgICAgICBsb25naXR1ZGU6IE51bWJlcihqd1swXSksXG4gICAgICAgIHRpdGxlOiB0ZXJtaW5hbC5uYW1lLFxuICAgICAgICB3aWR0aDogNTAsXG4gICAgICAgIGhlaWdodDogNTBcbiAgICAgIH1cbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIGxvbmdpdHVkZTogandbMF0sXG4gICAgICAgIGxhdGl0dWRlOiBqd1sxXSxcbiAgICAgICAgbWFya2VyczogW21hcmtdXG4gICAgICB9KVxuICAgICAgLy8g5qC55o2uZ3Bz6I635Y+W5Zyw5Z2AXG4gICAgICBhcGkuZ2V0R1BTYWRkcmVzcyhbandbMV0sIGp3WzBdXS5qb2luKCcsJykpLnRoZW4oKHsgY29kZSwgZGF0YSwgbXNnIH0pID0+IHtcbiAgICAgICAgaWYgKGNvZGUpIHtcbiAgICAgICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICAgICAgYWRkcmVzczogZGF0YS5hZGRyZXNzLFxuICAgICAgICAgICAgcmVjb21tZW5kOiBkYXRhLmZvcm1hdHRlZF9hZGRyZXNzZXMucmVjb21tZW5kXG4gICAgICAgICAgfSlcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB3eC5zaG93VG9hc3QoeyB0aXRsZTogbXNnIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICAgIHd4LnNldE5hdmlnYXRpb25CYXJUaXRsZSh7IHRpdGxlOiB0ZXJtaW5hbC5uYW1lIHx8IHRlcm1pbmFsLkRldk1hYyB9KVxuICB9LFxuXG4gIC8vIOafpeeci+iuvuWkh+aVsOaNrlxuICBzaG93TW91bnREZXZEYXRhKGV2ZW50OiB2YW50RXZlbnQ8VWFydC5UZXJtaW5hbE1vdW50RGV2cz4pIHtcbiAgICBjb25zdCB7IHBpZCwgbW91bnREZXYsIHByb3RvY29sLCBUeXBlIH0gPSBldmVudC5jdXJyZW50VGFyZ2V0LmRhdGFzZXQuaXRlbVxuICAgIGNvbnN0IHsgRGV2TWFjIH0gPSB0aGlzLmRhdGEudGVybWluYWxcbiAgICB3eC5uYXZpZ2F0ZVRvKHtcbiAgICAgIHVybDogJy9wYWdlcy9pbmRleC9kZXZzL2RldnMnICsgT2JqZWN0VG9TdHJxdWVyeSh7IHBpZDogU3RyaW5nKHBpZCksIG1vdW50RGV2LCBwcm90b2NvbCwgRGV2TWFjLCBUeXBlIH0pXG4gICAgfSlcbiAgfSxcblxuICBtYXJrZXJ0YXAoX2U6IHZhbnRFdmVudCkge1xuICAgIC8qIGNvbnN0IG1hcCA9IHd4LmNyZWF0ZU1hcENvbnRleHQoZS5jdXJyZW50VGFyZ2V0LmlkKVxuICAgIG1hcC5nZXRDZW50ZXJMb2NhdGlvbih7XG4gICAgICBzdWNjZXNzKGUyKXtcbiAgICAgICAgY29uc29sZS5sb2coZTIpO1xuICAgICAgICBcbiAgICAgIH1cbiAgICB9KVxuICAgIFxuICovXG4gIH0sXG4gIC8vXG4gIGFzeW5jIG5hbWVDaGFuZ2UoZXZlbnQ6IHZhbnRFdmVudCkge1xuICAgIGNvbnN0IHZhbHVlID0gZXZlbnQuZGV0YWlsLnZhbHVlXG4gICAgY29uc3QgeyBjb2RlLCBtc2cgfSA9IGF3YWl0IGFwaS5tb2RpZnlUZXJtaW5hbCh0aGlzLmRhdGEudGVybWluYWwuRGV2TWFjLCB2YWx1ZSlcbiAgICBpZiAoIWNvZGUpIHtcbiAgICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICAgIHRpdGxlOiBcIkVycm9yXCIsXG4gICAgICAgIGNvbnRlbnQ6IG1zZ1xuICAgICAgfSlcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgXCJ0ZXJtaW5hbC5uYW1lXCI6IHZhbHVlXG4gICAgICB9KVxuICAgICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICAgIGtleTogdGhpcy5kYXRhLnRlcm1pbmFsLl9pZCxcbiAgICAgICAgZGF0YTogdGhpcy5kYXRhLnRlcm1pbmFsXG4gICAgICB9KVxuICAgIH1cbiAgfSxcblxuICAvLyBcbiAgdXBkYXRlR3BzKCkge1xuICAgIGNvbnN0IHNldHVwR3BzID0gdGhpcy5zZXR1cEdwc1xuICAgIHd4LnNob3dNb2RhbCh7XG4gICAgICB0aXRsZTogJ1RpcCcsXG4gICAgICBjb250ZW50OiAn5piv5ZCm5oqKRFRV5a6a5L2N5pu05paw5Li65b2T5YmN5Zyw5Z2APycsXG4gICAgICBzdWNjZXNzKG9rKSB7XG4gICAgICAgIHd4LnNob3dMb2FkaW5nKHtcbiAgICAgICAgICB0aXRsZTogJ+ivt+eojeetiSdcbiAgICAgICAgfSlcbiAgICAgICAgaWYgKG9rLmNvbmZpcm0pIHtcbiAgICAgICAgICB3eC5nZXRTZXR0aW5nKHtcbiAgICAgICAgICAgIHN1Y2Nlc3MocmVzKSB7XG4gICAgICAgICAgICAgIGlmICghcmVzLmF1dGhTZXR0aW5nW1wic2NvcGUudXNlckxvY2F0aW9uXCJdKSB7XG5cbiAgICAgICAgICAgICAgICB3eC5hdXRob3JpemUoe1xuICAgICAgICAgICAgICAgICAgc2NvcGU6IFwic2NvcGUudXNlckxvY2F0aW9uXCIsXG4gICAgICAgICAgICAgICAgICBzdWNjZXNzKCkge1xuICAgICAgICAgICAgICAgICAgICBzZXR1cEdwcygpXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZXR1cEdwcygpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSlcbiAgfSxcblxuICAvLyDorr7nva5HcHNcbiAgc2V0dXBHcHMoKSB7XG4gICAgY29uc3QgeyB0ZXJtaW5hbCB9ID0gdGhpcy5kYXRhXG4gICAgd3guZ2V0TG9jYXRpb24oe1xuICAgICAgc3VjY2VzczogKGxvY2F0aW9uKSA9PiB7XG4gICAgICAgIHRlcm1pbmFsLmp3ID0gW2xvY2F0aW9uLmxvbmdpdHVkZS50b0ZpeGVkKDUpLCBsb2NhdGlvbi5sYXRpdHVkZS50b0ZpeGVkKDUpXS5qb2luKCcsJylcbiAgICAgICAgd3guaGlkZUxvYWRpbmcoKVxuICAgICAgICB3eC5zZXRTdG9yYWdlKHtcbiAgICAgICAgICBrZXk6IHRlcm1pbmFsLl9pZCxcbiAgICAgICAgICBkYXRhOiB0ZXJtaW5hbCxcbiAgICAgICAgICBzdWNjZXNzOiAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnN0YXJ0KClcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICAgIC8vIOS4iuS8oOWumuS9jeWIsOacjeWKoeerr1xuICAgICAgICBhcGkudXBkYXRlR3BzKHRlcm1pbmFsLkRldk1hYywgdGVybWluYWwuancpLnRoZW4oZWwgPT4ge1xuICAgICAgICAgIGlmIChlbC5jb2RlKSB7XG4gICAgICAgICAgICB3eC5zaG93VG9hc3QoeyB0aXRsZTogJ+abtOaWsOWumuS9jeaIkOWKnycgfSlcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHsgdGl0bGU6IGVsLm1zZywgaWNvbjogJ25vbmUnIH0pXG4gICAgICAgICAgfVxuICAgICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9KVxuICB9XG59KSJdfQ==