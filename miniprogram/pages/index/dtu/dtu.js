"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("../../../utils/util");
const api_1 = require("../../../utils/api");
Page({
    data: {
        mac: '',
        terminal: {},
        dtuItem: [],
        jwSupport: false,
        longitude: '',
        latitude: '',
        markers: [],
        address: '',
        recommend: '',
        devPics: {
            "UPS": 'https://besiv-uart.oss-cn-hangzhou.aliyuncs.com/png/99daa3e07c7b60ef7e16ed8b9fe7cf33.png',
            "温湿度": 'https://besiv-uart.oss-cn-hangzhou.aliyuncs.com/png/5fc7d6fe0571b714d5a3395a8c7a9f12.png',
            "电量仪": 'https://besiv-uart.oss-cn-hangzhou.aliyuncs.com/png/ab52d9fccdddc0fa5b0386ea0b5cbc7f.png',
            "空调": 'https://besiv-uart.oss-cn-hangzhou.aliyuncs.com/png/c3c1852270ca35fd56135d8fda2a9977.png'
        },
    },
    onLoad: function (options) {
        this.setData({
            mac: options.mac
        });
        this.start();
    },
    async start() {
        const { data: terminal } = await api_1.default.getTerminal(this.data.mac);
        const jw = terminal.jw && terminal.jw.length > 10 ? terminal.jw.split(',') : false;
        terminal.uptime = (0, util_1.parseTime)(terminal.uptime);
        const devs = terminal.mountDevs.map(dev => {
            dev.pic = this.data.devPics[dev.Type];
            return dev;
        });
        this.setData({
            terminal,
            dtuItem: devs,
            jwSupport: Boolean(jw),
        });
        if (jw) {
            const mark = {
                iconPath: "../../../assert/mark.png",
                latitude: Number(jw[1]),
                longitude: Number(jw[0]),
                title: terminal.name,
                width: 50,
                height: 50
            };
            this.setData({
                longitude: jw[0],
                latitude: jw[1],
                markers: [mark]
            });
            api_1.default.getGPSaddress([jw[1], jw[0]].join(',')).then(({ code, data, msg }) => {
                if (code) {
                    this.setData({
                        address: data.address,
                        recommend: data.formatted_addresses.recommend
                    });
                }
                else {
                    wx.showToast({ title: msg });
                }
            });
        }
        wx.setNavigationBarTitle({ title: terminal.name || terminal.DevMac });
    },
    showMountDevData(event) {
        const { pid, mountDev, protocol, Type } = event.currentTarget.dataset.item;
        const { DevMac } = this.data.terminal;
        wx.navigateTo({
            url: '/pages/index/devs/devs' + (0, util_1.ObjectToStrquery)({ pid: String(pid), mountDev, protocol, DevMac, Type })
        });
    },
    markertap(_e) {
    },
    async nameChange(event) {
        const value = event.detail.value;
        const { code, msg } = await api_1.default.modifyTerminal(this.data.terminal.DevMac, value);
        if (!code) {
            wx.showModal({
                title: "Error",
                content: msg
            });
        }
        else {
            this.setData({
                "terminal.name": value
            });
            wx.setStorage({
                key: this.data.terminal._id,
                data: this.data.terminal
            });
        }
    },
    updateGps() {
        const setupGps = this.setupGps;
        wx.showModal({
            title: 'Tip',
            content: '是否把DTU定位更新为当前地址?',
            success(ok) {
                wx.showLoading({
                    title: '请稍等'
                });
                if (ok.confirm) {
                    wx.getSetting({
                        success(res) {
                            if (!res.authSetting["scope.userLocation"]) {
                                wx.authorize({
                                    scope: "scope.userLocation",
                                    success() {
                                        setupGps();
                                    }
                                });
                            }
                            else {
                                setupGps();
                            }
                        }
                    });
                }
            }
        });
    },
    setupGps() {
        const { terminal } = this.data;
        wx.getLocation({
            success: (location) => {
                terminal.jw = [location.longitude.toFixed(5), location.latitude.toFixed(5)].join(',');
                wx.hideLoading();
                wx.setStorage({
                    key: terminal._id,
                    data: terminal,
                    success: () => {
                        this.start();
                    }
                });
                api_1.default.updateGps(terminal.DevMac, terminal.jw).then(el => {
                    if (el.code) {
                        wx.showToast({ title: '更新定位成功' });
                    }
                    else {
                        wx.showToast({ title: el.msg, icon: 'none' });
                    }
                    wx.hideLoading();
                });
            }
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHR1LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHR1LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQWlFO0FBQ2pFLDRDQUFvQztBQUdwQyxJQUFJLENBQUM7SUFLSCxJQUFJLEVBQUU7UUFDSixHQUFHLEVBQUUsRUFBRTtRQUNQLFFBQVEsRUFBRSxFQUFtQjtRQUM3QixPQUFPLEVBQUUsRUFBOEI7UUFDdkMsU0FBUyxFQUFFLEtBQUs7UUFDaEIsU0FBUyxFQUFFLEVBQUU7UUFDYixRQUFRLEVBQUUsRUFBRTtRQUNaLE9BQU8sRUFBRSxFQUFXO1FBQ3BCLE9BQU8sRUFBRSxFQUFFO1FBQ1gsU0FBUyxFQUFFLEVBQUU7UUFDYixPQUFPLEVBQUU7WUFDUCxLQUFLLEVBQUUsMEZBQTBGO1lBQ2pHLEtBQUssRUFBRSwwRkFBMEY7WUFDakcsS0FBSyxFQUFFLDBGQUEwRjtZQUNqRyxJQUFJLEVBQUUsMEZBQTBGO1NBQ2pHO0tBQ0Y7SUFLRCxNQUFNLEVBQUUsVUFBVSxPQUF3QjtRQUN4QyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ1gsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHO1NBQ2pCLENBQUMsQ0FBQTtRQUNGLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQTtJQUNkLENBQUM7SUFFRCxLQUFLLENBQUMsS0FBSztRQUNULE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLEdBQUcsTUFBTSxhQUFHLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUE7UUFDL0QsTUFBTSxFQUFFLEdBQUcsUUFBUSxDQUFDLEVBQUUsSUFBSSxRQUFRLENBQUMsRUFBRSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUE7UUFFbEYsUUFBUSxDQUFDLE1BQU0sR0FBRyxJQUFBLGdCQUFT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dXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9iamVjdFRvU3RycXVlcnksIHBhcnNlVGltZSB9IGZyb20gXCIuLi8uLi8uLi91dGlscy91dGlsXCJcbmltcG9ydCBhcGkgZnJvbSBcIi4uLy4uLy4uL3V0aWxzL2FwaVwiXG5cbi8vIG1pbmlwcm9ncmFtL3BhZ2VzL2luZGV4L2R0dS9kdHUuanNcblBhZ2Uoe1xuXG4gIC8qKlxuICAgKiDpobXpnaLnmoTliJ3lp4vmlbDmja5cbiAgICovXG4gIGRhdGE6IHtcbiAgICBtYWM6ICcnLFxuICAgIHRlcm1pbmFsOiB7fSBhcyBVYXJ0LlRlcm1pbmFsLFxuICAgIGR0dUl0ZW06IFtdIGFzIFVhcnQuVGVybWluYWxNb3VudERldnNbXSxcbiAgICBqd1N1cHBvcnQ6IGZhbHNlLFxuICAgIGxvbmdpdHVkZTogJycsXG4gICAgbGF0aXR1ZGU6ICcnLFxuICAgIG1hcmtlcnM6IFtdIGFzIGFueVtdLFxuICAgIGFkZHJlc3M6ICcnLFxuICAgIHJlY29tbWVuZDogJycsXG4gICAgZGV2UGljczoge1xuICAgICAgXCJVUFNcIjogJ2h0dHBzOi8vYmVzaXYtdWFydC5vc3MtY24taGFuZ3pob3UuYWxpeXVuY3MuY29tL3BuZy85OWRhYTNlMDdjN2I2MGVmN2UxNmVkOGI5ZmU3Y2YzMy5wbmcnLFxuICAgICAgXCLmuKnmub/luqZcIjogJ2h0dHBzOi8vYmVzaXYtdWFydC5vc3MtY24taGFuZ3pob3UuYWxpeXVuY3MuY29tL3BuZy81ZmM3ZDZmZTA1NzFiNzE0ZDVhMzM5NWE4YzdhOWYxMi5wbmcnLFxuICAgICAgXCLnlLXph4/ku6pcIjogJ2h0dHBzOi8vYmVzaXYtdWFydC5vc3MtY24taGFuZ3pob3UuYWxpeXVuY3MuY29tL3BuZy9hYjUyZDlmY2NkZGRjMGZhNWIwMzg2ZWEwYjVjYmM3Zi5wbmcnLFxuICAgICAgXCLnqbrosINcIjogJ2h0dHBzOi8vYmVzaXYtdWFydC5vc3MtY24taGFuZ3pob3UuYWxpeXVuY3MuY29tL3BuZy9jM2MxODUyMjcwY2EzNWZkNTYxMzVkOGZkYTJhOTk3Ny5wbmcnXG4gICAgfSxcbiAgfSxcblxuICAvKipcbiAgICog55Sf5ZG95ZGo5pyf5Ye95pWwLS3nm5HlkKzpobXpnaLliqDovb1cbiAgICovXG4gIG9uTG9hZDogZnVuY3Rpb24gKG9wdGlvbnM6IHsgbWFjOiBzdHJpbmcgfSkge1xuICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICBtYWM6IG9wdGlvbnMubWFjXG4gICAgfSlcbiAgICB0aGlzLnN0YXJ0KClcbiAgfSxcblxuICBhc3luYyBzdGFydCgpIHtcbiAgICBjb25zdCB7IGRhdGE6IHRlcm1pbmFsIH0gPSBhd2FpdCBhcGkuZ2V0VGVybWluYWwodGhpcy5kYXRhLm1hYylcbiAgICBjb25zdCBqdyA9IHRlcm1pbmFsLmp3ICYmIHRlcm1pbmFsLmp3Lmxlbmd0aCA+IDEwID8gdGVybWluYWwuancuc3BsaXQoJywnKSA6IGZhbHNlXG4gICAgLy8gY29uc29sZS5sb2coancpO1xuICAgIHRlcm1pbmFsLnVwdGltZSA9IHBhcnNlVGltZSh0ZXJtaW5hbC51cHRpbWUpXG4gICAgLy9cbiAgICBjb25zdCBkZXZzID0gdGVybWluYWwubW91bnREZXZzLm1hcChkZXYgPT4ge1xuICAgICAgZGV2LnBpYyA9ICh0aGlzLmRhdGEuZGV2UGljcyBhcyBhbnkpW2Rldi5UeXBlXVxuICAgICAgcmV0dXJuIGRldlxuICAgIH0pXG4gICAgdGhpcy5zZXREYXRhKHtcbiAgICAgIHRlcm1pbmFsLFxuICAgICAgZHR1SXRlbTogZGV2cyxcbiAgICAgIGp3U3VwcG9ydDogQm9vbGVhbihqdyksXG4gICAgfSlcbiAgICBpZiAoancpIHtcbiAgICAgIGNvbnN0IG1hcmsgPSB7XG4gICAgICAgIGljb25QYXRoOiBcIi4uLy4uLy4uL2Fzc2VydC9tYXJrLnBuZ1wiLFxuICAgICAgICBsYXRpdHVkZTogTnVtYmVyKGp3WzFdKSxcbiAgICAgICAgbG9uZ2l0dWRlOiBOdW1iZXIoandbMF0pLFxuICAgICAgICB0aXRsZTogdGVybWluYWwubmFtZSxcbiAgICAgICAgd2lkdGg6IDUwLFxuICAgICAgICBoZWlnaHQ6IDUwXG4gICAgICB9XG4gICAgICB0aGlzLnNldERhdGEoe1xuICAgICAgICBsb25naXR1ZGU6IGp3WzBdLFxuICAgICAgICBsYXRpdHVkZTogandbMV0sXG4gICAgICAgIG1hcmtlcnM6IFttYXJrXVxuICAgICAgfSlcbiAgICAgIC8vIOagueaNrmdwc+iOt+WPluWcsOWdgFxuICAgICAgYXBpLmdldEdQU2FkZHJlc3MoW2p3WzFdLCBqd1swXV0uam9pbignLCcpKS50aGVuKCh7IGNvZGUsIGRhdGEsIG1zZyB9KSA9PiB7XG4gICAgICAgIGlmIChjb2RlKSB7XG4gICAgICAgICAgdGhpcy5zZXREYXRhKHtcbiAgICAgICAgICAgIGFkZHJlc3M6IGRhdGEuYWRkcmVzcyxcbiAgICAgICAgICAgIHJlY29tbWVuZDogZGF0YS5mb3JtYXR0ZWRfYWRkcmVzc2VzLnJlY29tbWVuZFxuICAgICAgICAgIH0pXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgd3guc2hvd1RvYXN0KHsgdGl0bGU6IG1zZyB9KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH1cbiAgICB3eC5zZXROYXZpZ2F0aW9uQmFyVGl0bGUoeyB0aXRsZTogdGVybWluYWwubmFtZSB8fCB0ZXJtaW5hbC5EZXZNYWMgfSlcbiAgfSxcblxuICAvLyDmn6XnnIvorr7lpIfmlbDmja5cbiAgc2hvd01vdW50RGV2RGF0YShldmVudDogdmFudEV2ZW50PFVhcnQuVGVybWluYWxNb3VudERldnM+KSB7XG4gICAgY29uc3QgeyBwaWQsIG1vdW50RGV2LCBwcm90b2NvbCwgVHlwZSB9ID0gZXZlbnQuY3VycmVudFRhcmdldC5kYXRhc2V0Lml0ZW1cbiAgICBjb25zdCB7IERldk1hYyB9ID0gdGhpcy5kYXRhLnRlcm1pbmFsXG4gICAgd3gubmF2aWdhdGVUbyh7XG4gICAgICB1cmw6ICcvcGFnZXMvaW5kZXgvZGV2cy9kZXZzJyArIE9iamVjdFRvU3RycXVlcnkoeyBwaWQ6IFN0cmluZyhwaWQpLCBtb3VudERldiwgcHJvdG9jb2wsIERldk1hYywgVHlwZSB9KVxuICAgIH0pXG4gIH0sXG5cbiAgbWFya2VydGFwKF9lOiB2YW50RXZlbnQpIHtcbiAgICAvKiBjb25zdCBtYXAgPSB3eC5jcmVhdGVNYXBDb250ZXh0KGUuY3VycmVudFRhcmdldC5pZClcbiAgICBtYXAuZ2V0Q2VudGVyTG9jYXRpb24oe1xuICAgICAgc3VjY2VzcyhlMil7XG4gICAgICAgIGNvbnNvbGUubG9nKGUyKTtcbiAgICAgICAgXG4gICAgICB9XG4gICAgfSlcbiAgICBcbiAqL1xuICB9LFxuICAvL1xuICBhc3luYyBuYW1lQ2hhbmdlKGV2ZW50OiB2YW50RXZlbnQpIHtcbiAgICBjb25zdCB2YWx1ZSA9IGV2ZW50LmRldGFpbC52YWx1ZVxuICAgIGNvbnN0IHsgY29kZSwgbXNnIH0gPSBhd2FpdCBhcGkubW9kaWZ5VGVybWluYWwodGhpcy5kYXRhLnRlcm1pbmFsLkRldk1hYywgdmFsdWUpXG4gICAgaWYgKCFjb2RlKSB7XG4gICAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgICB0aXRsZTogXCJFcnJvclwiLFxuICAgICAgICBjb250ZW50OiBtc2dcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuc2V0RGF0YSh7XG4gICAgICAgIFwidGVybWluYWwubmFtZVwiOiB2YWx1ZVxuICAgICAgfSlcbiAgICAgIHd4LnNldFN0b3JhZ2Uoe1xuICAgICAgICBrZXk6IHRoaXMuZGF0YS50ZXJtaW5hbC5faWQsXG4gICAgICAgIGRhdGE6IHRoaXMuZGF0YS50ZXJtaW5hbFxuICAgICAgfSlcbiAgICB9XG4gIH0sXG5cbiAgLy8gXG4gIHVwZGF0ZUdwcygpIHtcbiAgICBjb25zdCBzZXR1cEdwcyA9IHRoaXMuc2V0dXBHcHNcbiAgICB3eC5zaG93TW9kYWwoe1xuICAgICAgdGl0bGU6ICdUaXAnLFxuICAgICAgY29udGVudDogJ+aYr+WQpuaKikRUVeWumuS9jeabtOaWsOS4uuW9k+WJjeWcsOWdgD8nLFxuICAgICAgc3VjY2Vzcyhvaykge1xuICAgICAgICB3eC5zaG93TG9hZGluZyh7XG4gICAgICAgICAgdGl0bGU6ICfor7fnqI3nrYknXG4gICAgICAgIH0pXG4gICAgICAgIGlmIChvay5jb25maXJtKSB7XG4gICAgICAgICAgd3guZ2V0U2V0dGluZyh7XG4gICAgICAgICAgICBzdWNjZXNzKHJlcykge1xuICAgICAgICAgICAgICBpZiAoIXJlcy5hdXRoU2V0dGluZ1tcInNjb3BlLnVzZXJMb2NhdGlvblwiXSkge1xuXG4gICAgICAgICAgICAgICAgd3guYXV0aG9yaXplKHtcbiAgICAgICAgICAgICAgICAgIHNjb3BlOiBcInNjb3BlLnVzZXJMb2NhdGlvblwiLFxuICAgICAgICAgICAgICAgICAgc3VjY2VzcygpIHtcbiAgICAgICAgICAgICAgICAgICAgc2V0dXBHcHMoKVxuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgc2V0dXBHcHMoKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pXG4gIH0sXG5cbiAgLy8g6K6+572uR3BzXG4gIHNldHVwR3BzKCkge1xuICAgIGNvbnN0IHsgdGVybWluYWwgfSA9IHRoaXMuZGF0YVxuICAgIHd4LmdldExvY2F0aW9uKHtcbiAgICAgIHN1Y2Nlc3M6IChsb2NhdGlvbikgPT4ge1xuICAgICAgICB0ZXJtaW5hbC5qdyA9IFtsb2NhdGlvbi5sb25naXR1ZGUudG9GaXhlZCg1KSwgbG9jYXRpb24ubGF0aXR1ZGUudG9GaXhlZCg1KV0uam9pbignLCcpXG4gICAgICAgIHd4LmhpZGVMb2FkaW5nKClcbiAgICAgICAgd3guc2V0U3RvcmFnZSh7XG4gICAgICAgICAga2V5OiB0ZXJtaW5hbC5faWQsXG4gICAgICAgICAgZGF0YTogdGVybWluYWwsXG4gICAgICAgICAgc3VjY2VzczogKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5zdGFydCgpXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgICAvLyDkuIrkvKDlrprkvY3liLDmnI3liqHnq69cbiAgICAgICAgYXBpLnVwZGF0ZUdwcyh0ZXJtaW5hbC5EZXZNYWMsIHRlcm1pbmFsLmp3KS50aGVuKGVsID0+IHtcbiAgICAgICAgICBpZiAoZWwuY29kZSkge1xuICAgICAgICAgICAgd3guc2hvd1RvYXN0KHsgdGl0bGU6ICfmm7TmlrDlrprkvY3miJDlip8nIH0pXG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHd4LnNob3dUb2FzdCh7IHRpdGxlOiBlbC5tc2csIGljb246ICdub25lJyB9KVxuICAgICAgICAgIH1cbiAgICAgICAgICB3eC5oaWRlTG9hZGluZygpXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgfSlcbiAgfVxufSkiXX0=